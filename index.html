<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BIST Pro v3.0 â€” Borsa Analiz Platformu</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js" defer></script>
<style>
:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-card: #1a2234;
  --bg-card-hover: #1f2a40;
  --bg-input: #0d1321;
  --border: #2a3548;
  --border-hover: #3d4f6a;
  --text-primary: #e8ecf4;
  --text-secondary: #8896aa;
  --text-muted: #5a6a80;
  --accent: #00d4aa;
  --accent-dim: rgba(0,212,170,0.12);
  --accent-glow: rgba(0,212,170,0.25);
  --green: #00e5a0;
  --green-bg: rgba(0,229,160,0.1);
  --red: #ff4d6a;
  --red-bg: rgba(255,77,106,0.1);
  --yellow: #ffc547;
  --yellow-bg: rgba(255,197,71,0.1);
  --blue: #4da6ff;
  --blue-bg: rgba(77,166,255,0.1);
  --purple: #a78bfa;
  --font-body: 'Plus Jakarta Sans', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: var(--font-body);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€â”€ SCROLLBAR â”€â”€â”€ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

/* â”€â”€â”€ NAVBAR â”€â”€â”€ */
.navbar {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px; height: 56px;
  background: rgba(10,14,23,0.85);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
}
.navbar-brand {
  display: flex; align-items: center; gap: 10px;
  font-weight: 800; font-size: 18px; color: var(--accent);
  cursor: pointer; text-decoration: none;
}
.navbar-brand span { color: var(--text-muted); font-weight: 500; font-size: 12px; }
.nav-links { display: flex; gap: 4px; }
.nav-link {
  padding: 8px 16px; border-radius: var(--radius-sm);
  color: var(--text-secondary); font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all .2s; border: none; background: none;
  text-decoration: none;
}
.nav-link:hover { color: var(--text-primary); background: var(--bg-card); }
.nav-link.active { color: var(--accent); background: var(--accent-dim); }

.nav-search {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg-input); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 6px 12px;
}
.nav-search input {
  background: none; border: none; color: var(--text-primary);
  font-size: 13px; width: 180px; outline: none;
  font-family: var(--font-body);
}
.nav-search input::placeholder { color: var(--text-muted); }
.search-results-dropdown {
  position: absolute; top: 48px; right: 24px;
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); min-width: 280px;
  box-shadow: var(--shadow-lg); display: none; max-height: 300px; overflow-y: auto;
}
.search-results-dropdown.show { display: block; }
.search-result-item {
  padding: 10px 14px; cursor: pointer; transition: background .15s;
  display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid var(--border);
}
.search-result-item:hover { background: var(--bg-card-hover); }
.search-result-item:last-child { border: none; }
.search-result-code { font-family: var(--font-mono); font-weight: 700; color: var(--accent); }
.search-result-name { color: var(--text-secondary); font-size: 12px; }

/* â”€â”€â”€ MAIN CONTENT â”€â”€â”€ */
.main { padding-top: 56px; min-height: 100vh; }
.page { display: none; padding: 24px; max-width: 1440px; margin: 0 auto; }
.page.active { display: block; }

/* â”€â”€â”€ COMMON â”€â”€â”€ */
.section-title {
  font-size: 20px; font-weight: 800; margin-bottom: 16px;
  display: flex; align-items: center; gap: 10px;
}
.section-title .icon { font-size: 22px; }

.card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px;
  transition: all .25s;
}
.card:hover { border-color: var(--border-hover); box-shadow: var(--shadow); }

.grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
.grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
.grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
.grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; }

@media (max-width: 1024px) {
  .grid-4, .grid-5 { grid-template-columns: repeat(2, 1fr); }
  .grid-3 { grid-template-columns: repeat(2, 1fr); }
  .grid-3col { grid-template-columns: repeat(2, 1fr) !important; }
}
@media (max-width: 640px) {
  .grid-2, .grid-3, .grid-4, .grid-5, .grid-3col { grid-template-columns: 1fr !important; }
  .navbar { padding: 0 8px; gap: 4px; }
  .nav-links { display: none; }
  .page { padding: 12px; }
  .main { padding-top: 60px; }
  .section-title { font-size: 16px; }
  .stock-header .stock-price-big { font-size: 22px; }
  .indicator-grid { grid-template-columns: 1fr !important; }
  .chart-container { height: 250px; }
  .card { padding: 12px; }
  .table-wrap { font-size: 12px; }
  .table-wrap th, .table-wrap td { padding: 6px 8px; }
  .nav-search input { width: 100px; font-size: 12px; }
  .index-card { padding: 10px; }
  .index-card .value { font-size: 14px; }
  .btn { padding: 8px 14px; font-size: 12px; }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  #userStatus { display: flex; align-items: center; gap: 8px; }
  .condition-row { flex-direction: column; align-items: stretch; }
  .condition-row select, .condition-row input { max-width: 100% !important; width: 100% !important; }
  .stock-header { flex-direction: column; gap: 12px; }
  .flex-center { flex-wrap: wrap; }
}
@media (max-width: 400px) {
  .page { padding: 8px; }
  .navbar-brand span { display: none; }
}

.badge {
  display: inline-flex; padding: 3px 8px; border-radius: 6px;
  font-size: 11px; font-weight: 700; font-family: var(--font-mono);
}
.badge-green { background: var(--green-bg); color: var(--green); }
.badge-red { background: var(--red-bg); color: var(--red); }
.badge-yellow { background: var(--yellow-bg); color: var(--yellow); }
.badge-blue { background: var(--blue-bg); color: var(--blue); }
.badge-neutral { background: rgba(136,150,170,0.1); color: var(--text-secondary); }

.price-up { color: var(--green); }
.price-down { color: var(--red); }

.btn {
  padding: 10px 20px; border-radius: var(--radius-sm); font-size: 13px;
  font-weight: 600; cursor: pointer; transition: all .2s;
  border: 1px solid var(--border); font-family: var(--font-body);
}
.btn-primary {
  background: var(--accent); color: var(--bg-primary); border: none;
}
.btn-primary:hover { filter: brightness(1.15); transform: translateY(-1px); }
.btn-secondary { background: var(--bg-card); color: var(--text-primary); }
.btn-secondary:hover { background: var(--bg-card-hover); }
.btn-sm { padding: 6px 12px; font-size: 12px; }

input, select {
  background: var(--bg-input); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 14px;
  color: var(--text-primary); font-size: 13px;
  font-family: var(--font-body); outline: none;
  transition: border .2s;
}
input:focus, select:focus { border-color: var(--accent); }

.loading {
  display: flex; align-items: center; justify-content: center;
  padding: 60px; color: var(--text-muted);
}
.spinner {
  width: 32px; height: 32px; border: 3px solid var(--border);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin .8s linear infinite; margin-right: 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th {
  text-align: left; padding: 10px 14px; font-size: 11px;
  text-transform: uppercase; letter-spacing: 0.5px;
  color: var(--text-muted); border-bottom: 1px solid var(--border);
  font-weight: 600; white-space: nowrap;
}
td {
  padding: 12px 14px; border-bottom: 1px solid rgba(42,53,72,0.5);
  font-size: 13px; white-space: nowrap;
}
tr:hover td { background: rgba(26,34,52,0.5); }
.td-mono { font-family: var(--font-mono); font-weight: 600; }
.td-clickable { cursor: pointer; color: var(--accent); }
.td-clickable:hover { text-decoration: underline; }

.empty-state {
  text-align: center; padding: 60px 20px; color: var(--text-muted);
}
.empty-state .icon { font-size: 48px; margin-bottom: 12px; }

.tabs { display: flex; gap: 4px; margin-bottom: 20px; flex-wrap: wrap; }
.tab {
  padding: 8px 16px; border-radius: var(--radius-sm);
  font-size: 13px; font-weight: 600; cursor: pointer;
  color: var(--text-secondary); background: none; border: none;
  transition: all .2s; font-family: var(--font-body);
}
.tab:hover { color: var(--text-primary); background: var(--bg-card); }
.tab.active { color: var(--accent); background: var(--accent-dim); }

.flex-between { display: flex; justify-content: space-between; align-items: center; }
.flex-center { display: flex; align-items: center; }
.gap-8 { gap: 8px; }
.gap-12 { gap: 12px; }
.gap-16 { gap: 16px; }
.gap-24 { gap: 24px; }
.mb-8 { margin-bottom: 8px; }
.mb-16 { margin-bottom: 16px; }
.mb-24 { margin-bottom: 24px; }
.mt-16 { margin-top: 16px; }
.mt-24 { margin-top: 24px; }

/* â”€â”€â”€ INDEX CARDS â”€â”€â”€ */
.index-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px 20px;
  transition: all .25s;
}
.index-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
.index-card .label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.index-card .value { font-family: var(--font-mono); font-size: 22px; font-weight: 700; }
.index-card .change { font-family: var(--font-mono); font-size: 13px; font-weight: 600; margin-top: 4px; }

/* â”€â”€â”€ STOCK TABLE ROW â”€â”€â”€ */
.stock-row { cursor: pointer; }
.stock-row:hover td { background: var(--bg-card-hover); }

/* â”€â”€â”€ STOCK DETAIL HEADER â”€â”€â”€ */
.stock-header {
  display: flex; align-items: flex-start; justify-content: space-between;
  flex-wrap: wrap; gap: 20px; margin-bottom: 24px;
}
.stock-header .stock-price-big {
  font-family: var(--font-mono); font-size: 36px; font-weight: 700;
}
.stock-header .stock-change-big {
  font-family: var(--font-mono); font-size: 16px; font-weight: 600;
}
.stock-header .stock-name { font-size: 14px; color: var(--text-secondary); }

/* â”€â”€â”€ COLLAPSIBLE SECTIONS â”€â”€â”€ */
.collapsible-header {
  display: flex; justify-content: space-between; align-items: center;
  cursor: pointer; user-select: none; padding: 4px 0;
}
.collapsible-header:hover { opacity: 0.8; }
.collapsible-header .collapse-icon {
  transition: transform 0.3s ease; font-size: 14px; color: var(--text-muted);
}
.collapsible-header.collapsed .collapse-icon { transform: rotate(-90deg); }
.collapsible-body { transition: max-height 0.3s ease, opacity 0.3s ease; overflow: hidden; }
.collapsible-body.collapsed { max-height: 0 !important; opacity: 0; padding-top: 0; padding-bottom: 0; }

/* â”€â”€â”€ INDICATOR PILL â”€â”€â”€ */
.indicator-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
.indicator-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 14px; transition: border-color 0.2s;
}
.indicator-card:hover { border-color: var(--accent); }
.indicator-card.signal-buy { border-left: 3px solid var(--green); }
.indicator-card.signal-sell { border-left: 3px solid var(--red); }
.indicator-card.signal-neutral { border-left: 3px solid var(--text-muted); }
.indicator-card .ind-name { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.indicator-card .ind-value { font-family: var(--font-mono); font-size: 18px; font-weight: 700; }
.indicator-card .ind-detail { font-size: 11px; color: var(--text-secondary); margin-top: 6px; line-height: 1.5; }
.indicator-card .ind-explanation { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
.indicator-card .ind-bar { height: 4px; border-radius: 2px; background: var(--border); margin-top: 8px; overflow: hidden; }
.indicator-card .ind-bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

/* â”€â”€â”€ FIBONACCI LEVELS â”€â”€â”€ */
.fib-bar {
  display: flex; align-items: center; gap: 12px;
  padding: 8px 0; border-bottom: 1px solid rgba(42,53,72,0.3);
}
.fib-label { font-family: var(--font-mono); font-size: 11px; color: var(--text-muted); min-width: 80px; }
.fib-value { font-family: var(--font-mono); font-size: 13px; font-weight: 600; }
.fib-line { flex: 1; height: 2px; background: var(--border); position: relative; }
.fib-marker {
  position: absolute; top: -4px; width: 10px; height: 10px;
  background: var(--accent); border-radius: 50%;
}

/* â”€â”€â”€ SCREENER CONDITION â”€â”€â”€ */
.condition-row {
  display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap;
}
.condition-row select, .condition-row input { max-width: 180px; }
.remove-condition {
  background: var(--red-bg); color: var(--red); border: none;
  width: 28px; height: 28px; border-radius: 6px; cursor: pointer;
  font-size: 16px; display: flex; align-items: center; justify-content: center;
}

/* â”€â”€â”€ BACKTEST RESULT â”€â”€â”€ */
.bt-metric {
  text-align: center; padding: 16px;
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius-sm);
}
.bt-metric .bt-val { font-family: var(--font-mono); font-size: 20px; font-weight: 700; }
.bt-metric .bt-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

/* â”€â”€â”€ BREADTH BAR â”€â”€â”€ */
.breadth-bar {
  display: flex; height: 28px; border-radius: 14px; overflow: hidden;
  background: var(--bg-input); margin: 8px 0;
}
.breadth-bar .adv { background: var(--green); transition: width .5s; }
.breadth-bar .unc { background: var(--yellow); transition: width .5s; }
.breadth-bar .dec { background: var(--red); transition: width .5s; }

/* â”€â”€â”€ CHART CONTAINER â”€â”€â”€ */
.chart-container {
  position: relative; width: 100%; background: var(--bg-card);
  border: 1px solid var(--border); border-radius: var(--radius);
  padding: 16px;
}
.chart-container canvas { max-height: 400px; }

/* Mobile nav toggle */
.nav-toggle {
  display: none; background: none; border: none; color: var(--text-primary);
  font-size: 24px; cursor: pointer;
}
@media (max-width: 640px) {
  .nav-toggle { display: block; }
  .nav-links.show { display: flex; position: absolute; top: 56px; left: 0; right: 0;
    background: var(--bg-secondary); flex-direction: column; padding: 12px;
    border-bottom: 1px solid var(--border); }
}

/* â”€â”€â”€ FADE IN â”€â”€â”€ */
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
.fade-in { animation: fadeIn .4s ease-out; }

/* â”€â”€â”€ PORTFOLIO TABLE â”€â”€â”€ */
.pnl-positive { color: var(--green); }
.pnl-negative { color: var(--red); }
</style>
</head>
<body>

<!-- NAVBAR -->
<nav class="navbar">
  <a class="navbar-brand" onclick="navigate('dashboard')">
    â—† BIST Pro <span>v3.0</span>
  </a>
  <button class="nav-toggle" onclick="document.querySelector('.nav-links').classList.toggle('show')">â˜°</button>
  <div class="nav-links">
    <button class="nav-link active" data-page="dashboard" onclick="navigate('dashboard')">Dashboard</button>
    <button class="nav-link" data-page="bist100" onclick="navigate('bist100')">BIST 100</button>
    <button class="nav-link" data-page="heatmap" onclick="navigate('heatmap')">IsÄ± HaritasÄ±</button>
    <button class="nav-link" data-page="screener" onclick="navigate('screener')">TarayÄ±cÄ±</button>
    <button class="nav-link" data-page="compare" onclick="navigate('compare')">KarÅŸÄ±laÅŸtÄ±r</button>
    <button class="nav-link" data-page="report" onclick="navigate('report')">GÃ¼nlÃ¼k Rapor</button>
    <button class="nav-link" data-page="watchlist" onclick="navigate('watchlist')">Favoriler</button>
    <button class="nav-link" data-page="portfolio" onclick="navigate('portfolio')">PortfÃ¶y</button>
    <button class="nav-link" data-page="backtest" onclick="navigate('backtest')">Backtest</button>
    <button class="nav-link" data-page="alerts" onclick="navigate('alerts')">UyarÄ±lar</button>
  </div>
  <div style="position:relative;">
    <div class="nav-search">
      <span style="color:var(--text-muted)">ğŸ”</span>
      <input type="text" id="globalSearch" placeholder="Hisse ara... (THYAO)" oninput="onSearch(this.value)" onfocus="onSearch(this.value)">
    </div>
    <div class="search-results-dropdown" id="searchDropdown"></div>
  </div>
  <div id="userStatus" style="margin-left:8px;"></div>
</nav>

<!-- MAIN -->
<div class="main">

<!-- â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-dashboard">
  <div class="section-title mb-24"><span class="icon">ğŸ“Š</span> Piyasa Ã–zeti</div>

  <!-- Endeks KartlarÄ± -->
  <div class="mb-24" id="indicesCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px;">
    <div class="index-card"><div class="label">YÃ¼kleniyor...</div><div class="spinner" style="margin:8px auto;width:20px;height:20px;border-width:2px;"></div></div>
  </div>

  <!-- Piyasa GeniÅŸliÄŸi -->
  <div class="card mb-24" id="breadthCard">
    <div class="flex-between mb-8">
      <div style="font-weight:700;font-size:14px;">Piyasa GeniÅŸliÄŸi</div>
      <div id="breadthStats" style="font-size:12px;color:var(--text-secondary);"></div>
    </div>
    <div class="breadth-bar">
      <div class="adv" id="breadthAdv" style="width:50%"></div>
      <div class="unc" id="breadthUnc" style="width:10%"></div>
      <div class="dec" id="breadthDec" style="width:40%"></div>
    </div>
    <div class="flex-between" style="font-size:11px;color:var(--text-muted);margin-top:4px;">
      <span>ğŸŸ¢ YÃ¼kselen: <span id="advCount">-</span></span>
      <span>ğŸŸ¡ DeÄŸiÅŸmez: <span id="uncCount">-</span></span>
      <span>ğŸ”´ DÃ¼ÅŸen: <span id="decCount">-</span></span>
    </div>
  </div>

  <!-- Movers Grid -->
  <div class="grid-2 mb-24">
    <!-- En Ã‡ok Artan -->
    <div class="card">
      <div style="font-weight:700;font-size:14px;margin-bottom:12px;">ğŸš€ En Ã‡ok Artan</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Hisse</th><th>Fiyat</th><th>DeÄŸiÅŸim</th></tr></thead>
        <tbody id="topGainers"></tbody>
      </table></div>
    </div>
    <!-- En Ã‡ok Azalan -->
    <div class="card">
      <div style="font-weight:700;font-size:14px;margin-bottom:12px;">ğŸ“‰ En Ã‡ok Azalan</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Hisse</th><th>Fiyat</th><th>DeÄŸiÅŸim</th></tr></thead>
        <tbody id="topLosers"></tbody>
      </table></div>
    </div>
  </div>

  <div class="grid-2 mb-24">
    <!-- Hacim Liderleri -->
    <div class="card">
      <div style="font-weight:700;font-size:14px;margin-bottom:12px;">ğŸ“Š Hacim Liderleri</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Hisse</th><th>Fiyat</th><th>Hacim</th></tr></thead>
        <tbody id="volumeLeaders"></tbody>
      </table></div>
    </div>
    <!-- Gap AÃ§anlar -->
    <div class="card">
      <div style="font-weight:700;font-size:14px;margin-bottom:12px;">âš¡ Gap AÃ§anlar</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Hisse</th><th>Fiyat</th><th>Gap %</th></tr></thead>
        <tbody id="gapStocks"></tbody>
      </table></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• BIST 100 â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-bist100">
  <div class="flex-between mb-24">
    <div class="section-title"><span class="icon">ğŸ“‹</span> BIST 100 Hisseleri</div>
    <div class="flex-center gap-8">
      <select id="sectorFilter" onchange="loadBist100()">
        <option value="">TÃ¼m SektÃ¶rler</option>
      </select>
      <select id="sortFilter" onchange="loadBist100()">
        <option value="code">Kod</option>
        <option value="change">DeÄŸiÅŸim</option>
        <option value="volume">Hacim</option>
        <option value="price">Fiyat</option>
      </select>
    </div>
  </div>
  <div class="card">
    <div class="table-wrap"><table>
      <thead><tr>
        <th>Kod</th><th>Ä°sim</th><th>Fiyat</th><th>DeÄŸiÅŸim</th><th>DeÄŸiÅŸim %</th><th>Hacim</th><th>AÃ§Ä±lÄ±ÅŸ</th><th>YÃ¼ksek</th><th>DÃ¼ÅŸÃ¼k</th>
      </tr></thead>
      <tbody id="bist100Table"></tbody>
    </table></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• STOCK DETAIL â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-stock">
  <div id="stockDetailContent">
    <div class="empty-state">
      <div class="icon">ğŸ“ˆ</div>
      <div>Bir hisse seÃ§in veya arama yapÄ±n</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• COMMODITY DETAIL â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-commodity">
  <div id="commodityDetailContent">
    <div class="empty-state">
      <div class="icon">ğŸ¥‡</div>
      <div>Bir emtia seÃ§in (Dashboard'dan AltÄ±n/GÃ¼mÃ¼ÅŸ kartÄ±na tÄ±klayÄ±n)</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• WATCHLIST (FAVORÄ°LER) â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-watchlist">
  <div class="flex-between mb-24">
    <div class="section-title"><span class="icon">â­</span> Favori Hisselerim</div>
    <div class="flex-center gap-8">
      <input id="wlAddSymbol" placeholder="Hisse kodu (THYAO)" style="width:160px;">
      <button class="btn btn-primary btn-sm" onclick="addToWatchlist()">+ Ekle</button>
    </div>
  </div>
  <div id="watchlistLoginMsg" style="display:none;" class="card mb-24">
    <div class="empty-state">
      <div class="icon">ğŸ”’</div>
      <div>Favorileri kullanmak iÃ§in giriÅŸ yapÄ±n</div>
      <button class="btn btn-primary btn-sm" onclick="showLogin()" style="margin-top:12px;">GiriÅŸ Yap</button>
    </div>
  </div>
  <div class="card">
    <div class="table-wrap"><table>
      <thead><tr><th>Kod</th><th>Ä°sim</th><th>Fiyat</th><th>DeÄŸiÅŸim</th><th>DeÄŸiÅŸim %</th><th>Hacim</th><th></th></tr></thead>
      <tbody id="watchlistTable"></tbody>
    </table></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SCREENER â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-screener">
  <div class="section-title mb-24"><span class="icon">ğŸ”</span> Hisse TarayÄ±cÄ±</div>

  <!-- KoÅŸul AÃ§Ä±klamalarÄ± -->
  <div class="card mb-16" style="border:1px solid rgba(99,102,241,0.2);background:rgba(99,102,241,0.05);">
    <div class="collapsible-header" onclick="toggleSection(this)">
      <div style="font-weight:700;font-size:13px;color:var(--accent);">â„¹ï¸ KoÅŸullar NasÄ±l KullanÄ±lÄ±r?</div>
      <span class="collapse-icon">â–¼</span>
    </div>
    <div class="collapsible-body collapsed" style="max-height:800px;">
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.8;padding-top:12px;">
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;">
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">RSI (GÃ¶receli GÃ¼Ã§ Endeksi)</div>
            0-100 arasÄ± deÄŸer alÄ±r. <b>RSI &lt; 30</b> â†’ AÅŸÄ±rÄ± satÄ±m (alÄ±ÅŸ fÄ±rsatÄ±). <b>RSI &gt; 70</b> â†’ AÅŸÄ±rÄ± alÄ±m (satÄ±ÅŸ sinyali).
            <br><i>Ã–rnek: RSI &lt; 30 â†’ AÅŸÄ±rÄ± satÄ±lan hisseleri bulur</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">Hacim OranÄ±</div>
            GÃ¼ncel hacim / ortalama hacim. <b>&gt; 2</b> â†’ Normalin 2 katÄ± iÅŸlem. Ani hacim artÄ±ÅŸÄ± fiyat kÄ±rÄ±lÄ±mÄ± habercisi olabilir.
            <br><i>Ã–rnek: Hacim OranÄ± &gt; 2 â†’ YÃ¼ksek iÅŸlem hacimli hisseler</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">ATR % (Ortalama GerÃ§ek AralÄ±k)</div>
            GÃ¼nlÃ¼k fiyat hareketinin yÃ¼zdesi. <b>YÃ¼ksek ATR</b> = yÃ¼ksek volatilite. Scalping ve day trade iÃ§in kullanÄ±lÄ±r.
            <br><i>Ã–rnek: ATR % &gt; 3 â†’ GÃ¼nlÃ¼k %3'ten fazla hareket eden hisseler</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">EMA Cross</div>
            EMA20 ve EMA50 kesiÅŸimi. <b>1</b> = EMA20 yukarÄ± kesti (altÄ±n kesiÅŸim, alÄ±ÅŸ). <b>-1</b> = EMA20 aÅŸaÄŸÄ± kesti (Ã¶lÃ¼m kesiÅŸimi, satÄ±ÅŸ).
            <br><i>Ã–rnek: EMA Cross &gt; 0 â†’ YukarÄ± trend baÅŸlayan hisseler</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">Breakout (KÄ±rÄ±lÄ±m)</div>
            FiyatÄ±n son 20 gÃ¼nlÃ¼k en yÃ¼ksek seviyeyi geÃ§mesi. <b>1</b> = yukarÄ± kÄ±rÄ±lÄ±m. Yeni yÃ¼kseliÅŸ trendinin habercisi.
            <br><i>Ã–rnek: Breakout &gt; 0 â†’ DirenÃ§ kÄ±ran hisseler</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">MACD Sinyal</div>
            MACD Ã§izgisi sinyal Ã§izgisini kestiÄŸinde. <b>1</b> = alÄ±ÅŸ sinyali (yukarÄ± kesiÅŸim). <b>-1</b> = satÄ±ÅŸ sinyali (aÅŸaÄŸÄ± kesiÅŸim).
            <br><i>Ã–rnek: MACD Sinyal &gt; 0 â†’ MACD alÄ±ÅŸ veren hisseler</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">Fiyat &gt; EMA20</div>
            KÄ±sa vadeli trendin Ã¼stÃ¼nde olan hisseler. <b>1</b> = fiyat EMA20'nin Ã¼stÃ¼nde. KÄ±sa vadeli yÃ¼kseliÅŸ trendi.
            <br><i>Ã–rnek: Fiyat &gt; EMA20 &gt; 0 â†’ KÄ±sa vadeli yÃ¼kseliÅŸte olanlar</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">Fiyat &gt; EMA50</div>
            Orta vadeli trendin Ã¼stÃ¼nde olan hisseler. <b>1</b> = fiyat EMA50'nin Ã¼stÃ¼nde. Orta vadeli yÃ¼kseliÅŸ trendi.
            <br><i>Ã–rnek: Fiyat &gt; EMA50 &gt; 0 â†’ Orta vadeli yÃ¼kseliÅŸte olanlar</i>
          </div>
        </div>
        <div style="margin-top:12px;padding:8px;border-radius:6px;background:var(--card-bg);border-left:3px solid var(--accent);">
          <b>Ä°pucu:</b> Birden fazla koÅŸul ekleyerek daha hassas tarama yapabilirsiniz.
          Ã–rneÄŸin: RSI &lt; 30 <b>VE</b> Hacim OranÄ± &gt; 1.5 â†’ AÅŸÄ±rÄ± satÄ±lan ama yÃ¼ksek hacimli hisseler (potansiyel dÃ¶nÃ¼ÅŸ sinyali).
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-24">
    <div style="font-weight:700;margin-bottom:12px;">KoÅŸullar</div>
    <div id="screenerConditions">
      <div class="condition-row">
        <select class="sc-indicator" onchange="updateScreenerHint(this)">
          <option value="rsi">RSI (0-100)</option>
          <option value="volume_ratio">Hacim OranÄ± (x)</option>
          <option value="atr_pct">ATR % (volatilite)</option>
          <option value="ema_cross">EMA Cross (1/-1)</option>
          <option value="breakout">Breakout (0/1)</option>
          <option value="macd_signal">MACD Sinyal (1/-1)</option>
          <option value="price_above_ema20">Fiyat > EMA20 (0/1)</option>
          <option value="price_above_ema50">Fiyat > EMA50 (0/1)</option>
          <option value="changePct">GÃ¼nlÃ¼k DeÄŸiÅŸim %</option>
          <option value="price">Fiyat (TL)</option>
          <option value="volume">Hacim (lot)</option>
          <option value="gapPct">Gap %</option>
        </select>
        <select class="sc-operator">
          <option value=">">&gt;</option>
          <option value="<">&lt;</option>
          <option value=">=">&ge;</option>
          <option value="<=">&le;</option>
          <option value="==">=</option>
        </select>
        <input class="sc-value" placeholder="DeÄŸer" style="width:100px;">
        <button class="remove-condition" onclick="this.parentElement.remove()">âœ•</button>
      </div>
    </div>
    <div class="flex-center gap-8 mt-16">
      <button class="btn btn-secondary btn-sm" onclick="addScreenerCondition()">+ KoÅŸul Ekle</button>
      <select id="screenerSector" style="font-size:13px;">
        <option value="">TÃ¼m SektÃ¶rler</option>
      </select>
      <button class="btn btn-primary" onclick="runScreener()">Tara ğŸ”</button>
    </div>
    <!-- HazÄ±r tarama ÅŸablonlarÄ± -->
    <div style="margin-top:12px;display:flex;gap:6px;flex-wrap:wrap;">
      <button class="btn btn-sm" style="font-size:11px;background:rgba(16,185,129,0.1);color:var(--green);border:1px solid rgba(16,185,129,0.3);" onclick="applyScreenerTemplate('oversold')">AÅŸÄ±rÄ± SatÄ±m (RSI&lt;30)</button>
      <button class="btn btn-sm" style="font-size:11px;background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.3);" onclick="applyScreenerTemplate('overbought')">AÅŸÄ±rÄ± AlÄ±m (RSI&gt;70)</button>
      <button class="btn btn-sm" style="font-size:11px;background:rgba(99,102,241,0.1);color:var(--accent);border:1px solid rgba(99,102,241,0.3);" onclick="applyScreenerTemplate('highvolume')">YÃ¼ksek Hacim</button>
      <button class="btn btn-sm" style="font-size:11px;background:rgba(245,158,11,0.1);color:#F59E0B;border:1px solid rgba(245,158,11,0.3);" onclick="applyScreenerTemplate('breakout')">KÄ±rÄ±lÄ±m</button>
    </div>
  </div>

  <div class="card" id="screenerResults" style="display:none;">
    <div class="flex-between mb-16">
      <div style="font-weight:700;">SonuÃ§lar</div>
      <div id="screenerCount" style="font-size:12px;color:var(--text-secondary);"></div>
    </div>
    <div class="table-wrap"><table>
      <thead><tr><th>Kod</th><th>Ä°sim</th><th>Fiyat</th><th>DeÄŸiÅŸim %</th><th>RSI</th><th>Hacim Oran</th><th>EMA Cross</th></tr></thead>
      <tbody id="screenerTable"></tbody>
    </table></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• PORTFOLIO â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-portfolio">
  <div class="flex-between mb-24">
    <div class="section-title"><span class="icon">ğŸ’¼</span> PortfÃ¶y</div>
    <button class="btn btn-primary btn-sm" onclick="showAddPositionForm()">+ Pozisyon Ekle</button>
  </div>

  <!-- Ekleme Formu -->
  <div class="card mb-24" id="addPositionForm" style="display:none;">
    <div style="font-weight:700;margin-bottom:12px;">Yeni Pozisyon</div>
    <div class="flex-center gap-8" style="flex-wrap:wrap;">
      <input id="pfSymbol" placeholder="Hisse Kodu (THYAO)" style="width:140px;">
      <input id="pfQty" type="number" placeholder="Adet" style="width:100px;">
      <input id="pfCost" type="number" step="0.01" placeholder="Ort. Maliyet" style="width:140px;">
      <button class="btn btn-primary btn-sm" onclick="addPosition()">Ekle</button>
      <button class="btn btn-secondary btn-sm" onclick="document.getElementById('addPositionForm').style.display='none'">Ä°ptal</button>
    </div>
  </div>

  <!-- PortfÃ¶y Ã–zeti -->
  <div class="grid-4 mb-24" id="portfolioSummary"></div>

  <!-- Pozisyonlar -->
  <div class="card mb-24">
    <div style="font-weight:700;margin-bottom:12px;">Pozisyonlar</div>
    <div class="table-wrap"><table>
      <thead><tr><th>Hisse</th><th>Adet</th><th>Ort. Maliyet</th><th>GÃ¼ncel</th><th>Piyasa DeÄŸeri</th><th>Kar/Zarar</th><th>K/Z %</th><th>AÄŸÄ±rlÄ±k</th><th></th></tr></thead>
      <tbody id="portfolioTable"></tbody>
    </table></div>
  </div>

  <!-- Risk -->
  <div class="card" id="riskCard" style="display:none;">
    <div style="font-weight:700;margin-bottom:12px;">ğŸ“Š Risk Analizi</div>
    <div class="grid-4" id="riskMetrics"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• BACKTEST â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-backtest">
  <div class="section-title mb-24"><span class="icon">ğŸ”„</span> Backtest</div>

  <div class="card mb-24">
    <div class="grid-3 gap-16" style="align-items:end;">
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">Hisse</label>
        <input id="btSymbol" placeholder="THYAO" style="width:100%;">
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">Strateji</label>
        <select id="btStrategy" style="width:100%;" onchange="updateBtParams()">
          <option value="ma_cross">MA Cross</option>
          <option value="breakout">Breakout</option>
          <option value="mean_reversion">Mean Reversion (RSI)</option>
        </select>
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">Periyot</label>
        <select id="btPeriod" style="width:100%;">
          <option value="1y">1 YÄ±l</option>
          <option value="2y" selected>2 YÄ±l</option>
          <option value="5y">5 YÄ±l</option>
        </select>
      </div>
    </div>
    <div class="grid-4 gap-16 mt-16" id="btParamsRow">
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">HÄ±zlÄ± MA</label>
        <input id="btParam1" type="number" value="20" style="width:100%;">
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">YavaÅŸ MA</label>
        <input id="btParam2" type="number" value="50" style="width:100%;">
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">Komisyon %</label>
        <input id="btCommission" type="number" value="0.1" step="0.01" style="width:100%;">
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">BaÅŸlangÄ±Ã§ â‚º</label>
        <input id="btCapital" type="number" value="100000" style="width:100%;">
      </div>
    </div>
    <div class="mt-16">
      <button class="btn btn-primary" onclick="runBacktest()">Backtest BaÅŸlat ğŸš€</button>
    </div>
  </div>

  <div id="btResults" style="display:none;">
    <div class="grid-4 mb-24" id="btMetrics"></div>
    <div class="card mb-24">
      <div style="font-weight:700;margin-bottom:12px;">Equity Curve</div>
      <div class="chart-container"><canvas id="btChart"></canvas></div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:12px;">Ä°ÅŸlem GeÃ§miÅŸi</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Tarih</th><th>Ä°ÅŸlem</th><th>Fiyat</th><th>Adet</th><th>K/Z</th></tr></thead>
        <tbody id="btTrades"></tbody>
      </table></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• ALERTS â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-alerts">
  <div class="flex-between mb-24">
    <div class="section-title"><span class="icon">ğŸ””</span> UyarÄ±lar</div>
    <button class="btn btn-primary btn-sm" onclick="if(!currentUser){showLogin();return;} document.getElementById('alertForm').style.display='block'">+ UyarÄ± Ekle</button>
  </div>

  <div class="card mb-24" id="alertForm" style="display:none;">
    <div style="font-weight:700;margin-bottom:12px;">Yeni UyarÄ±</div>
    <div class="grid-3 gap-16" style="align-items:end;">
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">Hisse</label>
        <input id="alertSymbol" placeholder="THYAO" style="width:100%;">
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">KoÅŸul</label>
        <select id="alertCondition" style="width:100%;">
          <option value="price_above">Fiyat ÃœstÃ¼nde</option>
          <option value="price_below">Fiyat AltÄ±nda</option>
          <option value="change_above">DeÄŸiÅŸim % ÃœstÃ¼nde</option>
          <option value="change_below">DeÄŸiÅŸim % AltÄ±nda</option>
        </select>
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">EÅŸik DeÄŸer</label>
        <input id="alertThreshold" type="number" step="0.01" placeholder="300" style="width:100%;">
      </div>
    </div>
    <div class="flex-center gap-8 mt-16">
      <button class="btn btn-primary btn-sm" onclick="createAlert()">OluÅŸtur</button>
      <button class="btn btn-secondary btn-sm" onclick="document.getElementById('alertForm').style.display='none'">Ä°ptal</button>
    </div>
  </div>

  <div class="card">
    <div class="table-wrap"><table>
      <thead><tr><th>Hisse</th><th>KoÅŸul</th><th>EÅŸik</th><th>Tetikleme</th><th>Durum</th><th></th></tr></thead>
      <tbody id="alertsTable"></tbody>
    </table></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• HEATMAP â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-heatmap">
  <div class="section-title mb-24"><span class="icon">ğŸ—ºï¸</span> SektÃ¶r IsÄ± HaritasÄ±</div>
  <div id="heatmapContent">
    <div class="loading"><div class="spinner"></div>YÃ¼kleniyor...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• COMPARE â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-compare">
  <div class="section-title mb-24"><span class="icon">âš–ï¸</span> Hisse KarÅŸÄ±laÅŸtÄ±rma</div>
  <div class="card mb-24">
    <div style="font-weight:700;margin-bottom:12px;">KarÅŸÄ±laÅŸtÄ±rÄ±lacak Hisseler</div>
    <div class="flex-center gap-8" style="flex-wrap:wrap;">
      <input id="cmpInput1" placeholder="THYAO" style="width:100px;text-transform:uppercase;">
      <input id="cmpInput2" placeholder="PGSUS" style="width:100px;text-transform:uppercase;">
      <input id="cmpInput3" placeholder="TAVHL" style="width:100px;text-transform:uppercase;">
      <input id="cmpInput4" placeholder="" style="width:100px;text-transform:uppercase;">
      <button class="btn btn-primary" onclick="runCompare()">KarÅŸÄ±laÅŸtÄ±r</button>
    </div>
  </div>
  <div id="compareResults" style="display:none;"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• DAILY REPORT â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-report">
  <div class="section-title mb-24"><span class="icon">ğŸ“‹</span> GÃ¼nlÃ¼k Piyasa Raporu</div>
  <div id="reportContent">
    <div class="loading"><div class="spinner"></div>Rapor hazÄ±rlanÄ±yor...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• LOGIN MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginModal" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.7);z-index:1000;display:none;align-items:center;justify-content:center;">
  <div class="card" style="width:360px;max-width:90vw;">
    <div style="font-weight:700;font-size:16px;margin-bottom:16px;" id="authTitle">GiriÅŸ Yap</div>
    <div style="margin-bottom:12px;">
      <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">KullanÄ±cÄ± AdÄ±</label>
      <input id="authUsername" placeholder="kullanici_adi" style="width:100%;">
    </div>
    <div style="margin-bottom:12px;">
      <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">Åifre</label>
      <input id="authPassword" type="password" placeholder="****" style="width:100%;">
    </div>
    <div id="authEmailRow" style="margin-bottom:12px;display:none;">
      <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">E-posta (opsiyonel)</label>
      <input id="authEmail" placeholder="email@ornek.com" style="width:100%;">
    </div>
    <div id="authError" style="color:var(--red);font-size:12px;margin-bottom:8px;display:none;"></div>
    <div class="flex-center gap-8">
      <button class="btn btn-primary" onclick="doAuth()">GiriÅŸ</button>
      <button class="btn btn-secondary" onclick="toggleAuthMode()">KayÄ±t Ol</button>
      <button class="btn btn-secondary" onclick="closeLogin()">Ä°ptal</button>
    </div>
  </div>
</div>

</div><!-- /main -->

<script>
// =============================================================================
// CONFIG
// =============================================================================
const API_BASE = window.location.origin + '/api';
let currentChart = null;
let btChartInstance = null;

// =============================================================================
// NAVIGATION
// =============================================================================
function navigate(page, params) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));

  const el = document.getElementById('page-' + page);
  if (el) { el.classList.add('active'); el.classList.add('fade-in'); }

  const nav = document.querySelector(`.nav-link[data-page="${page}"]`);
  if (nav) nav.classList.add('active');

  // Close mobile nav
  document.querySelector('.nav-links').classList.remove('show');

  // Load data
  switch(page) {
    case 'dashboard': loadDashboard(); break;
    case 'bist100': loadBist100(); break;
    case 'stock': if(params?.symbol) loadStockDetail(params.symbol); break;
    case 'commodity': if(params?.symbol) loadCommodityDetail(params.symbol); break;
    case 'screener': loadSectors('screenerSector'); break;
    case 'portfolio': loadPortfolio(); break;
    case 'watchlist': loadWatchlist(); break;
    case 'backtest': break;
    case 'alerts': loadAlerts(); break;
    case 'heatmap': loadHeatmap(); break;
    case 'compare': break;
    case 'report': loadReport(); break;
  }
}

function goToStock(symbol) {
  navigate('stock', { symbol });
}

function goToCommodity(symbol) {
  navigate('commodity', { symbol });
}

// =============================================================================
// API HELPER
// =============================================================================
async function api(path, options = {}) {
  try {
    const res = await fetch(API_BASE + path, {
      headers: { 'Content-Type': 'application/json' },
      ...options,
    });
    const text = await res.text();
    try {
      return JSON.parse(text);
    } catch(parseErr) {
      console.error('API JSON parse error:', path, text.substring(0, 200));
      return { error: 'Sunucudan geÃ§ersiz yanÄ±t geldi. LÃ¼tfen sayfayÄ± yenileyin.', status: res.status };
    }
  } catch(e) {
    console.error('API Error:', path, e);
    return { error: e.message };
  }
}

// =============================================================================
// FORMATTERS
// =============================================================================
function fmtPrice(v) { return v != null ? Number(v).toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2}) : '-'; }
function fmtPct(v) { return v != null ? (v >= 0 ? '+' : '') + Number(v).toFixed(2) + '%' : '-'; }
function fmtVolume(v) {
  if (!v) return '-';
  if (v >= 1e9) return (v/1e9).toFixed(1) + 'B';
  if (v >= 1e6) return (v/1e6).toFixed(1) + 'M';
  if (v >= 1e3) return (v/1e3).toFixed(0) + 'K';
  return v.toString();
}
function fmtMoney(v) { return 'â‚º' + fmtPrice(v); }
function changeClass(v) { return v >= 0 ? 'price-up' : 'price-down'; }
function signalBadge(s) {
  if (s === 'buy') return '<span class="badge badge-green">AL</span>';
  if (s === 'sell') return '<span class="badge badge-red">SAT</span>';
  return '<span class="badge badge-neutral">NÃ–TR</span>';
}

// =============================================================================
// SEARCH
// =============================================================================
let searchTimeout;
function onSearch(q) {
  clearTimeout(searchTimeout);
  const dd = document.getElementById('searchDropdown');
  if (!q || q.length < 1) { dd.classList.remove('show'); return; }
  searchTimeout = setTimeout(async () => {
    const data = await api('/search?q=' + encodeURIComponent(q));
    if (data.results && data.results.length > 0) {
      dd.innerHTML = data.results.map(r =>
        `<div class="search-result-item" onclick="goToStock('${r.code}');document.getElementById('searchDropdown').classList.remove('show');document.getElementById('globalSearch').value='';">
          <span class="search-result-code">${r.code}</span>
          <span class="search-result-name">${r.name}</span>
        </div>`
      ).join('');
      dd.classList.add('show');
    } else {
      dd.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:13px;">SonuÃ§ bulunamadÄ±</div>';
      dd.classList.add('show');
    }
  }, 200);
}
document.addEventListener('click', e => {
  if (!e.target.closest('.nav-search')) document.getElementById('searchDropdown').classList.remove('show');
});

// =============================================================================
// DASHBOARD
// =============================================================================
async function loadDashboard() {
  // Indices
  loadIndices();
  // Dashboard data
  const data = await api('/dashboard');
  if (data.error && !data.success) {
    document.getElementById('indicesCards').innerHTML = `
      <div class="index-card" style="grid-column:1/-1;text-align:center;">
        <div style="color:var(--yellow);margin-bottom:8px;">âš ï¸ Veri yÃ¼klenirken sorun oluÅŸtu</div>
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">${data.error}</div>
        <button class="btn btn-primary btn-sm" onclick="loadDashboard()">Tekrar Dene</button>
      </div>`;
    return;
  }

  if (data.loading || (data.allStocks && data.allStocks.length === 0)) {
    document.getElementById('indicesCards').innerHTML = `
      <div class="index-card" style="grid-column:1/-1;text-align:center;">
        <div class="spinner" style="margin:0 auto 12px;"></div>
        <div style="color:var(--yellow);margin-bottom:8px;">â³ ${data.message || 'Veriler yÃ¼kleniyor...'}</div>
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Sunucu arka planda veri Ã§ekiyor, otomatik yenilenecek...</div>
        <button class="btn btn-primary btn-sm" onclick="loadDashboard()">Åimdi Yenile</button>
      </div>`;
    // Auto-retry 10sn sonra
    setTimeout(() => loadDashboard(), 10000);
    return;
  }

  // Breadth
  const mb = data.marketBreadth || {};
  const total = (mb.advancing||0) + (mb.declining||0) + (mb.unchanged||0) || 1;
  document.getElementById('breadthAdv').style.width = (mb.advancing/total*100) + '%';
  document.getElementById('breadthUnc').style.width = (mb.unchanged/total*100) + '%';
  document.getElementById('breadthDec').style.width = (mb.declining/total*100) + '%';
  document.getElementById('advCount').textContent = mb.advancing || 0;
  document.getElementById('uncCount').textContent = mb.unchanged || 0;
  document.getElementById('decCount').textContent = mb.declining || 0;
  document.getElementById('breadthStats').textContent = `A/D OranÄ±: ${mb.advDecRatio || '-'}`;

  // Movers tables
  renderMoverTable('topGainers', data.movers?.topGainers, 'changePct');
  renderMoverTable('topLosers', data.movers?.topLosers, 'changePct');
  renderMoverTable('volumeLeaders', data.movers?.volumeLeaders, 'volume', true);
  renderMoverTable('gapStocks', data.movers?.gapStocks, 'gapPct');
}

async function loadIndices() {
  const data = await api('/indices');
  if (!data.success || !data.indices || Object.keys(data.indices).length === 0) {
    document.getElementById('indicesCards').innerHTML = `
      <div class="index-card" style="grid-column:1/-1;text-align:center;">
        <div class="spinner" style="margin:0 auto 8px;"></div>
        <div style="color:var(--text-muted);">Endeks verileri yÃ¼kleniyor... <button class="btn btn-sm btn-secondary" onclick="loadIndices()" style="margin-left:8px;">Yenile</button></div>
      </div>`;
    // Auto-retry
    setTimeout(() => loadIndices(), 8000);
    return;
  }

  const idx = data.indices;
  const currencyMap = {'GOLD':'$','SILVER':'$','USDTRY':'â‚º','EURTRY':'â‚º','GOLDTL':'â‚º','SILVERTL':'â‚º'};
  const commodityKeys = ['GOLD','SILVER','GOLDTL','SILVERTL','USDTRY','EURTRY'];
  const cards = Object.entries(idx).map(([key, val]) => {
    const cur = currencyMap[key] || '';
    const clickable = commodityKeys.includes(key);
    const clickAttr = clickable ? `onclick="goToCommodity('${key}')" style="cursor:pointer;"` : '';
    return `<div class="index-card" ${clickAttr}>
      <div class="label">${val.name}${clickable ? ' <span style="font-size:9px;opacity:0.5;">detay</span>' : ''}</div>
      <div class="value">${fmtPrice(val.value)} ${cur}</div>
      <div class="change ${changeClass(val.changePct)}">
        ${(val.changePct||0) >= 0 ? 'â–²' : 'â–¼'} ${fmtPct(val.changePct)}
      </div>
    </div>`;
  }).join('');
  document.getElementById('indicesCards').innerHTML = cards;
}

function renderMoverTable(id, stocks, metric, isVolume) {
  if (!stocks) return;
  document.getElementById(id).innerHTML = stocks.map(s => `
    <tr class="stock-row" onclick="goToStock('${s.code}')">
      <td><span class="td-clickable td-mono">${s.code}</span></td>
      <td class="td-mono">${fmtPrice(s.price)}</td>
      <td class="td-mono ${isVolume ? '' : changeClass(s[metric])}">
        ${isVolume ? fmtVolume(s[metric]) : fmtPct(s[metric])}
      </td>
    </tr>
  `).join('');
}

// =============================================================================
// BIST 100
// =============================================================================
async function loadBist100() {
  const sector = document.getElementById('sectorFilter').value;
  const sort = document.getElementById('sortFilter').value;
  const params = new URLSearchParams({ sort, order: 'desc' });
  if (sector) params.set('sector', sector);

  document.getElementById('bist100Table').innerHTML = '<tr><td colspan="9"><div class="loading"><div class="spinner"></div>YÃ¼kleniyor...</div></td></tr>';

  const data = await api('/bist100?' + params.toString());
  if (!data.success) return;

  // Loading state - veriler henÃ¼z hazÄ±r deÄŸil
  if (data.loading || !data.stocks || data.stocks.length === 0) {
    document.getElementById('bist100Table').innerHTML = `<tr><td colspan="9"><div class="loading"><div class="spinner"></div>${data.message || 'Veriler yÃ¼kleniyor... Otomatik yenilenecek.'}</div></td></tr>`;
    setTimeout(() => loadBist100(), 10000);
    return;
  }

  // SektÃ¶r filtresi doldur
  if (data.sectors) {
    const sel = document.getElementById('sectorFilter');
    if (sel.options.length <= 1) {
      data.sectors.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s.charAt(0).toUpperCase() + s.slice(1);
        sel.appendChild(opt);
      });
    }
  }

  document.getElementById('bist100Table').innerHTML = (data.stocks || []).map(s => `
    <tr class="stock-row" onclick="goToStock('${s.code}')">
      <td class="td-mono td-clickable">${s.code}</td>
      <td>${s.name}</td>
      <td class="td-mono">${fmtPrice(s.price)}</td>
      <td class="td-mono ${changeClass(s.change)}">${s.change >= 0 ? '+' : ''}${fmtPrice(s.change)}</td>
      <td class="td-mono ${changeClass(s.changePct)}">${fmtPct(s.changePct)}</td>
      <td class="td-mono">${fmtVolume(s.volume)}</td>
      <td class="td-mono">${fmtPrice(s.open)}</td>
      <td class="td-mono">${fmtPrice(s.high)}</td>
      <td class="td-mono">${fmtPrice(s.low)}</td>
    </tr>
  `).join('');
}

async function loadSectors(selectId) {
  const data = await api('/sectors');
  if (!data.success) return;
  const sel = document.getElementById(selectId);
  if (sel && sel.options.length <= 1) {
    (data.sectors||[]).forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name; opt.textContent = s.name.charAt(0).toUpperCase() + s.name.slice(1) + ` (${s.avgChange >= 0 ? '+' : ''}${s.avgChange}%)`;
      sel.appendChild(opt);
    });
  }
}

// =============================================================================
// STOCK DETAIL
// =============================================================================
async function loadStockDetail(symbol) {
  const container = document.getElementById('stockDetailContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>Hisse verisi yÃ¼kleniyor...</div>';

  // Nav'Ä± gÃ¼ncelle
  document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));

  const [stockData, eventsData] = await Promise.all([
    api('/stock/' + symbol + '?period=1y'),
    api('/stock/' + symbol + '/events')
  ]);

  if (stockData.error && !stockData.success) {
    container.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><div>Hata: ${stockData.error}</div></div>`;
    return;
  }

  if (stockData.loading && (!stockData.indicators || Object.keys(stockData.indicators).length === 0)) {
    container.innerHTML = `<div class="empty-state"><div class="spinner" style="margin:0 auto 16px;"></div><div style="color:var(--yellow);">â³ ${stockData.message || 'Veri yÃ¼kleniyor...'}</div><div style="font-size:12px;color:var(--text-muted);margin-top:8px;">Ä°lk yÃ¼kleme birkaÃ§ saniye sÃ¼rebilir.</div><button class="btn btn-primary btn-sm" onclick="loadStockDetail('${symbol}')" style="margin-top:12px;">Yenile</button></div>`;
    setTimeout(() => loadStockDetail(symbol), 5000);
    return;
  }

  const s = stockData;
  const events = eventsData?.events || {};
  const ind = s.indicators || {};
  const summary = ind.summary || {};

  container.innerHTML = `
    <!-- Header -->
    <div class="stock-header fade-in">
      <div>
        <div class="stock-name">${s.name} Â· ${s.code}</div>
        <div class="stock-price-big ${changeClass(s.changePercent)}">${fmtPrice(s.price)} â‚º</div>
        <div class="stock-change-big ${changeClass(s.changePercent)}">
          ${s.change >= 0 ? 'â–²' : 'â–¼'} ${fmtPrice(Math.abs(s.change))} (${fmtPct(s.changePercent)})
        </div>
      </div>
      <div class="flex-center gap-8" style="flex-wrap:wrap;">
        ${['1mo','3mo','6mo','1y','2y','5y'].map(p =>
          `<button class="btn btn-sm ${p === s.period ? 'btn-primary' : 'btn-secondary'}" onclick="loadStockPeriod('${s.code}','${p}')">${p}</button>`
        ).join('')}
        <span style="width:1px;height:20px;background:var(--border);margin:0 4px;"></span>
        <button class="btn btn-sm" style="background:rgba(255,197,71,0.1);color:var(--yellow);border:1px solid rgba(255,197,71,0.3);" onclick="toggleWatchlist('${s.code}').then(d => { if(d?.action==='added') this.textContent='Favorilerde'; else if(d?.action==='removed') this.textContent='Favorilere Ekle'; })">Favorilere Ekle</button>
        <button class="btn btn-sm" style="background:rgba(0,212,170,0.1);color:var(--accent);border:1px solid rgba(0,212,170,0.3);" onclick="document.getElementById('pfSymbol').value='${s.code}'; navigate('portfolio'); showAddPositionForm();">PortfÃ¶ye Ekle</button>
      </div>
    </div>

    <!-- Info Cards -->
    <div class="grid-4 mb-24 fade-in">
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">GÃ¼n AralÄ±ÄŸÄ±</div>
        <div class="td-mono" style="margin-top:4px;">${fmtPrice(s.dayLow)} - ${fmtPrice(s.dayHigh)}</div>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">Hacim</div>
        <div class="td-mono" style="margin-top:4px;">${fmtVolume(s.volume)}</div>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">52H AralÄ±k</div>
        <div class="td-mono" style="margin-top:4px;">${s.week52?.low52w ? fmtPrice(s.week52.low52w) + ' - ' + fmtPrice(s.week52.high52w) : '-'}</div>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">Piyasa DeÄŸeri</div>
        <div class="td-mono" style="margin-top:4px;">${s.marketValue ? fmtVolume(s.marketValue) : '-'}</div>
      </div>
    </div>

    <!-- Sinyal Ã–zeti -->
    <div class="card mb-24 fade-in">
      <div class="flex-between mb-8">
        <div style="font-weight:700;">Teknik Sinyal Ã–zeti</div>
        ${signalBadge(summary.overall)}
      </div>
      <div style="font-size:13px;color:var(--text-secondary);">${summary.explanation || ''}</div>
      <div class="flex-center gap-16 mt-16" style="font-size:13px;">
        <span class="price-up">ğŸŸ¢ AL: ${summary.buySignals || 0}</span>
        <span class="price-down">ğŸ”´ SAT: ${summary.sellSignals || 0}</span>
        <span style="color:var(--text-muted);">âšª NÃ¶tr: ${summary.neutralSignals || 0}</span>
      </div>
    </div>

    <!-- Price Chart -->
    <div class="chart-container mb-24 fade-in">
      <canvas id="priceChart"></canvas>
    </div>

    <!-- Indicators Grid - Collapsible -->
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:15px;">Teknik IndikatÃ¶rler</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:2000px;padding-top:12px;">
        <div class="indicator-grid">
          ${renderIndicatorDetailed(ind.rsi, 'RSI', ind.rsi?.value, 'GÃ¶receli GÃ¼Ã§ Endeksi. 0-100 arasÄ±. <30 aÅŸÄ±rÄ± satÄ±m (alÄ±ÅŸ fÄ±rsatÄ±), >70 aÅŸÄ±rÄ± alÄ±m (satÄ±ÅŸ sinyali). 50 Ã¼zeri pozitif momentum.', 0, 100)}
          ${renderIndicatorDetailed(ind.macd, 'MACD', ind.macd?.histogram, 'Hareketli Ortalama YakÄ±nsama/Iraksama. Histogram pozitif â†’ alÄ±ÅŸ, negatif â†’ satÄ±ÅŸ. MACD Ã§izgisi sinyal Ã§izgisini yukarÄ± keserse alÄ±ÅŸ sinyali.', null, null, `MACD: ${ind.macd?.macd?.toFixed(2)||'-'} | Sinyal: ${ind.macd?.signal?.toFixed(2)||'-'}`)}
          ${renderIndicatorDetailed(ind.bollinger, 'Bollinger BantlarÄ±', ind.bollinger?.bandwidth, 'Fiyat volatilitesini Ã¶lÃ§er. Fiyat alt banda yakÄ±nsa â†’ alÄ±ÅŸ, Ã¼st banda yakÄ±nsa â†’ satÄ±ÅŸ. Bantlar daralÄ±yorsa sert hareket beklenir.', null, null, `Ãœst: ${fmtPrice(ind.bollinger?.upper)} | Orta: ${fmtPrice(ind.bollinger?.middle)} | Alt: ${fmtPrice(ind.bollinger?.lower)}`)}
          ${renderIndicatorDetailed(ind.ema, 'EMA', null, 'Ãœstel Hareketli Ortalama. Fiyat > EMA20 > EMA50 â†’ gÃ¼Ã§lÃ¼ yÃ¼kseliÅŸ.', null, null, `${ind.ema?.ema5?'EMA5:'+fmtPrice(ind.ema.ema5)+' | ':''} ${ind.ema?.ema10?'EMA10:'+fmtPrice(ind.ema.ema10)+' | ':''} EMA20: ${fmtPrice(ind.ema?.ema20)} | EMA50: ${fmtPrice(ind.ema?.ema50)} ${ind.ema?.ema100 ? '| EMA100: '+fmtPrice(ind.ema.ema100) : ''} ${ind.ema?.ema200 ? '| EMA200: '+fmtPrice(ind.ema.ema200) : ''}`)}
          ${renderIndicatorDetailed(ind.stochastic, 'Stochastic', ind.stochastic?.k, 'KapanÄ±ÅŸ fiyatÄ±nÄ±n belirli dÃ¶nemdeki aralÄ±ÄŸa gÃ¶re konumu. K<20 aÅŸÄ±rÄ± satÄ±m, K>80 aÅŸÄ±rÄ± alÄ±m.', 0, 100)}
          ${renderIndicatorDetailed(ind.atr, 'ATR', ind.atr?.value, 'Ortalama GerÃ§ek AralÄ±k. Volatilite Ã¶lÃ§er. YÃ¼ksek ATR = yÃ¼ksek risk/fÄ±rsat. Stop-loss belirlemede kullanÄ±lÄ±r.', null, null, `GÃ¼nlÃ¼k ort. hareket: ${ind.atr?.pct?.toFixed(2)||'-'}%`)}
          ${renderIndicatorDetailed(ind.adx, 'ADX', ind.adx?.value, 'Ortalama YÃ¶nsel Endeks. Trend gÃ¼cÃ¼nÃ¼ Ã¶lÃ§er. >25 gÃ¼Ã§lÃ¼ trend, <20 trendsiz piyasa. +DI>-DI â†’ yÃ¼kseliÅŸ.', 0, 100, `+DI: ${ind.adx?.plusDI?.toFixed(1)||'-'} | -DI: ${ind.adx?.minusDI?.toFixed(1)||'-'}`)}
          ${renderIndicatorDetailed(ind.cci, 'CCI', ind.cci?.value, 'Emtia Kanal Endeksi. >100 aÅŸÄ±rÄ± alÄ±m, <-100 aÅŸÄ±rÄ± satÄ±m. 0 Ã§izgisi trend yÃ¶nÃ¼nÃ¼ gÃ¶sterir.', -200, 200)}
          ${renderIndicatorDetailed(ind.williamsR, 'Williams %R', ind.williamsR?.value, 'AÅŸÄ±rÄ± alÄ±m/satÄ±m gÃ¶stergesi. -80 altÄ± aÅŸÄ±rÄ± satÄ±m (alÄ±ÅŸ), -20 Ã¼stÃ¼ aÅŸÄ±rÄ± alÄ±m (satÄ±ÅŸ).', -100, 0)}
          ${renderIndicatorDetailed(ind.obv, 'OBV', null, 'Denge Hacmi. Fiyat yÃ¼kselirken hacim artÄ±yorsa â†’ gÃ¼Ã§lÃ¼ trend. Hacim dÃ¼ÅŸerken fiyat yÃ¼kseliyorsa â†’ zayÄ±f hareket.', null, null, `Hacim: ${ind.obv?.value || '-'} | Trend: ${ind.obv?.trend === 'up' ? 'â†‘ YÃ¼kseliÅŸ' : 'â†“ DÃ¼ÅŸÃ¼ÅŸ'}`)}
          ${renderIndicatorDetailed(ind.mfi, 'MFI', ind.mfi?.value, 'Para AkÄ±ÅŸ Endeksi. Hacim aÄŸÄ±rlÄ±klÄ± RSI. <20 aÅŸÄ±rÄ± satÄ±m, >80 aÅŸÄ±rÄ± alÄ±m. AkÄ±llÄ± para takibi.', 0, 100)}
          ${renderIndicatorDetailed(ind.vwap, 'VWAP', ind.vwap?.value, 'Hacim AÄŸÄ±rlÄ±klÄ± Ortalama Fiyat. Fiyat > VWAP â†’ alÄ±cÄ±lar gÃ¼Ã§lÃ¼. Fiyat < VWAP â†’ satÄ±cÄ±lar gÃ¼Ã§lÃ¼.', null, null, `VWAP: ${fmtPrice(ind.vwap?.value)} â‚º`)}
          ${renderIndicatorDetailed(ind.ichimoku, 'Ichimoku', null, 'Japon bulut sistemi. Fiyat bulutun Ã¼stÃ¼nde â†’ yÃ¼kseliÅŸ, altÄ±nda â†’ dÃ¼ÅŸÃ¼ÅŸ. Tenkan>Kijun â†’ alÄ±ÅŸ sinyali.', null, null, `Tenkan: ${fmtPrice(ind.ichimoku?.tenkan)} | Kijun: ${fmtPrice(ind.ichimoku?.kijun)} | SpanA: ${fmtPrice(ind.ichimoku?.senkouA)} | SpanB: ${fmtPrice(ind.ichimoku?.senkouB)}`)}
          ${renderIndicatorDetailed(ind.psar, 'Parabolic SAR', ind.psar?.value, 'Dur ve Geri DÃ¶n. Fiyat SAR Ã¼stÃ¼nde â†’ yÃ¼kseliÅŸ trendi. Fiyat SAR altÄ±na inerse â†’ trend dÃ¶nÃ¼ÅŸÃ¼. Stop-loss seviyesi olarak kullanÄ±lÄ±r.', null, null, `SAR: ${fmtPrice(ind.psar?.value)} â‚º | Trend: ${ind.psar?.trend === 'up' ? 'â†‘ YÃ¼kseliÅŸ' : 'â†“ DÃ¼ÅŸÃ¼ÅŸ'}`)}
          ${renderIndicatorDetailed(ind.roc, 'ROC (Momentum)', ind.roc?.value, 'DeÄŸiÅŸim OranÄ±. FiyatÄ±n belirli dÃ¶nem Ã¶ncesine gÃ¶re yÃ¼zde deÄŸiÅŸimi. >5 pozitif momentum, <-5 negatif momentum.', null, null, `${ind.roc?.period || 12} gÃ¼nlÃ¼k deÄŸiÅŸim`)}
          ${renderIndicatorDetailed(ind.aroon, 'Aroon', ind.aroon?.oscillator, 'Trend yÃ¶nÃ¼ ve gÃ¼cÃ¼. Up>70 & Down<30 â†’ gÃ¼Ã§lÃ¼ yÃ¼kseliÅŸ. Down>70 & Up<30 â†’ gÃ¼Ã§lÃ¼ dÃ¼ÅŸÃ¼ÅŸ.', -100, 100, `Up: ${ind.aroon?.up?.toFixed(0)||'-'} | Down: ${ind.aroon?.down?.toFixed(0)||'-'}`)}
          ${renderIndicatorDetailed(ind.trix, 'TRIX', ind.trix?.value, 'ÃœÃ§lÃ¼ Ã¼stel ortalama. SÄ±fÄ±r Ã¼stÃ¼ â†’ yÃ¼kseliÅŸ, sÄ±fÄ±r altÄ± â†’ dÃ¼ÅŸÃ¼ÅŸ. Trend dÃ¶nÃ¼ÅŸlerini erken yakalar.', null, null)}
          ${renderIndicatorDetailed(ind.dmi, 'DMI', ind.dmi?.adx, 'YÃ¶nsel Hareket Endeksi. ADX>25 â†’ gÃ¼Ã§lÃ¼ trend. +DI>-DI â†’ yÃ¼kseliÅŸ trendi.', 0, 100, `+DI: ${ind.dmi?.plusDI?.toFixed(1)||'-'} | -DI: ${ind.dmi?.minusDI?.toFixed(1)||'-'}`)}
        </div>
      </div>
    </div>

    <!-- AL/SAT Ã–nerisi - Collapsible -->
    <div class="card mb-24 fade-in" style="border:2px solid var(--border);">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:16px;">ğŸ“Š AL / SAT Ã–nerisi</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:2000px;">
        <div style="font-size:11px;color:var(--text-muted);margin:8px 0 12px;">âš ï¸ Bu Ã¶neriler teknik indikatÃ¶rlere dayanÄ±r, yatÄ±rÄ±m tavsiyesi deÄŸildir.</div>
        ${renderRecommendation(s.recommendation)}
      </div>
    </div>

    <!-- Pivot Points & Fibonacci & S/R - Collapsible -->
    <div class="grid-2 grid-3col mb-24" style="grid-template-columns:repeat(3,1fr);">
      <div class="card fade-in">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <div style="font-weight:700;">Pivot NoktalarÄ±</div>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
          ${renderPivotPoints(s.pivotPoints)}
        </div>
      </div>
      <div class="card fade-in">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <div style="font-weight:700;">Fibonacci Seviyeleri</div>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">${s.fibonacci?.currentZone || ''}</div>
          ${s.fibonacci?.description ? '<div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;line-height:1.5;">' + s.fibonacci.description.split(' | ').join('<br>') + '</div>' : ''}
          ${renderFibonacci(s.fibonacci)}
        </div>
      </div>
      <div class="card fade-in">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <div style="font-weight:700;">Destek / DirenÃ§</div>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
          ${renderSR(s.supportResistance)}
        </div>
      </div>
    </div>

    <!-- Fundamentals - Collapsible -->
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;">Temel Veriler</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
        ${renderFundamentals(s.fundamentals, s)}
      </div>
    </div>

    <!-- Events -->
    ${events.dividends && events.dividends.length > 0 ? `
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;">TemettÃ¼ GeÃ§miÅŸi</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
        <div class="table-wrap"><table>
          <thead><tr><th>Tarih</th><th>Tutar</th></tr></thead>
          <tbody>${events.dividends.slice(-10).reverse().map(d =>
            `<tr><td>${d.date}</td><td class="td-mono">${fmtPrice(d.amount)} â‚º</td></tr>`
          ).join('')}</tbody>
        </table></div>
      </div>
    </div>` : ''}
  `;

  // Draw chart
  drawPriceChart(s.chartData, s.code, ind);
}

function loadStockPeriod(symbol, period) {
  const container = document.getElementById('stockDetailContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>YÃ¼kleniyor...</div>';
  api('/stock/' + symbol + '?period=' + period).then(data => {
    if (!data.error) loadStockDetail(symbol);
  });
  // Simpler: just reload
  setTimeout(() => loadStockDetailWithPeriod(symbol, period), 100);
}

async function loadStockDetailWithPeriod(symbol, period) {
  const container = document.getElementById('stockDetailContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>YÃ¼kleniyor...</div>';
  // Re-fetch with different period
  const stockData = await api('/stock/' + symbol + '?period=' + period);
  if (stockData.error) {
    container.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><div>${stockData.error}</div></div>`;
    return;
  }
  // Rebuild (reuse loadStockDetail flow by temporarily overriding)
  navigate('stock', { symbol });
}

// =============================================================================
// COMMODITY DETAIL (AltÄ±n, GÃ¼mÃ¼ÅŸ, DÃ¶viz)
// =============================================================================
async function loadCommodityDetail(symbol, period) {
  period = period || '1y';
  const container = document.getElementById('commodityDetailContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>Emtia verisi yÃ¼kleniyor...</div>';

  document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));

  const s = await api('/commodity/' + symbol + '?period=' + period);

  if (s.error && !s.success) {
    container.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><div>Hata: ${s.error}</div></div>`;
    return;
  }

  if (!s.indicators || Object.keys(s.indicators).length === 0) {
    if (s.dataPoints === 0) {
      container.innerHTML = `<div class="empty-state"><div class="spinner" style="margin:0 auto 16px;"></div><div style="color:var(--yellow);">Emtia verisi yÃ¼kleniyor...</div><button class="btn btn-primary btn-sm" onclick="loadCommodityDetail('${symbol}')" style="margin-top:12px;">Yenile</button></div>`;
      return;
    }
  }

  const ind = s.indicators || {};
  const summary = ind.summary || {};
  const cur = s.currency === 'USD' ? '$' : 'â‚º';
  const nameEmoji = symbol.includes('GOLD') ? 'ğŸ¥‡' : symbol.includes('SILVER') ? 'ğŸ¥ˆ' : 'ğŸ’±';

  container.innerHTML = `
    <!-- Header -->
    <div class="stock-header fade-in">
      <div>
        <div class="stock-name">${nameEmoji} ${s.name} Â· ${s.code}</div>
        <div class="stock-price-big ${changeClass(s.changePercent)}">${fmtPrice(s.price)} ${cur}</div>
        <div class="stock-change-big ${changeClass(s.changePercent)}">
          ${s.change >= 0 ? 'â–²' : 'â–¼'} ${fmtPrice(Math.abs(s.change))} (${fmtPct(s.changePercent)})
        </div>
      </div>
      <div class="flex-center gap-8">
        ${['1mo','3mo','6mo','1y','2y','5y'].map(p =>
          `<button class="btn btn-sm ${p === period ? 'btn-primary' : 'btn-secondary'}" onclick="loadCommodityPeriod('${s.code}','${p}')">${p}</button>`
        ).join('')}
      </div>
    </div>

    <!-- Info Cards -->
    <div class="grid-4 mb-24 fade-in">
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">GÃ¼n AralÄ±ÄŸÄ±</div>
        <div class="td-mono" style="margin-top:4px;">${fmtPrice(s.dayLow)} - ${fmtPrice(s.dayHigh)} ${cur}</div>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">Hacim</div>
        <div class="td-mono" style="margin-top:4px;">${fmtVolume(s.volume)}</div>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">52H AralÄ±k</div>
        <div class="td-mono" style="margin-top:4px;">${s.week52?.low52w ? fmtPrice(s.week52.low52w) + ' - ' + fmtPrice(s.week52.high52w) + ' ' + cur : '-'}</div>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">Ã–nceki KapanÄ±ÅŸ</div>
        <div class="td-mono" style="margin-top:4px;">${fmtPrice(s.prevClose)} ${cur}</div>
      </div>
    </div>

    <!-- Sinyal Ã–zeti -->
    <div class="card mb-24 fade-in">
      <div class="flex-between mb-8">
        <div style="font-weight:700;">Teknik Sinyal Ã–zeti</div>
        ${signalBadge(summary.overall)}
      </div>
      <div style="font-size:13px;color:var(--text-secondary);">${summary.explanation || ''}</div>
      <div class="flex-center gap-16 mt-16" style="font-size:13px;">
        <span class="price-up">AL: ${summary.buySignals || 0}</span>
        <span class="price-down">SAT: ${summary.sellSignals || 0}</span>
        <span style="color:var(--text-muted);">NÃ¶tr: ${summary.neutralSignals || 0}</span>
      </div>
    </div>

    <!-- Price Chart -->
    <div class="chart-container mb-24 fade-in">
      <canvas id="priceChart"></canvas>
    </div>

    <!-- Indicators Grid -->
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:15px;">Teknik IndikatÃ¶rler</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:2000px;padding-top:12px;">
        <div class="indicator-grid">
          ${renderIndicatorDetailed(ind.rsi, 'RSI', ind.rsi?.value, 'GÃ¶receli GÃ¼Ã§ Endeksi. 0-100 arasÄ±. <30 aÅŸÄ±rÄ± satÄ±m, >70 aÅŸÄ±rÄ± alÄ±m.', 0, 100)}
          ${renderIndicatorDetailed(ind.macd, 'MACD', ind.macd?.histogram, 'Hareketli Ortalama YakÄ±nsama/Iraksama.', null, null, `MACD: ${ind.macd?.macd?.toFixed(2)||'-'} | Sinyal: ${ind.macd?.signal?.toFixed(2)||'-'}`)}
          ${renderIndicatorDetailed(ind.bollinger, 'Bollinger BantlarÄ±', ind.bollinger?.bandwidth, 'Fiyat volatilitesini Ã¶lÃ§er.', null, null, `Ãœst: ${fmtPrice(ind.bollinger?.upper)} | Orta: ${fmtPrice(ind.bollinger?.middle)} | Alt: ${fmtPrice(ind.bollinger?.lower)}`)}
          ${renderIndicatorDetailed(ind.ema, 'EMA', null, 'Ãœstel Hareketli Ortalama.', null, null, `EMA20: ${fmtPrice(ind.ema?.ema20)} | EMA50: ${fmtPrice(ind.ema?.ema50)} ${ind.ema?.ema100 ? '| EMA100: '+fmtPrice(ind.ema.ema100) : ''} ${ind.ema?.ema200 ? '| EMA200: '+fmtPrice(ind.ema.ema200) : ''}`)}
          ${renderIndicatorDetailed(ind.stochastic, 'Stochastic', ind.stochastic?.k, 'K<20 aÅŸÄ±rÄ± satÄ±m, K>80 aÅŸÄ±rÄ± alÄ±m.', 0, 100)}
          ${renderIndicatorDetailed(ind.atr, 'ATR', ind.atr?.value, 'Ortalama GerÃ§ek AralÄ±k. Volatilite Ã¶lÃ§er.', null, null, `GÃ¼nlÃ¼k ort. hareket: ${ind.atr?.pct?.toFixed(2)||'-'}%`)}
          ${renderIndicatorDetailed(ind.adx, 'ADX', ind.adx?.value, 'Trend gÃ¼cÃ¼nÃ¼ Ã¶lÃ§er. >25 gÃ¼Ã§lÃ¼ trend.', 0, 100)}
          ${renderIndicatorDetailed(ind.cci, 'CCI', ind.cci?.value, 'Emtia Kanal Endeksi.', -200, 200)}
          ${renderIndicatorDetailed(ind.williamsR, 'Williams %R', ind.williamsR?.value, 'AÅŸÄ±rÄ± alÄ±m/satÄ±m gÃ¶stergesi.', -100, 0)}
          ${renderIndicatorDetailed(ind.mfi, 'MFI', ind.mfi?.value, 'Para AkÄ±ÅŸ Endeksi.', 0, 100)}
          ${renderIndicatorDetailed(ind.ichimoku, 'Ichimoku', null, 'Japon bulut sistemi.', null, null, `Tenkan: ${fmtPrice(ind.ichimoku?.tenkan)} | Kijun: ${fmtPrice(ind.ichimoku?.kijun)}`)}
          ${renderIndicatorDetailed(ind.psar, 'Parabolic SAR', ind.psar?.value, 'Dur ve Geri DÃ¶n.', null, null, `SAR: ${fmtPrice(ind.psar?.value)} | Trend: ${ind.psar?.trend === 'up' ? 'â†‘ YÃ¼kseliÅŸ' : 'â†“ DÃ¼ÅŸÃ¼ÅŸ'}`)}
        </div>
      </div>
    </div>

    <!-- AL/SAT Ã–nerisi -->
    <div class="card mb-24 fade-in" style="border:2px solid var(--border);">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:16px;">AL / SAT Ã–nerisi</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:2000px;">
        <div style="font-size:11px;color:var(--text-muted);margin:8px 0 12px;">Bu Ã¶neriler teknik indikatÃ¶rlere dayanÄ±r, yatÄ±rÄ±m tavsiyesi deÄŸildir.</div>
        ${renderRecommendation(s.recommendation)}
      </div>
    </div>

    <!-- Pivot Points & Fibonacci & S/R -->
    <div class="grid-2 grid-3col mb-24" style="grid-template-columns:repeat(3,1fr);">
      <div class="card fade-in">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <div style="font-weight:700;">Pivot NoktalarÄ±</div>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
          ${renderPivotPoints(s.pivotPoints)}
        </div>
      </div>
      <div class="card fade-in">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <div style="font-weight:700;">Fibonacci Seviyeleri</div>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
          ${renderFibonacci(s.fibonacci)}
        </div>
      </div>
      <div class="card fade-in">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <div style="font-weight:700;">Destek / DirenÃ§</div>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
          ${renderSR(s.supportResistance)}
        </div>
      </div>
    </div>

    <!-- Fundamentals -->
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;">Temel Veriler</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
        ${renderFundamentals(s.fundamentals, s)}
      </div>
    </div>
  `;

  drawPriceChart(s.chartData, s.code, ind);
}

function loadCommodityPeriod(symbol, period) {
  navigate('commodity', { symbol });
  setTimeout(() => loadCommodityDetail(symbol, period), 50);
}


function toggleSection(header) {
  header.classList.toggle('collapsed');
  const body = header.nextElementSibling;
  body.classList.toggle('collapsed');
}

function renderIndicator(ind, nameOverride, valueOverride) {
  if (!ind) return '';
  const name = nameOverride || ind.name || '';
  const value = valueOverride !== undefined ? valueOverride : ind.value;
  return `
    <div class="indicator-card">
      <div class="ind-name">${name}</div>
      <div class="flex-between">
        <div class="ind-value">${value != null ? (typeof value === 'number' ? value.toFixed(2) : value) : '-'}</div>
        ${signalBadge(ind.signal || ind.signalType || 'neutral')}
      </div>
      <div class="ind-explanation">${ind.explanation || ''}</div>
    </div>
  `;
}

function renderIndicatorDetailed(ind, name, value, description, rangeMin, rangeMax, extraInfo) {
  if (!ind) return '';
  const sig = ind.signal || ind.signalType || 'neutral';
  const displayVal = value !== undefined && value !== null ? value : ind.value;
  const sigClass = sig === 'buy' ? 'signal-buy' : (sig === 'sell' ? 'signal-sell' : 'signal-neutral');
  const sigText = sig === 'buy' ? 'ALIÅ' : (sig === 'sell' ? 'SATIÅ' : 'NÃ–TR');
  const sigColor = sig === 'buy' ? 'var(--green)' : (sig === 'sell' ? 'var(--red)' : 'var(--text-muted)');

  let barHtml = '';
  if (rangeMin !== null && rangeMax !== null && displayVal != null) {
    const pct = Math.max(0, Math.min(100, ((displayVal - rangeMin) / (rangeMax - rangeMin)) * 100));
    const barColor = sig === 'buy' ? 'var(--green)' : (sig === 'sell' ? 'var(--red)' : 'var(--accent)');
    barHtml = `<div class="ind-bar"><div class="ind-bar-fill" style="width:${pct}%;background:${barColor};"></div></div>`;
  }

  return `
    <div class="indicator-card ${sigClass}">
      <div class="flex-between" style="margin-bottom:4px;">
        <div class="ind-name" style="margin-bottom:0;">${name}</div>
        <span style="font-size:10px;font-weight:700;color:${sigColor};padding:2px 6px;border-radius:4px;background:${sig==='buy'?'var(--green-bg)':(sig==='sell'?'var(--red-bg)':'rgba(255,255,255,0.05)')};">${sigText}</span>
      </div>
      <div class="ind-value">${displayVal != null ? (typeof displayVal === 'number' ? displayVal.toFixed(2) : displayVal) : '-'}</div>
      ${extraInfo ? '<div style="font-size:11px;color:var(--accent);margin-top:4px;font-family:var(--font-mono);">' + extraInfo + '</div>' : ''}
      ${barHtml}
      <div class="ind-detail">${description || ''}</div>
    </div>
  `;
}

function renderFundamentals(fund, stock) {
  if (!fund || Object.keys(fund).length === 0) {
    return '<div style="color:var(--text-muted);font-size:13px;">Veri hesaplanÄ±yor...</div>';
  }
  let html = '<div class="grid-4" style="gap:16px;">';
  const items = [
    {label:'Volatilite (YÄ±llÄ±k)', value: fund.volatility ? '%'+fund.volatility : '-', desc:'Fiyat dalgalanma oranÄ±'},
    {label:'Beta', value: fund.beta || '-', desc:'Piyasaya gÃ¶re risk'},
    {label:'Ort. Hacim (20G)', value: fund.avgVolume20 ? fmtVolume(fund.avgVolume20) : '-', desc:'Son 20 gÃ¼n ort.'},
    {label:'Ort. Hacim (60G)', value: fund.avgVolume60 ? fmtVolume(fund.avgVolume60) : '-', desc:'Son 60 gÃ¼n ort.'},
    {label:'Ort. GÃ¼nlÃ¼k AralÄ±k', value: fund.avgDailyRange ? fmtPrice(fund.avgDailyRange) + ' â‚º' : '-', desc: fund.avgDailyRangePct ? '%'+fund.avgDailyRangePct : ''},
    {label:'52H Tepeden UzaklÄ±k', value: fund.distFromHigh52w ? '%'+fund.distFromHigh52w : '-', desc:'52 hafta zirvesinden'},
    {label:'52H Dipten UzaklÄ±k', value: fund.distFromLow52w ? '%'+fund.distFromLow52w : '-', desc:'52 hafta dibinden'},
    {label:'Ort. Ä°ÅŸlem Hacmi', value: fund.avgTurnover ? fmtVolume(fund.avgTurnover) + ' â‚º' : '-', desc:'GÃ¼nlÃ¼k TL hacim'},
  ];
  items.forEach(item => {
    html += `<div style="padding:8px 0;">
      <div style="font-size:11px;color:var(--text-muted);">${item.label}</div>
      <div class="td-mono" style="font-size:15px;margin-top:2px;">${item.value}</div>
      ${item.desc ? '<div style="font-size:10px;color:var(--text-muted);">'+item.desc+'</div>' : ''}
    </div>`;
  });
  html += '</div>';

  // Getiriler
  if (fund.returns && Object.keys(fund.returns).length > 0) {
    html += '<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);">';
    html += '<div style="font-size:12px;font-weight:600;margin-bottom:8px;">DÃ¶nemsel Getiri</div>';
    html += '<div class="flex-center gap-16" style="flex-wrap:wrap;">';
    Object.entries(fund.returns).forEach(([period, ret]) => {
      const color = ret >= 0 ? 'var(--green)' : 'var(--red)';
      html += `<div style="text-align:center;min-width:60px;">
        <div style="font-size:11px;color:var(--text-muted);">${period}</div>
        <div style="font-family:var(--font-mono);font-size:14px;font-weight:700;color:${color};">${ret >= 0 ? '+' : ''}%${ret}</div>
      </div>`;
    });
    html += '</div></div>';
  }
  return html;
}

function renderFibonacci(fib) {
  if (!fib || !fib.levels || Object.keys(fib.levels).length === 0) return '<div style="color:var(--text-muted);font-size:13px;">Veri yok</div>';
  const hi = fib.high || 0;
  const lo = fib.low || 0;
  const range = hi - lo;
  return Object.entries(fib.levels).map(([key, val]) => {
    const pct = range > 0 ? ((val - lo) / range * 100) : 50;
    const isNearSupport = fib.nearestSupport && Math.abs(val - fib.nearestSupport.price) < 0.01;
    const isNearResistance = fib.nearestResistance && Math.abs(val - fib.nearestResistance.price) < 0.01;
    const labelColor = isNearSupport ? 'var(--green)' : (isNearResistance ? 'var(--red)' : 'var(--text-muted)');
    const valColor = isNearSupport ? 'var(--green)' : (isNearResistance ? 'var(--red)' : 'inherit');
    return `<div class="fib-bar">
      <div class="fib-label" style="color:${labelColor};">${key}</div>
      <div class="fib-line">
        <div style="position:absolute;left:${pct}%;top:-3px;width:8px;height:8px;background:var(--accent);border-radius:50%;transform:translateX(-50%);"></div>
      </div>
      <div class="fib-value" style="color:${valColor};">${fmtPrice(val)} â‚º</div>
    </div>`;
  }).join('');
}

function renderSR(sr) {
  if (!sr) return '<div style="color:var(--text-muted);font-size:13px;">Veri yok</div>';
  let html = '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">' + (sr.explanation || '') + '</div>';

  if (sr.resistances && sr.resistances.length) {
    html += '<div style="margin-bottom:8px;font-size:11px;color:var(--text-muted);">DÄ°RENÃ‡</div>';
    sr.resistances.forEach(r => {
      html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <span style="width:8px;height:8px;background:var(--red);border-radius:50%;"></span>
        <span class="td-mono">${fmtPrice(r)}</span>
      </div>`;
    });
  }

  html += `<div style="display:flex;align-items:center;gap:8px;margin:12px 0;padding:8px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);">
    <span style="width:8px;height:8px;background:var(--accent);border-radius:50%;"></span>
    <span class="td-mono" style="color:var(--accent);font-weight:700;">GÃ¼ncel: ${fmtPrice(sr.current)}</span>
  </div>`;

  if (sr.supports && sr.supports.length) {
    html += '<div style="margin-bottom:8px;font-size:11px;color:var(--text-muted);">DESTEK</div>';
    sr.supports.forEach(s => {
      html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <span style="width:8px;height:8px;background:var(--green);border-radius:50%;"></span>
        <span class="td-mono">${fmtPrice(s)}</span>
      </div>`;
    });
  }
  return html;
}

function renderPivotPoints(pp) {
  if (!pp || !pp.classic || !pp.classic.pp) return '<div style="color:var(--text-muted);font-size:13px;">Veri yok</div>';
  const cur = pp.current || 0;
  function pivotRow(label, val, type) {
    const color = type === 'r' ? 'var(--red)' : type === 's' ? 'var(--green)' : 'var(--accent)';
    const dist = cur ? (((val - cur) / cur) * 100).toFixed(2) : 0;
    const distLabel = val > cur ? `+${dist}%` : `${dist}%`;
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid var(--border);">
      <span style="color:${color};font-weight:600;font-size:12px;min-width:32px;">${label}</span>
      <span class="td-mono" style="font-size:13px;">${fmtPrice(val)}</span>
      <span style="font-size:11px;color:var(--text-muted);">${distLabel}</span>
    </div>`;
  }
  let html = '<div style="display:flex;gap:4px;margin-bottom:10px;">';
  html += '<button onclick="switchPivot(\'classic\')" class="pivot-tab active" id="pt-classic" style="flex:1;padding:4px 8px;font-size:11px;border:1px solid var(--border);border-radius:6px;background:var(--accent);color:#fff;cursor:pointer;">Klasik</button>';
  html += '<button onclick="switchPivot(\'camarilla\')" class="pivot-tab" id="pt-camarilla" style="flex:1;padding:4px 8px;font-size:11px;border:1px solid var(--border);border-radius:6px;background:var(--card-bg);color:var(--text-secondary);cursor:pointer;">Camarilla</button>';
  html += '<button onclick="switchPivot(\'woodie\')" class="pivot-tab" id="pt-woodie" style="flex:1;padding:4px 8px;font-size:11px;border:1px solid var(--border);border-radius:6px;background:var(--card-bg);color:var(--text-secondary);cursor:pointer;">Woodie</button>';
  html += '</div>';
  
  const c = pp.classic;
  html += '<div id="pivot-classic">';
  if(c.r3) html += pivotRow('R3', c.r3, 'r');
  if(c.r2) html += pivotRow('R2', c.r2, 'r');
  if(c.r1) html += pivotRow('R1', c.r1, 'r');
  html += pivotRow('PP', c.pp, 'p');
  if(c.s1) html += pivotRow('S1', c.s1, 's');
  if(c.s2) html += pivotRow('S2', c.s2, 's');
  if(c.s3) html += pivotRow('S3', c.s3, 's');
  html += '</div>';

  const cam = pp.camarilla;
  html += '<div id="pivot-camarilla" style="display:none;">';
  if(cam.r4) html += pivotRow('R4', cam.r4, 'r');
  if(cam.r3) html += pivotRow('R3', cam.r3, 'r');
  if(cam.r2) html += pivotRow('R2', cam.r2, 'r');
  if(cam.r1) html += pivotRow('R1', cam.r1, 'r');
  html += pivotRow('PP', cam.pp, 'p');
  if(cam.s1) html += pivotRow('S1', cam.s1, 's');
  if(cam.s2) html += pivotRow('S2', cam.s2, 's');
  if(cam.s3) html += pivotRow('S3', cam.s3, 's');
  if(cam.s4) html += pivotRow('S4', cam.s4, 's');
  html += '</div>';

  const w = pp.woodie;
  html += '<div id="pivot-woodie" style="display:none;">';
  if(w.r2) html += pivotRow('R2', w.r2, 'r');
  if(w.r1) html += pivotRow('R1', w.r1, 'r');
  html += pivotRow('PP', w.pp, 'p');
  if(w.s1) html += pivotRow('S1', w.s1, 's');
  if(w.s2) html += pivotRow('S2', w.s2, 's');
  html += '</div>';
  return html;
}
function switchPivot(type) {
  ['classic','camarilla','woodie'].forEach(t => {
    const el = document.getElementById('pivot-' + t);
    const btn = document.getElementById('pt-' + t);
    if (el) el.style.display = t === type ? 'block' : 'none';
    if (btn) { btn.style.background = t === type ? 'var(--accent)' : 'var(--card-bg)'; btn.style.color = t === type ? '#fff' : 'var(--text-secondary)'; }
  });
}

function renderRecommendation(rec) {
  if (!rec) return '<div style="color:var(--text-muted);font-size:13px;">Veri yok</div>';
  const actionColor = (a) => {
    if (!a) return 'var(--text-muted)';
    if (a === 'AL') return 'var(--green)';
    if (a === 'SAT') return 'var(--red)';
    if (a === 'TUTUN/AL') return '#4CAF50';
    if (a === 'TUTUN/SAT') return '#FF9800';
    return 'var(--text-secondary)';
  };
  const actionIcon = (a) => {
    if (!a) return 'â¸ï¸';
    if (a === 'AL') return 'ğŸŸ¢';
    if (a === 'SAT') return 'ğŸ”´';
    if (a === 'TUTUN/AL') return 'ğŸŸ¡';
    if (a === 'TUTUN/SAT') return 'ğŸŸ ';
    return 'âšª';
  };
  const actionDesc = (a) => {
    if (a === 'AL') return 'Teknik gÃ¶stergeler gÃ¼Ã§lÃ¼ alÄ±ÅŸ sinyali veriyor';
    if (a === 'SAT') return 'Teknik gÃ¶stergeler satÄ±ÅŸ yÃ¶nÃ¼nde';
    if (a === 'TUTUN/AL') return 'Hafif pozitif, alÄ±ÅŸ yÃ¶nÃ¼nde eÄŸilim var';
    if (a === 'TUTUN/SAT') return 'Hafif negatif, dikkatli olunmalÄ±';
    return 'Belirgin bir yÃ¶n sinyali yok';
  };
  let html = '';
  [['weekly','HaftalÄ±k'],['monthly','AylÄ±k'],['yearly','YÄ±llÄ±k']].forEach(([key, label]) => {
    const r = rec[key];
    if (!r) return;
    const conf = r.confidence || 0;
    const kl = r.keyLevels || {};

    html += `<div style="padding:14px;border:1px solid var(--border);border-radius:10px;margin-bottom:12px;background:var(--card-bg);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <span style="font-weight:700;font-size:14px;">${label}</span>
        <span style="font-size:20px;font-weight:800;color:${actionColor(r.action)};">${actionIcon(r.action)} ${r.action || 'NOTR'}</span>
      </div>
      <div style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;">${actionDesc(r.action)}</div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
        <div style="flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden;">
          <div style="width:${conf}%;height:100%;background:${actionColor(r.action)};border-radius:4px;"></div>
        </div>
        <span style="font-size:12px;font-weight:600;color:var(--text-muted);">%${conf.toFixed ? conf.toFixed(0) : conf}</span>
      </div>`;

    // Strateji kutusu
    if (r.strategy) {
      html += `<div style="background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);border-radius:8px;padding:10px;margin-bottom:10px;">
        <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:4px;">STRATEJÄ°</div>
        <div style="font-size:12px;color:var(--text-primary);line-height:1.6;">${r.strategy.split(' | ').map(s => 'â†’ ' + s).join('<br>')}</div>
      </div>`;
    }

    // Onemli seviyeler
    if (kl.supports?.length || kl.resistances?.length) {
      html += '<div style="display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap;">';
      if (kl.supports?.length) {
        html += '<div style="flex:1;min-width:120px;padding:8px;border-radius:6px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);">';
        html += '<div style="font-size:10px;font-weight:700;color:var(--green);margin-bottom:4px;">DESTEK</div>';
        kl.supports.forEach(s => { html += '<div style="font-family:var(--font-mono);font-size:12px;color:var(--green);">' + fmtPrice(s) + ' â‚º</div>'; });
        html += '</div>';
      }
      if (kl.resistances?.length) {
        html += '<div style="flex:1;min-width:120px;padding:8px;border-radius:6px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);">';
        html += '<div style="font-size:10px;font-weight:700;color:var(--red);margin-bottom:4px;">DÄ°RENÃ‡</div>';
        kl.resistances.forEach(r2 => { html += '<div style="font-family:var(--font-mono);font-size:12px;color:var(--red);">' + fmtPrice(r2) + ' â‚º</div>'; });
        html += '</div>';
      }
      html += '</div>';
    }

    // Nedenler
    if (r.reasons && r.reasons.length) {
      html += '<div style="font-size:11px;color:var(--text-secondary);line-height:1.7;border-top:1px solid var(--border);padding-top:8px;">';
      r.reasons.forEach(reason => {
        let icon = 'â€¢';
        if (reason.toLowerCase().includes('alis') || reason.toLowerCase().includes('uzerinde') || reason.toLowerCase().includes('yukari') || reason.toLowerCase().includes('pozitif')) icon = '<span style="color:var(--green);">â–²</span>';
        else if (reason.toLowerCase().includes('satis') || reason.toLowerCase().includes('altinda') || reason.toLowerCase().includes('asagi') || reason.toLowerCase().includes('negatif') || reason.toLowerCase().includes('dusus')) icon = '<span style="color:var(--red);">â–¼</span>';
        html += icon + ' ' + reason + '<br>';
      });
      html += '</div>';
    }

    html += '</div>';
  });
  return html;
}

// =============================================================================
// CHARTS
// =============================================================================
// Chart overlay indicator system
let _chartData = null;
let _chartSymbol = null;
let _chartIndicators = null;
let _activeOverlays = new Set(['ema20', 'ema50']); // default aktif

const OVERLAY_CONFIG = {
  ema5:   { label: 'EMA 5',   color: '#ff6b6b', dash: [], group: 'ema' },
  ema10:  { label: 'EMA 10',  color: '#ffa06b', dash: [], group: 'ema' },
  ema20:  { label: 'EMA 20',  color: '#ffc547', dash: [], group: 'ema' },
  ema50:  { label: 'EMA 50',  color: '#a78bfa', dash: [], group: 'ema' },
  ema100: { label: 'EMA 100', color: '#4da6ff', dash: [], group: 'ema' },
  ema200: { label: 'EMA 200', color: '#ff4da6', dash: [], group: 'ema' },
  bbands: { label: 'Bollinger', color: '#ff4d6a', dash: [4,4], group: 'bb' },
  ichimoku: { label: 'Ichimoku', color: '#26a69a', dash: [], group: 'ich' },
  vwap:   { label: 'VWAP',    color: '#e040fb', dash: [2,2], group: 'vwap' },
  psar:   { label: 'P.SAR',   color: '#ffeb3b', dash: [], group: 'psar' },
};

function toggleOverlay(key) {
  if (_activeOverlays.has(key)) _activeOverlays.delete(key);
  else _activeOverlays.add(key);
  rebuildChart();
}

function renderOverlayButtons() {
  return Object.entries(OVERLAY_CONFIG).map(([key, cfg]) => {
    const active = _activeOverlays.has(key);
    return `<button class="btn btn-sm" onclick="toggleOverlay('${key}')" style="font-size:10px;padding:3px 8px;margin:2px;border:1px solid ${cfg.color}${active?'':'44'};background:${active ? cfg.color+'22' : 'transparent'};color:${active ? cfg.color : 'var(--text-muted)'};transition:all .2s;">${cfg.label}</button>`;
  }).join('');
}

function rebuildChart() {
  if (!_chartData || !_chartSymbol) return;
  drawPriceChart(_chartData, _chartSymbol, _chartIndicators, true);
}

function drawPriceChart(chartData, symbol, indicators, isRebuild) {
  if (!chartData || !chartData.dates) return;
  _chartData = chartData;
  _chartSymbol = symbol;
  _chartIndicators = indicators;

  if (currentChart) { currentChart.destroy(); currentChart = null; }

  const ctx = document.getElementById('priceChart');
  if (!ctx) return;

  // Render toggle buttons
  if (!isRebuild) {
    let btnContainer = document.getElementById('chartOverlayBtns');
    if (!btnContainer) {
      btnContainer = document.createElement('div');
      btnContainer.id = 'chartOverlayBtns';
      btnContainer.style.cssText = 'display:flex;flex-wrap:wrap;gap:2px;margin-bottom:8px;padding:8px;background:var(--bg-card);border-radius:8px;border:1px solid var(--border);';
      ctx.parentElement.insertBefore(btnContainer, ctx);
    }
    btnContainer.innerHTML = '<span style="font-size:10px;color:var(--text-muted);margin-right:6px;line-height:28px;">Grafik:</span>' + renderOverlayButtons();
  } else {
    const btnContainer = document.getElementById('chartOverlayBtns');
    if (btnContainer) btnContainer.innerHTML = '<span style="font-size:10px;color:var(--text-muted);margin-right:6px;line-height:28px;">Grafik:</span>' + renderOverlayButtons();
  }

  const datasets = [{
    label: symbol + ' KapanÄ±ÅŸ',
    data: chartData.prices,
    borderColor: '#00d4aa',
    backgroundColor: 'rgba(0,212,170,0.05)',
    fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2,
  }];

  const padData = (arr, targetLen) => {
    const padLen = targetLen - arr.length;
    return padLen > 0 ? [...new Array(padLen).fill(null), ...arr] : arr;
  };

  // EMA overlays
  if (indicators?.emaHistory) {
    for (const p of [5, 10, 20, 50, 100, 200]) {
      const key = `ema${p}`;
      if (!_activeOverlays.has(key)) continue;
      const cfg = OVERLAY_CONFIG[key];
      const data = indicators.emaHistory.map(e => e[key] || null);
      if (data.some(v => v)) {
        datasets.push({
          label: cfg.label, data, borderColor: cfg.color,
          borderWidth: 1.5, pointRadius: 0, tension: 0.3, fill: false,
        });
      }
    }
  }

  // Bollinger bands
  if (_activeOverlays.has('bbands') && indicators?.bollingerHistory?.length > 0) {
    const bh = indicators.bollingerHistory;
    datasets.push({
      label: 'BB Ãœst', data: padData(bh.map(b => b.upper), chartData.dates.length),
      borderColor: 'rgba(255,77,106,0.5)', borderWidth: 1, borderDash: [4,4], pointRadius: 0, fill: false,
    });
    datasets.push({
      label: 'BB Orta', data: padData(bh.map(b => b.middle), chartData.dates.length),
      borderColor: 'rgba(255,77,106,0.25)', borderWidth: 1, borderDash: [2,4], pointRadius: 0, fill: false,
    });
    datasets.push({
      label: 'BB Alt', data: padData(bh.map(b => b.lower), chartData.dates.length),
      borderColor: 'rgba(77,166,255,0.5)', borderWidth: 1, borderDash: [4,4], pointRadius: 0, fill: false,
    });
  }

  // Ichimoku cloud
  if (_activeOverlays.has('ichimoku') && indicators?.ichimoku) {
    const ich = indicators.ichimoku;
    if (ich.tenkan) {
      const tenkanLine = chartData.prices.map(() => ich.tenkan);
      const kijunLine = chartData.prices.map(() => ich.kijun);
      datasets.push({
        label: 'Tenkan', data: tenkanLine,
        borderColor: '#26a69a', borderWidth: 1, pointRadius: 0, fill: false,
      });
      datasets.push({
        label: 'Kijun', data: kijunLine,
        borderColor: '#ef5350', borderWidth: 1, pointRadius: 0, fill: false,
      });
    }
  }

  // VWAP
  if (_activeOverlays.has('vwap') && indicators?.vwap?.value) {
    datasets.push({
      label: 'VWAP', data: chartData.prices.map(() => indicators.vwap.value),
      borderColor: '#e040fb', borderWidth: 1, borderDash: [2,2], pointRadius: 0, fill: false,
    });
  }

  // Parabolic SAR
  if (_activeOverlays.has('psar') && indicators?.psar?.value) {
    datasets.push({
      label: 'P.SAR', data: chartData.prices.map(() => indicators.psar.value),
      borderColor: '#ffeb3b', borderWidth: 1.5, borderDash: [1,3], pointRadius: 0, fill: false,
    });
  }

  currentChart = new Chart(ctx, {
    type: 'line',
    data: { labels: chartData.dates, datasets },
    options: {
      responsive: true, maintainAspectRatio: false,
      interaction: { mode: 'index', intersect: false },
      plugins: {
        legend: {
          display: true, position: 'top',
          labels: { color: '#8896aa', font: { size: 10 }, boxWidth: 12, padding: 8, usePointStyle: true },
          onClick: (e, item, legend) => {
            const idx = item.datasetIndex;
            const meta = legend.chart.getDatasetMeta(idx);
            meta.hidden = !meta.hidden;
            legend.chart.update();
          }
        },
        tooltip: {
          backgroundColor: '#1a2234', borderColor: '#2a3548', borderWidth: 1,
          titleColor: '#e8ecf4', bodyColor: '#8896aa',
          titleFont: { family: 'JetBrains Mono' }, bodyFont: { family: 'JetBrains Mono', size: 11 },
        }
      },
      scales: {
        x: { grid: { color: 'rgba(42,53,72,0.3)' }, ticks: { color: '#5a6a80', maxTicksLimit: 12, font: { size: 10 } } },
        y: { grid: { color: 'rgba(42,53,72,0.3)' }, ticks: { color: '#5a6a80', font: { family: 'JetBrains Mono', size: 11 } } },
      }
    }
  });
}

// =============================================================================
// SCREENER
// =============================================================================
function addScreenerCondition() {
  const row = document.createElement('div');
  row.className = 'condition-row';
  row.innerHTML = `
    <select class="sc-indicator" onchange="updateScreenerHint(this)">
      <option value="rsi">RSI (0-100)</option>
      <option value="volume_ratio">Hacim OranÄ± (x)</option>
      <option value="atr_pct">ATR % (volatilite)</option>
      <option value="ema_cross">EMA Cross (1/-1)</option>
      <option value="breakout">Breakout (0/1)</option>
      <option value="macd_signal">MACD Sinyal (1/-1)</option>
      <option value="price_above_ema20">Fiyat > EMA20 (0/1)</option>
      <option value="price_above_ema50">Fiyat > EMA50 (0/1)</option>
      <option value="changePct">GÃ¼nlÃ¼k DeÄŸiÅŸim %</option>
      <option value="price">Fiyat (TL)</option>
      <option value="volume">Hacim (lot)</option>
      <option value="gapPct">Gap %</option>
    </select>
    <select class="sc-operator">
      <option value=">">&gt;</option>
      <option value="<">&lt;</option>
      <option value=">=">&ge;</option>
      <option value="<=">&le;</option>
      <option value="==">=</option>
    </select>
    <input class="sc-value" placeholder="DeÄŸer" style="width:100px;">
    <button class="remove-condition" onclick="this.parentElement.remove()">âœ•</button>
  `;
  document.getElementById('screenerConditions').appendChild(row);
}

function applyScreenerTemplate(tpl) {
  const container = document.getElementById('screenerConditions');
  container.innerHTML = '';
  const templates = {
    'oversold': [{indicator:'rsi',operator:'<',value:'30'}],
    'overbought': [{indicator:'rsi',operator:'>',value:'70'}],
    'highvolume': [{indicator:'volume_ratio',operator:'>',value:'2'}],
    'breakout': [{indicator:'breakout',operator:'>',value:'0'},{indicator:'volume_ratio',operator:'>',value:'1.5'}],
  };
  const conditions = templates[tpl] || [];
  conditions.forEach(c => {
    addScreenerCondition();
    const rows = container.querySelectorAll('.condition-row');
    const lastRow = rows[rows.length - 1];
    lastRow.querySelector('.sc-indicator').value = c.indicator;
    lastRow.querySelector('.sc-operator').value = c.operator;
    lastRow.querySelector('.sc-value').value = c.value;
  });
  if (conditions.length === 0) addScreenerCondition();
}

function updateScreenerHint(select) {
  // Placeholder hint based on selected indicator
  const hints = {
    'rsi': 'Ã–rn: 30', 'volume_ratio': 'Ã–rn: 2', 'atr_pct': 'Ã–rn: 3',
    'ema_cross': '1 veya -1', 'breakout': '0 veya 1', 'macd_signal': '1 veya -1',
    'price_above_ema20': '0 veya 1', 'price_above_ema50': '0 veya 1',
    'changePct': 'Ã–rn: 5', 'price': 'Ã–rn: 100', 'volume': 'Ã–rn: 1000000', 'gapPct': 'Ã–rn: 2'
  };
  const input = select.parentElement.querySelector('.sc-value');
  if (input) input.placeholder = hints[select.value] || 'DeÄŸer';
}

async function runScreener() {
  const rows = document.querySelectorAll('.condition-row');
  const conditions = [];
  rows.forEach(row => {
    const indicator = row.querySelector('.sc-indicator')?.value;
    const operator = row.querySelector('.sc-operator')?.value;
    const value = row.querySelector('.sc-value')?.value;
    if (indicator && operator && value) {
      let parsedVal = value;
      if (!isNaN(value)) parsedVal = parseFloat(value);
      else if (value === 'true') parsedVal = true;
      else if (value === 'false') parsedVal = false;
      conditions.push({ indicator, operator, value: parsedVal });
    }
  });

  const sector = document.getElementById('screenerSector').value;

  const resultsDiv = document.getElementById('screenerResults');
  resultsDiv.style.display = 'block';
  document.getElementById('screenerTable').innerHTML = '<tr><td colspan="7"><div class="loading"><div class="spinner"></div>TaranÄ±yor...</div></td></tr>';

  const data = await api('/screener', {
    method: 'POST',
    body: JSON.stringify({ conditions, sector: sector || undefined }),
  });

  if (data.error) {
    document.getElementById('screenerTable').innerHTML = `<tr><td colspan="7" style="color:var(--red);">${data.error}</td></tr>`;
    return;
  }

  document.getElementById('screenerCount').textContent = `${data.totalMatches} / ${data.scannedStocks} hisse eÅŸleÅŸti`;

  document.getElementById('screenerTable').innerHTML = (data.matches || []).map(m => `
    <tr class="stock-row" onclick="goToStock('${m.code}')">
      <td class="td-mono td-clickable">${m.code}</td>
      <td>${m.name}</td>
      <td class="td-mono">${fmtPrice(m.price)}</td>
      <td class="td-mono ${changeClass(m.changePct)}">${fmtPct(m.changePct)}</td>
      <td class="td-mono">${m.metrics?.rsi ?? '-'}</td>
      <td class="td-mono">${m.metrics?.volume_ratio ?? '-'}</td>
      <td>${m.metrics?.ema_cross === 'bullish' ? '<span class="badge badge-green">Bullish</span>' : '<span class="badge badge-red">Bearish</span>'}</td>
    </tr>
  `).join('') || '<tr><td colspan="7" class="empty-state">EÅŸleÅŸen hisse bulunamadÄ±</td></tr>';
}

// =============================================================================
// PORTFOLIO
// =============================================================================
function showAddPositionForm() {
  if (!currentUser) { showLogin(); return; }
  document.getElementById('addPositionForm').style.display = 'block';
}

async function addPosition() {
  if (!currentUser) { showLogin(); return; }
  const symbol = document.getElementById('pfSymbol').value.toUpperCase();
  const quantity = parseFloat(document.getElementById('pfQty').value);
  const avgCost = parseFloat(document.getElementById('pfCost').value);

  if (!symbol || !quantity || !avgCost) { alert('TÃ¼m alanlarÄ± doldurun'); return; }

  await api('/portfolio', {
    method: 'POST',
    body: JSON.stringify({ userId: currentUser.userId, symbol, quantity, avgCost }),
  });

  document.getElementById('addPositionForm').style.display = 'none';
  document.getElementById('pfSymbol').value = '';
  document.getElementById('pfQty').value = '';
  document.getElementById('pfCost').value = '';
  loadPortfolio();
}

async function removePosition(symbol, posId) {
  if (!confirm(`${symbol} portfÃ¶yden Ã§Ä±karÄ±lsÄ±n mÄ±?`)) return;
  await api('/portfolio', {
    method: 'DELETE',
    body: JSON.stringify({ userId: currentUser?.userId, symbol, id: posId }),
  });
  loadPortfolio();
}

async function loadPortfolio() {
  if (!currentUser) {
    document.getElementById('portfolioSummary').innerHTML = '';
    document.getElementById('portfolioTable').innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="icon">ğŸ”’</div><div>PortfÃ¶y kaydetmek iÃ§in giriÅŸ yapÄ±n</div><button class="btn btn-primary btn-sm" onclick="showLogin()" style="margin-top:12px;">GiriÅŸ Yap</button></div></td></tr>`;
    return;
  }
  const data = await api('/portfolio?userId=' + currentUser.userId);
  if (!data.success) return;

  const s = data.summary || {};

  document.getElementById('portfolioSummary').innerHTML = `
    <div class="card" style="text-align:center;">
      <div style="font-size:11px;color:var(--text-muted);">Toplam DeÄŸer</div>
      <div class="td-mono" style="font-size:20px;font-weight:700;margin-top:4px;">${fmtMoney(s.totalValue)}</div>
    </div>
    <div class="card" style="text-align:center;">
      <div style="font-size:11px;color:var(--text-muted);">Toplam Maliyet</div>
      <div class="td-mono" style="font-size:20px;font-weight:700;margin-top:4px;">${fmtMoney(s.totalCost)}</div>
    </div>
    <div class="card" style="text-align:center;">
      <div style="font-size:11px;color:var(--text-muted);">Kar/Zarar</div>
      <div class="td-mono ${changeClass(s.totalPnL)}" style="font-size:20px;font-weight:700;margin-top:4px;">${fmtMoney(s.totalPnL)} (${fmtPct(s.totalPnLPct)})</div>
    </div>
    <div class="card" style="text-align:center;">
      <div style="font-size:11px;color:var(--text-muted);">GÃ¼nlÃ¼k DeÄŸiÅŸim</div>
      <div class="td-mono ${changeClass(s.dailyPnL)}" style="font-size:20px;font-weight:700;margin-top:4px;">${fmtMoney(s.dailyPnL)}</div>
    </div>
  `;

  const positions = data.positions || [];
  if (positions.length === 0) {
    document.getElementById('portfolioTable').innerHTML = '<tr><td colspan="9" class="empty-state">PortfÃ¶y boÅŸ. Pozisyon ekleyin.</td></tr>';
    document.getElementById('riskCard').style.display = 'none';
    return;
  }

  document.getElementById('portfolioTable').innerHTML = positions.map(p => `
    <tr>
      <td class="td-mono td-clickable" onclick="goToStock('${p.symbol}')">${p.symbol}</td>
      <td class="td-mono">${p.quantity}</td>
      <td class="td-mono">${fmtPrice(p.avgCost)}</td>
      <td class="td-mono">${fmtPrice(p.currentPrice)}</td>
      <td class="td-mono">${fmtMoney(p.marketValue)}</td>
      <td class="td-mono ${p.unrealizedPnL >= 0 ? 'pnl-positive' : 'pnl-negative'}">${fmtMoney(p.unrealizedPnL)}</td>
      <td class="td-mono ${p.unrealizedPnLPct >= 0 ? 'pnl-positive' : 'pnl-negative'}">${fmtPct(p.unrealizedPnLPct)}</td>
      <td class="td-mono">${p.weight}%</td>
      <td><button class="btn btn-sm" style="background:var(--red-bg);color:var(--red);border:none;padding:4px 8px;font-size:11px;" onclick="removePosition('${p.symbol}', ${p.id})">Sil</button></td>
    </tr>
  `).join('');

  loadPortfolioRisk();
}

// =============================================================================
// WATCHLIST (FAVORÄ°LER)
// =============================================================================
async function loadWatchlist() {
  const table = document.getElementById('watchlistTable');
  const loginMsg = document.getElementById('watchlistLoginMsg');

  if (!currentUser) {
    loginMsg.style.display = 'block';
    table.innerHTML = '';
    return;
  }
  loginMsg.style.display = 'none';

  table.innerHTML = '<tr><td colspan="7"><div class="loading"><div class="spinner"></div>YÃ¼kleniyor...</div></td></tr>';

  const data = await api('/watchlist?userId=' + currentUser.userId);
  if (!data.success) return;

  const stocks = data.watchlist || [];
  if (stocks.length === 0) {
    table.innerHTML = '<tr><td colspan="7" class="empty-state">Favori listeniz boÅŸ. YukarÄ±dan hisse ekleyin.</td></tr>';
    return;
  }

  table.innerHTML = stocks.map(s => `
    <tr class="stock-row" onclick="goToStock('${s.code}')">
      <td class="td-mono td-clickable">${s.code}</td>
      <td>${s.name}</td>
      <td class="td-mono">${fmtPrice(s.price)}</td>
      <td class="td-mono ${changeClass(s.change)}">${fmtPrice(s.change)}</td>
      <td class="td-mono ${changeClass(s.changePct)}">${fmtPct(s.changePct)}</td>
      <td class="td-mono">${fmtVolume(s.volume)}</td>
      <td><button class="btn btn-sm" style="background:var(--red-bg);color:var(--red);border:none;padding:4px 8px;font-size:11px;" onclick="event.stopPropagation(); removeFromWatchlist('${s.code}')">KaldÄ±r</button></td>
    </tr>
  `).join('');
}

async function addToWatchlist(symbolOverride) {
  if (!currentUser) { showLogin(); return; }
  const sym = symbolOverride || document.getElementById('wlAddSymbol')?.value?.toUpperCase();
  if (!sym) { alert('Hisse kodu girin'); return; }

  const data = await api('/watchlist', {
    method: 'POST',
    body: JSON.stringify({ userId: currentUser.userId, symbol: sym, action: 'add' }),
  });

  if (data.success) {
    const input = document.getElementById('wlAddSymbol');
    if (input) input.value = '';
    loadWatchlist();
  }
}

async function removeFromWatchlist(symbol) {
  if (!currentUser) return;
  await api('/watchlist', {
    method: 'POST',
    body: JSON.stringify({ userId: currentUser.userId, symbol, action: 'remove' }),
  });
  loadWatchlist();
}

async function toggleWatchlist(symbol) {
  if (!currentUser) { showLogin(); return; }
  const data = await api('/watchlist', {
    method: 'POST',
    body: JSON.stringify({ userId: currentUser.userId, symbol, action: 'toggle' }),
  });
  return data;
}

async function loadPortfolioRisk() {
  const data = await api('/portfolio/risk');
  if (!data.success || !data.risk) return;
  const r = data.risk;
  if (r.message) return;

  document.getElementById('riskCard').style.display = 'block';
  document.getElementById('riskMetrics').innerHTML = `
    <div class="bt-metric"><div class="bt-val">${r.volatility}%</div><div class="bt-label">YÄ±llÄ±k Volatilite</div></div>
    <div class="bt-metric"><div class="bt-val ${changeClass(r.maxDrawdown)}">${r.maxDrawdown}%</div><div class="bt-label">Max Drawdown</div></div>
    <div class="bt-metric"><div class="bt-val">${r.sharpeRatio}</div><div class="bt-label">Sharpe OranÄ±</div></div>
    <div class="bt-metric"><div class="bt-val ${changeClass(r.annualReturn)}">${r.annualReturn}%</div><div class="bt-label">YÄ±llÄ±k Getiri</div></div>
  `;
}

// =============================================================================
// BACKTEST
// =============================================================================
function updateBtParams() {
  const strategy = document.getElementById('btStrategy').value;
  const row = document.getElementById('btParamsRow');
  if (strategy === 'ma_cross') {
    row.children[0].querySelector('label').textContent = 'HÄ±zlÄ± MA';
    row.children[0].querySelector('input').value = 20;
    row.children[1].querySelector('label').textContent = 'YavaÅŸ MA';
    row.children[1].querySelector('input').value = 50;
  } else if (strategy === 'breakout') {
    row.children[0].querySelector('label').textContent = 'Lookback GÃ¼n';
    row.children[0].querySelector('input').value = 20;
    row.children[1].querySelector('label').textContent = '(KullanÄ±lmÄ±yor)';
    row.children[1].querySelector('input').value = 0;
  } else if (strategy === 'mean_reversion') {
    row.children[0].querySelector('label').textContent = 'RSI Alt SÄ±nÄ±r';
    row.children[0].querySelector('input').value = 30;
    row.children[1].querySelector('label').textContent = 'RSI Ãœst SÄ±nÄ±r';
    row.children[1].querySelector('input').value = 70;
  }
}

async function runBacktest() {
  const symbol = document.getElementById('btSymbol').value.toUpperCase();
  const strategy = document.getElementById('btStrategy').value;
  const period = document.getElementById('btPeriod').value;
  const p1 = parseFloat(document.getElementById('btParam1').value);
  const p2 = parseFloat(document.getElementById('btParam2').value);
  const commission = parseFloat(document.getElementById('btCommission').value) / 100;
  const capital = parseFloat(document.getElementById('btCapital').value);

  if (!symbol) { alert('Hisse kodu girin'); return; }

  let params = {};
  if (strategy === 'ma_cross') params = { fast: p1, slow: p2 };
  else if (strategy === 'breakout') params = { lookback: p1 };
  else if (strategy === 'mean_reversion') params = { rsi_low: p1, rsi_high: p2 };

  document.getElementById('btResults').style.display = 'block';
  document.getElementById('btMetrics').innerHTML = '<div class="bt-metric" style="grid-column:1/-1;"><div class="loading"><div class="spinner"></div>Backtest Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...</div></div>';

  const data = await api('/backtest', {
    method: 'POST',
    body: JSON.stringify({ symbol, strategy, params, period, commission, slippage: 0.001, initialCapital: capital }),
  });

  if (data.error) {
    document.getElementById('btMetrics').innerHTML = `<div style="color:var(--red);grid-column:1/-1;">${data.error}</div>`;
    return;
  }

  const r = data.results;

  document.getElementById('btMetrics').innerHTML = `
    <div class="bt-metric"><div class="bt-val ${changeClass(r.totalReturn)}">${r.totalReturn}%</div><div class="bt-label">Toplam Getiri</div></div>
    <div class="bt-metric"><div class="bt-val">${r.cagr}%</div><div class="bt-label">CAGR</div></div>
    <div class="bt-metric"><div class="bt-val">${r.sharpeRatio}</div><div class="bt-label">Sharpe</div></div>
    <div class="bt-metric"><div class="bt-val ${changeClass(r.maxDrawdown)}">${r.maxDrawdown}%</div><div class="bt-label">Max Drawdown</div></div>
    <div class="bt-metric"><div class="bt-val">${r.winRate}%</div><div class="bt-label">Kazanma OranÄ±</div></div>
    <div class="bt-metric"><div class="bt-val">${r.totalTrades}</div><div class="bt-label">Ä°ÅŸlem SayÄ±sÄ±</div></div>
    <div class="bt-metric"><div class="bt-val ${changeClass(r.buyAndHoldReturn)}">${r.buyAndHoldReturn}%</div><div class="bt-label">Al-Tut Getiri</div></div>
    <div class="bt-metric"><div class="bt-val ${changeClass(r.alpha)}">${r.alpha}%</div><div class="bt-label">Alpha</div></div>
  `;

  // Equity Chart
  if (btChartInstance) btChartInstance.destroy();
  const ctx = document.getElementById('btChart');
  const ec = data.equityCurve || [];

  btChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ec.map(e => e.date),
      datasets: [{
        label: 'PortfÃ¶y DeÄŸeri',
        data: ec.map(e => e.equity),
        borderColor: '#00d4aa', backgroundColor: 'rgba(0,212,170,0.05)',
        fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#8896aa' } },
        tooltip: { backgroundColor: '#1a2234', borderColor: '#2a3548', borderWidth: 1, titleColor: '#e8ecf4', bodyColor: '#8896aa' }
      },
      scales: {
        x: { grid: { color: 'rgba(42,53,72,0.3)' }, ticks: { color: '#5a6a80', maxTicksLimit: 10, font: { size: 10 } } },
        y: { grid: { color: 'rgba(42,53,72,0.3)' }, ticks: { color: '#5a6a80', font: { family: 'JetBrains Mono', size: 11 } } },
      }
    }
  });

  // Trades table
  document.getElementById('btTrades').innerHTML = (data.trades || []).slice(-20).reverse().map(t => `
    <tr>
      <td>${t.date}</td>
      <td><span class="badge ${t.type.includes('BUY') ? 'badge-green' : 'badge-red'}">${t.type}</span></td>
      <td class="td-mono">${fmtPrice(t.price)}</td>
      <td class="td-mono">${t.shares || '-'}</td>
      <td class="td-mono ${t.pnl ? (t.pnl >= 0 ? 'pnl-positive' : 'pnl-negative') : ''}">${t.pnl ? fmtMoney(t.pnl) : '-'}</td>
    </tr>
  `).join('');
}

// =============================================================================
// ALERTS
// =============================================================================
async function createAlert() {
  if (!currentUser) { showLogin(); return; }
  const symbol = document.getElementById('alertSymbol').value.toUpperCase();
  const condition = document.getElementById('alertCondition').value;
  const threshold = parseFloat(document.getElementById('alertThreshold').value);

  if (!symbol || !condition || !threshold) { alert('Zorunlu alanlarÄ± doldurun'); return; }

  await api('/alerts', {
    method: 'POST',
    body: JSON.stringify({ userId: currentUser.userId, symbol, condition, targetValue: threshold }),
  });

  document.getElementById('alertForm').style.display = 'none';
  loadAlerts();
}

async function loadAlerts() {
  if (!currentUser) {
    document.getElementById('alertsTable').innerHTML = '<tr><td colspan="8"><div class="empty-state"><div class="icon">ğŸ”’</div><div>UyarÄ±larÄ± kullanmak iÃ§in giriÅŸ yapÄ±n</div><button class="btn btn-primary btn-sm" onclick="showLogin()" style="margin-top:12px;">GiriÅŸ Yap</button></div></td></tr>';
    return;
  }
  const data = await api('/alerts?userId=' + currentUser.userId);
  if (!data.success) return;

  const alerts = data.alerts || [];
  if (alerts.length === 0) {
    document.getElementById('alertsTable').innerHTML = '<tr><td colspan="8" class="empty-state">HenÃ¼z uyarÄ± yok</td></tr>';
    return;
  }

  const conditionNames = {
    'price_above': 'Fiyat ÃœstÃ¼nde', 'price_below': 'Fiyat AltÄ±nda',
    'change_above': 'DeÄŸiÅŸim ÃœstÃ¼nde', 'change_below': 'DeÄŸiÅŸim AltÄ±nda',
    'rsi_above': 'RSI ÃœstÃ¼nde', 'rsi_below': 'RSI AltÄ±nda',
    'volume_spike': 'Hacim Spike', 'breakout': 'KÄ±rÄ±lÄ±m',
    'macd_cross_up': 'MACD YukarÄ±', 'macd_cross_down': 'MACD AÅŸaÄŸÄ±',
  };

  document.getElementById('alertsTable').innerHTML = alerts.map(a => `
    <tr>
      <td class="td-mono td-clickable" onclick="goToStock('${a.symbol}')">${a.symbol}</td>
      <td>${conditionNames[a.condition] || a.condition}</td>
      <td class="td-mono">${a.targetValue || '-'}</td>
      <td>-</td>
      <td>-</td>
      <td class="td-mono">${a.triggered ? '1x' : '0x'}</td>
      <td>${a.active && !a.triggered ? '<span class="badge badge-green">Aktif</span>' : a.triggered ? '<span class="badge badge-yellow">Tetiklendi</span>' : '<span class="badge badge-neutral">Pasif</span>'}</td>
      <td><button class="btn btn-sm" style="background:var(--red-bg);color:var(--red);border:none;padding:4px 8px;font-size:11px;" onclick="deleteAlert(${a.id})">Sil</button></td>
    </tr>
  `).join('');
}

async function deleteAlert(id) {
  await api('/alerts/' + id, { method: 'DELETE' });
  loadAlerts();
}

// =============================================================================
// HEATMAP
// =============================================================================
async function loadHeatmap() {
  const container = document.getElementById('heatmapContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>IsÄ± haritasÄ± yÃ¼kleniyor...</div>';

  const data = await api('/heatmap');
  if (!data.success || !data.sectors || data.sectors.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ—ºï¸</div><div>Veriler yÃ¼kleniyor...</div></div>';
    if (data.loading) setTimeout(loadHeatmap, 5000);
    return;
  }

  let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;">';
  data.sectors.forEach(sector => {
    const sColor = sector.avgChange > 1 ? 'var(--green)' : (sector.avgChange < -1 ? 'var(--red)' : 'var(--text-muted)');
    const sBg = sector.avgChange > 1 ? 'rgba(16,185,129,0.08)' : (sector.avgChange < -1 ? 'rgba(239,68,68,0.08)' : 'rgba(255,255,255,0.03)');
    html += `<div class="card" style="border-left:4px solid ${sColor};background:${sBg};">
      <div class="flex-between mb-8">
        <div style="font-weight:700;font-size:14px;">${sector.displayName}</div>
        <div style="font-weight:800;font-size:16px;color:${sColor};">${sector.avgChange >= 0 ? '+' : ''}%${sector.avgChange}</div>
      </div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">${sector.stockCount} hisse</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;">`;

    sector.stocks.forEach(s => {
      const c = s.changePct > 0.5 ? 'var(--green)' : (s.changePct < -0.5 ? 'var(--red)' : 'var(--text-muted)');
      const bg = s.changePct > 2 ? 'rgba(16,185,129,0.2)' : (s.changePct > 0 ? 'rgba(16,185,129,0.08)' : (s.changePct < -2 ? 'rgba(239,68,68,0.2)' : (s.changePct < 0 ? 'rgba(239,68,68,0.08)' : 'rgba(255,255,255,0.05)')));
      const size = Math.max(70, Math.min(120, 80 + Math.abs(s.changePct) * 8));
      html += `<div onclick="goToStock('${s.code}')" style="cursor:pointer;padding:8px;border-radius:8px;background:${bg};border:1px solid ${c}33;min-width:${size}px;text-align:center;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-weight:700;font-size:12px;color:${c};">${s.code}</div>
        <div style="font-family:var(--font-mono);font-size:11px;color:${c};">${s.changePct >= 0 ? '+' : ''}%${s.changePct}</div>
        <div style="font-size:10px;color:var(--text-muted);">${fmtPrice(s.price)}</div>
      </div>`;
    });

    html += '</div></div>';
  });
  html += '</div>';
  container.innerHTML = html;
}

// =============================================================================
// COMPARE
// =============================================================================
async function runCompare() {
  const symbols = [1,2,3,4].map(i => document.getElementById('cmpInput'+i).value.trim().toUpperCase()).filter(Boolean);
  if (symbols.length < 2) { alert('En az 2 hisse girin'); return; }

  const container = document.getElementById('compareResults');
  container.style.display = 'block';
  container.innerHTML = '<div class="loading"><div class="spinner"></div>KarÅŸÄ±laÅŸtÄ±rÄ±lÄ±yor...</div>';

  const data = await api('/compare', { method: 'POST', body: JSON.stringify({ symbols }) });
  if (!data.success || !data.comparison || data.comparison.length < 2) {
    container.innerHTML = '<div class="card" style="color:var(--red);">KarÅŸÄ±laÅŸtÄ±rma yapÄ±lamadÄ±. Hisse kodlarÄ±nÄ± kontrol edin.</div>';
    return;
  }

  const stocks = data.comparison;
  let html = '<div class="card mb-24"><div style="font-weight:700;margin-bottom:16px;">KarÅŸÄ±laÅŸtÄ±rma Tablosu</div>';
  html += '<div class="table-wrap"><table><thead><tr><th>Metrik</th>';
  stocks.forEach(s => { html += `<th style="text-align:center;"><span class="td-clickable" onclick="goToStock('${s.code}')">${s.code}</span><br><span style="font-size:10px;color:var(--text-muted);">${s.name}</span></th>`; });
  html += '</tr></thead><tbody>';

  const metrics = [
    {label:'Fiyat', key:'price', fmt:v=>fmtPrice(v)+' â‚º'},
    {label:'DeÄŸiÅŸim %', key:'changePct', fmt:v=>'%'+v, color:true},
    {label:'Hacim', key:'volume', fmt:v=>fmtVolume(v)},
    {label:'AÃ§Ä±lÄ±ÅŸ', key:'open', fmt:v=>fmtPrice(v)+' â‚º'},
    {label:'YÃ¼ksek', key:'high', fmt:v=>fmtPrice(v)+' â‚º'},
    {label:'DÃ¼ÅŸÃ¼k', key:'low', fmt:v=>fmtPrice(v)+' â‚º'},
    {label:'Ã–nceki KapanÄ±ÅŸ', key:'prevClose', fmt:v=>fmtPrice(v)+' â‚º'},
    {label:'Gap %', key:'gapPct', fmt:v=>'%'+v, color:true},
    {label:'RSI', key:'rsi', fmt:v=>v?v.toFixed(1):'-'},
    {label:'MACD Sinyal', key:'macdSignal', fmt:v=>v||'-'},
    {label:'EMA20', key:'ema20', fmt:v=>v?fmtPrice(v)+' â‚º':'-'},
    {label:'EMA50', key:'ema50', fmt:v=>v?fmtPrice(v)+' â‚º':'-'},
    {label:'52H YÃ¼ksek', key:'high52w', fmt:v=>v?fmtPrice(v)+' â‚º':'-'},
    {label:'52H DÃ¼ÅŸÃ¼k', key:'low52w', fmt:v=>v?fmtPrice(v)+' â‚º':'-'},
    {label:'52H Pozisyon %', key:'pos52w', fmt:v=>v?'%'+v.toFixed(0):'-'},
  ];

  metrics.forEach(m => {
    html += `<tr><td style="font-weight:600;font-size:12px;">${m.label}</td>`;
    // Find best value for highlighting
    const vals = stocks.map(s => s[m.key] || 0);
    stocks.forEach((s, i) => {
      const v = s[m.key];
      const cls = m.color ? changeClass(v) : '';
      const isBest = m.color && Math.abs(v) === Math.max(...vals.map(Math.abs)) && v > 0;
      html += `<td class="td-mono ${cls}" style="text-align:center;${isBest ? 'font-weight:700;' : ''}">${m.fmt(v)}</td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table></div></div>';
  container.innerHTML = html;
}

// =============================================================================
// DAILY REPORT
// =============================================================================
async function loadReport() {
  const container = document.getElementById('reportContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>Rapor hazÄ±rlanÄ±yor...</div>';

  const data = await api('/report');
  if (!data.success) {
    container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div><div>Veriler yÃ¼kleniyor...</div></div>';
    if (data.loading) setTimeout(loadReport, 5000);
    return;
  }

  const mb = data.marketBreadth || {};
  const upPct = mb.total ? (mb.advancing/mb.total*100).toFixed(0) : 0;
  const downPct = mb.total ? (mb.declining/mb.total*100).toFixed(0) : 0;

  let html = `
    <div class="card mb-24 fade-in">
      <div style="font-weight:700;font-size:16px;margin-bottom:8px;">ğŸ“‹ ${data.date} Piyasa Ã–zeti</div>
      <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
        ${(data.reportLines||[]).map(l => 'â€¢ ' + l).join('<br>')}
      </div>
    </div>

    <div class="grid-4 mb-24 fade-in">
      <div class="card" style="text-align:center;border-left:3px solid var(--green);">
        <div style="font-size:11px;color:var(--text-muted);">YÃ¼kselen</div>
        <div style="font-size:24px;font-weight:800;color:var(--green);">${mb.advancing}</div>
        <div style="font-size:11px;color:var(--text-muted);">%${upPct}</div>
      </div>
      <div class="card" style="text-align:center;border-left:3px solid var(--red);">
        <div style="font-size:11px;color:var(--text-muted);">DÃ¼ÅŸen</div>
        <div style="font-size:24px;font-weight:800;color:var(--red);">${mb.declining}</div>
        <div style="font-size:11px;color:var(--text-muted);">%${downPct}</div>
      </div>
      <div class="card" style="text-align:center;border-left:3px solid var(--text-muted);">
        <div style="font-size:11px;color:var(--text-muted);">DeÄŸiÅŸmez</div>
        <div style="font-size:24px;font-weight:800;">${mb.unchanged}</div>
      </div>
      <div class="card" style="text-align:center;border-left:3px solid var(--accent);">
        <div style="font-size:11px;color:var(--text-muted);">Ort. DeÄŸiÅŸim</div>
        <div class="td-mono ${changeClass(mb.avgChange)}" style="font-size:24px;font-weight:800;">%${mb.avgChange}</div>
      </div>
    </div>

    <div class="grid-2 mb-24 fade-in">
      <div class="card">
        <div style="font-weight:700;margin-bottom:12px;color:var(--green);">ğŸŸ¢ En Ã‡ok YÃ¼kselenler</div>
        <div class="table-wrap"><table>
          <thead><tr><th>Kod</th><th>Fiyat</th><th>DeÄŸiÅŸim</th></tr></thead>
          <tbody>${(data.topGainers||[]).map(s => `<tr class="stock-row" onclick="goToStock('${s.code}')"><td class="td-clickable td-mono">${s.code}</td><td class="td-mono">${fmtPrice(s.price)}</td><td class="td-mono price-up">+%${s.changePct}</td></tr>`).join('')}</tbody>
        </table></div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:12px;color:var(--red);">ğŸ”´ En Ã‡ok DÃ¼ÅŸenler</div>
        <div class="table-wrap"><table>
          <thead><tr><th>Kod</th><th>Fiyat</th><th>DeÄŸiÅŸim</th></tr></thead>
          <tbody>${(data.topLosers||[]).map(s => `<tr class="stock-row" onclick="goToStock('${s.code}')"><td class="td-clickable td-mono">${s.code}</td><td class="td-mono">${fmtPrice(s.price)}</td><td class="td-mono price-down">%${s.changePct}</td></tr>`).join('')}</tbody>
        </table></div>
      </div>
    </div>

    <div class="grid-2 mb-24 fade-in">
      <div class="card">
        <div style="font-weight:700;margin-bottom:12px;">ğŸ“Š Hacim Liderleri</div>
        <div class="table-wrap"><table>
          <thead><tr><th>Kod</th><th>Hacim</th><th>DeÄŸiÅŸim</th></tr></thead>
          <tbody>${(data.volumeLeaders||[]).map(s => `<tr class="stock-row" onclick="goToStock('${s.code}')"><td class="td-clickable td-mono">${s.code}</td><td class="td-mono">${fmtVolume(s.volume)}</td><td class="td-mono ${changeClass(s.changePct)}">%${s.changePct}</td></tr>`).join('')}</tbody>
        </table></div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:12px;">ğŸ“ˆ SektÃ¶r PerformansÄ±</div>
        ${(data.sectorPerformance||[]).map(s => {
          const c = s.avgChange > 0 ? 'var(--green)' : (s.avgChange < 0 ? 'var(--red)' : 'var(--text-muted)');
          const w = Math.min(100, Math.abs(s.avgChange) * 15);
          return `<div style="margin-bottom:8px;">
            <div class="flex-between" style="font-size:12px;margin-bottom:2px;">
              <span>${s.name}</span>
              <span style="color:${c};font-weight:700;">${s.avgChange >= 0 ? '+' : ''}%${s.avgChange}</span>
            </div>
            <div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden;">
              <div style="width:${w}%;height:100%;background:${c};border-radius:3px;"></div>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;

  container.innerHTML = html;
}


// =============================================================================
// AUTH (LOGIN/REGISTER)
// =============================================================================
let currentUser = JSON.parse(localStorage.getItem('bistUser') || 'null');
let authMode = 'login';

function showLogin() {
  document.getElementById('loginModal').style.display = 'flex';
  authMode = 'login';
  document.getElementById('authTitle').textContent = 'GiriÅŸ Yap';
  document.getElementById('authEmailRow').style.display = 'none';
  document.getElementById('authError').style.display = 'none';
}

function closeLogin() {
  document.getElementById('loginModal').style.display = 'none';
}

function toggleAuthMode() {
  if (authMode === 'login') {
    authMode = 'register';
    document.getElementById('authTitle').textContent = 'KayÄ±t Ol';
    document.getElementById('authEmailRow').style.display = 'block';
  } else {
    authMode = 'login';
    document.getElementById('authTitle').textContent = 'GiriÅŸ Yap';
    document.getElementById('authEmailRow').style.display = 'none';
  }
  document.getElementById('authError').style.display = 'none';
}

async function doAuth() {
  const username = document.getElementById('authUsername').value.trim();
  const password = document.getElementById('authPassword').value;
  const email = document.getElementById('authEmail')?.value || '';
  const errEl = document.getElementById('authError');

  const endpoint = authMode === 'register' ? '/auth/register' : '/auth/login';
  const data = await api(endpoint, {
    method: 'POST',
    body: JSON.stringify({ username, password, email }),
  });

  if (data.error) {
    errEl.textContent = data.error;
    errEl.style.display = 'block';
    return;
  }

  currentUser = { userId: data.userId, username: data.username, email: data.email || '' };
  localStorage.setItem('bistUser', JSON.stringify(currentUser));
  closeLogin();
  updateUserUI();
  // Aktif sayfayÄ± yenile
  const activePage = document.querySelector('.page.active');
  if (activePage) {
    const pageId = activePage.id.replace('page-', '');
    if (pageId === 'portfolio') loadPortfolio();
    else if (pageId === 'watchlist') loadWatchlist();
    else if (pageId === 'alerts') loadAlerts();
  }
}

function logout() {
  currentUser = null;
  localStorage.removeItem('bistUser');
  updateUserUI();
}

function updateUserUI() {
  const el = document.getElementById('userStatus');
  if (!el) return;
  el.style.display = 'flex';
  el.style.alignItems = 'center';
  el.style.gap = '8px';
  if (currentUser) {
    el.innerHTML = `<span style="font-size:12px;color:var(--accent);font-weight:600;">ğŸ‘¤ ${currentUser.username}</span> <button class="btn btn-sm btn-secondary" onclick="logout()" style="font-size:10px;padding:2px 8px;">Ã‡Ä±kÄ±ÅŸ</button>`;
  } else {
    el.innerHTML = `<button class="btn btn-sm btn-primary" onclick="showLogin()" style="font-size:11px;background:var(--accent);color:#000;font-weight:700;">GiriÅŸ / KayÄ±t</button>`;
  }
}


// =============================================================================
// INIT
// =============================================================================
document.addEventListener('DOMContentLoaded', () => {
  loadDashboard();
  updateUserUI();
});
</script>
</body>
</html>
