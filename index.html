<!DOCTYPE html>
<html lang="tr">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BIST Pro v3.0 â€” Borsa Analiz Platformu</title>
<link rel="preconnect" href="https://fonts.googleapis.com">
<link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;600;700&family=Plus+Jakarta+Sans:wght@400;500;600;700;800&display=swap" rel="stylesheet">
<script src="https://cdn.jsdelivr.net/npm/chart.js@4.4.4/dist/chart.umd.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/chartjs-chart-financial@0.2.1/dist/chartjs-chart-financial.min.js" defer></script>
<style>
:root {
  --bg-primary: #0a0e17;
  --bg-secondary: #111827;
  --bg-card: #1a2234;
  --bg-card-hover: #1f2a40;
  --bg-input: #0d1321;
  --border: #2a3548;
  --border-hover: #3d4f6a;
  --text-primary: #e8ecf4;
  --text-secondary: #8896aa;
  --text-muted: #5a6a80;
  --accent: #00d4aa;
  --accent-dim: rgba(0,212,170,0.12);
  --accent-glow: rgba(0,212,170,0.25);
  --green: #00e5a0;
  --green-bg: rgba(0,229,160,0.1);
  --red: #ff4d6a;
  --red-bg: rgba(255,77,106,0.1);
  --yellow: #ffc547;
  --yellow-bg: rgba(255,197,71,0.1);
  --blue: #4da6ff;
  --blue-bg: rgba(77,166,255,0.1);
  --purple: #a78bfa;
  --font-body: 'Plus Jakarta Sans', sans-serif;
  --font-mono: 'JetBrains Mono', monospace;
  --radius: 12px;
  --radius-sm: 8px;
  --shadow: 0 4px 24px rgba(0,0,0,0.4);
  --shadow-lg: 0 8px 40px rgba(0,0,0,0.5);
}

* { margin:0; padding:0; box-sizing:border-box; }

body {
  font-family: var(--font-body);
  background: var(--bg-primary);
  color: var(--text-primary);
  min-height: 100vh;
  overflow-x: hidden;
}

/* â”€â”€â”€ SCROLLBAR â”€â”€â”€ */
::-webkit-scrollbar { width: 6px; height: 6px; }
::-webkit-scrollbar-track { background: var(--bg-primary); }
::-webkit-scrollbar-thumb { background: var(--border); border-radius: 3px; }
::-webkit-scrollbar-thumb:hover { background: var(--border-hover); }

/* â”€â”€â”€ NAVBAR â”€â”€â”€ */
.navbar {
  position: fixed; top: 0; left: 0; right: 0; z-index: 100;
  display: flex; align-items: center; justify-content: space-between;
  padding: 0 24px; height: 56px;
  background: rgba(10,14,23,0.85);
  backdrop-filter: blur(20px);
  border-bottom: 1px solid var(--border);
}
.navbar-brand {
  display: flex; align-items: center; gap: 10px;
  font-weight: 800; font-size: 18px; color: var(--accent);
  cursor: pointer; text-decoration: none;
}
.navbar-brand span { color: var(--text-muted); font-weight: 500; font-size: 12px; }
.nav-links { display: flex; gap: 4px; }
.nav-link {
  padding: 8px 16px; border-radius: var(--radius-sm);
  color: var(--text-secondary); font-size: 13px; font-weight: 600;
  cursor: pointer; transition: all .2s; border: none; background: none;
  text-decoration: none;
}
.nav-link:hover { color: var(--text-primary); background: var(--bg-card); }
.nav-link.active { color: var(--accent); background: var(--accent-dim); }

.nav-search {
  display: flex; align-items: center; gap: 8px;
  background: var(--bg-input); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 6px 12px;
}
.nav-search input {
  background: none; border: none; color: var(--text-primary);
  font-size: 13px; width: 180px; outline: none;
  font-family: var(--font-body);
}
.nav-search input::placeholder { color: var(--text-muted); }
.search-results-dropdown {
  position: absolute; top: 48px; right: 24px;
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); min-width: 280px;
  box-shadow: var(--shadow-lg); display: none; max-height: 300px; overflow-y: auto;
}
.search-results-dropdown.show { display: block; }
.search-result-item {
  padding: 10px 14px; cursor: pointer; transition: background .15s;
  display: flex; justify-content: space-between; align-items: center;
  border-bottom: 1px solid var(--border);
}
.search-result-item:hover { background: var(--bg-card-hover); }
.search-result-item:last-child { border: none; }
.search-result-code { font-family: var(--font-mono); font-weight: 700; color: var(--accent); }
.search-result-name { color: var(--text-secondary); font-size: 12px; }

/* â”€â”€â”€ MAIN CONTENT â”€â”€â”€ */
.main { padding-top: 56px; min-height: 100vh; }
.page { display: none; padding: 24px; max-width: 1440px; margin: 0 auto; }
.page.active { display: block; }

/* â”€â”€â”€ COMMON â”€â”€â”€ */
.section-title {
  font-size: 20px; font-weight: 800; margin-bottom: 16px;
  display: flex; align-items: center; gap: 10px;
}
.section-title .icon { font-size: 22px; }

.card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 20px;
  transition: all .25s;
}
.card:hover { border-color: var(--border-hover); box-shadow: var(--shadow); }

.grid-2 { display: grid; grid-template-columns: repeat(2, 1fr); gap: 16px; }
.grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 16px; }
.grid-4 { display: grid; grid-template-columns: repeat(4, 1fr); gap: 16px; }
.grid-5 { display: grid; grid-template-columns: repeat(5, 1fr); gap: 16px; }

@media (max-width: 1024px) {
  .grid-4, .grid-5 { grid-template-columns: repeat(2, 1fr); }
  .grid-3 { grid-template-columns: repeat(2, 1fr); }
  .grid-3col { grid-template-columns: repeat(2, 1fr) !important; }
}
@media (max-width: 640px) {
  .grid-2, .grid-3, .grid-4, .grid-5, .grid-3col { grid-template-columns: 1fr !important; }
  .navbar { padding: 0 8px; gap: 4px; }
  .nav-links { display: none; }
  .page { padding: 12px; }
  .main { padding-top: 60px; }
  .section-title { font-size: 16px; }
  .stock-header .stock-price-big { font-size: 22px; }
  .indicator-grid { grid-template-columns: 1fr !important; }
  .chart-container { height: 250px; }
  .card { padding: 12px; }
  .table-wrap { font-size: 12px; }
  .table-wrap th, .table-wrap td { padding: 6px 8px; }
  .nav-search input { width: 100px; font-size: 12px; }
  .index-card { padding: 10px; }
  .index-card .value { font-size: 14px; }
  .btn { padding: 8px 14px; font-size: 12px; }
  .btn-sm { padding: 4px 10px; font-size: 11px; }
  #userStatus { display: flex; align-items: center; gap: 8px; }
  .condition-row { flex-direction: column; align-items: stretch; }
  .condition-row select, .condition-row input { max-width: 100% !important; width: 100% !important; }
  .stock-header { flex-direction: column; gap: 12px; }
  .flex-center { flex-wrap: wrap; }
}
@media (max-width: 400px) {
  .page { padding: 8px; }
  .navbar-brand span { display: none; }
}

.badge {
  display: inline-flex; padding: 3px 8px; border-radius: 6px;
  font-size: 11px; font-weight: 700; font-family: var(--font-mono);
}
.badge-green { background: var(--green-bg); color: var(--green); }
.badge-red { background: var(--red-bg); color: var(--red); }
.badge-yellow { background: var(--yellow-bg); color: var(--yellow); }
.badge-blue { background: var(--blue-bg); color: var(--blue); }
.badge-neutral { background: rgba(136,150,170,0.1); color: var(--text-secondary); }

.price-up { color: var(--green); }
.price-down { color: var(--red); }

.btn {
  padding: 10px 20px; border-radius: var(--radius-sm); font-size: 13px;
  font-weight: 600; cursor: pointer; transition: all .2s;
  border: 1px solid var(--border); font-family: var(--font-body);
}
.btn-primary {
  background: var(--accent); color: var(--bg-primary); border: none;
}
.btn-primary:hover { filter: brightness(1.15); transform: translateY(-1px); }
.btn-secondary { background: var(--bg-card); color: var(--text-primary); }
.btn-secondary:hover { background: var(--bg-card-hover); }
.btn-sm { padding: 6px 12px; font-size: 12px; }

input, select {
  background: var(--bg-input); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 10px 14px;
  color: var(--text-primary); font-size: 13px;
  font-family: var(--font-body); outline: none;
  transition: border .2s;
}
input:focus, select:focus { border-color: var(--accent); }

.loading {
  display: flex; align-items: center; justify-content: center;
  padding: 60px; color: var(--text-muted);
}
.spinner {
  width: 32px; height: 32px; border: 3px solid var(--border);
  border-top-color: var(--accent); border-radius: 50%;
  animation: spin .8s linear infinite; margin-right: 12px;
}
@keyframes spin { to { transform: rotate(360deg); } }

.table-wrap { overflow-x: auto; }
table { width: 100%; border-collapse: collapse; }
th {
  text-align: left; padding: 10px 14px; font-size: 11px;
  text-transform: uppercase; letter-spacing: 0.5px;
  color: var(--text-muted); border-bottom: 1px solid var(--border);
  font-weight: 600; white-space: nowrap;
}
td {
  padding: 12px 14px; border-bottom: 1px solid rgba(42,53,72,0.5);
  font-size: 13px; white-space: nowrap;
}
tr:hover td { background: rgba(26,34,52,0.5); }
.td-mono { font-family: var(--font-mono); font-weight: 600; }
.td-clickable { cursor: pointer; color: var(--accent); }
.td-clickable:hover { text-decoration: underline; }

.empty-state {
  text-align: center; padding: 60px 20px; color: var(--text-muted);
}
.empty-state .icon { font-size: 48px; margin-bottom: 12px; }

.tabs { display: flex; gap: 4px; margin-bottom: 20px; flex-wrap: wrap; }
.tab {
  padding: 8px 16px; border-radius: var(--radius-sm);
  font-size: 13px; font-weight: 600; cursor: pointer;
  color: var(--text-secondary); background: none; border: none;
  transition: all .2s; font-family: var(--font-body);
}
.tab:hover { color: var(--text-primary); background: var(--bg-card); }
.tab.active { color: var(--accent); background: var(--accent-dim); }

.flex-between { display: flex; justify-content: space-between; align-items: center; }
.flex-center { display: flex; align-items: center; }
.gap-8 { gap: 8px; }
.gap-12 { gap: 12px; }
.gap-16 { gap: 16px; }
.gap-24 { gap: 24px; }
.mb-8 { margin-bottom: 8px; }
.mb-16 { margin-bottom: 16px; }
.mb-24 { margin-bottom: 24px; }
.mt-16 { margin-top: 16px; }
.mt-24 { margin-top: 24px; }

/* â”€â”€â”€ INDEX CARDS â”€â”€â”€ */
.index-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius); padding: 16px 20px;
  transition: all .25s;
}
.index-card:hover { transform: translateY(-2px); box-shadow: var(--shadow); }
.index-card .label { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 4px; }
.index-card .value { font-family: var(--font-mono); font-size: 22px; font-weight: 700; }
.index-card .change { font-family: var(--font-mono); font-size: 13px; font-weight: 600; margin-top: 4px; }

/* â”€â”€â”€ STOCK TABLE ROW â”€â”€â”€ */
.stock-row { cursor: pointer; }
.stock-row:hover td { background: var(--bg-card-hover); }

/* â”€â”€â”€ STOCK DETAIL HEADER â”€â”€â”€ */
.stock-header {
  display: flex; align-items: flex-start; justify-content: space-between;
  flex-wrap: wrap; gap: 20px; margin-bottom: 24px;
}
.stock-header .stock-price-big {
  font-family: var(--font-mono); font-size: 36px; font-weight: 700;
}
.stock-header .stock-change-big {
  font-family: var(--font-mono); font-size: 16px; font-weight: 600;
}
.stock-header .stock-name { font-size: 14px; color: var(--text-secondary); }

/* â”€â”€â”€ COLLAPSIBLE SECTIONS â”€â”€â”€ */
.collapsible-header {
  display: flex; justify-content: space-between; align-items: center;
  cursor: pointer; user-select: none; padding: 4px 0;
}
.collapsible-header:hover { opacity: 0.8; }
.collapsible-header .collapse-icon {
  transition: transform 0.3s ease; font-size: 14px; color: var(--text-muted);
}
.collapsible-header.collapsed .collapse-icon { transform: rotate(-90deg); }
.collapsible-body { transition: max-height 0.3s ease, opacity 0.3s ease; overflow: hidden; }
.collapsible-body.collapsed { max-height: 0 !important; opacity: 0; padding-top: 0; padding-bottom: 0; }

/* â”€â”€â”€ INDICATOR PILL â”€â”€â”€ */
.indicator-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(260px, 1fr)); gap: 12px; }
.indicator-card {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius-sm); padding: 14px; transition: border-color 0.2s;
}
.indicator-card:hover { border-color: var(--accent); }
.indicator-card.signal-buy { border-left: 3px solid var(--green); }
.indicator-card.signal-sell { border-left: 3px solid var(--red); }
.indicator-card.signal-neutral { border-left: 3px solid var(--text-muted); }
.indicator-card .ind-name { font-size: 11px; color: var(--text-muted); text-transform: uppercase; letter-spacing: 0.5px; margin-bottom: 6px; }
.indicator-card .ind-value { font-family: var(--font-mono); font-size: 18px; font-weight: 700; }
.indicator-card .ind-detail { font-size: 11px; color: var(--text-secondary); margin-top: 6px; line-height: 1.5; }
.indicator-card .ind-explanation { font-size: 11px; color: var(--text-secondary); margin-top: 4px; }
.indicator-card .ind-bar { height: 4px; border-radius: 2px; background: var(--border); margin-top: 8px; overflow: hidden; }
.indicator-card .ind-bar-fill { height: 100%; border-radius: 2px; transition: width 0.3s; }

/* â”€â”€â”€ FIBONACCI LEVELS â”€â”€â”€ */
.fib-bar {
  display: flex; align-items: center; gap: 12px;
  padding: 8px 0; border-bottom: 1px solid rgba(42,53,72,0.3);
}
.fib-label { font-family: var(--font-mono); font-size: 11px; color: var(--text-muted); min-width: 80px; }
.fib-value { font-family: var(--font-mono); font-size: 13px; font-weight: 600; }
.fib-line { flex: 1; height: 2px; background: var(--border); position: relative; }
.fib-marker {
  position: absolute; top: -4px; width: 10px; height: 10px;
  background: var(--accent); border-radius: 50%;
}

/* â”€â”€â”€ SCREENER CONDITION â”€â”€â”€ */
.condition-row {
  display: flex; gap: 8px; align-items: center; margin-bottom: 8px; flex-wrap: wrap;
}
.condition-row select, .condition-row input { max-width: 180px; }
.remove-condition {
  background: var(--red-bg); color: var(--red); border: none;
  width: 28px; height: 28px; border-radius: 6px; cursor: pointer;
  font-size: 16px; display: flex; align-items: center; justify-content: center;
}

/* â”€â”€â”€ BACKTEST RESULT â”€â”€â”€ */
.bt-metric {
  text-align: center; padding: 16px;
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: var(--radius-sm);
}
.bt-metric .bt-val { font-family: var(--font-mono); font-size: 20px; font-weight: 700; }
.bt-metric .bt-label { font-size: 11px; color: var(--text-muted); margin-top: 4px; }

/* â”€â”€â”€ BREADTH BAR â”€â”€â”€ */
.breadth-bar {
  display: flex; height: 28px; border-radius: 14px; overflow: hidden;
  background: var(--bg-input); margin: 8px 0;
}
.breadth-bar .adv { background: var(--green); transition: width .5s; }
.breadth-bar .unc { background: var(--yellow); transition: width .5s; }
.breadth-bar .dec { background: var(--red); transition: width .5s; }

/* â”€â”€â”€ CHART CONTAINER â”€â”€â”€ */
.chart-container {
  position: relative; width: 100%; background: var(--bg-card);
  border: 1px solid var(--border); border-radius: var(--radius);
  padding: 16px;
}
.chart-container canvas { max-height: 400px; }

/* Mobile nav toggle */
.nav-toggle {
  display: none; background: none; border: none; color: var(--text-primary);
  font-size: 24px; cursor: pointer;
}
@media (max-width: 640px) {
  .nav-toggle { display: block; }
  .nav-links.show { display: flex; position: absolute; top: 56px; left: 0; right: 0;
    background: var(--bg-secondary); flex-direction: column; padding: 12px;
    border-bottom: 1px solid var(--border); }
}

/* â”€â”€â”€ FADE IN â”€â”€â”€ */
@keyframes fadeIn { from { opacity: 0; transform: translateY(8px); } to { opacity: 1; transform: none; } }
.fade-in { animation: fadeIn .4s ease-out; }

/* â”€â”€â”€ PORTFOLIO TABLE â”€â”€â”€ */
.pnl-positive { color: var(--green); }
.pnl-negative { color: var(--red); }

/* â”€â”€â”€ LOADING POPUP â”€â”€â”€ */
.loading-overlay {
  position: fixed; inset: 0; z-index: 2000;
  background: rgba(10,14,23,0.92);
  backdrop-filter: blur(12px);
  display: flex; align-items: center; justify-content: center;
  transition: opacity 0.4s ease;
}
.loading-overlay.fade-out { opacity: 0; pointer-events: none; }
.loading-popup {
  background: var(--bg-card); border: 1px solid var(--border);
  border-radius: 16px; padding: 40px 48px; text-align: center;
  max-width: 440px; width: 90vw; box-shadow: var(--shadow-lg);
}
.loading-popup .lp-icon { font-size: 48px; margin-bottom: 16px; }
.loading-popup .lp-title {
  font-size: 20px; font-weight: 800; color: var(--accent); margin-bottom: 8px;
}
.loading-popup .lp-subtitle {
  font-size: 13px; color: var(--text-secondary); margin-bottom: 20px; line-height: 1.6;
}
.loading-popup .lp-progress-bar {
  height: 6px; background: var(--bg-input); border-radius: 3px;
  overflow: hidden; margin-bottom: 12px;
}
.loading-popup .lp-progress-fill {
  height: 100%; background: linear-gradient(90deg, var(--accent), var(--green));
  border-radius: 3px; transition: width 0.5s ease; width: 0%;
}
.loading-popup .lp-status {
  font-size: 12px; color: var(--text-muted); margin-bottom: 16px;
  min-height: 18px;
}
.loading-popup .lp-estimate {
  font-size: 11px; color: var(--text-muted);
  padding: 8px 16px; background: var(--bg-input);
  border-radius: var(--radius-sm); display: inline-block;
  margin-bottom: 16px;
}
.loading-popup .lp-close {
  font-size: 12px; color: var(--text-muted); background: none;
  border: 1px solid var(--border); border-radius: var(--radius-sm);
  padding: 8px 20px; cursor: pointer; transition: all .2s;
  font-family: var(--font-body);
}
.loading-popup .lp-close:hover {
  color: var(--text-primary); border-color: var(--accent);
}
</style>
</head>
<body>

<!-- LOADING POPUP -->
<div class="loading-overlay" id="loadingOverlay">
  <div class="loading-popup">
    <div class="lp-icon">â—†</div>
    <div class="lp-title">BIST Pro</div>
    <div class="lp-subtitle">Piyasa verileri hazÄ±rlanÄ±yor...<br>131 hisse senedi verisi arka planda yÃ¼kleniyor.</div>
    <div class="lp-progress-bar"><div class="lp-progress-fill" id="lpProgress"></div></div>
    <div class="lp-status" id="lpStatus">Endeksler yÃ¼kleniyor...</div>
    <div class="lp-estimate">Tahmini sÃ¼re: 10-30 saniye</div>
    <div><button class="lp-close" onclick="dismissLoadingPopup()">Arka Planda YÃ¼klensin</button></div>
  </div>
</div>

<!-- NAVBAR -->
<nav class="navbar">
  <a class="navbar-brand" onclick="navigate('dashboard')">
    â—† BIST Pro <span>v3.0</span>
  </a>
  <button class="nav-toggle" onclick="document.querySelector('.nav-links').classList.toggle('show')">â˜°</button>
  <div class="nav-links">
    <button class="nav-link active" data-page="dashboard" onclick="navigate('dashboard')">Dashboard</button>
    <button class="nav-link" data-page="signals" onclick="navigate('signals')" style="color:var(--green);font-weight:700;">Sinyaller</button>
    <button class="nav-link" data-page="opportunities" onclick="navigate('opportunities')">FÄ±rsatlar</button>
    <button class="nav-link" data-page="strategies" onclick="navigate('strategies')">Stratejiler</button>
    <button class="nav-link" data-page="dividends" onclick="navigate('dividends')">TemettÃ¼</button>
    <button class="nav-link" data-page="bist100" onclick="navigate('bist100')">BIST 100</button>
    <button class="nav-link" data-page="heatmap" onclick="navigate('heatmap')">IsÄ± HaritasÄ±</button>
    <button class="nav-link" data-page="screener" onclick="navigate('screener')">TarayÄ±cÄ±</button>
    <button class="nav-link" data-page="compare" onclick="navigate('compare')">KarÅŸÄ±laÅŸtÄ±r</button>
    <button class="nav-link" data-page="report" onclick="navigate('report')">Rapor</button>
    <button class="nav-link" data-page="watchlist" onclick="navigate('watchlist')">Favoriler</button>
    <button class="nav-link" data-page="portfolio" onclick="navigate('portfolio')">PortfÃ¶y</button>
    <button class="nav-link" data-page="backtest" onclick="navigate('backtest')">Backtest</button>
    <button class="nav-link" data-page="alerts" onclick="navigate('alerts')">UyarÄ±lar</button>
    <button class="nav-link" data-page="bes" onclick="navigate('bes')" style="color:var(--purple);font-weight:700;">BES Analiz</button>
  </div>
  <div style="position:relative;">
    <div class="nav-search">
      <span style="color:var(--text-muted)">ğŸ”</span>
      <input type="text" id="globalSearch" placeholder="Hisse ara... (THYAO)" oninput="onSearch(this.value)" onfocus="onSearch(this.value)">
    </div>
    <div class="search-results-dropdown" id="searchDropdown"></div>
  </div>
  <div id="userStatus" style="margin-left:8px;"></div>
</nav>

<!-- MAIN -->
<div class="main">

<!-- â•â•â•â•â•â•â•â•â•â•â• DASHBOARD â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page active" id="page-dashboard">
  <div class="section-title mb-24"><span class="icon">ğŸ“Š</span> Piyasa Ã–zeti</div>

  <!-- Endeks KartlarÄ± -->
  <div class="mb-24" id="indicesCards" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(170px,1fr));gap:12px;">
    <div class="index-card"><div class="label">YÃ¼kleniyor...</div><div class="spinner" style="margin:8px auto;width:20px;height:20px;border-width:2px;"></div></div>
  </div>

  <!-- Piyasa GeniÅŸliÄŸi -->
  <div class="card mb-24" id="breadthCard">
    <div class="flex-between mb-8">
      <div style="font-weight:700;font-size:14px;">Piyasa GeniÅŸliÄŸi</div>
      <div id="breadthStats" style="font-size:12px;color:var(--text-secondary);"></div>
    </div>
    <div class="breadth-bar">
      <div class="adv" id="breadthAdv" style="width:50%"></div>
      <div class="unc" id="breadthUnc" style="width:10%"></div>
      <div class="dec" id="breadthDec" style="width:40%"></div>
    </div>
    <div class="flex-between" style="font-size:11px;color:var(--text-muted);margin-top:4px;">
      <span>ğŸŸ¢ YÃ¼kselen: <span id="advCount">-</span></span>
      <span>ğŸŸ¡ DeÄŸiÅŸmez: <span id="uncCount">-</span></span>
      <span>ğŸ”´ DÃ¼ÅŸen: <span id="decCount">-</span></span>
    </div>
  </div>

  <!-- Dashboard yÃ¼kleme/hata durumu â€” endeks kartlarÄ±ndan AYRI -->
  <div id="dashboardStatus" style="display:none;" class="mb-24"></div>

  <!-- Meta Bar: lastUpdated + stale badge -->
  <div id="dashboardMeta" class="card mb-24" style="padding:10px 16px;display:flex;align-items:center;justify-content:space-between;background:var(--bg-secondary);border:1px solid var(--border);">
    <div style="display:flex;align-items:center;gap:12px;">
      <span id="dataQualityBadge" class="badge badge-green" style="font-size:11px;">CANLI</span>
      <span id="lastUpdatedText" style="font-size:12px;color:var(--text-muted);">Son gÃ¼ncelleme: --</span>
    </div>
    <button class="btn btn-sm btn-secondary" onclick="loadDashboard(true)" style="padding:4px 12px;font-size:11px;">Yenile</button>
  </div>

  <!-- Piyasa Rejimi + Favori Hisseler -->
  <div class="grid-2 mb-24">
    <div class="card" id="dashboardRegime" style="border-left:3px solid var(--accent);">
      <div style="font-weight:700;font-size:14px;margin-bottom:8px;">Piyasa Rejimi</div>
      <div id="dashRegimeContent" style="font-size:13px;color:var(--text-secondary);">YÃ¼kleniyor...</div>
    </div>
    <div class="card" id="dashboardWatchlist" style="border-left:3px solid var(--yellow);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <div style="font-weight:700;font-size:14px;">Favorilerim</div>
        <button class="btn btn-sm btn-secondary" onclick="navigate('watchlist')" style="padding:3px 10px;font-size:11px;">TÃ¼mÃ¼</button>
      </div>
      <div id="dashWatchlistContent" style="font-size:12px;color:var(--text-secondary);">GiriÅŸ yaparak favorilerinizi gÃ¶rebilirsiniz.</div>
    </div>
  </div>

  <!-- Movers Grid -->
  <div class="grid-2 mb-24">
    <!-- En Ã‡ok Artan -->
    <div class="card">
      <div style="font-weight:700;font-size:14px;margin-bottom:12px;">ğŸš€ En Ã‡ok Artan</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Hisse</th><th>Fiyat</th><th>DeÄŸiÅŸim</th></tr></thead>
        <tbody id="topGainers"></tbody>
      </table></div>
    </div>
    <!-- En Ã‡ok Azalan -->
    <div class="card">
      <div style="font-weight:700;font-size:14px;margin-bottom:12px;">ğŸ“‰ En Ã‡ok Azalan</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Hisse</th><th>Fiyat</th><th>DeÄŸiÅŸim</th></tr></thead>
        <tbody id="topLosers"></tbody>
      </table></div>
    </div>
  </div>

  <div class="grid-2 mb-24">
    <!-- Hacim Liderleri -->
    <div class="card">
      <div style="font-weight:700;font-size:14px;margin-bottom:12px;">ğŸ“Š Hacim Liderleri</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Hisse</th><th>Fiyat</th><th>Hacim</th></tr></thead>
        <tbody id="volumeLeaders"></tbody>
      </table></div>
    </div>
    <!-- Gap AÃ§anlar -->
    <div class="card">
      <div style="font-weight:700;font-size:14px;margin-bottom:12px;">âš¡ Gap AÃ§anlar</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Hisse</th><th>Fiyat</th><th>Gap %</th></tr></thead>
        <tbody id="gapStocks"></tbody>
      </table></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• BIST 100 â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-bist100">
  <div class="flex-between mb-24">
    <div class="section-title"><span class="icon">ğŸ“‹</span> BIST 100 Hisseleri</div>
    <div class="flex-center gap-8">
      <select id="sectorFilter" onchange="loadBist100()">
        <option value="">TÃ¼m SektÃ¶rler</option>
      </select>
      <select id="sortFilter" onchange="loadBist100()">
        <option value="code">Kod</option>
        <option value="change">DeÄŸiÅŸim</option>
        <option value="volume">Hacim</option>
        <option value="price">Fiyat</option>
      </select>
    </div>
  </div>
  <div class="card">
    <div class="table-wrap"><table>
      <thead><tr>
        <th>Kod</th><th>Ä°sim</th><th>Fiyat</th><th>DeÄŸiÅŸim</th><th>DeÄŸiÅŸim %</th><th>Hacim</th><th>AÃ§Ä±lÄ±ÅŸ</th><th>YÃ¼ksek</th><th>DÃ¼ÅŸÃ¼k</th>
      </tr></thead>
      <tbody id="bist100Table"></tbody>
    </table></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• STOCK DETAIL â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-stock">
  <div id="stockDetailContent">
    <div class="empty-state">
      <div class="icon">ğŸ“ˆ</div>
      <div>Bir hisse seÃ§in veya arama yapÄ±n</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• COMMODITY DETAIL â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-commodity">
  <div id="commodityDetailContent">
    <div class="empty-state">
      <div class="icon">ğŸ¥‡</div>
      <div>Bir emtia seÃ§in (Dashboard'dan AltÄ±n/GÃ¼mÃ¼ÅŸ kartÄ±na tÄ±klayÄ±n)</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• WATCHLIST (FAVORÄ°LER) â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-watchlist">
  <div class="flex-between mb-24">
    <div class="section-title"><span class="icon">â­</span> Favori Hisselerim</div>
    <div class="flex-center gap-8">
      <input id="wlAddSymbol" placeholder="Hisse kodu (THYAO)" style="width:160px;">
      <button class="btn btn-primary btn-sm" onclick="addToWatchlist()">+ Ekle</button>
    </div>
  </div>
  <div id="watchlistLoginMsg" style="display:none;" class="card mb-24">
    <div class="empty-state">
      <div class="icon">ğŸ”’</div>
      <div>Favorileri kullanmak iÃ§in giriÅŸ yapÄ±n</div>
      <button class="btn btn-primary btn-sm" onclick="showLogin()" style="margin-top:12px;">GiriÅŸ Yap</button>
    </div>
  </div>
  <div class="card">
    <div class="table-wrap"><table>
      <thead><tr><th>Kod</th><th>Ä°sim</th><th>Fiyat</th><th>DeÄŸiÅŸim</th><th>DeÄŸiÅŸim %</th><th>Hacim</th><th></th></tr></thead>
      <tbody id="watchlistTable"></tbody>
    </table></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SCREENER â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-screener">
  <div class="section-title mb-24"><span class="icon">ğŸ”</span> Hisse TarayÄ±cÄ±</div>

  <!-- KoÅŸul AÃ§Ä±klamalarÄ± -->
  <div class="card mb-16" style="border:1px solid rgba(99,102,241,0.2);background:rgba(99,102,241,0.05);">
    <div class="collapsible-header" onclick="toggleSection(this)">
      <div style="font-weight:700;font-size:13px;color:var(--accent);">â„¹ï¸ KoÅŸullar NasÄ±l KullanÄ±lÄ±r?</div>
      <span class="collapse-icon">â–¼</span>
    </div>
    <div class="collapsible-body collapsed" style="max-height:800px;">
      <div style="font-size:12px;color:var(--text-secondary);line-height:1.8;padding-top:12px;">
        <div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:12px;">
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">RSI (GÃ¶receli GÃ¼Ã§ Endeksi)</div>
            0-100 arasÄ± deÄŸer alÄ±r. <b>RSI &lt; 30</b> â†’ AÅŸÄ±rÄ± satÄ±m (alÄ±ÅŸ fÄ±rsatÄ±). <b>RSI &gt; 70</b> â†’ AÅŸÄ±rÄ± alÄ±m (satÄ±ÅŸ sinyali).
            <br><i>Ã–rnek: RSI &lt; 30 â†’ AÅŸÄ±rÄ± satÄ±lan hisseleri bulur</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">Hacim OranÄ±</div>
            GÃ¼ncel hacim / ortalama hacim. <b>&gt; 2</b> â†’ Normalin 2 katÄ± iÅŸlem. Ani hacim artÄ±ÅŸÄ± fiyat kÄ±rÄ±lÄ±mÄ± habercisi olabilir.
            <br><i>Ã–rnek: Hacim OranÄ± &gt; 2 â†’ YÃ¼ksek iÅŸlem hacimli hisseler</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">ATR % (Ortalama GerÃ§ek AralÄ±k)</div>
            GÃ¼nlÃ¼k fiyat hareketinin yÃ¼zdesi. <b>YÃ¼ksek ATR</b> = yÃ¼ksek volatilite. Scalping ve day trade iÃ§in kullanÄ±lÄ±r.
            <br><i>Ã–rnek: ATR % &gt; 3 â†’ GÃ¼nlÃ¼k %3'ten fazla hareket eden hisseler</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">EMA Cross</div>
            EMA20 ve EMA50 kesiÅŸimi. <b>1</b> = EMA20 yukarÄ± kesti (altÄ±n kesiÅŸim, alÄ±ÅŸ). <b>-1</b> = EMA20 aÅŸaÄŸÄ± kesti (Ã¶lÃ¼m kesiÅŸimi, satÄ±ÅŸ).
            <br><i>Ã–rnek: EMA Cross &gt; 0 â†’ YukarÄ± trend baÅŸlayan hisseler</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">Breakout (KÄ±rÄ±lÄ±m)</div>
            FiyatÄ±n son 20 gÃ¼nlÃ¼k en yÃ¼ksek seviyeyi geÃ§mesi. <b>1</b> = yukarÄ± kÄ±rÄ±lÄ±m. Yeni yÃ¼kseliÅŸ trendinin habercisi.
            <br><i>Ã–rnek: Breakout &gt; 0 â†’ DirenÃ§ kÄ±ran hisseler</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">MACD Sinyal</div>
            MACD Ã§izgisi sinyal Ã§izgisini kestiÄŸinde. <b>1</b> = alÄ±ÅŸ sinyali (yukarÄ± kesiÅŸim). <b>-1</b> = satÄ±ÅŸ sinyali (aÅŸaÄŸÄ± kesiÅŸim).
            <br><i>Ã–rnek: MACD Sinyal &gt; 0 â†’ MACD alÄ±ÅŸ veren hisseler</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">Fiyat &gt; EMA20</div>
            KÄ±sa vadeli trendin Ã¼stÃ¼nde olan hisseler. <b>1</b> = fiyat EMA20'nin Ã¼stÃ¼nde. KÄ±sa vadeli yÃ¼kseliÅŸ trendi.
            <br><i>Ã–rnek: Fiyat &gt; EMA20 &gt; 0 â†’ KÄ±sa vadeli yÃ¼kseliÅŸte olanlar</i>
          </div>
          <div style="padding:8px;border-radius:6px;background:var(--card-bg);">
            <div style="font-weight:700;color:var(--text-primary);margin-bottom:4px;">Fiyat &gt; EMA50</div>
            Orta vadeli trendin Ã¼stÃ¼nde olan hisseler. <b>1</b> = fiyat EMA50'nin Ã¼stÃ¼nde. Orta vadeli yÃ¼kseliÅŸ trendi.
            <br><i>Ã–rnek: Fiyat &gt; EMA50 &gt; 0 â†’ Orta vadeli yÃ¼kseliÅŸte olanlar</i>
          </div>
        </div>
        <div style="margin-top:12px;padding:8px;border-radius:6px;background:var(--card-bg);border-left:3px solid var(--accent);">
          <b>Ä°pucu:</b> Birden fazla koÅŸul ekleyerek daha hassas tarama yapabilirsiniz.
          Ã–rneÄŸin: RSI &lt; 30 <b>VE</b> Hacim OranÄ± &gt; 1.5 â†’ AÅŸÄ±rÄ± satÄ±lan ama yÃ¼ksek hacimli hisseler (potansiyel dÃ¶nÃ¼ÅŸ sinyali).
        </div>
      </div>
    </div>
  </div>

  <div class="card mb-24">
    <div style="font-weight:700;margin-bottom:12px;">KoÅŸullar</div>
    <div id="screenerConditions">
      <div class="condition-row">
        <select class="sc-indicator" onchange="updateScreenerHint(this)">
          <option value="rsi">RSI (0-100)</option>
          <option value="volume_ratio">Hacim OranÄ± (x)</option>
          <option value="atr_pct">ATR % (volatilite)</option>
          <option value="ema_cross">EMA Cross (1/-1)</option>
          <option value="breakout">Breakout (0/1)</option>
          <option value="macd_signal">MACD Sinyal (1/-1)</option>
          <option value="price_above_ema20">Fiyat > EMA20 (0/1)</option>
          <option value="price_above_ema50">Fiyat > EMA50 (0/1)</option>
          <option value="changePct">GÃ¼nlÃ¼k DeÄŸiÅŸim %</option>
          <option value="price">Fiyat (TL)</option>
          <option value="volume">Hacim (lot)</option>
          <option value="gapPct">Gap %</option>
        </select>
        <select class="sc-operator">
          <option value=">">&gt;</option>
          <option value="<">&lt;</option>
          <option value=">=">&ge;</option>
          <option value="<=">&le;</option>
          <option value="==">=</option>
        </select>
        <input class="sc-value" placeholder="DeÄŸer" style="width:100px;">
        <button class="remove-condition" onclick="this.parentElement.remove()">âœ•</button>
      </div>
    </div>
    <div class="flex-center gap-8 mt-16">
      <button class="btn btn-secondary btn-sm" onclick="addScreenerCondition()">+ KoÅŸul Ekle</button>
      <select id="screenerSector" style="font-size:13px;">
        <option value="">TÃ¼m SektÃ¶rler</option>
      </select>
      <button class="btn btn-primary" onclick="runScreener()">Tara ğŸ”</button>
    </div>
    <!-- HazÄ±r tarama ÅŸablonlarÄ± -->
    <div style="margin-top:12px;display:flex;gap:6px;flex-wrap:wrap;">
      <button class="btn btn-sm" style="font-size:11px;background:rgba(16,185,129,0.1);color:var(--green);border:1px solid rgba(16,185,129,0.3);" onclick="applyScreenerTemplate('oversold')">AÅŸÄ±rÄ± SatÄ±m (RSI&lt;30)</button>
      <button class="btn btn-sm" style="font-size:11px;background:rgba(239,68,68,0.1);color:var(--red);border:1px solid rgba(239,68,68,0.3);" onclick="applyScreenerTemplate('overbought')">AÅŸÄ±rÄ± AlÄ±m (RSI&gt;70)</button>
      <button class="btn btn-sm" style="font-size:11px;background:rgba(99,102,241,0.1);color:var(--accent);border:1px solid rgba(99,102,241,0.3);" onclick="applyScreenerTemplate('highvolume')">YÃ¼ksek Hacim</button>
      <button class="btn btn-sm" style="font-size:11px;background:rgba(245,158,11,0.1);color:#F59E0B;border:1px solid rgba(245,158,11,0.3);" onclick="applyScreenerTemplate('breakout')">KÄ±rÄ±lÄ±m</button>
    </div>
  </div>

  <div class="card" id="screenerResults" style="display:none;">
    <div class="flex-between mb-16">
      <div style="font-weight:700;">SonuÃ§lar</div>
      <div id="screenerCount" style="font-size:12px;color:var(--text-secondary);"></div>
    </div>
    <div class="table-wrap"><table>
      <thead><tr><th>Kod</th><th>Ä°sim</th><th>Fiyat</th><th>DeÄŸiÅŸim %</th><th>RSI</th><th>Hacim Oran</th><th>EMA Cross</th></tr></thead>
      <tbody id="screenerTable"></tbody>
    </table></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• PORTFOLIO â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-portfolio">
  <div class="flex-between mb-24">
    <div class="section-title"><span class="icon">ğŸ’¼</span> PortfÃ¶y</div>
    <button class="btn btn-primary btn-sm" onclick="showAddPositionForm()">+ Pozisyon Ekle</button>
  </div>

  <!-- Ekleme Formu -->
  <div class="card mb-24" id="addPositionForm" style="display:none;">
    <div style="font-weight:700;margin-bottom:12px;">Yeni Pozisyon</div>
    <div class="flex-center gap-8" style="flex-wrap:wrap;">
      <input id="pfSymbol" placeholder="Hisse Kodu (THYAO)" style="width:140px;">
      <input id="pfQty" type="number" placeholder="Adet" style="width:100px;">
      <input id="pfCost" type="number" step="0.01" placeholder="Ort. Maliyet" style="width:140px;">
      <button class="btn btn-primary btn-sm" onclick="addPosition()">Ekle</button>
      <button class="btn btn-secondary btn-sm" onclick="document.getElementById('addPositionForm').style.display='none'">Ä°ptal</button>
    </div>
  </div>

  <!-- PortfÃ¶y Ã–zeti -->
  <div class="grid-4 mb-24" id="portfolioSummary"></div>

  <!-- Pozisyonlar -->
  <div class="card mb-24">
    <div style="font-weight:700;margin-bottom:12px;">Pozisyonlar</div>
    <div class="table-wrap"><table>
      <thead><tr><th>Hisse</th><th>Adet</th><th>Ort. Maliyet</th><th>GÃ¼ncel</th><th>Piyasa DeÄŸeri</th><th>Kar/Zarar</th><th>K/Z %</th><th>AÄŸÄ±rlÄ±k</th><th></th></tr></thead>
      <tbody id="portfolioTable"></tbody>
    </table></div>
  </div>

  <!-- Risk -->
  <div class="card" id="riskCard" style="display:none;">
    <div style="font-weight:700;margin-bottom:12px;">ğŸ“Š Risk Analizi</div>
    <div class="grid-4" id="riskMetrics"></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• BACKTEST â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-backtest">
  <div class="section-title mb-24"><span class="icon">ğŸ”„</span> Backtest</div>

  <div class="card mb-24">
    <div class="grid-3 gap-16" style="align-items:end;">
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">Hisse</label>
        <input id="btSymbol" placeholder="THYAO" style="width:100%;">
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">Strateji</label>
        <select id="btStrategy" style="width:100%;" onchange="updateBtParams()">
          <option value="ma_cross">MA Cross</option>
          <option value="breakout">Breakout</option>
          <option value="mean_reversion">Mean Reversion (RSI)</option>
        </select>
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">Periyot</label>
        <select id="btPeriod" style="width:100%;">
          <option value="1y">1 YÄ±l</option>
          <option value="2y" selected>2 YÄ±l</option>
          <option value="5y">5 YÄ±l</option>
        </select>
      </div>
    </div>
    <div class="grid-4 gap-16 mt-16" id="btParamsRow">
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">HÄ±zlÄ± MA</label>
        <input id="btParam1" type="number" value="20" style="width:100%;">
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">YavaÅŸ MA</label>
        <input id="btParam2" type="number" value="50" style="width:100%;">
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">Komisyon %</label>
        <input id="btCommission" type="number" value="0.1" step="0.01" style="width:100%;">
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">BaÅŸlangÄ±Ã§ â‚º</label>
        <input id="btCapital" type="number" value="100000" style="width:100%;">
      </div>
    </div>
    <div class="mt-16">
      <button class="btn btn-primary" onclick="runBacktest()">Backtest BaÅŸlat ğŸš€</button>
    </div>
  </div>

  <div id="btResults" style="display:none;">
    <div class="grid-4 mb-24" id="btMetrics"></div>
    <div class="card mb-24">
      <div style="font-weight:700;margin-bottom:12px;">Equity Curve</div>
      <div class="chart-container"><canvas id="btChart"></canvas></div>
    </div>
    <div class="card">
      <div style="font-weight:700;margin-bottom:12px;">Ä°ÅŸlem GeÃ§miÅŸi</div>
      <div class="table-wrap"><table>
        <thead><tr><th>Tarih</th><th>Ä°ÅŸlem</th><th>Fiyat</th><th>Adet</th><th>K/Z</th></tr></thead>
        <tbody id="btTrades"></tbody>
      </table></div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• ALERTS â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-alerts">
  <div class="flex-between mb-24">
    <div class="section-title"><span class="icon">ğŸ””</span> UyarÄ±lar</div>
    <button class="btn btn-primary btn-sm" onclick="if(!currentUser){showLogin();return;} document.getElementById('alertForm').style.display='block'">+ UyarÄ± Ekle</button>
  </div>

  <div class="card mb-24" id="alertForm" style="display:none;">
    <div style="font-weight:700;margin-bottom:12px;">Yeni UyarÄ±</div>
    <div class="grid-3 gap-16" style="align-items:end;">
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">Hisse</label>
        <input id="alertSymbol" placeholder="THYAO" style="width:100%;">
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">KoÅŸul</label>
        <select id="alertCondition" style="width:100%;">
          <option value="price_above">Fiyat ÃœstÃ¼nde</option>
          <option value="price_below">Fiyat AltÄ±nda</option>
          <option value="change_above">DeÄŸiÅŸim % ÃœstÃ¼nde</option>
          <option value="change_below">DeÄŸiÅŸim % AltÄ±nda</option>
        </select>
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:4px;">EÅŸik DeÄŸer</label>
        <input id="alertThreshold" type="number" step="0.01" placeholder="300" style="width:100%;">
      </div>
    </div>
    <div class="flex-center gap-8 mt-16">
      <button class="btn btn-primary btn-sm" onclick="createAlert()">OluÅŸtur</button>
      <button class="btn btn-secondary btn-sm" onclick="document.getElementById('alertForm').style.display='none'">Ä°ptal</button>
    </div>
  </div>

  <div class="card">
    <div class="table-wrap"><table>
      <thead><tr><th>Hisse</th><th>KoÅŸul</th><th>EÅŸik</th><th>Tetikleme</th><th>Durum</th><th></th></tr></thead>
      <tbody id="alertsTable"></tbody>
    </table></div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• HEATMAP â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-heatmap">
  <div class="section-title mb-24"><span class="icon">ğŸ—ºï¸</span> SektÃ¶r IsÄ± HaritasÄ±</div>
  <div id="heatmapContent">
    <div class="loading"><div class="spinner"></div>YÃ¼kleniyor...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• COMPARE â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-compare">
  <div class="section-title mb-24"><span class="icon">âš–ï¸</span> Hisse KarÅŸÄ±laÅŸtÄ±rma</div>
  <div class="card mb-24">
    <div style="font-weight:700;margin-bottom:12px;">KarÅŸÄ±laÅŸtÄ±rÄ±lacak Hisseler</div>
    <div class="flex-center gap-8" style="flex-wrap:wrap;">
      <input id="cmpInput1" placeholder="THYAO" style="width:100px;text-transform:uppercase;">
      <input id="cmpInput2" placeholder="PGSUS" style="width:100px;text-transform:uppercase;">
      <input id="cmpInput3" placeholder="TAVHL" style="width:100px;text-transform:uppercase;">
      <input id="cmpInput4" placeholder="" style="width:100px;text-transform:uppercase;">
      <button class="btn btn-primary" onclick="runCompare()">KarÅŸÄ±laÅŸtÄ±r</button>
    </div>
  </div>
  <div id="compareResults" style="display:none;"></div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• DAILY REPORT â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-report">
  <div class="section-title mb-24"><span class="icon">ğŸ“‹</span> Piyasa Raporu</div>
  <div id="reportContent">
    <div class="loading"><div class="spinner"></div>Rapor hazÄ±rlanÄ±yor...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• SINYAL TARAMA â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-signals">
  <div class="section-title mb-24" style="display:flex;align-items:center;justify-content:space-between;flex-wrap:wrap;gap:12px;">
    <span><span class="icon">ğŸ¯</span> Sinyal Tarama</span>
    <div class="flex-center gap-8">
      <select id="signalTimeframe" onchange="loadSignals()" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card-bg);color:var(--text-primary);font-size:13px;">
        <option value="weekly">HaftalÄ±k</option>
        <option value="monthly">AylÄ±k</option>
        <option value="yearly">YÄ±llÄ±k</option>
      </select>
      <select id="signalType" onchange="loadSignals()" style="padding:8px 12px;border-radius:8px;border:1px solid var(--border);background:var(--card-bg);color:var(--text-primary);font-size:13px;">
        <option value="all">TÃ¼mÃ¼</option>
        <option value="buy">Sadece AL</option>
        <option value="sell">Sadece SAT</option>
      </select>
    </div>
  </div>
  <div id="signalStats" class="grid-4 mb-24"></div>
  <div id="signalResults">
    <div class="loading"><div class="spinner"></div>TÃ¼m hisseler taranÄ±yor...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• FIRSAT Ã–ZETÄ° â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-opportunities">
  <div class="section-title mb-24"><span class="icon">ğŸ’¡</span> FÄ±rsat Ã–zeti</div>
  <div id="oppContent">
    <div class="loading"><div class="spinner"></div>FÄ±rsatlar araÅŸtÄ±rÄ±lÄ±yor...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• CANLI STRATEJÄ°LER â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-strategies">
  <div class="section-title mb-24"><span class="icon">âš¡</span> CanlÄ± Strateji Sinyalleri</div>
  <div id="strategyContent">
    <div class="loading"><div class="spinner"></div>Stratejiler hesaplanÄ±yor...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• TEMETTÃœ TAKVÄ°MÄ° â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-dividends">
  <div class="section-title mb-24"><span class="icon">ğŸ’°</span> TemettÃ¼ Takvimi</div>
  <div id="dividendContent">
    <div class="loading"><div class="spinner"></div>TemettÃ¼ bilgileri yÃ¼kleniyor...</div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• BES ANALÄ°Z â•â•â•â•â•â•â•â•â•â•â• -->
<div class="page" id="page-bes">
  <div class="section-title mb-24"><span class="icon">ğŸ¦</span> BES Fon Analiz & Ã–neri Sistemi</div>

  <!-- Top Fonlar Ozeti (otomatik yuklenir) -->
  <div id="besTopFundsSection" class="mb-24">
    <div class="card" style="border-left:3px solid var(--accent);">
      <div class="flex-between mb-16">
        <div style="font-weight:700;font-size:15px;">En Iyi Performans Gosteren Fonlar</div>
        <div style="display:flex;align-items:center;gap:8px;">
          <div style="display:flex;gap:2px;background:var(--bg-input);border-radius:8px;padding:2px;">
            <button onclick="besLoadTopFunds(true,'1a')" class="btn btn-sm bes-period-btn" id="besPeriod1a" style="font-size:10px;padding:4px 10px;border-radius:6px;background:transparent;color:var(--text-muted);border:none;cursor:pointer;">1 Ay</button>
            <button onclick="besLoadTopFunds(true,'3a')" class="btn btn-sm bes-period-btn" id="besPeriod3a" style="font-size:10px;padding:4px 10px;border-radius:6px;background:var(--accent);color:#fff;border:none;cursor:pointer;">3 Ay</button>
            <button onclick="besLoadTopFunds(true,'6a')" class="btn btn-sm bes-period-btn" id="besPeriod6a" style="font-size:10px;padding:4px 10px;border-radius:6px;background:transparent;color:var(--text-muted);border:none;cursor:pointer;">6 Ay</button>
          </div>
          <button class="btn btn-sm btn-secondary" onclick="besLoadTopFunds(true)" style="padding:4px 12px;font-size:11px;">Yenile</button>
        </div>
      </div>
      <div id="besTopFundsContent">
        <div class="loading"><div class="spinner"></div>En iyi fonlar yÃ¼kleniyor...</div>
      </div>
    </div>
  </div>

  <!-- Kategori Bazli Performans -->
  <div id="besCategoryOverview" class="mb-24" style="display:none;">
    <div class="card">
      <div style="font-weight:700;font-size:15px;margin-bottom:16px;">Kategori BazlÄ± Performans</div>
      <div id="besCategoryContent"></div>
    </div>
  </div>

  <!-- Risk Profili + Parametreler -->
  <div class="card" style="margin-bottom:20px;">
    <div style="font-weight:700;font-size:15px;margin-bottom:16px;color:var(--accent);">PortfÃ¶y Bilgilerinizi Girin</div>

    <div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:16px;margin-bottom:20px;">
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:6px;">Risk Profili</label>
        <select id="besRiskProfile" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-primary);font-size:13px;">
          <option value="conservative">Muhafazakar (DÃ¼ÅŸÃ¼k Risk)</option>
          <option value="moderate" selected>Dengeli (Orta Risk)</option>
          <option value="aggressive">Agresif (YÃ¼ksek Risk)</option>
        </select>
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:6px;">AylÄ±k KatkÄ± PayÄ± (TL)</label>
        <input id="besMonthly" type="number" value="2000" min="100" step="100" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-primary);font-size:13px;">
      </div>
      <div>
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:6px;">YatÄ±rÄ±m SÃ¼resi (Ay)</label>
        <select id="besHorizon" style="width:100%;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-primary);font-size:13px;">
          <option value="1">1 Ay</option>
          <option value="3">3 Ay</option>
          <option value="6">6 Ay</option>
          <option value="12">12 Ay (1 YÄ±l)</option>
          <option value="24">24 Ay (2 YÄ±l)</option>
          <option value="36" selected>36 Ay (3 YÄ±l)</option>
          <option value="60">60 Ay (5 YÄ±l)</option>
          <option value="120">120 Ay (10 YÄ±l)</option>
        </select>
      </div>
    </div>

    <!-- Mevcut Fonlar -->
    <div style="font-weight:600;font-size:13px;margin-bottom:10px;color:var(--text-secondary);">Mevcut FonlarÄ±nÄ±z (opsiyonel)</div>
    <div id="besFundInputs" style="margin-bottom:12px;">
      <div class="bes-fund-row" style="display:flex;gap:10px;margin-bottom:8px;align-items:center;">
        <input type="text" placeholder="Fon Kodu (Ã¶r: IPB)" class="bes-fund-code" style="flex:2;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-primary);font-size:13px;text-transform:uppercase;">
        <input type="number" placeholder="%" class="bes-fund-pct" value="100" min="0" max="100" style="flex:1;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-primary);font-size:13px;">
        <button onclick="this.parentElement.remove()" style="background:var(--red-bg);color:var(--red);border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-size:16px;">Ã—</button>
      </div>
    </div>
    <div style="display:flex;gap:10px;flex-wrap:wrap;">
      <button onclick="besAddFundRow()" class="btn btn-secondary btn-sm">+ Fon Ekle</button>
      <button onclick="besAnalyze()" class="btn btn-primary" style="padding:10px 28px;font-weight:700;">Analiz Et & Ã–neri Al</button>
      <button onclick="besLoadFunds()" class="btn btn-secondary btn-sm">TÃ¼m FonlarÄ± Listele</button>
    </div>
  </div>

  <!-- Sonuc alani -->
  <div id="besResults" style="display:none;">

    <!-- Ozet kartlar -->
    <div id="besSummaryCards" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:14px;margin-bottom:20px;"></div>

    <!-- Mevcut vs Onerilen Karsilastirma -->
    <div id="besComparison" style="display:none;" class="card" style="margin-bottom:20px;">
      <div style="font-weight:700;font-size:15px;margin-bottom:12px;">Mevcut PortfÃ¶y vs Ã–neri</div>
      <div id="besComparisonContent"></div>
    </div>

    <!-- Oneri Tablosu -->
    <div class="card" style="margin-bottom:20px;">
      <div style="font-weight:700;font-size:15px;margin-bottom:12px;color:var(--accent);">Ã–nerilen Fon DaÄŸÄ±lÄ±mÄ±</div>
      <div id="besRecommendations" style="overflow-x:auto;"></div>
    </div>

    <!-- Simulasyon -->
    <div class="card" style="margin-bottom:20px;">
      <div style="font-weight:700;font-size:15px;margin-bottom:12px;color:var(--green);">Birikim Projeksiyonu</div>
      <div id="besSimulation"></div>
      <canvas id="besSimChart" style="margin-top:16px;max-height:300px;"></canvas>
    </div>

    <!-- Fon Detaylari -->
    <div id="besFundDetails" class="card" style="display:none;margin-bottom:20px;">
      <div style="font-weight:700;font-size:15px;margin-bottom:12px;">Fon BazlÄ± Birikim DetayÄ±</div>
      <div id="besFundDetailsContent"></div>
    </div>
  </div>

  <!-- Fon Listesi -->
  <div id="besFundList" style="display:none;">
    <div class="card">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:16px;flex-wrap:wrap;gap:10px;">
        <div style="font-weight:700;font-size:15px;">BES Fon Listesi</div>
        <div style="display:flex;gap:8px;flex-wrap:wrap;">
          <select id="besCategoryFilter" onchange="besFilterFunds()" style="padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-primary);font-size:12px;">
            <option value="">TÃ¼m Kategoriler</option>
            <option value="hisse">Hisse Senedi</option>
            <option value="borclanma">BorÃ§lanma AraÃ§larÄ±</option>
            <option value="katilim">KatÄ±lÄ±m</option>
            <option value="karma">Karma / Dengeli</option>
            <option value="doviz">DÃ¶viz</option>
            <option value="altin">AltÄ±n / KÄ±ymetli Maden</option>
            <option value="endeks">Endeks</option>
            <option value="para_piyasasi">Para PiyasasÄ±</option>
            <option value="standart">Standart</option>
          </select>
          <input id="besFundSearch" onkeyup="besFilterFunds()" placeholder="Fon ara..." style="padding:8px 10px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-primary);font-size:12px;width:160px;">
        </div>
      </div>
      <div id="besFundListContent" style="overflow-x:auto;"></div>
    </div>
  </div>

  <!-- Loading -->
  <div id="besLoading" style="display:none;">
    <div class="card" style="text-align:center;padding:48px;">
      <div class="spinner" style="margin:0 auto 16px;"></div>
      <div style="font-size:15px;font-weight:600;" id="besLoadingText">TEFAS'tan fon verileri Ã§ekiliyor...</div>
      <div style="font-size:12px;color:var(--text-muted);margin-top:8px;">Bu iÅŸlem birkaÃ§ dakika sÃ¼rebilir</div>
    </div>
  </div>
</div>

<!-- â•â•â•â•â•â•â•â•â•â•â• LOGIN MODAL â•â•â•â•â•â•â•â•â•â•â• -->
<div id="loginModal" onclick="if(event.target===this)closeLogin()" style="display:none;position:fixed;inset:0;background:rgba(0,0,0,0.75);z-index:1000;align-items:center;justify-content:center;backdrop-filter:blur(4px);">
  <div style="width:400px;max-width:92vw;background:var(--card-bg);border:1px solid var(--border);border-radius:16px;overflow:hidden;box-shadow:0 24px 48px rgba(0,0,0,0.4);">
    <!-- Header with icon -->
    <div style="text-align:center;padding:28px 24px 0;">
      <div style="width:56px;height:56px;border-radius:50%;background:linear-gradient(135deg,var(--accent),#f7c948);margin:0 auto 12px;display:flex;align-items:center;justify-content:center;font-size:24px;">
        <svg width="28" height="28" fill="none" stroke="#000" stroke-width="2.5" stroke-linecap="round" stroke-linejoin="round" viewBox="0 0 24 24"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      </div>
      <div style="font-weight:700;font-size:18px;color:var(--text-primary);" id="authTitle">HesabÄ±nÄ±za GiriÅŸ YapÄ±n</div>
      <div style="font-size:12px;color:var(--text-muted);margin-top:4px;" id="authSubtitle">PortfÃ¶y ve favorilerinize eriÅŸin</div>
    </div>
    <!-- Tab Switcher -->
    <div style="display:flex;margin:20px 24px 0;background:var(--bg);border-radius:10px;padding:3px;gap:3px;">
      <button id="tabLogin" onclick="switchAuthTab('login')" style="flex:1;padding:10px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;background:var(--accent);color:#000;">GiriÅŸ Yap</button>
      <button id="tabRegister" onclick="switchAuthTab('register')" style="flex:1;padding:10px;border:none;border-radius:8px;font-size:13px;font-weight:600;cursor:pointer;transition:all .2s;background:transparent;color:var(--text-muted);">KayÄ±t Ol</button>
    </div>
    <!-- Form -->
    <div style="padding:20px 24px 24px;">
      <div style="margin-bottom:14px;">
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:6px;font-weight:500;">KullanÄ±cÄ± AdÄ±</label>
        <input id="authUsername" placeholder="ornek: ahmet123" style="width:100%;padding:11px 14px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text-primary);font-size:14px;outline:none;transition:border-color .2s;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'" onkeydown="if(event.key==='Enter')doAuth()">
      </div>
      <div style="margin-bottom:14px;">
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:6px;font-weight:500;">Åifre</label>
        <input id="authPassword" type="password" placeholder="En az 4 karakter" style="width:100%;padding:11px 14px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text-primary);font-size:14px;outline:none;transition:border-color .2s;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'" onkeydown="if(event.key==='Enter')doAuth()">
      </div>
      <div id="authEmailRow" style="margin-bottom:14px;display:none;">
        <label style="font-size:12px;color:var(--text-muted);display:block;margin-bottom:6px;font-weight:500;">E-posta <span style="opacity:0.6">(opsiyonel)</span></label>
        <input id="authEmail" placeholder="email@ornek.com" style="width:100%;padding:11px 14px;border-radius:10px;border:1px solid var(--border);background:var(--bg);color:var(--text-primary);font-size:14px;outline:none;transition:border-color .2s;" onfocus="this.style.borderColor='var(--accent)'" onblur="this.style.borderColor='var(--border)'" onkeydown="if(event.key==='Enter')doAuth()">
      </div>
      <div id="authError" style="color:var(--red);font-size:12px;margin-bottom:10px;display:none;padding:8px 12px;background:rgba(234,57,67,0.1);border-radius:8px;"></div>
      <div id="authSuccess" style="color:var(--green);font-size:12px;margin-bottom:10px;display:none;padding:8px 12px;background:rgba(0,229,160,0.1);border-radius:8px;"></div>
      <button class="btn btn-primary" onclick="doAuth()" id="authSubmitBtn" style="width:100%;padding:12px;font-size:14px;font-weight:600;border-radius:10px;background:var(--accent);color:#000;border:none;cursor:pointer;margin-bottom:10px;">GiriÅŸ Yap</button>
      <button class="btn btn-secondary" onclick="closeLogin()" style="width:100%;padding:10px;font-size:13px;border-radius:10px;background:transparent;color:var(--text-muted);border:1px solid var(--border);cursor:pointer;">Ä°ptal</button>
    </div>
  </div>
</div>

</div><!-- /main -->

<script>
// =============================================================================
// CONFIG
// =============================================================================
const API_BASE = window.location.origin + '/api';
let currentChart = null; // legacy compat
let btChartInstance = null;

// =============================================================================
// LOADING POPUP
// =============================================================================
let _loadingDismissed = false;
let _loadingProgress = 0;

// Safety net: auto-dismiss loading popup after 20 seconds no matter what
setTimeout(() => { if (!_loadingDismissed) dismissLoadingPopup(); }, 20000);

function updateLoadingProgress(pct, status) {
  _loadingProgress = Math.min(pct, 100);
  const bar = document.getElementById('lpProgress');
  const txt = document.getElementById('lpStatus');
  if (bar) bar.style.width = _loadingProgress + '%';
  if (txt) txt.textContent = status || '';
  if (_loadingProgress >= 100) {
    setTimeout(() => dismissLoadingPopup(), 600);
  }
}

function dismissLoadingPopup() {
  if (_loadingDismissed) return;
  _loadingDismissed = true;
  const overlay = document.getElementById('loadingOverlay');
  if (overlay) {
    overlay.classList.add('fade-out');
    setTimeout(() => { overlay.style.display = 'none'; }, 400);
  }
}

// =============================================================================
// NAVIGATION
// =============================================================================
function navigate(page, params) {
  document.querySelectorAll('.page').forEach(p => p.classList.remove('active'));
  document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));

  const el = document.getElementById('page-' + page);
  if (el) { el.classList.add('active'); el.classList.add('fade-in'); }

  const nav = document.querySelector(`.nav-link[data-page="${page}"]`);
  if (nav) nav.classList.add('active');

  // Close mobile nav
  document.querySelector('.nav-links').classList.remove('show');

  // Load data
  switch(page) {
    case 'dashboard': loadDashboard(); break;
    case 'bist100': loadBist100(); break;
    case 'stock': if(params?.symbol) loadStockDetail(params.symbol); break;
    case 'commodity': if(params?.symbol) loadCommodityDetail(params.symbol); break;
    case 'screener': loadSectors('screenerSector'); break;
    case 'portfolio': loadPortfolio(); break;
    case 'watchlist': loadWatchlist(); break;
    case 'backtest': break;
    case 'alerts': loadAlerts(); break;
    case 'heatmap': loadHeatmap(); break;
    case 'compare': break;
    case 'report': loadReport(); break;
    case 'signals': loadSignals(); break;
    case 'opportunities': loadOpportunities(); break;
    case 'strategies': loadStrategies(); break;
    case 'dividends': loadDividends(); break;
    case 'bes': besLoadTopFunds(); break;
  }
}

function goToStock(symbol) {
  navigate('stock', { symbol });
}

function goToCommodity(symbol) {
  navigate('commodity', { symbol });
}

// =============================================================================
// API HELPER
// =============================================================================
async function api(path, options = {}) {
  try {
    const controller = new AbortController();
    const timeoutMs = path.includes('/signals') || path.includes('/opportunities') || path.includes('/strategies') || path.includes('/dividends') || path.includes('/bes') ? 180000 : 30000;
    const timer = setTimeout(() => controller.abort(), timeoutMs);
    const res = await fetch(API_BASE + path, {
      headers: { 'Content-Type': 'application/json' },
      signal: controller.signal,
      ...options,
    });
    clearTimeout(timer);
    const text = await res.text();
    try {
      return JSON.parse(text);
    } catch(parseErr) {
      console.error('API JSON parse error:', path, text.substring(0, 200));
      return { error: 'Sunucudan geÃ§ersiz yanÄ±t geldi. LÃ¼tfen sayfayÄ± yenileyin.', status: res.status };
    }
  } catch(e) {
    console.error('API Error:', path, e);
    if (e.name === 'AbortError') return { error: 'Sunucu yanÄ±t sÃ¼resini aÅŸtÄ±. Veriler arka planda hazÄ±rlanÄ±yor, lÃ¼tfen biraz bekleyip tekrar deneyin.' };
    return { error: e.message };
  }
}

// =============================================================================
// FORMATTERS
// =============================================================================
function fmtPrice(v) { return v != null ? Number(v).toLocaleString('tr-TR', {minimumFractionDigits:2, maximumFractionDigits:2}) : '-'; }
function fmtPct(v) { return v != null ? (v >= 0 ? '+' : '') + Number(v).toFixed(2) + '%' : '-'; }
function fmtVolume(v) {
  if (!v) return '-';
  if (v >= 1e9) return (v/1e9).toFixed(1) + 'B';
  if (v >= 1e6) return (v/1e6).toFixed(1) + 'M';
  if (v >= 1e3) return (v/1e3).toFixed(0) + 'K';
  return v.toString();
}
function fmtMoney(v) { return 'â‚º' + fmtPrice(v); }
function changeClass(v) { return v >= 0 ? 'price-up' : 'price-down'; }
function signalBadge(s) {
  if (s === 'buy') return '<span class="badge badge-green">AL</span>';
  if (s === 'sell') return '<span class="badge badge-red">SAT</span>';
  return '<span class="badge badge-neutral">NÃ–TR</span>';
}

// =============================================================================
// SEARCH
// =============================================================================
function escHtml(s) {
  return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/"/g,'&quot;').replace(/'/g,'&#39;');
}
let searchTimeout;
function onSearch(q) {
  clearTimeout(searchTimeout);
  const dd = document.getElementById('searchDropdown');
  if (!q || q.length < 1) { dd.classList.remove('show'); return; }
  searchTimeout = setTimeout(async () => {
    const data = await api('/search?q=' + encodeURIComponent(q));
    if (data.results && data.results.length > 0) {
      dd.innerHTML = data.results.map(r => {
        const code = escHtml(r.code);
        const name = escHtml(r.name);
        return `<div class="search-result-item" onclick="goToStock('${code}');document.getElementById('searchDropdown').classList.remove('show');document.getElementById('globalSearch').value='';">
          <span class="search-result-code">${code}</span>
          <span class="search-result-name">${name}</span>
        </div>`;
      }).join('');
      dd.classList.add('show');
    } else {
      dd.innerHTML = '<div style="padding:12px;color:var(--text-muted);font-size:13px;">SonuÃ§ bulunamadÄ±</div>';
      dd.classList.add('show');
    }
  }, 200);
}
document.addEventListener('click', e => {
  if (!e.target.closest('.nav-search')) document.getElementById('searchDropdown').classList.remove('show');
});

// =============================================================================
// DASHBOARD (page-level cache: sayfa gecisleri icin)
// =============================================================================
const _pageCache = {};
const PAGE_CACHE_TTL = 300000; // 5 dakika (sayfalar arasÄ± geÃ§iÅŸlerde tekrar yÃ¼klemeyi Ã¶nler)
const CACHE_TTL_SHORT = 60000; // 1 dakika (sÄ±k gÃ¼ncellenen veriler)

function _getCached(key, customTtl) {
  const c = _pageCache[key];
  const ttl = customTtl || PAGE_CACHE_TTL;
  if (c && Date.now() - c.ts < ttl) return c.data;
  return null;
}
function _setCache(key, data) {
  _pageCache[key] = { data, ts: Date.now() };
}

function _dashboardStatusMsg(html) {
  // Hata/yÃ¼kleme mesajlarÄ±nÄ± endeks kartlarÄ±na DEÄÄ°L, ayrÄ± div'e yaz
  const el = document.getElementById('dashboardStatus');
  if (!el) return;
  el.style.display = html ? '' : 'none';
  el.innerHTML = html || '';
}

async function loadDashboard(forceRefresh) {
  // Endeks kartlarÄ±: tamamen baÄŸÄ±msÄ±z yÃ¼kle, dashboard ile karÄ±ÅŸmasÄ±n
  updateLoadingProgress(10, 'Endeksler yÃ¼kleniyor...');
  loadIndices();

  // Piyasa Rejimi + Favoriler (baÄŸÄ±msÄ±z paralel)
  _loadDashboardRegime();
  _loadDashboardWatchlist();

  // Ã–nceki veri varsa hemen render et
  const cached = forceRefresh ? null : _getCached('dashboard');
  if (cached && cached.allStocks && cached.allStocks.length > 0) {
    _dashboardStatusMsg('');
    renderDashboard(cached);
    updateLoadingProgress(100, 'Veriler hazÄ±r!');
    if (!forceRefresh) return;
  }

  updateLoadingProgress(30, 'Hisse verileri Ã§ekiliyor...');
  let data;
  // api() kendi iÃ§inde hatalarÄ± yakalar ve {error:...} dÃ¶ner â€” fÄ±rlatmaz
  data = await api('/dashboard');

  if (data.error && !data.success) {
    dismissLoadingPopup();
    if (cached) { renderDashboard(cached); return; }
    _dashboardStatusMsg(`
      <div class="card" style="text-align:center;padding:20px;">
        <div style="color:var(--yellow);margin-bottom:8px;font-weight:600;">âš ï¸ Veri yÃ¼klenirken sorun oluÅŸtu</div>
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">${data.error}</div>
        <button class="btn btn-primary btn-sm" onclick="loadDashboard(true)">Tekrar Dene</button>
      </div>`);
    return;
  }

  if (data.loading || (data.allStocks && data.allStocks.length === 0)) {
    dismissLoadingPopup();
    if (cached) { _dashboardStatusMsg(''); renderDashboard(cached); return; }
    _dashboardStatusMsg(`
      <div class="card" style="text-align:center;padding:20px;">
        <div class="spinner" style="margin:0 auto 12px;"></div>
        <div style="color:var(--yellow);margin-bottom:8px;font-weight:600;">${data.message || 'Hisse verileri yÃ¼kleniyor...'}</div>
        <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Sunucu arka planda veri Ã§ekiyor, otomatik yenilenecek...</div>
        <button class="btn btn-primary btn-sm" onclick="loadDashboard(true)">Åimdi Yenile</button>
      </div>`);
    setTimeout(() => loadDashboard(), 10000);
    return;
  }

  _dashboardStatusMsg(''); // BaÅŸarÄ±lÄ± veri: status div'i temizle
  updateLoadingProgress(90, 'Dashboard render ediliyor...');
  _setCache('dashboard', data);
  renderDashboard(data);
  updateLoadingProgress(100, 'Veriler hazÄ±r!');
}

function renderDashboard(data) {
  // Meta bar (lastUpdated + stale badge)
  const meta = data.meta || {};
  const qualityBadge = document.getElementById('dataQualityBadge');
  const lastUpdatedEl = document.getElementById('lastUpdatedText');
  if (meta.dataQuality === 'stale') {
    qualityBadge.className = 'badge badge-yellow'; qualityBadge.textContent = 'ESKÄ° VERÄ°';
  } else if (meta.dataQuality === 'loading') {
    qualityBadge.className = 'badge badge-blue'; qualityBadge.textContent = 'YÃœKLENÄ°YOR';
  } else if (meta.dataQuality === 'expired') {
    qualityBadge.className = 'badge badge-red'; qualityBadge.textContent = 'SÃœRESI DOLMUÅ';
  } else {
    qualityBadge.className = 'badge badge-green'; qualityBadge.textContent = 'CANLI';
  }
  if (meta.lastUpdated) {
    try {
      const d = new Date(meta.lastUpdated);
      lastUpdatedEl.textContent = 'Son gÃ¼ncelleme: ' + d.toLocaleTimeString('tr-TR', {hour:'2-digit',minute:'2-digit',second:'2-digit'});
    } catch(e) { lastUpdatedEl.textContent = ''; }
  }

  // Breadth
  const mb = data.marketBreadth || {};
  const total = (mb.advancing||0) + (mb.declining||0) + (mb.unchanged||0) || 1;
  document.getElementById('breadthAdv').style.width = (mb.advancing/total*100) + '%';
  document.getElementById('breadthUnc').style.width = (mb.unchanged/total*100) + '%';
  document.getElementById('breadthDec').style.width = (mb.declining/total*100) + '%';
  document.getElementById('advCount').textContent = mb.advancing || 0;
  document.getElementById('uncCount').textContent = mb.unchanged || 0;
  document.getElementById('decCount').textContent = mb.declining || 0;
  document.getElementById('breadthStats').textContent = `A/D OranÄ±: ${mb.advDecRatio || '-'} | Toplam: ${total} hisse`;

  // Movers tables
  renderMoverTable('topGainers', data.movers?.topGainers, 'changePct');
  renderMoverTable('topLosers', data.movers?.topLosers, 'changePct');
  renderMoverTable('volumeLeaders', data.movers?.volumeLeaders, 'volume', true);
  renderMoverTable('gapStocks', data.movers?.gapStocks, 'gapPct');
}

async function _loadDashboardRegime() {
  try {
    const data = await api('/market/regime');
    if (!data.success) return;
    const el = document.getElementById('dashRegimeContent');
    const regimeEmoji = {'strong_bull':'ğŸ‚ğŸ‚','bull':'ğŸ‚','strong_bear':'ğŸ»ğŸ»','bear':'ğŸ»','sideways':'â†”ï¸'}[data.regime] || 'â“';
    const regimeColor = {'strong_bull':'var(--green)','bull':'#4CAF50','strong_bear':'var(--red)','bear':'#FF9800','sideways':'var(--yellow)'}[data.regime] || 'var(--text-secondary)';
    el.innerHTML = `
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:6px;">
        <span style="font-size:20px;">${regimeEmoji}</span>
        <span style="font-weight:700;color:${regimeColor};font-size:15px;">${data.description || data.regime}</span>
      </div>
      <div style="background:var(--bg-input);border-radius:4px;height:6px;overflow:hidden;margin-bottom:6px;">
        <div style="height:100%;width:${data.strength || 0}%;background:${regimeColor};border-radius:4px;"></div>
      </div>
      <div style="font-size:11px;color:var(--text-muted);">GÃ¼Ã§: %${data.strength || 0} | Skor: ${data.score || 0}</div>
      ${(data.reasons||[]).slice(0,2).map(r => `<div style="font-size:11px;color:var(--text-muted);margin-top:2px;">â€¢ ${r}</div>`).join('')}
    `;
  } catch(e) {}
}

async function _loadDashboardWatchlist() {
  try {
    const user = typeof currentUser !== 'undefined' ? currentUser : null;
    if (!user || !user.userId) {
      document.getElementById('dashWatchlistContent').innerHTML = '<div style="color:var(--text-muted);font-size:12px;">GiriÅŸ yaparak favorilerinizi gÃ¶rebilirsiniz.</div>';
      return;
    }
    const data = await api('/watchlist?userId=' + user.userId);
    if (!data.success || !data.watchlist || data.watchlist.length === 0) {
      document.getElementById('dashWatchlistContent').innerHTML = '<div style="color:var(--text-muted);font-size:12px;">HenÃ¼z favori eklenmemiÅŸ.</div>';
      return;
    }
    const el = document.getElementById('dashWatchlistContent');
    el.innerHTML = data.watchlist.slice(0,5).map(s => `
      <div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid var(--border);cursor:pointer;" onclick="goToStock('${s.code}')">
        <span style="font-family:var(--font-mono);font-weight:700;color:var(--accent);font-size:12px;">${s.code}</span>
        <span style="font-family:var(--font-mono);font-size:12px;">${fmtPrice(s.price)}</span>
        <span class="${changeClass(s.changePct)}" style="font-family:var(--font-mono);font-size:11px;">${fmtPct(s.changePct)}</span>
      </div>
    `).join('') + (data.watchlist.length > 5 ? `<div style="text-align:center;margin-top:4px;font-size:11px;color:var(--text-muted);">+${data.watchlist.length - 5} daha</div>` : '');
  } catch(e) {}
}

async function loadIndices() {
  const cached = _getCached('indices');
  if (cached && cached.indices && Object.keys(cached.indices).length > 0) {
    renderIndicesCards(cached.indices);
    updateLoadingProgress(25, "Endeksler cache'den yÃ¼klendi");
    return;
  }

  let data;
  try {
    data = await api('/indices');
  } catch(e) {
    // AÄŸ hatasÄ± â€” Ã¶nce cache'den dene, yoksa yenile butonu gÃ¶ster
    if (cached && cached.indices) { renderIndicesCards(cached.indices); return; }
    document.getElementById('indicesCards').innerHTML = `
      <div class="index-card" style="grid-column:1/-1;text-align:center;padding:16px;">
        <div style="color:var(--yellow);margin-bottom:8px;">âš ï¸ Endeks verisi alÄ±namadÄ±</div>
        <button class="btn btn-sm btn-secondary" onclick="loadIndices()">Tekrar Dene</button>
      </div>`;
    return;
  }

  if (!data.success || !data.indices || Object.keys(data.indices).length === 0) {
    // HenÃ¼z yÃ¼kleniyor
    document.getElementById('indicesCards').innerHTML = `
      <div class="index-card" style="grid-column:1/-1;text-align:center;padding:16px;">
        <div class="spinner" style="margin:0 auto 8px;width:20px;height:20px;border-width:2px;"></div>
        <div style="color:var(--text-muted);margin-bottom:8px;">Endeks verileri yÃ¼kleniyor...</div>
        <button class="btn btn-sm btn-secondary" onclick="loadIndices()">Yenile</button>
      </div>`;
    setTimeout(() => loadIndices(), 8000);
    return;
  }

  _setCache('indices', data);
  updateLoadingProgress(25, 'Endeksler yÃ¼klendi');
  renderIndicesCards(data.indices);
}

function renderIndicesCards(idx) {
  const currencyMap = {'GOLD':'$','SILVER':'$','USDTRY':'â‚º','EURTRY':'â‚º','GOLDTL':'â‚º','SILVERTL':'â‚º'};
  const commodityKeys = ['GOLD','SILVER','GOLDTL','SILVERTL','USDTRY','EURTRY'];
  const cards = Object.entries(idx).map(([key, val]) => {
    const cur = currencyMap[key] || '';
    const clickable = commodityKeys.includes(key);
    const clickAttr = clickable ? `onclick="goToCommodity('${key}')" style="cursor:pointer;"` : '';
    return `<div class="index-card" ${clickAttr}>
      <div class="label">${val.name}${clickable ? ' <span style="font-size:9px;opacity:0.5;">detay</span>' : ''}</div>
      <div class="value">${fmtPrice(val.value)} ${cur}</div>
      <div class="change ${changeClass(val.changePct)}">
        ${(val.changePct||0) >= 0 ? 'â–²' : 'â–¼'} ${fmtPct(val.changePct)}
      </div>
    </div>`;
  }).join('');
  document.getElementById('indicesCards').innerHTML = cards;
}

function renderMoverTable(id, stocks, metric, isVolume) {
  if (!stocks) return;
  document.getElementById(id).innerHTML = stocks.map(s => `
    <tr class="stock-row" onclick="goToStock('${s.code}')">
      <td><span class="td-clickable td-mono">${s.code}</span></td>
      <td class="td-mono">${fmtPrice(s.price)}</td>
      <td class="td-mono ${isVolume ? '' : changeClass(s[metric])}">
        ${isVolume ? fmtVolume(s[metric]) : fmtPct(s[metric])}
      </td>
    </tr>
  `).join('');
}

// =============================================================================
// BIST 100
// =============================================================================
async function loadBist100() {
  const sector = document.getElementById('sectorFilter').value;
  const sort = document.getElementById('sortFilter').value;
  const params = new URLSearchParams({ sort, order: 'desc' });
  if (sector) params.set('sector', sector);

  const cacheKey = 'bist100_' + sector + '_' + sort;

  // Cache'den gÃ¶ster
  const cached = _getCached(cacheKey);
  if (cached && cached.stocks && cached.stocks.length > 0) {
    renderBist100(cached);
    return;
  }

  document.getElementById('bist100Table').innerHTML = '<tr><td colspan="9"><div class="loading"><div class="spinner"></div>YÃ¼kleniyor...</div></td></tr>';

  const data = await api('/bist100?' + params.toString());
  if (!data.success) return;

  if (data.loading || !data.stocks || data.stocks.length === 0) {
    document.getElementById('bist100Table').innerHTML = `<tr><td colspan="9"><div class="loading"><div class="spinner"></div>${data.message || 'Veriler yÃ¼kleniyor... Otomatik yenilenecek.'}</div></td></tr>`;
    setTimeout(() => loadBist100(), 10000);
    return;
  }

  _setCache(cacheKey, data);
  renderBist100(data);
}

function renderBist100(data) {
  // SektÃ¶r filtresi doldur
  if (data.sectors) {
    const sel = document.getElementById('sectorFilter');
    if (sel.options.length <= 1) {
      data.sectors.forEach(s => {
        const opt = document.createElement('option');
        opt.value = s; opt.textContent = s.charAt(0).toUpperCase() + s.slice(1);
        sel.appendChild(opt);
      });
    }
  }

  document.getElementById('bist100Table').innerHTML = (data.stocks || []).map(s => `
    <tr class="stock-row" onclick="goToStock('${s.code}')">
      <td class="td-mono td-clickable">${s.code}</td>
      <td>${s.name}</td>
      <td class="td-mono">${fmtPrice(s.price)}</td>
      <td class="td-mono ${changeClass(s.change)}">${s.change >= 0 ? '+' : ''}${fmtPrice(s.change)}</td>
      <td class="td-mono ${changeClass(s.changePct)}">${fmtPct(s.changePct)}</td>
      <td class="td-mono">${fmtVolume(s.volume)}</td>
      <td class="td-mono">${fmtPrice(s.open)}</td>
      <td class="td-mono">${fmtPrice(s.high)}</td>
      <td class="td-mono">${fmtPrice(s.low)}</td>
    </tr>
  `).join('');
}

async function loadSectors(selectId) {
  const data = await api('/sectors');
  if (!data.success) return;
  const sel = document.getElementById(selectId);
  if (sel && sel.options.length <= 1) {
    (data.sectors||[]).forEach(s => {
      const opt = document.createElement('option');
      opt.value = s.name; opt.textContent = s.name.charAt(0).toUpperCase() + s.name.slice(1) + ` (${s.avgChange >= 0 ? '+' : ''}${s.avgChange}%)`;
      sel.appendChild(opt);
    });
  }
}

// =============================================================================
// STOCK DETAIL
// =============================================================================
let _stockDetailSymbol = null; // race condition guard
async function loadStockDetail(symbol, period) {
  period = period || '1y';
  _stockDetailSymbol = symbol; // mark current request
  const container = document.getElementById('stockDetailContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>Hisse verisi yÃ¼kleniyor...</div>';

  // Nav'Ä± gÃ¼ncelle
  document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));

  const [stockData, eventsData] = await Promise.all([
    api('/stock/' + symbol + '?period=' + period),
    api('/stock/' + symbol + '/events')
  ]);

  // If user navigated to a different stock while this was loading, discard
  if (_stockDetailSymbol !== symbol) return;

  if (stockData.error && !stockData.success) {
    container.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><div>Hata: ${stockData.error}</div></div>`;
    return;
  }

  if (stockData.loading && (!stockData.indicators || Object.keys(stockData.indicators).length === 0)) {
    container.innerHTML = `<div class="empty-state"><div class="spinner" style="margin:0 auto 16px;"></div><div style="color:var(--yellow);">â³ ${stockData.message || 'Veri yÃ¼kleniyor...'}</div><div style="font-size:12px;color:var(--text-muted);margin-top:8px;">Ä°lk yÃ¼kleme birkaÃ§ saniye sÃ¼rebilir.</div><button class="btn btn-primary btn-sm" onclick="loadStockDetail('${symbol}','${period}')" style="margin-top:12px;">Yenile</button></div>`;
    setTimeout(() => loadStockDetail(symbol, period), 5000);
    return;
  }

  const s = stockData;
  const events = eventsData?.events || {};
  const ind = s.indicators || {};
  const summary = ind.summary || {};

  container.innerHTML = `
    <!-- Header -->
    <div class="stock-header fade-in">
      <div>
        <div class="stock-name">${s.name} Â· ${s.code}</div>
        <div class="stock-price-big ${changeClass(s.changePercent)}">${fmtPrice(s.price)} â‚º</div>
        <div class="stock-change-big ${changeClass(s.changePercent)}">
          ${s.change >= 0 ? 'â–²' : 'â–¼'} ${fmtPrice(Math.abs(s.change))} (${fmtPct(s.changePercent)})
        </div>
      </div>
      <div class="flex-center gap-8" style="flex-wrap:wrap;">
        ${['1mo','3mo','6mo','1y','2y','5y'].map(p =>
          `<button class="btn btn-sm ${p === s.period ? 'btn-primary' : 'btn-secondary'}" onclick="loadStockPeriod('${s.code}','${p}')">${p}</button>`
        ).join('')}
        <span style="width:1px;height:20px;background:var(--border);margin:0 4px;"></span>
        <button class="btn btn-sm" style="background:rgba(255,197,71,0.1);color:var(--yellow);border:1px solid rgba(255,197,71,0.3);" onclick="toggleWatchlist('${s.code}').then(d => { if(d?.action==='added') this.textContent='Favorilerde'; else if(d?.action==='removed') this.textContent='Favorilere Ekle'; })">Favorilere Ekle</button>
        <button class="btn btn-sm" style="background:rgba(0,212,170,0.1);color:var(--accent);border:1px solid rgba(0,212,170,0.3);" onclick="document.getElementById('pfSymbol').value='${s.code}'; navigate('portfolio'); showAddPositionForm();">PortfÃ¶ye Ekle</button>
      </div>
    </div>

    <!-- Info Cards -->
    <div class="grid-4 mb-24 fade-in">
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">GÃ¼n AralÄ±ÄŸÄ±</div>
        <div class="td-mono" style="margin-top:4px;">${fmtPrice(s.dayLow)} - ${fmtPrice(s.dayHigh)}</div>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">Hacim</div>
        <div class="td-mono" style="margin-top:4px;">${fmtVolume(s.volume)}</div>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">52H AralÄ±k</div>
        <div class="td-mono" style="margin-top:4px;">${s.week52?.low52w ? fmtPrice(s.week52.low52w) + ' - ' + fmtPrice(s.week52.high52w) : '-'}</div>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">Piyasa DeÄŸeri</div>
        <div class="td-mono" style="margin-top:4px;">${s.marketValue ? fmtVolume(s.marketValue) : '-'}</div>
      </div>
    </div>

    <!-- Sinyal Ã–zeti -->
    <div class="card mb-24 fade-in">
      <div class="flex-between mb-8">
        <div style="font-weight:700;">Teknik Sinyal Ã–zeti</div>
        ${signalBadge(summary.overall)}
      </div>
      <div style="font-size:13px;color:var(--text-secondary);">${summary.explanation || ''}</div>
      <div class="flex-center gap-16 mt-16" style="font-size:13px;">
        <span class="price-up">ğŸŸ¢ AL: ${summary.buySignals || 0}</span>
        <span class="price-down">ğŸ”´ SAT: ${summary.sellSignals || 0}</span>
        <span style="color:var(--text-muted);">âšª NÃ¶tr: ${summary.neutralSignals || 0}</span>
      </div>
    </div>

    <!-- Chart System -->
    <div class="mb-24 fade-in" id="chartSystem"></div>

    <!-- Indicators Grid - Collapsible -->
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:15px;">Teknik IndikatÃ¶rler</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:2000px;padding-top:12px;">
        <div class="indicator-grid">
          ${renderIndicatorDetailed(ind.rsi, 'RSI', ind.rsi?.value, 'GÃ¶receli GÃ¼Ã§ Endeksi. 0-100 arasÄ±. <30 aÅŸÄ±rÄ± satÄ±m (alÄ±ÅŸ fÄ±rsatÄ±), >70 aÅŸÄ±rÄ± alÄ±m (satÄ±ÅŸ sinyali). 50 Ã¼zeri pozitif momentum.', 0, 100)}
          ${renderIndicatorDetailed(ind.macd, 'MACD', ind.macd?.histogram, 'Hareketli Ortalama YakÄ±nsama/Iraksama. Histogram pozitif â†’ alÄ±ÅŸ, negatif â†’ satÄ±ÅŸ. MACD Ã§izgisi sinyal Ã§izgisini yukarÄ± keserse alÄ±ÅŸ sinyali.', null, null, `MACD: ${ind.macd?.macd?.toFixed(2)||'-'} | Sinyal: ${ind.macd?.signal?.toFixed(2)||'-'}`)}
          ${renderIndicatorDetailed(ind.bollinger, 'Bollinger BantlarÄ±', ind.bollinger?.bandwidth, 'Fiyat volatilitesini Ã¶lÃ§er. Fiyat alt banda yakÄ±nsa â†’ alÄ±ÅŸ, Ã¼st banda yakÄ±nsa â†’ satÄ±ÅŸ. Bantlar daralÄ±yorsa sert hareket beklenir.', null, null, `Ãœst: ${fmtPrice(ind.bollinger?.upper)} | Orta: ${fmtPrice(ind.bollinger?.middle)} | Alt: ${fmtPrice(ind.bollinger?.lower)}`)}
          ${renderIndicatorDetailed(ind.ema, 'EMA', null, 'Ãœstel Hareketli Ortalama. Fiyat > EMA20 > EMA50 â†’ gÃ¼Ã§lÃ¼ yÃ¼kseliÅŸ.', null, null, `${ind.ema?.ema5?'EMA5:'+fmtPrice(ind.ema.ema5)+' | ':''} ${ind.ema?.ema10?'EMA10:'+fmtPrice(ind.ema.ema10)+' | ':''} EMA20: ${fmtPrice(ind.ema?.ema20)} | EMA50: ${fmtPrice(ind.ema?.ema50)} ${ind.ema?.ema100 ? '| EMA100: '+fmtPrice(ind.ema.ema100) : ''} ${ind.ema?.ema200 ? '| EMA200: '+fmtPrice(ind.ema.ema200) : ''}`)}
          ${renderIndicatorDetailed(ind.stochastic, 'Stochastic', ind.stochastic?.k, 'KapanÄ±ÅŸ fiyatÄ±nÄ±n belirli dÃ¶nemdeki aralÄ±ÄŸa gÃ¶re konumu. K<20 aÅŸÄ±rÄ± satÄ±m, K>80 aÅŸÄ±rÄ± alÄ±m.', 0, 100)}
          ${renderIndicatorDetailed(ind.atr, 'ATR', ind.atr?.value, 'Ortalama GerÃ§ek AralÄ±k. Volatilite Ã¶lÃ§er. YÃ¼ksek ATR = yÃ¼ksek risk/fÄ±rsat. Stop-loss belirlemede kullanÄ±lÄ±r.', null, null, `GÃ¼nlÃ¼k ort. hareket: ${ind.atr?.pct?.toFixed(2)||'-'}%`)}
          ${renderIndicatorDetailed(ind.adx, 'ADX', ind.adx?.value, 'Ortalama YÃ¶nsel Endeks. Trend gÃ¼cÃ¼nÃ¼ Ã¶lÃ§er. >25 gÃ¼Ã§lÃ¼ trend, <20 trendsiz piyasa. +DI>-DI â†’ yÃ¼kseliÅŸ.', 0, 100, `+DI: ${ind.adx?.plusDI?.toFixed(1)||'-'} | -DI: ${ind.adx?.minusDI?.toFixed(1)||'-'}`)}
          ${renderIndicatorDetailed(ind.cci, 'CCI', ind.cci?.value, 'Emtia Kanal Endeksi. >100 aÅŸÄ±rÄ± alÄ±m, <-100 aÅŸÄ±rÄ± satÄ±m. 0 Ã§izgisi trend yÃ¶nÃ¼nÃ¼ gÃ¶sterir.', -200, 200)}
          ${renderIndicatorDetailed(ind.williamsR, 'Williams %R', ind.williamsR?.value, 'AÅŸÄ±rÄ± alÄ±m/satÄ±m gÃ¶stergesi. -80 altÄ± aÅŸÄ±rÄ± satÄ±m (alÄ±ÅŸ), -20 Ã¼stÃ¼ aÅŸÄ±rÄ± alÄ±m (satÄ±ÅŸ).', -100, 0)}
          ${renderIndicatorDetailed(ind.obv, 'OBV', null, 'Denge Hacmi. Fiyat yÃ¼kselirken hacim artÄ±yorsa â†’ gÃ¼Ã§lÃ¼ trend. Hacim dÃ¼ÅŸerken fiyat yÃ¼kseliyorsa â†’ zayÄ±f hareket.', null, null, `Hacim: ${ind.obv?.value || '-'} | Trend: ${ind.obv?.trend === 'up' ? 'â†‘ YÃ¼kseliÅŸ' : 'â†“ DÃ¼ÅŸÃ¼ÅŸ'}`)}
          ${renderIndicatorDetailed(ind.mfi, 'MFI', ind.mfi?.value, 'Para AkÄ±ÅŸ Endeksi. Hacim aÄŸÄ±rlÄ±klÄ± RSI. <20 aÅŸÄ±rÄ± satÄ±m, >80 aÅŸÄ±rÄ± alÄ±m. AkÄ±llÄ± para takibi.', 0, 100)}
          ${renderIndicatorDetailed(ind.vwap, 'VWAP', ind.vwap?.value, 'Hacim AÄŸÄ±rlÄ±klÄ± Ortalama Fiyat. Fiyat > VWAP â†’ alÄ±cÄ±lar gÃ¼Ã§lÃ¼. Fiyat < VWAP â†’ satÄ±cÄ±lar gÃ¼Ã§lÃ¼.', null, null, `VWAP: ${fmtPrice(ind.vwap?.value)} â‚º`)}
          ${renderIndicatorDetailed(ind.ichimoku, 'Ichimoku', null, 'Japon bulut sistemi. Fiyat bulutun Ã¼stÃ¼nde â†’ yÃ¼kseliÅŸ, altÄ±nda â†’ dÃ¼ÅŸÃ¼ÅŸ. Tenkan>Kijun â†’ alÄ±ÅŸ sinyali.', null, null, `Tenkan: ${fmtPrice(ind.ichimoku?.tenkan)} | Kijun: ${fmtPrice(ind.ichimoku?.kijun)} | SpanA: ${fmtPrice(ind.ichimoku?.senkouA)} | SpanB: ${fmtPrice(ind.ichimoku?.senkouB)}`)}
          ${renderIndicatorDetailed(ind.psar, 'Parabolic SAR', ind.psar?.value, 'Dur ve Geri DÃ¶n. Fiyat SAR Ã¼stÃ¼nde â†’ yÃ¼kseliÅŸ trendi. Fiyat SAR altÄ±na inerse â†’ trend dÃ¶nÃ¼ÅŸÃ¼. Stop-loss seviyesi olarak kullanÄ±lÄ±r.', null, null, `SAR: ${fmtPrice(ind.psar?.value)} â‚º | Trend: ${ind.psar?.trend === 'up' ? 'â†‘ YÃ¼kseliÅŸ' : 'â†“ DÃ¼ÅŸÃ¼ÅŸ'}`)}
          ${renderIndicatorDetailed(ind.roc, 'ROC (Momentum)', ind.roc?.value, 'DeÄŸiÅŸim OranÄ±. FiyatÄ±n belirli dÃ¶nem Ã¶ncesine gÃ¶re yÃ¼zde deÄŸiÅŸimi. >5 pozitif momentum, <-5 negatif momentum.', null, null, `${ind.roc?.period || 12} gÃ¼nlÃ¼k deÄŸiÅŸim`)}
          ${renderIndicatorDetailed(ind.aroon, 'Aroon', ind.aroon?.oscillator, 'Trend yÃ¶nÃ¼ ve gÃ¼cÃ¼. Up>70 & Down<30 â†’ gÃ¼Ã§lÃ¼ yÃ¼kseliÅŸ. Down>70 & Up<30 â†’ gÃ¼Ã§lÃ¼ dÃ¼ÅŸÃ¼ÅŸ.', -100, 100, `Up: ${ind.aroon?.up?.toFixed(0)||'-'} | Down: ${ind.aroon?.down?.toFixed(0)||'-'}`)}
          ${renderIndicatorDetailed(ind.trix, 'TRIX', ind.trix?.value, 'ÃœÃ§lÃ¼ Ã¼stel ortalama. SÄ±fÄ±r Ã¼stÃ¼ â†’ yÃ¼kseliÅŸ, sÄ±fÄ±r altÄ± â†’ dÃ¼ÅŸÃ¼ÅŸ. Trend dÃ¶nÃ¼ÅŸlerini erken yakalar.', null, null)}
          ${renderIndicatorDetailed(ind.dmi, 'DMI', ind.dmi?.adx, 'YÃ¶nsel Hareket Endeksi. ADX>25 â†’ gÃ¼Ã§lÃ¼ trend. +DI>-DI â†’ yÃ¼kseliÅŸ trendi.', 0, 100, `+DI: ${ind.dmi?.plusDI?.toFixed(1)||'-'} | -DI: ${ind.dmi?.minusDI?.toFixed(1)||'-'}`)}
        </div>
      </div>
    </div>

    <!-- AL/SAT Ã–nerisi - Collapsible -->
    <div class="card mb-24 fade-in" style="border:2px solid var(--border);">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:16px;">ğŸ“Š AL / SAT Ã–nerisi</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:2000px;">
        <div style="font-size:11px;color:var(--text-muted);margin:8px 0 12px;">âš ï¸ Bu Ã¶neriler teknik indikatÃ¶rlere dayanÄ±r, yatÄ±rÄ±m tavsiyesi deÄŸildir.</div>
        ${renderRecommendation(s.recommendation)}
      </div>
    </div>

    <!-- Trade Plan (Detayli Giris/Cikis) -->
    ${s.tradePlan && Object.keys(s.tradePlan).length ? `
    <div class="card mb-24 fade-in" style="border:2px solid var(--accent);">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:16px;">ğŸ¯ DetaylÄ± Trade PlanÄ± (GiriÅŸ / Ã‡Ä±kÄ±ÅŸ Seviyeleri)</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:5000px;">
        <div style="font-size:11px;color:var(--text-muted);margin:8px 0 12px;">âš ï¸ Bu seviyeler teknik analize dayanÄ±r. Destek/DirenÃ§, Fibonacci, Bollinger, Pivot ve EMA seviyeleri kullanÄ±larak hesaplanmÄ±ÅŸtÄ±r. YatÄ±rÄ±m tavsiyesi deÄŸildir.</div>
        ${renderTradePlan(s.tradePlan)}
      </div>
    </div>` : ''}

    <!-- Pivot Points & Fibonacci & S/R - Collapsible -->
    <div class="grid-2 grid-3col mb-24" style="grid-template-columns:repeat(3,1fr);">
      <div class="card fade-in">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <div style="font-weight:700;">Pivot NoktalarÄ±</div>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
          ${renderPivotPoints(s.pivotPoints)}
        </div>
      </div>
      <div class="card fade-in">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <div style="font-weight:700;">Fibonacci Seviyeleri</div>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
          <div style="font-size:12px;color:var(--text-secondary);margin-bottom:8px;">${s.fibonacci?.currentZone || ''}</div>
          ${s.fibonacci?.description ? '<div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;line-height:1.5;">' + s.fibonacci.description.split(' | ').join('<br>') + '</div>' : ''}
          ${renderFibonacci(s.fibonacci)}
        </div>
      </div>
      <div class="card fade-in">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <div style="font-weight:700;">Destek / DirenÃ§</div>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
          ${renderSR(s.supportResistance)}
        </div>
      </div>
    </div>

    <!-- Fundamentals - Collapsible -->
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;">Temel Veriler</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
        ${renderFundamentals(s.fundamentals, s)}
      </div>
    </div>

    <!-- Piyasa Rejimi -->
    ${s.marketRegime ? `
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:15px;">Piyasa Rejimi</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
        ${renderMarketRegime(s.marketRegime)}
      </div>
    </div>` : ''}

    <!-- Mum Formasyonlari -->
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:15px;">Mum FormasyonlarÄ±</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
        ${renderCandlestickPatterns(ind.candlestick)}
      </div>
    </div>

    <!-- ML Guven Skoru -->
    ${s.mlConfidence ? `
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:15px;">ML GÃ¼ven Analizi</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:2000px;padding-top:8px;">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">Yapay zeka destekli Ã§oklu faktÃ¶r analizi ile sinyal gÃ¼venilirliÄŸi</div>
        ${renderMLConfidence(s.mlConfidence)}
      </div>
    </div>` : ''}

    <!-- Sinyal Performansi -->
    ${s.signalBacktest ? `
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:15px;">Sinyal PerformansÄ± (Backtest)</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:2000px;padding-top:8px;">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">GeÃ§miÅŸ 1 yÄ±lda Ã¼retilen sinyallerin gerÃ§ek performansÄ±</div>
        ${renderSignalBacktest(s.signalBacktest)}
      </div>
    </div>` : ''}

    <!-- Dinamik Esikler -->
    ${ind.dynamicThresholds ? `
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:15px;">Dinamik EÅŸikler</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
        <div style="font-size:11px;color:var(--text-muted);margin-bottom:10px;">Bu hissenin tarihsel daÄŸÄ±lÄ±mÄ±na gÃ¶re hesaplanan adaptif eÅŸik deÄŸerleri</div>
        <div class="grid-4" style="gap:8px;">
          <div style="text-align:center;padding:10px;border-radius:8px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);">
            <div style="font-size:10px;color:var(--green);font-weight:700;">RSI AÅŸÄ±rÄ± SatÄ±m</div>
            <div style="font-size:18px;font-weight:800;color:var(--green);">${ind.dynamicThresholds.rsi_oversold}</div>
            <div style="font-size:10px;color:var(--text-muted);">Standart: 30</div>
          </div>
          <div style="text-align:center;padding:10px;border-radius:8px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);">
            <div style="font-size:10px;color:var(--red);font-weight:700;">RSI AÅŸÄ±rÄ± AlÄ±m</div>
            <div style="font-size:18px;font-weight:800;color:var(--red);">${ind.dynamicThresholds.rsi_overbought}</div>
            <div style="font-size:10px;color:var(--text-muted);">Standart: 70</div>
          </div>
          <div style="text-align:center;padding:10px;border-radius:8px;background:rgba(99,102,241,0.08);border:1px solid rgba(99,102,241,0.2);">
            <div style="font-size:10px;color:var(--accent);font-weight:700;">Bollinger Std</div>
            <div style="font-size:18px;font-weight:800;color:var(--accent);">${ind.dynamicThresholds.bb_std}</div>
            <div style="font-size:10px;color:var(--text-muted);">Standart: 2.0</div>
          </div>
          <div style="text-align:center;padding:10px;border-radius:8px;background:rgba(234,179,8,0.08);border:1px solid rgba(234,179,8,0.2);">
            <div style="font-size:10px;color:var(--yellow);font-weight:700;">Hacim Spike</div>
            <div style="font-size:18px;font-weight:800;color:var(--yellow);">${ind.dynamicThresholds.vol_spike}x</div>
            <div style="font-size:10px;color:var(--text-muted);">Standart: 2.0x</div>
          </div>
        </div>
      </div>
    </div>` : ''}

    <!-- Events -->
    ${events.dividends && events.dividends.length > 0 ? `
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;">TemettÃ¼ GeÃ§miÅŸi</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
        <div class="table-wrap"><table>
          <thead><tr><th>Tarih</th><th>Tutar</th></tr></thead>
          <tbody>${events.dividends.slice(-10).reverse().map(d =>
            `<tr><td>${d.date}</td><td class="td-mono">${fmtPrice(d.amount)} â‚º</td></tr>`
          ).join('')}</tbody>
        </table></div>
      </div>
    </div>` : ''}
  `;

  // Draw chart
  drawPriceChart(s.chartData, s.code, ind);

  // Faz 2-9 advanced analysis tabs
  _initAdvancedTabs(symbol);
}

// =============================================================================
// FAZ 2-9 ADVANCED ANALYSIS TABS
// =============================================================================
let _advTabsLoaded = {};

function _initAdvancedTabs(symbol) {
  _advTabsLoaded = {}; // reset on new stock
  const container = document.getElementById('stockDetailContent');
  const tabSection = document.createElement('div');
  tabSection.id = 'advAnalysisTabs';
  tabSection.className = 'card mb-24 fade-in';
  tabSection.style.cssText = 'margin-top:20px;';
  tabSection.innerHTML = `
    <div style="font-weight:700;font-size:14px;margin-bottom:14px;">GeliÅŸmiÅŸ Analiz</div>
    <div class="tabs" id="advTabBar">
      <button class="tab active" onclick="_loadAdvTab('mtf','${escHtml(symbol)}',this)">Ã‡oklu Zaman Dilimi</button>
      <button class="tab" onclick="_loadAdvTab('divergence','${escHtml(symbol)}',this)">Diverjans</button>
      <button class="tab" onclick="_loadAdvTab('volume-profile','${escHtml(symbol)}',this)">Hacim Profili</button>
      <button class="tab" onclick="_loadAdvTab('smc','${escHtml(symbol)}',this)">Smart Money</button>
      <button class="tab" onclick="_loadAdvTab('patterns','${escHtml(symbol)}',this)">Formasyonlar</button>
      <button class="tab" onclick="_loadAdvTab('fibonacci','${escHtml(symbol)}',this)">Fibonacci</button>
      <button class="tab" onclick="_loadAdvTab('pivots','${escHtml(symbol)}',this)">Pivot</button>
      <button class="tab" onclick="_loadAdvTab('advanced-indicators','${escHtml(symbol)}',this)">GeliÅŸmiÅŸ Ä°nd.</button>
    </div>
    <div id="advTabContent"><div class="loading"><div class="spinner"></div>YÃ¼kleniyor...</div></div>
  `;
  container.appendChild(tabSection);
  _loadAdvTab('mtf', symbol, document.querySelector('#advTabBar .tab'));
}

async function _loadAdvTab(endpoint, symbol, btn) {
  document.querySelectorAll('#advTabBar .tab').forEach(t => t.classList.remove('active'));
  if (btn) btn.classList.add('active');
  const content = document.getElementById('advTabContent');
  if (!content) return;

  if (_advTabsLoaded[endpoint]) { content.innerHTML = _advTabsLoaded[endpoint]; return; }

  content.innerHTML = '<div class="loading"><div class="spinner"></div>HesaplanÄ±yor...</div>';
  const data = await api('/stock/' + encodeURIComponent(symbol) + '/' + endpoint);
  if (data.error) { content.innerHTML = `<div class="empty-state" style="padding:20px;"><div class="icon">âš ï¸</div><div>${escHtml(data.error)}</div></div>`; return; }

  let html = '';
  if (endpoint === 'mtf') html = _renderMtf(data);
  else if (endpoint === 'divergence') html = _renderDivergence(data);
  else if (endpoint === 'volume-profile') html = _renderVolumeProfile(data);
  else if (endpoint === 'smc') html = _renderSmc(data);
  else if (endpoint === 'patterns') html = _renderPatterns(data);
  else if (endpoint === 'fibonacci') html = _renderFibonacci(data);
  else if (endpoint === 'pivots') html = _renderPivots(data);
  else if (endpoint === 'advanced-indicators') html = _renderAdvIndicators(data);
  else html = `<pre style="font-size:11px;overflow:auto;">${escHtml(JSON.stringify(data,null,2))}</pre>`;

  _advTabsLoaded[endpoint] = html;
  content.innerHTML = html;
}

function _advKv(label, value, color) {
  const c = color ? `color:${color};` : '';
  return `<div style="display:flex;justify-content:space-between;padding:4px 0;border-bottom:1px solid var(--border);font-size:12px;">
    <span style="color:var(--text-muted);">${label}</span>
    <span class="td-mono" style="${c}font-weight:600;">${value}</span>
  </div>`;
}

function _renderMtf(d) {
  const frames = d.timeframes || {};
  const keys = Object.keys(frames);
  if (!keys.length) return '<div class="empty-state">Veri yok</div>';
  return keys.map(tf => {
    const f = frames[tf];
    const trendColor = f.trend === 'Yukari' ? 'var(--green)' : f.trend === 'Asagi' ? 'var(--red)' : 'var(--text-muted)';
    return `<div class="card mb-12" style="padding:12px;">
      <div style="font-weight:700;font-size:13px;margin-bottom:8px;">${tf.toUpperCase()}</div>
      ${_advKv('Trend', f.trend || '-', trendColor)}
      ${_advKv('RSI', f.rsi ?? '-', parseFloat(f.rsi)<30?'var(--green)':parseFloat(f.rsi)>70?'var(--red)':'')}
      ${_advKv('MACD Sinyal', f.macdSignal || '-', f.macdSignal==='buy'?'var(--green)':f.macdSignal==='sell'?'var(--red)':'')}
      ${_advKv('Fiyat / BB', f.priceVsBB || '-')}
    </div>`;
  }).join('') + (d.summary ? `<div class="card" style="padding:12px;border-left:3px solid var(--accent);">${_advKv('MTF Ã–zeti', d.summary.overallTrend || '-')}${_advKv('Uyum Skoru', d.summary.alignmentScore ?? '-')}</div>` : '');
}

function _renderDivergence(d) {
  const divs = d.divergences || [];
  if (!divs.length) return '<div class="empty-state" style="padding:20px;">Aktif diverjans sinyali yok</div>';
  return divs.map(div => {
    const color = div.type && div.type.toLowerCase().includes('bullish') ? 'var(--green)' : 'var(--red)';
    return `<div class="card mb-12" style="padding:12px;border-left:3px solid ${color};">
      ${_advKv('Tip', escHtml(div.type || '-'), color)}
      ${_advKv('Ä°ndikatÃ¶r', escHtml(div.indicator || '-'))}
      ${_advKv('GÃ¼Ã§', escHtml(div.strength || '-'))}
      ${div.description ? `<div style="font-size:11px;color:var(--text-muted);margin-top:6px;">${escHtml(div.description)}</div>` : ''}
    </div>`;
  }).join('');
}

function _renderVolumeProfile(d) {
  const vp = d.volumeProfile || d;
  return `<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">
    <div class="card" style="padding:12px;">
      <div style="font-weight:700;font-size:12px;margin-bottom:8px;">VWAP & POC</div>
      ${_advKv('VWAP', fmtPrice(vp.vwap) + ' â‚º')}
      ${_advKv('POC (En YÃ¼ksek Hacim)', fmtPrice(vp.poc) + ' â‚º')}
      ${_advKv('DeÄŸer AlanÄ± Ãœst (VAH)', fmtPrice(vp.vah) + ' â‚º')}
      ${_advKv('DeÄŸer AlanÄ± Alt (VAL)', fmtPrice(vp.val) + ' â‚º')}
    </div>
    <div class="card" style="padding:12px;">
      <div style="font-weight:700;font-size:12px;margin-bottom:8px;">Hacim Anomalisi</div>
      ${_advKv('Anomali', vp.volumeAnomaly ? 'Var âš ï¸' : 'Yok', vp.volumeAnomaly ? 'var(--yellow)' : '')}
      ${_advKv('Fiyat vs VWAP', vp.priceVsVwap || '-', vp.priceVsVwap === 'above' ? 'var(--green)' : vp.priceVsVwap === 'below' ? 'var(--red)' : '')}
      ${_advKv('DeÄŸer AlanÄ±nda mÄ±?', vp.inValueArea ? 'Evet' : 'HayÄ±r')}
    </div>
  </div>`;
}

function _renderSmc(d) {
  const smc = d.smc || d;
  let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">';
  const fvgs = smc.fairValueGaps || [];
  const obs = smc.orderBlocks || [];
  html += `<div class="card" style="padding:12px;"><div style="font-weight:700;font-size:12px;margin-bottom:8px;">Fair Value Gaps (${fvgs.length})</div>`;
  if (fvgs.length) fvgs.slice(-3).forEach(g => {
    const c = g.type === 'bullish' ? 'var(--green)' : 'var(--red)';
    html += _advKv(escHtml(g.type || '-'), `${fmtPrice(g.low)} - ${fmtPrice(g.high)} â‚º`, c);
  }); else html += '<div style="color:var(--text-muted);font-size:12px;">Aktif FVG yok</div>';
  html += '</div>';
  html += `<div class="card" style="padding:12px;"><div style="font-weight:700;font-size:12px;margin-bottom:8px;">Order Blocks (${obs.length})</div>`;
  if (obs.length) obs.slice(-3).forEach(o => {
    const c = o.type === 'bullish' ? 'var(--green)' : 'var(--red)';
    html += _advKv(escHtml(o.type || '-'), `${fmtPrice(o.low)} - ${fmtPrice(o.high)} â‚º`, c);
  }); else html += '<div style="color:var(--text-muted);font-size:12px;">Aktif OB yok</div>';
  html += '</div></div>';
  const bias = smc.marketBias;
  if (bias) html += `<div class="card mt-12" style="padding:12px;margin-top:12px;border-left:3px solid ${bias==='bullish'?'var(--green)':bias==='bearish'?'var(--red)':'var(--text-muted)'};">${_advKv('Piyasa YÃ¶nelimi', escHtml(bias), bias==='bullish'?'var(--green)':bias==='bearish'?'var(--red)':'')}${smc.bos?_advKv('BOS', escHtml(smc.bos)):''}${smc.choch?_advKv('CHoCH', escHtml(smc.choch)):''}${smc.description?`<div style="font-size:11px;color:var(--text-muted);margin-top:6px;">${escHtml(smc.description)}</div>`:''}</div>`;
  return html;
}

function _renderPatterns(d) {
  const pats = d.patterns || [];
  if (!pats.length) return '<div class="empty-state" style="padding:20px;">Aktif formasyon bulunamadÄ±</div>';
  return pats.map(p => {
    const color = p.type === 'bullish' ? 'var(--green)' : p.type === 'bearish' ? 'var(--red)' : 'var(--yellow)';
    return `<div class="card mb-12" style="padding:12px;border-left:3px solid ${color};">
      ${_advKv('Formasyon', escHtml(p.name || '-'), color)}
      ${_advKv('YÃ¶n', escHtml(p.type || '-'), color)}
      ${p.target ? _advKv('Hedef Fiyat', fmtPrice(p.target) + ' â‚º') : ''}
      ${p.completion !== undefined ? _advKv('Tamamlanma', Math.round(p.completion * 100) + '%') : ''}
      ${p.description ? `<div style="font-size:11px;color:var(--text-muted);margin-top:6px;">${escHtml(p.description)}</div>` : ''}
    </div>`;
  }).join('');
}

function _renderFibonacci(d) {
  const fib = d.fibonacci || d;
  const levels = fib.levels || {};
  let html = '<div class="card" style="padding:12px;"><div style="font-weight:700;font-size:12px;margin-bottom:8px;">Fibonacci Seviyeleri</div>';
  Object.entries(levels).forEach(([k, v]) => { html += _advKv(k, fmtPrice(v) + ' â‚º'); });
  html += '</div>';
  if (fib.goldenPocket) html += `<div class="card mt-12" style="padding:12px;margin-top:12px;border-left:3px solid var(--yellow);">${_advKv('Golden Pocket Alt', fmtPrice(fib.goldenPocket.low) + ' â‚º', 'var(--yellow)')}${_advKv('Golden Pocket Ãœst', fmtPrice(fib.goldenPocket.high) + ' â‚º', 'var(--yellow)')}</div>`;
  return html;
}

function _renderPivots(d) {
  const pv = d.pivots || d;
  return `<div style="display:grid;grid-template-columns:1fr 1fr 1fr;gap:12px;">
    ${['R3','R2','R1'].map(k => `<div class="card" style="padding:10px;text-align:center;border-left:3px solid var(--red);">
      <div style="font-size:10px;color:var(--red);font-weight:700;">${k}</div>
      <div class="td-mono" style="font-size:14px;font-weight:800;">${fmtPrice(pv[k] ?? pv[k.toLowerCase()]) || '-'} â‚º</div>
    </div>`).join('')}
    <div class="card" style="padding:10px;text-align:center;border-left:3px solid var(--accent);grid-column:2;">
      <div style="font-size:10px;color:var(--accent);font-weight:700;">PIVOT</div>
      <div class="td-mono" style="font-size:14px;font-weight:800;">${fmtPrice(pv.PP ?? pv.pp) || '-'} â‚º</div>
    </div>
    ${['S1','S2','S3'].map(k => `<div class="card" style="padding:10px;text-align:center;border-left:3px solid var(--green);">
      <div style="font-size:10px;color:var(--green);font-weight:700;">${k}</div>
      <div class="td-mono" style="font-size:14px;font-weight:800;">${fmtPrice(pv[k] ?? pv[k.toLowerCase()]) || '-'} â‚º</div>
    </div>`).join('')}
  </div>`;
}

function _renderAdvIndicators(d) {
  const ind = d.indicators || d;
  const ich = ind.ichimoku || {};
  const sto = ind.stochastic || {};
  const wpr = ind.williamsR;
  let html = '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">';
  html += `<div class="card" style="padding:12px;"><div style="font-weight:700;font-size:12px;margin-bottom:8px;">Ichimoku</div>
    ${_advKv('Bulut Rengi', escHtml(ich.cloudColor || '-'), ich.cloudColor==='green'?'var(--green)':ich.cloudColor==='red'?'var(--red)':'')}
    ${_advKv('Fiyat vs Bulut', escHtml(ich.priceVsCloud || '-'), ich.priceVsCloud==='above'?'var(--green)':ich.priceVsCloud==='below'?'var(--red)':'')}
    ${_advKv('TK Sinyal', escHtml(ich.tkSignal || '-'), ich.tkSignal==='bullish'?'var(--green)':ich.tkSignal==='bearish'?'var(--red)':'')}
    ${_advKv('Tenkan', fmtPrice(ich.tenkan) || '-')}
    ${_advKv('Kijun', fmtPrice(ich.kijun) || '-')}
  </div>`;
  html += `<div class="card" style="padding:12px;"><div style="font-weight:700;font-size:12px;margin-bottom:8px;">Stokastik & Williams</div>
    ${_advKv('Stokastik %K', sto.k !== undefined ? sto.k.toFixed(1) : '-', parseFloat(sto.k)<20?'var(--green)':parseFloat(sto.k)>80?'var(--red)':'')}
    ${_advKv('Stokastik %D', sto.d !== undefined ? sto.d.toFixed(1) : '-')}
    ${_advKv('Sto. Sinyal', escHtml(sto.signal || '-'), sto.signal==='oversold'?'var(--green)':sto.signal==='overbought'?'var(--red)':'')}
    ${_advKv('Williams %R', wpr !== undefined ? wpr.toFixed(1) : '-', parseFloat(wpr)<-80?'var(--green)':parseFloat(wpr)>-20?'var(--red)':'')}
  </div>`;
  html += '</div>';
  return html;
}

function loadStockPeriod(symbol, period) {
  loadStockDetail(symbol, period);
}

// =============================================================================
// COMMODITY DETAIL (AltÄ±n, GÃ¼mÃ¼ÅŸ, DÃ¶viz)
// =============================================================================
async function loadCommodityDetail(symbol, period) {
  period = period || '1y';
  const container = document.getElementById('commodityDetailContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>Emtia verisi yÃ¼kleniyor...</div>';

  document.querySelectorAll('.nav-link').forEach(n => n.classList.remove('active'));

  const s = await api('/commodity/' + symbol + '?period=' + period);

  if (s.error && !s.success) {
    container.innerHTML = `<div class="empty-state"><div class="icon">âŒ</div><div>Hata: ${s.error}</div></div>`;
    return;
  }

  if (!s.indicators || Object.keys(s.indicators).length === 0) {
    if (s.dataPoints === 0) {
      container.innerHTML = `<div class="empty-state"><div class="spinner" style="margin:0 auto 16px;"></div><div style="color:var(--yellow);">Emtia verisi yÃ¼kleniyor...</div><button class="btn btn-primary btn-sm" onclick="loadCommodityDetail('${symbol}')" style="margin-top:12px;">Yenile</button></div>`;
      return;
    }
  }

  const ind = s.indicators || {};
  const summary = ind.summary || {};
  const cur = s.currency === 'USD' ? '$' : 'â‚º';
  const nameEmoji = symbol.includes('GOLD') ? 'ğŸ¥‡' : symbol.includes('SILVER') ? 'ğŸ¥ˆ' : 'ğŸ’±';

  container.innerHTML = `
    <!-- Header -->
    <div class="stock-header fade-in">
      <div>
        <div class="stock-name">${nameEmoji} ${s.name} Â· ${s.code}</div>
        <div class="stock-price-big ${changeClass(s.changePercent)}">${fmtPrice(s.price)} ${cur}</div>
        <div class="stock-change-big ${changeClass(s.changePercent)}">
          ${s.change >= 0 ? 'â–²' : 'â–¼'} ${fmtPrice(Math.abs(s.change))} (${fmtPct(s.changePercent)})
        </div>
      </div>
      <div class="flex-center gap-8">
        ${['1mo','3mo','6mo','1y','2y','5y'].map(p =>
          `<button class="btn btn-sm ${p === period ? 'btn-primary' : 'btn-secondary'}" onclick="loadCommodityPeriod('${s.code}','${p}')">${p}</button>`
        ).join('')}
      </div>
    </div>

    <!-- Info Cards -->
    <div class="grid-4 mb-24 fade-in">
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">GÃ¼n AralÄ±ÄŸÄ±</div>
        <div class="td-mono" style="margin-top:4px;">${fmtPrice(s.dayLow)} - ${fmtPrice(s.dayHigh)} ${cur}</div>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">Hacim</div>
        <div class="td-mono" style="margin-top:4px;">${fmtVolume(s.volume)}</div>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">52H AralÄ±k</div>
        <div class="td-mono" style="margin-top:4px;">${s.week52?.low52w ? fmtPrice(s.week52.low52w) + ' - ' + fmtPrice(s.week52.high52w) + ' ' + cur : '-'}</div>
      </div>
      <div class="card" style="text-align:center;">
        <div style="font-size:11px;color:var(--text-muted);">Ã–nceki KapanÄ±ÅŸ</div>
        <div class="td-mono" style="margin-top:4px;">${fmtPrice(s.prevClose)} ${cur}</div>
      </div>
    </div>

    <!-- Sinyal Ã–zeti -->
    <div class="card mb-24 fade-in">
      <div class="flex-between mb-8">
        <div style="font-weight:700;">Teknik Sinyal Ã–zeti</div>
        ${signalBadge(summary.overall)}
      </div>
      <div style="font-size:13px;color:var(--text-secondary);">${summary.explanation || ''}</div>
      <div class="flex-center gap-16 mt-16" style="font-size:13px;">
        <span class="price-up">AL: ${summary.buySignals || 0}</span>
        <span class="price-down">SAT: ${summary.sellSignals || 0}</span>
        <span style="color:var(--text-muted);">NÃ¶tr: ${summary.neutralSignals || 0}</span>
      </div>
    </div>

    <!-- Chart System -->
    <div class="mb-24 fade-in" id="chartSystem"></div>

    <!-- Indicators Grid -->
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:15px;">Teknik IndikatÃ¶rler</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:2000px;padding-top:12px;">
        <div class="indicator-grid">
          ${renderIndicatorDetailed(ind.rsi, 'RSI', ind.rsi?.value, 'GÃ¶receli GÃ¼Ã§ Endeksi. 0-100 arasÄ±. <30 aÅŸÄ±rÄ± satÄ±m, >70 aÅŸÄ±rÄ± alÄ±m.', 0, 100)}
          ${renderIndicatorDetailed(ind.macd, 'MACD', ind.macd?.histogram, 'Hareketli Ortalama YakÄ±nsama/Iraksama.', null, null, `MACD: ${ind.macd?.macd?.toFixed(2)||'-'} | Sinyal: ${ind.macd?.signal?.toFixed(2)||'-'}`)}
          ${renderIndicatorDetailed(ind.bollinger, 'Bollinger BantlarÄ±', ind.bollinger?.bandwidth, 'Fiyat volatilitesini Ã¶lÃ§er.', null, null, `Ãœst: ${fmtPrice(ind.bollinger?.upper)} | Orta: ${fmtPrice(ind.bollinger?.middle)} | Alt: ${fmtPrice(ind.bollinger?.lower)}`)}
          ${renderIndicatorDetailed(ind.ema, 'EMA', null, 'Ãœstel Hareketli Ortalama.', null, null, `EMA20: ${fmtPrice(ind.ema?.ema20)} | EMA50: ${fmtPrice(ind.ema?.ema50)} ${ind.ema?.ema100 ? '| EMA100: '+fmtPrice(ind.ema.ema100) : ''} ${ind.ema?.ema200 ? '| EMA200: '+fmtPrice(ind.ema.ema200) : ''}`)}
          ${renderIndicatorDetailed(ind.stochastic, 'Stochastic', ind.stochastic?.k, 'K<20 aÅŸÄ±rÄ± satÄ±m, K>80 aÅŸÄ±rÄ± alÄ±m.', 0, 100)}
          ${renderIndicatorDetailed(ind.atr, 'ATR', ind.atr?.value, 'Ortalama GerÃ§ek AralÄ±k. Volatilite Ã¶lÃ§er.', null, null, `GÃ¼nlÃ¼k ort. hareket: ${ind.atr?.pct?.toFixed(2)||'-'}%`)}
          ${renderIndicatorDetailed(ind.adx, 'ADX', ind.adx?.value, 'Trend gÃ¼cÃ¼nÃ¼ Ã¶lÃ§er. >25 gÃ¼Ã§lÃ¼ trend.', 0, 100)}
          ${renderIndicatorDetailed(ind.cci, 'CCI', ind.cci?.value, 'Emtia Kanal Endeksi.', -200, 200)}
          ${renderIndicatorDetailed(ind.williamsR, 'Williams %R', ind.williamsR?.value, 'AÅŸÄ±rÄ± alÄ±m/satÄ±m gÃ¶stergesi.', -100, 0)}
          ${renderIndicatorDetailed(ind.mfi, 'MFI', ind.mfi?.value, 'Para AkÄ±ÅŸ Endeksi.', 0, 100)}
          ${renderIndicatorDetailed(ind.ichimoku, 'Ichimoku', null, 'Japon bulut sistemi.', null, null, `Tenkan: ${fmtPrice(ind.ichimoku?.tenkan)} | Kijun: ${fmtPrice(ind.ichimoku?.kijun)}`)}
          ${renderIndicatorDetailed(ind.psar, 'Parabolic SAR', ind.psar?.value, 'Dur ve Geri DÃ¶n.', null, null, `SAR: ${fmtPrice(ind.psar?.value)} | Trend: ${ind.psar?.trend === 'up' ? 'â†‘ YÃ¼kseliÅŸ' : 'â†“ DÃ¼ÅŸÃ¼ÅŸ'}`)}
        </div>
      </div>
    </div>

    <!-- AL/SAT Ã–nerisi -->
    <div class="card mb-24 fade-in" style="border:2px solid var(--border);">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;font-size:16px;">AL / SAT Ã–nerisi</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:2000px;">
        <div style="font-size:11px;color:var(--text-muted);margin:8px 0 12px;">Bu Ã¶neriler teknik indikatÃ¶rlere dayanÄ±r, yatÄ±rÄ±m tavsiyesi deÄŸildir.</div>
        ${renderRecommendation(s.recommendation)}
      </div>
    </div>

    <!-- Pivot Points & Fibonacci & S/R -->
    <div class="grid-2 grid-3col mb-24" style="grid-template-columns:repeat(3,1fr);">
      <div class="card fade-in">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <div style="font-weight:700;">Pivot NoktalarÄ±</div>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
          ${renderPivotPoints(s.pivotPoints)}
        </div>
      </div>
      <div class="card fade-in">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <div style="font-weight:700;">Fibonacci Seviyeleri</div>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
          ${renderFibonacci(s.fibonacci)}
        </div>
      </div>
      <div class="card fade-in">
        <div class="collapsible-header" onclick="toggleSection(this)">
          <div style="font-weight:700;">Destek / DirenÃ§</div>
          <span class="collapse-icon">â–¼</span>
        </div>
        <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
          ${renderSR(s.supportResistance)}
        </div>
      </div>
    </div>

    <!-- Fundamentals -->
    <div class="card mb-24 fade-in">
      <div class="collapsible-header" onclick="toggleSection(this)">
        <div style="font-weight:700;">Temel Veriler</div>
        <span class="collapse-icon">â–¼</span>
      </div>
      <div class="collapsible-body" style="max-height:1000px;padding-top:8px;">
        ${renderFundamentals(s.fundamentals, s)}
      </div>
    </div>
  `;

  drawPriceChart(s.chartData, s.code, ind);
}

function loadCommodityPeriod(symbol, period) {
  navigate('commodity', { symbol });
  setTimeout(() => loadCommodityDetail(symbol, period), 50);
}


function toggleSection(header) {
  header.classList.toggle('collapsed');
  const body = header.nextElementSibling;
  body.classList.toggle('collapsed');
}

function renderIndicator(ind, nameOverride, valueOverride) {
  if (!ind) return '';
  const name = nameOverride || ind.name || '';
  const value = valueOverride !== undefined ? valueOverride : ind.value;
  return `
    <div class="indicator-card">
      <div class="ind-name">${name}</div>
      <div class="flex-between">
        <div class="ind-value">${value != null ? (typeof value === 'number' ? value.toFixed(2) : value) : '-'}</div>
        ${signalBadge(ind.signal || ind.signalType || 'neutral')}
      </div>
      <div class="ind-explanation">${ind.explanation || ''}</div>
    </div>
  `;
}

function renderIndicatorDetailed(ind, name, value, description, rangeMin, rangeMax, extraInfo) {
  if (!ind) return '';
  const sig = ind.signal || ind.signalType || 'neutral';
  const displayVal = value !== undefined && value !== null ? value : ind.value;
  const sigClass = sig === 'buy' ? 'signal-buy' : (sig === 'sell' ? 'signal-sell' : 'signal-neutral');
  const sigText = sig === 'buy' ? 'ALIÅ' : (sig === 'sell' ? 'SATIÅ' : 'NÃ–TR');
  const sigColor = sig === 'buy' ? 'var(--green)' : (sig === 'sell' ? 'var(--red)' : 'var(--text-muted)');

  let barHtml = '';
  if (rangeMin !== null && rangeMax !== null && displayVal != null) {
    const pct = Math.max(0, Math.min(100, ((displayVal - rangeMin) / (rangeMax - rangeMin)) * 100));
    const barColor = sig === 'buy' ? 'var(--green)' : (sig === 'sell' ? 'var(--red)' : 'var(--accent)');
    barHtml = `<div class="ind-bar"><div class="ind-bar-fill" style="width:${pct}%;background:${barColor};"></div></div>`;
  }

  return `
    <div class="indicator-card ${sigClass}">
      <div class="flex-between" style="margin-bottom:4px;">
        <div class="ind-name" style="margin-bottom:0;">${name}</div>
        <span style="font-size:10px;font-weight:700;color:${sigColor};padding:2px 6px;border-radius:4px;background:${sig==='buy'?'var(--green-bg)':(sig==='sell'?'var(--red-bg)':'rgba(255,255,255,0.05)')};">${sigText}</span>
      </div>
      <div class="ind-value">${displayVal != null ? (typeof displayVal === 'number' ? displayVal.toFixed(2) : displayVal) : '-'}</div>
      ${extraInfo ? '<div style="font-size:11px;color:var(--accent);margin-top:4px;font-family:var(--font-mono);">' + extraInfo + '</div>' : ''}
      ${barHtml}
      <div class="ind-detail">${description || ''}</div>
    </div>
  `;
}

function renderFundamentals(fund, stock) {
  if (!fund || Object.keys(fund).length === 0) {
    return '<div style="color:var(--text-muted);font-size:13px;">Veri hesaplanÄ±yor...</div>';
  }
  let html = '<div class="grid-4" style="gap:16px;">';
  const items = [
    {label:'Volatilite (YÄ±llÄ±k)', value: fund.volatility ? '%'+fund.volatility : '-', desc:'Fiyat dalgalanma oranÄ±'},
    {label:'Beta', value: fund.beta || '-', desc:'Piyasaya gÃ¶re risk'},
    {label:'Ort. Hacim (20G)', value: fund.avgVolume20 ? fmtVolume(fund.avgVolume20) : '-', desc:'Son 20 gÃ¼n ort.'},
    {label:'Ort. Hacim (60G)', value: fund.avgVolume60 ? fmtVolume(fund.avgVolume60) : '-', desc:'Son 60 gÃ¼n ort.'},
    {label:'Ort. GÃ¼nlÃ¼k AralÄ±k', value: fund.avgDailyRange ? fmtPrice(fund.avgDailyRange) + ' â‚º' : '-', desc: fund.avgDailyRangePct ? '%'+fund.avgDailyRangePct : ''},
    {label:'52H Tepeden UzaklÄ±k', value: fund.distFromHigh52w ? '%'+fund.distFromHigh52w : '-', desc:'52 hafta zirvesinden'},
    {label:'52H Dipten UzaklÄ±k', value: fund.distFromLow52w ? '%'+fund.distFromLow52w : '-', desc:'52 hafta dibinden'},
    {label:'Ort. Ä°ÅŸlem Hacmi', value: fund.avgTurnover ? fmtVolume(fund.avgTurnover) + ' â‚º' : '-', desc:'GÃ¼nlÃ¼k TL hacim'},
  ];
  items.forEach(item => {
    html += `<div style="padding:8px 0;">
      <div style="font-size:11px;color:var(--text-muted);">${item.label}</div>
      <div class="td-mono" style="font-size:15px;margin-top:2px;">${item.value}</div>
      ${item.desc ? '<div style="font-size:10px;color:var(--text-muted);">'+item.desc+'</div>' : ''}
    </div>`;
  });
  html += '</div>';

  // Getiriler
  if (fund.returns && Object.keys(fund.returns).length > 0) {
    html += '<div style="margin-top:16px;padding-top:12px;border-top:1px solid var(--border);">';
    html += '<div style="font-size:12px;font-weight:600;margin-bottom:8px;">DÃ¶nemsel Getiri</div>';
    html += '<div class="flex-center gap-16" style="flex-wrap:wrap;">';
    Object.entries(fund.returns).forEach(([period, ret]) => {
      const color = ret >= 0 ? 'var(--green)' : 'var(--red)';
      html += `<div style="text-align:center;min-width:60px;">
        <div style="font-size:11px;color:var(--text-muted);">${period}</div>
        <div style="font-family:var(--font-mono);font-size:14px;font-weight:700;color:${color};">${ret >= 0 ? '+' : ''}%${ret}</div>
      </div>`;
    });
    html += '</div></div>';
  }
  return html;
}

function renderFibonacci(fib) {
  if (!fib || !fib.levels || Object.keys(fib.levels).length === 0) return '<div style="color:var(--text-muted);font-size:13px;">Veri yok</div>';
  const hi = fib.high || 0;
  const lo = fib.low || 0;
  const range = hi - lo;
  return Object.entries(fib.levels).map(([key, val]) => {
    const pct = range > 0 ? ((val - lo) / range * 100) : 50;
    const isNearSupport = fib.nearestSupport && Math.abs(val - fib.nearestSupport.price) < 0.01;
    const isNearResistance = fib.nearestResistance && Math.abs(val - fib.nearestResistance.price) < 0.01;
    const labelColor = isNearSupport ? 'var(--green)' : (isNearResistance ? 'var(--red)' : 'var(--text-muted)');
    const valColor = isNearSupport ? 'var(--green)' : (isNearResistance ? 'var(--red)' : 'inherit');
    return `<div class="fib-bar">
      <div class="fib-label" style="color:${labelColor};">${key}</div>
      <div class="fib-line">
        <div style="position:absolute;left:${pct}%;top:-3px;width:8px;height:8px;background:var(--accent);border-radius:50%;transform:translateX(-50%);"></div>
      </div>
      <div class="fib-value" style="color:${valColor};">${fmtPrice(val)} â‚º</div>
    </div>`;
  }).join('');
}

function renderSR(sr) {
  if (!sr) return '<div style="color:var(--text-muted);font-size:13px;">Veri yok</div>';
  let html = '<div style="font-size:12px;color:var(--text-secondary);margin-bottom:12px;">' + (sr.explanation || '') + '</div>';

  if (sr.resistances && sr.resistances.length) {
    html += '<div style="margin-bottom:8px;font-size:11px;color:var(--text-muted);">DÄ°RENÃ‡</div>';
    sr.resistances.forEach(r => {
      html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <span style="width:8px;height:8px;background:var(--red);border-radius:50%;"></span>
        <span class="td-mono">${fmtPrice(r)}</span>
      </div>`;
    });
  }

  html += `<div style="display:flex;align-items:center;gap:8px;margin:12px 0;padding:8px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);">
    <span style="width:8px;height:8px;background:var(--accent);border-radius:50%;"></span>
    <span class="td-mono" style="color:var(--accent);font-weight:700;">GÃ¼ncel: ${fmtPrice(sr.current)}</span>
  </div>`;

  if (sr.supports && sr.supports.length) {
    html += '<div style="margin-bottom:8px;font-size:11px;color:var(--text-muted);">DESTEK</div>';
    sr.supports.forEach(s => {
      html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;">
        <span style="width:8px;height:8px;background:var(--green);border-radius:50%;"></span>
        <span class="td-mono">${fmtPrice(s)}</span>
      </div>`;
    });
  }
  return html;
}

function renderPivotPoints(pp) {
  if (!pp || !pp.classic || !pp.classic.pp) return '<div style="color:var(--text-muted);font-size:13px;">Veri yok</div>';
  const cur = pp.current || 0;
  function pivotRow(label, val, type) {
    const color = type === 'r' ? 'var(--red)' : type === 's' ? 'var(--green)' : 'var(--accent)';
    const dist = cur ? (((val - cur) / cur) * 100).toFixed(2) : 0;
    const distLabel = val > cur ? `+${dist}%` : `${dist}%`;
    return `<div style="display:flex;justify-content:space-between;align-items:center;padding:3px 0;border-bottom:1px solid var(--border);">
      <span style="color:${color};font-weight:600;font-size:12px;min-width:32px;">${label}</span>
      <span class="td-mono" style="font-size:13px;">${fmtPrice(val)}</span>
      <span style="font-size:11px;color:var(--text-muted);">${distLabel}</span>
    </div>`;
  }
  let html = '<div style="display:flex;gap:4px;margin-bottom:10px;">';
  html += '<button onclick="switchPivot(\'classic\')" class="pivot-tab active" id="pt-classic" style="flex:1;padding:4px 8px;font-size:11px;border:1px solid var(--border);border-radius:6px;background:var(--accent);color:#fff;cursor:pointer;">Klasik</button>';
  html += '<button onclick="switchPivot(\'camarilla\')" class="pivot-tab" id="pt-camarilla" style="flex:1;padding:4px 8px;font-size:11px;border:1px solid var(--border);border-radius:6px;background:var(--card-bg);color:var(--text-secondary);cursor:pointer;">Camarilla</button>';
  html += '<button onclick="switchPivot(\'woodie\')" class="pivot-tab" id="pt-woodie" style="flex:1;padding:4px 8px;font-size:11px;border:1px solid var(--border);border-radius:6px;background:var(--card-bg);color:var(--text-secondary);cursor:pointer;">Woodie</button>';
  html += '</div>';
  
  const c = pp.classic;
  html += '<div id="pivot-classic">';
  if(c.r3) html += pivotRow('R3', c.r3, 'r');
  if(c.r2) html += pivotRow('R2', c.r2, 'r');
  if(c.r1) html += pivotRow('R1', c.r1, 'r');
  html += pivotRow('PP', c.pp, 'p');
  if(c.s1) html += pivotRow('S1', c.s1, 's');
  if(c.s2) html += pivotRow('S2', c.s2, 's');
  if(c.s3) html += pivotRow('S3', c.s3, 's');
  html += '</div>';

  const cam = pp.camarilla;
  html += '<div id="pivot-camarilla" style="display:none;">';
  if(cam.r4) html += pivotRow('R4', cam.r4, 'r');
  if(cam.r3) html += pivotRow('R3', cam.r3, 'r');
  if(cam.r2) html += pivotRow('R2', cam.r2, 'r');
  if(cam.r1) html += pivotRow('R1', cam.r1, 'r');
  html += pivotRow('PP', cam.pp, 'p');
  if(cam.s1) html += pivotRow('S1', cam.s1, 's');
  if(cam.s2) html += pivotRow('S2', cam.s2, 's');
  if(cam.s3) html += pivotRow('S3', cam.s3, 's');
  if(cam.s4) html += pivotRow('S4', cam.s4, 's');
  html += '</div>';

  const w = pp.woodie;
  html += '<div id="pivot-woodie" style="display:none;">';
  if(w.r2) html += pivotRow('R2', w.r2, 'r');
  if(w.r1) html += pivotRow('R1', w.r1, 'r');
  html += pivotRow('PP', w.pp, 'p');
  if(w.s1) html += pivotRow('S1', w.s1, 's');
  if(w.s2) html += pivotRow('S2', w.s2, 's');
  html += '</div>';
  return html;
}
function switchPivot(type) {
  ['classic','camarilla','woodie'].forEach(t => {
    const el = document.getElementById('pivot-' + t);
    const btn = document.getElementById('pt-' + t);
    if (el) el.style.display = t === type ? 'block' : 'none';
    if (btn) { btn.style.background = t === type ? 'var(--accent)' : 'var(--card-bg)'; btn.style.color = t === type ? '#fff' : 'var(--text-secondary)'; }
  });
}

function renderRecommendation(rec) {
  if (!rec) return '<div style="color:var(--text-muted);font-size:13px;">Veri yok</div>';
  const actionColor = (a) => {
    if (!a) return 'var(--text-muted)';
    if (a === 'AL') return 'var(--green)';
    if (a === 'SAT') return 'var(--red)';
    if (a === 'TUTUN/AL') return '#4CAF50';
    if (a === 'TUTUN/SAT') return '#FF9800';
    return 'var(--text-secondary)';
  };
  const actionIcon = (a) => {
    if (!a) return 'â¸ï¸';
    if (a === 'AL') return 'ğŸŸ¢';
    if (a === 'SAT') return 'ğŸ”´';
    if (a === 'TUTUN/AL') return 'ğŸŸ¡';
    if (a === 'TUTUN/SAT') return 'ğŸŸ ';
    return 'âšª';
  };
  const actionDesc = (a) => {
    if (a === 'AL') return 'Teknik gÃ¶stergeler gÃ¼Ã§lÃ¼ alÄ±ÅŸ sinyali veriyor';
    if (a === 'SAT') return 'Teknik gÃ¶stergeler satÄ±ÅŸ yÃ¶nÃ¼nde';
    if (a === 'TUTUN/AL') return 'Hafif pozitif, alÄ±ÅŸ yÃ¶nÃ¼nde eÄŸilim var';
    if (a === 'TUTUN/SAT') return 'Hafif negatif, dikkatli olunmalÄ±';
    return 'Belirgin bir yÃ¶n sinyali yok';
  };
  let html = '';
  [['weekly','HaftalÄ±k'],['monthly','AylÄ±k'],['yearly','YÄ±llÄ±k']].forEach(([key, label]) => {
    const r = rec[key];
    if (!r) return;
    const conf = r.confidence || 0;
    const kl = r.keyLevels || {};

    html += `<div style="padding:14px;border:1px solid var(--border);border-radius:10px;margin-bottom:12px;background:var(--card-bg);">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <span style="font-weight:700;font-size:14px;">${label}</span>
        <span style="font-size:20px;font-weight:800;color:${actionColor(r.action)};">${actionIcon(r.action)} ${r.action || 'NOTR'}</span>
      </div>
      <div style="font-size:12px;color:var(--text-secondary);margin-bottom:10px;">${actionDesc(r.action)}</div>
      <div style="display:flex;align-items:center;gap:8px;margin-bottom:10px;">
        <div style="flex:1;height:8px;background:var(--border);border-radius:4px;overflow:hidden;">
          <div style="width:${conf}%;height:100%;background:${actionColor(r.action)};border-radius:4px;"></div>
        </div>
        <span style="font-size:12px;font-weight:600;color:var(--text-muted);">%${conf.toFixed ? conf.toFixed(0) : conf}</span>
      </div>`;

    // Strateji kutusu
    if (r.strategy) {
      html += `<div style="background:rgba(99,102,241,0.1);border:1px solid rgba(99,102,241,0.2);border-radius:8px;padding:10px;margin-bottom:10px;">
        <div style="font-size:11px;font-weight:700;color:var(--accent);margin-bottom:4px;">STRATEJÄ°</div>
        <div style="font-size:12px;color:var(--text-primary);line-height:1.6;">${r.strategy.split(' | ').map(s => 'â†’ ' + s).join('<br>')}</div>
      </div>`;
    }

    // Onemli seviyeler
    if (kl.supports?.length || kl.resistances?.length) {
      html += '<div style="display:flex;gap:12px;margin-bottom:10px;flex-wrap:wrap;">';
      if (kl.supports?.length) {
        html += '<div style="flex:1;min-width:120px;padding:8px;border-radius:6px;background:rgba(16,185,129,0.08);border:1px solid rgba(16,185,129,0.2);">';
        html += '<div style="font-size:10px;font-weight:700;color:var(--green);margin-bottom:4px;">DESTEK</div>';
        kl.supports.forEach(s => { html += '<div style="font-family:var(--font-mono);font-size:12px;color:var(--green);">' + fmtPrice(s) + ' â‚º</div>'; });
        html += '</div>';
      }
      if (kl.resistances?.length) {
        html += '<div style="flex:1;min-width:120px;padding:8px;border-radius:6px;background:rgba(239,68,68,0.08);border:1px solid rgba(239,68,68,0.2);">';
        html += '<div style="font-size:10px;font-weight:700;color:var(--red);margin-bottom:4px;">DÄ°RENÃ‡</div>';
        kl.resistances.forEach(r2 => { html += '<div style="font-family:var(--font-mono);font-size:12px;color:var(--red);">' + fmtPrice(r2) + ' â‚º</div>'; });
        html += '</div>';
      }
      html += '</div>';
    }

    // Nedenler
    if (r.reasons && r.reasons.length) {
      html += '<div style="font-size:11px;color:var(--text-secondary);line-height:1.7;border-top:1px solid var(--border);padding-top:8px;">';
      r.reasons.forEach(reason => {
        let icon = 'â€¢';
        if (reason.toLowerCase().includes('alis') || reason.toLowerCase().includes('uzerinde') || reason.toLowerCase().includes('yukari') || reason.toLowerCase().includes('pozitif')) icon = '<span style="color:var(--green);">â–²</span>';
        else if (reason.toLowerCase().includes('satis') || reason.toLowerCase().includes('altinda') || reason.toLowerCase().includes('asagi') || reason.toLowerCase().includes('negatif') || reason.toLowerCase().includes('dusus')) icon = '<span style="color:var(--red);">â–¼</span>';
        html += icon + ' ' + reason + '<br>';
      });
      html += '</div>';
    }

    html += '</div>';
  });
  return html;
}

// =============================================================================
// NEW FEATURE RENDERERS (v7.0)
// =============================================================================
function renderCandlestickPatterns(candle) {
  if (!candle || !candle.patterns || !candle.patterns.length) return '<div style="font-size:12px;color:var(--text-muted);">Aktif mum formasyonu tespit edilmedi</div>';
  return candle.patterns.map(p => {
    const color = p.type === 'bullish' ? 'var(--green)' : (p.type === 'bearish' ? 'var(--red)' : 'var(--text-muted)');
    const icon = p.type === 'bullish' ? 'ğŸŸ¢' : (p.type === 'bearish' ? 'ğŸ”´' : 'âšª');
    const stars = 'â˜…'.repeat(p.strength) + 'â˜†'.repeat(5 - p.strength);
    return `<div style="padding:10px;border:1px solid var(--border);border-radius:8px;margin-bottom:8px;background:rgba(${p.type === 'bullish' ? '16,185,129' : (p.type === 'bearish' ? '239,68,68' : '156,163,175')},0.05);">
      <div style="display:flex;justify-content:space-between;align-items:center;">
        <span style="font-weight:700;color:${color};">${icon} ${p.name}</span>
        <span style="font-size:11px;color:var(--yellow);">${stars}</span>
      </div>
      <div style="font-size:12px;color:var(--text-secondary);margin-top:4px;">${p.description}</div>
    </div>`;
  }).join('');
}

function renderMLConfidence(mlConf) {
  if (!mlConf) return '';
  let html = '';
  [['weekly','HaftalÄ±k'],['monthly','AylÄ±k'],['yearly','YÄ±llÄ±k']].forEach(([key, label]) => {
    const m = mlConf[key];
    if (!m || !m.factors?.length) return;
    const gradeColor = {'A':'var(--green)','B':'#4CAF50','C':'var(--yellow)','D':'var(--red)','F':'#ff0000'}[m.grade] || 'var(--text-muted)';
    html += `<div style="padding:12px;border:1px solid var(--border);border-radius:8px;margin-bottom:10px;">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:10px;">
        <span style="font-weight:700;font-size:13px;">${label}</span>
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:24px;font-weight:900;color:${gradeColor};">${m.grade}</span>
          <span style="font-size:13px;color:var(--text-muted);">%${m.confidence}</span>
        </div>
      </div>
      <div style="height:6px;background:var(--border);border-radius:3px;margin-bottom:10px;overflow:hidden;">
        <div style="width:${m.confidence}%;height:100%;background:${gradeColor};border-radius:3px;"></div>
      </div>`;
    m.factors.forEach(f => {
      const pct = f.max > 0 ? (f.score / f.max * 100) : 0;
      html += `<div style="display:flex;align-items:center;gap:8px;margin-bottom:4px;font-size:11px;">
        <span style="width:140px;color:var(--text-secondary);">${f.name}</span>
        <div style="flex:1;height:4px;background:var(--border);border-radius:2px;overflow:hidden;">
          <div style="width:${pct}%;height:100%;background:var(--accent);border-radius:2px;"></div>
        </div>
        <span style="width:50px;text-align:right;color:var(--text-muted);">${f.score}/${f.max}</span>
      </div>`;
    });
    html += '</div>';
  });
  return html || '<div style="font-size:12px;color:var(--text-muted);">ML guven analizi mevcut degil</div>';
}

function renderMarketRegime(regime) {
  if (!regime || regime.regime === 'unknown') return '';
  const regimeColors = {
    'strong_bull': 'var(--green)', 'bull': '#4CAF50',
    'strong_bear': 'var(--red)', 'bear': '#FF9800',
    'sideways': 'var(--yellow)',
  };
  const regimeEmoji = {
    'strong_bull': 'ğŸ‚ğŸ‚', 'bull': 'ğŸ‚',
    'strong_bear': 'ğŸ»ğŸ»', 'bear': 'ğŸ»',
    'sideways': 'â†”ï¸',
  };
  const color = regimeColors[regime.regime] || 'var(--text-muted)';
  const emoji = regimeEmoji[regime.regime] || 'â“';
  return `<div style="padding:12px;border:2px solid ${color};border-radius:10px;background:rgba(${regime.regime.includes('bull') ? '16,185,129' : (regime.regime.includes('bear') ? '239,68,68' : '234,179,8')},0.05);">
    <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
      <span style="font-weight:800;font-size:15px;color:${color};">${emoji} ${regime.description}</span>
      <span style="font-size:12px;color:var(--text-muted);">Guc: %${regime.strength}</span>
    </div>
    <div style="height:6px;background:var(--border);border-radius:3px;margin-bottom:8px;overflow:hidden;">
      <div style="width:${regime.strength}%;height:100%;background:${color};border-radius:3px;"></div>
    </div>
    ${regime.reasons ? '<div style="font-size:11px;color:var(--text-secondary);line-height:1.6;">' + regime.reasons.slice(0,4).map(r => 'â€¢ ' + r).join('<br>') + '</div>' : ''}
  </div>`;
}

function renderSignalBacktest(bt) {
  if (!bt || bt.totalSignals === 0) return '<div style="font-size:12px;color:var(--text-muted);">Yeterli gecmis sinyal bulunamadi</div>';
  const overall = bt.overall || {};
  const buy = bt.buySignals || {};
  const sell = bt.sellSignals || {};
  const winColor = (rate) => rate >= 60 ? 'var(--green)' : (rate >= 45 ? 'var(--yellow)' : 'var(--red)');
  return `<div style="margin-bottom:12px;">
    <div style="display:flex;gap:8px;margin-bottom:12px;flex-wrap:wrap;">
      <div style="flex:1;min-width:100px;padding:10px;border-radius:8px;background:rgba(99,102,241,0.1);text-align:center;">
        <div style="font-size:20px;font-weight:800;color:var(--accent);">${bt.totalSignals}</div>
        <div style="font-size:10px;color:var(--text-muted);">Toplam Sinyal</div>
      </div>
      <div style="flex:1;min-width:100px;padding:10px;border-radius:8px;background:rgba(16,185,129,0.1);text-align:center;">
        <div style="font-size:20px;font-weight:800;color:${winColor(overall.winRate10d)};">%${overall.winRate10d}</div>
        <div style="font-size:10px;color:var(--text-muted);">10G Basari</div>
      </div>
      <div style="flex:1;min-width:100px;padding:10px;border-radius:8px;background:rgba(234,179,8,0.1);text-align:center;">
        <div style="font-size:20px;font-weight:800;color:${overall.avgRet10d >= 0 ? 'var(--green)' : 'var(--red)'};">%${overall.avgRet10d}</div>
        <div style="font-size:10px;color:var(--text-muted);">10G Ort. Getiri</div>
      </div>
    </div>
    <table style="width:100%;font-size:12px;">
      <thead><tr style="color:var(--text-muted);"><th></th><th>Sayi</th><th>5G Basari</th><th>10G Basari</th><th>20G Basari</th><th>10G Getiri</th></tr></thead>
      <tbody>
        <tr><td style="color:var(--green);font-weight:600;">Alis</td><td>${buy.count||0}</td><td style="color:${winColor(buy.winRate5d)};">%${buy.winRate5d||0}</td><td style="color:${winColor(buy.winRate10d)};">%${buy.winRate10d||0}</td><td style="color:${winColor(buy.winRate20d)};">%${buy.winRate20d||0}</td><td>${buy.avgRet10d||0}%</td></tr>
        <tr><td style="color:var(--red);font-weight:600;">Satis</td><td>${sell.count||0}</td><td style="color:${winColor(sell.winRate5d)};">%${sell.winRate5d||0}</td><td style="color:${winColor(sell.winRate10d)};">%${sell.winRate10d||0}</td><td style="color:${winColor(sell.winRate20d)};">%${sell.winRate20d||0}</td><td>${sell.avgRet10d||0}%</td></tr>
      </tbody>
    </table>
    ${bt.byReason ? '<div style="margin-top:10px;font-size:11px;color:var(--text-muted);border-top:1px solid var(--border);padding-top:8px;"><b>Sinyal Tiplerine Gore:</b><br>' + Object.entries(bt.byReason).map(([k,v]) => `â€¢ ${k}: ${v.count} sinyal, %${v.winRate10d} basari`).join('<br>') + '</div>' : ''}
  </div>`;
}

function renderTradePlan(plan) {
  if (!plan || !Object.keys(plan).length) return '<div style="font-size:12px;color:var(--text-muted);">Trade plan verisi mevcut degil</div>';

  const tfLabels = { daily: 'Gunluk', weekly: 'Haftalik', monthly: 'Aylik' };
  const trendIcons = { yukari: 'ğŸ“ˆ', asagi: 'ğŸ“‰', yatay: 'â†”ï¸' };
  const signalColors = { AL: 'var(--green)', SAT: 'var(--red)', BEKLE: 'var(--yellow)' };

  let html = '';
  for (const [tf, tfPlan] of Object.entries(plan)) {
    const label = tfLabels[tf] || tf;
    const trendIcon = trendIcons[tfPlan.trend] || 'â“';
    const sigColor = signalColors[tfPlan.signal] || 'var(--text-muted)';
    const buy = tfPlan.buy || {};
    const sell = tfPlan.sell || {};
    const kl = tfPlan.keyLevels || {};

    html += `<div style="border:2px solid var(--border);border-radius:12px;padding:16px;margin-bottom:16px;background:var(--card-bg);">`;
    // Header
    html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:12px;">
      <div style="display:flex;align-items:center;gap:8px;">
        <span style="font-size:20px;">${trendIcon}</span>
        <div>
          <div style="font-weight:800;font-size:15px;">${label} Plan</div>
          <div style="font-size:11px;color:var(--text-muted);">RSI: ${tfPlan.rsi} | ATR: ${tfPlan.atr} TL | Momentum: %${tfPlan.momentum}</div>
        </div>
      </div>
      <div style="text-align:right;">
        <div style="font-size:20px;font-weight:900;color:${sigColor};">${tfPlan.signal}</div>
        <div style="font-size:10px;color:var(--text-muted);max-width:180px;">${tfPlan.signalDescription}</div>
      </div>
    </div>`;

    // Alis / Satis yan yana
    html += '<div style="display:grid;grid-template-columns:1fr 1fr;gap:12px;">';

    // --- ALIS PLANI ---
    html += `<div style="border-radius:10px;padding:14px;background:rgba(16,185,129,0.04);border:1px solid rgba(16,185,129,0.2);">
      <div style="font-weight:800;color:var(--green);font-size:13px;margin-bottom:10px;">ğŸŸ¢ ALIÅ PLANI</div>`;
    // Entry
    html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <span style="font-size:11px;color:var(--text-muted);">GiriÅŸ FiyatÄ±</span>
      <span style="font-weight:800;font-size:16px;color:var(--green);">${buy.entry || '-'} â‚º</span>
    </div>`;
    // SL
    html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <span style="font-size:11px;color:var(--text-muted);">Stop-Loss</span>
      <span style="font-weight:700;font-size:13px;color:var(--red);">${buy.stopLoss || '-'} â‚º</span>
    </div>`;
    // Risk
    if (buy.risk) {
      html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px;">
        <span style="font-size:11px;color:var(--text-muted);">Risk (Fark)</span>
        <span style="font-size:12px;color:var(--red);">${buy.risk} â‚º</span>
      </div>`;
    }
    // Targets
    if (buy.targets && buy.targets.length) {
      html += '<div style="border-top:1px solid rgba(16,185,129,0.15);padding-top:8px;margin-top:4px;">';
      buy.targets.forEach((t, i) => {
        const tColors = ['var(--green)', 'var(--accent)', 'var(--yellow)'];
        html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <span style="font-size:11px;color:var(--text-muted);">Hedef ${i+1}</span>
          <span style="font-weight:700;font-size:13px;color:${tColors[i] || 'var(--green)'};">${t} â‚º</span>
        </div>`;
      });
      html += '</div>';
    }
    // R/R
    if (buy.riskReward) {
      const rrColor = parseFloat(buy.riskReward) >= 2 ? 'var(--green)' : (parseFloat(buy.riskReward) >= 1 ? 'var(--yellow)' : 'var(--red)');
      html += `<div style="margin-top:8px;padding:6px 10px;background:rgba(16,185,129,0.1);border-radius:6px;text-align:center;">
        <span style="font-size:11px;color:var(--text-muted);">Risk/Ã–dÃ¼l:</span>
        <span style="font-weight:800;font-size:14px;color:${rrColor};margin-left:6px;">1:${buy.riskReward}</span>
      </div>`;
    }
    // Entry uzakligi
    if (buy.distanceFromEntry && parseFloat(buy.distanceFromEntry) != 0) {
      const dist = parseFloat(buy.distanceFromEntry);
      html += `<div style="font-size:10px;color:var(--text-muted);margin-top:6px;text-align:center;">
        Mevcut fiyat giristen %${Math.abs(dist).toFixed(1)} ${dist > 0 ? 'yukarida' : 'asagida'}
      </div>`;
    }
    html += '</div>';

    // --- SATIS PLANI ---
    html += `<div style="border-radius:10px;padding:14px;background:rgba(239,68,68,0.04);border:1px solid rgba(239,68,68,0.2);">
      <div style="font-weight:800;color:var(--red);font-size:13px;margin-bottom:10px;">ğŸ”´ SATIÅ PLANI</div>`;
    // Entry
    html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <span style="font-size:11px;color:var(--text-muted);">SatÄ±ÅŸ FiyatÄ±</span>
      <span style="font-weight:800;font-size:16px;color:var(--red);">${sell.entry || '-'} â‚º</span>
    </div>`;
    // SL
    html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:6px;">
      <span style="font-size:11px;color:var(--text-muted);">Stop-Loss</span>
      <span style="font-weight:700;font-size:13px;color:var(--yellow);">${sell.stopLoss || '-'} â‚º</span>
    </div>`;
    // Targets
    if (sell.targets && sell.targets.length) {
      html += '<div style="border-top:1px solid rgba(239,68,68,0.15);padding-top:8px;margin-top:4px;">';
      sell.targets.forEach((t, i) => {
        const tColors = ['var(--red)', '#FF9800', 'var(--yellow)'];
        html += `<div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:4px;">
          <span style="font-size:11px;color:var(--text-muted);">Hedef ${i+1}</span>
          <span style="font-weight:700;font-size:13px;color:${tColors[i] || 'var(--red)'};">${t} â‚º</span>
        </div>`;
      });
      html += '</div>';
    }
    // R/R
    if (sell.riskReward) {
      const rrColor = parseFloat(sell.riskReward) >= 2 ? 'var(--green)' : (parseFloat(sell.riskReward) >= 1 ? 'var(--yellow)' : 'var(--red)');
      html += `<div style="margin-top:8px;padding:6px 10px;background:rgba(239,68,68,0.1);border-radius:6px;text-align:center;">
        <span style="font-size:11px;color:var(--text-muted);">Risk/Ã–dÃ¼l:</span>
        <span style="font-weight:800;font-size:14px;color:${rrColor};margin-left:6px;">1:${sell.riskReward}</span>
      </div>`;
    }
    html += '</div>';
    html += '</div>'; // grid end

    // Onemli seviyeler compact
    html += `<div style="margin-top:10px;padding:10px;background:var(--bg);border-radius:8px;">
      <div style="font-size:10px;font-weight:700;color:var(--text-muted);margin-bottom:6px;">Ã–NEMLI SEVÄ°YELER</div>
      <div style="display:flex;gap:8px;flex-wrap:wrap;font-size:11px;">
        ${kl.ema20 ? `<span style="padding:2px 8px;border-radius:4px;background:rgba(99,102,241,0.1);color:var(--accent);">EMA20: ${kl.ema20}</span>` : ''}
        ${kl.ema50 ? `<span style="padding:2px 8px;border-radius:4px;background:rgba(99,102,241,0.1);color:var(--accent);">EMA50: ${kl.ema50}</span>` : ''}
        ${kl.bbUpper ? `<span style="padding:2px 8px;border-radius:4px;background:rgba(239,68,68,0.1);color:var(--red);">BB Ãœst: ${kl.bbUpper}</span>` : ''}
        ${kl.bbLower ? `<span style="padding:2px 8px;border-radius:4px;background:rgba(16,185,129,0.1);color:var(--green);">BB Alt: ${kl.bbLower}</span>` : ''}
        ${kl.pivotPP ? `<span style="padding:2px 8px;border-radius:4px;background:rgba(234,179,8,0.1);color:var(--yellow);">Pivot: ${kl.pivotPP}</span>` : ''}
        ${(kl.supports||[]).map(s => `<span style="padding:2px 8px;border-radius:4px;background:rgba(16,185,129,0.1);color:var(--green);">D: ${s}</span>`).join('')}
        ${(kl.resistances||[]).map(r => `<span style="padding:2px 8px;border-radius:4px;background:rgba(239,68,68,0.1);color:var(--red);">R: ${r}</span>`).join('')}
      </div>
    </div>`;

    html += '</div>'; // main card end
  }
  return html;
}

function renderTradePlanCompact(plan, timeframe) {
  // Sinyaller sayfasinda kullanilacak kompakt versiyon
  if (!plan) return '';
  const tf = plan[timeframe] || plan.weekly || plan.daily;
  if (!tf) return '';
  const buy = tf.buy || {};
  const sell = tf.sell || {};
  return `<div style="font-size:11px;line-height:1.7;">
    <div style="color:var(--green);">ğŸŸ¢ GiriÅŸ: ${buy.entry||'-'} â‚º | SL: ${buy.stopLoss||'-'} â‚º</div>
    <div style="color:var(--green);">â†’ Hedef: ${(buy.targets||[]).join(' / ')} â‚º (R/R ${buy.riskReward||'-'})</div>
    <div style="color:var(--red);margin-top:2px;">ğŸ”´ SatiÅŸ: ${sell.entry||'-'} â‚º | SL: ${sell.stopLoss||'-'} â‚º</div>
    <div style="color:var(--red);">â†’ Hedef: ${(sell.targets||[]).join(' / ')} â‚º</div>
  </div>`;
}

// =============================================================================
// CHARTS - Multi-panel system with toggleable indicators
// =============================================================================
let _chartData = null;
let _chartSymbol = null;
let _chartIndicators = null;
let _charts = {}; // {main, volume, macd, rsi, stoch}
let _activeOverlays = new Set(['ema20', 'ema50']);
let _activeSubCharts = new Set(['volume']);

const OVERLAY_DEFS = {
  ema5:   { label: 'EMA 5',   color: '#ff6b6b', cat: 'EMA' },
  ema10:  { label: 'EMA 10',  color: '#ffa06b', cat: 'EMA' },
  ema20:  { label: 'EMA 20',  color: '#ffc547', cat: 'EMA' },
  ema50:  { label: 'EMA 50',  color: '#a78bfa', cat: 'EMA' },
  ema100: { label: 'EMA 100', color: '#4da6ff', cat: 'EMA' },
  ema200: { label: 'EMA 200', color: '#ff4da6', cat: 'EMA' },
  bbands: { label: 'Bollinger', color: '#ff4d6a', cat: 'Bant' },
  ichimoku: { label: 'Ichimoku', color: '#26a69a', cat: 'Trend' },
  vwap:   { label: 'VWAP',    color: '#e040fb',  cat: 'Hacim' },
  psar:   { label: 'P.SAR',   color: '#ffeb3b',  cat: 'Trend' },
};

const SUBCHART_DEFS = {
  volume:  { label: 'Hacim',      color: '#4da6ff', cat: 'Alt Grafik' },
  macd:    { label: 'MACD',       color: '#ffc547', cat: 'Alt Grafik' },
  rsi:     { label: 'RSI',        color: '#00e5a0', cat: 'Alt Grafik' },
  stoch:   { label: 'Stochastic', color: '#a78bfa', cat: 'Alt Grafik' },
};

function toggleOverlay(key) {
  if (_activeOverlays.has(key)) _activeOverlays.delete(key);
  else _activeOverlays.add(key);
  rebuildCharts();
}

function toggleSubChart(key) {
  if (_activeSubCharts.has(key)) _activeSubCharts.delete(key);
  else _activeSubCharts.add(key);
  rebuildCharts();
}

function rebuildCharts() {
  if (!_chartData || !_chartSymbol) return;
  drawPriceChart(_chartData, _chartSymbol, _chartIndicators);
}

function renderChartToolbar() {
  const cats = {};
  for (const [k, v] of Object.entries(OVERLAY_DEFS)) {
    if (!cats[v.cat]) cats[v.cat] = [];
    cats[v.cat].push({ key: k, ...v, active: _activeOverlays.has(k), type: 'overlay' });
  }
  for (const [k, v] of Object.entries(SUBCHART_DEFS)) {
    if (!cats[v.cat]) cats[v.cat] = [];
    cats[v.cat].push({ key: k, ...v, active: _activeSubCharts.has(k), type: 'sub' });
  }

  let html = '';
  for (const [cat, items] of Object.entries(cats)) {
    html += `<div style="display:flex;align-items:center;gap:3px;flex-wrap:wrap;"><span style="font-size:9px;color:var(--text-muted);min-width:55px;font-weight:600;">${cat}</span>`;
    for (const it of items) {
      const fn = it.type === 'overlay' ? 'toggleOverlay' : 'toggleSubChart';
      html += `<button onclick="${fn}('${it.key}')" style="font-size:10px;padding:2px 7px;border-radius:4px;border:1px solid ${it.color}${it.active?'':'33'};background:${it.active ? it.color+'25' : 'transparent'};color:${it.active ? it.color : 'var(--text-muted)'};cursor:pointer;transition:all .15s;font-family:var(--font-body);">${it.label}</button>`;
    }
    html += '</div>';
  }
  return html;
}

const _cOpts = {
  responsive: true, maintainAspectRatio: false,
  interaction: { mode: 'index', intersect: false },
  plugins: {
    legend: { display: true, position: 'top', labels: { color: '#8896aa', font: { size: 9 }, boxWidth: 10, padding: 6, usePointStyle: true } },
    tooltip: { backgroundColor: '#1a2234', borderColor: '#2a3548', borderWidth: 1, titleColor: '#e8ecf4', bodyColor: '#8896aa', titleFont: { family: 'JetBrains Mono', size: 11 }, bodyFont: { family: 'JetBrains Mono', size: 10 } },
  },
  scales: {
    x: { display: false },
    y: { grid: { color: 'rgba(42,53,72,0.3)' }, ticks: { color: '#5a6a80', font: { family: 'JetBrains Mono', size: 10 } } },
  }
};

function drawPriceChart(chartData, symbol, indicators) {
  if (!chartData || !chartData.dates) return;
  _chartData = chartData;
  _chartSymbol = symbol;
  _chartIndicators = indicators;

  // Destroy old charts
  Object.values(_charts).forEach(c => { try { c.destroy(); } catch(e){} });
  _charts = {};

  const container = document.getElementById('chartSystem');
  if (!container) return;

  const dates = chartData.dates;
  const pad = (arr, len) => { const p = len - arr.length; return p > 0 ? [...Array(p).fill(null), ...arr] : arr; };

  // Build HTML
  let html = `<div style="background:var(--bg-card);border-radius:var(--radius);border:1px solid var(--border);overflow:hidden;">`;
  // Toolbar
  html += `<div style="padding:10px 12px;border-bottom:1px solid var(--border);display:flex;flex-direction:column;gap:4px;">${renderChartToolbar()}</div>`;
  // Main chart
  html += `<div style="height:360px;padding:8px;"><canvas id="mainChart"></canvas></div>`;
  // Sub charts
  const subs = [..._activeSubCharts];
  for (const s of subs) {
    html += `<div style="height:140px;padding:4px 8px;border-top:1px solid var(--border);"><canvas id="sub_${s}"></canvas></div>`;
  }
  // X-axis labels (only on bottom)
  html += `<div style="height:26px;padding:0 8px;"><canvas id="xAxisChart"></canvas></div>`;
  html += `</div>`;
  container.innerHTML = html;

  // --- MAIN CHART ---
  const mainDS = [{
    label: symbol, data: chartData.prices,
    borderColor: '#00d4aa', backgroundColor: 'rgba(0,212,170,0.05)',
    fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2,
  }];

  // EMA overlays
  if (indicators?.emaHistory) {
    for (const p of [5, 10, 20, 50, 100, 200]) {
      const key = `ema${p}`;
      if (!_activeOverlays.has(key)) continue;
      const cfg = OVERLAY_DEFS[key];
      const data = indicators.emaHistory.map(e => e[key] || null);
      if (data.some(v => v)) mainDS.push({ label: cfg.label, data, borderColor: cfg.color, borderWidth: 1.5, pointRadius: 0, tension: 0.3, fill: false });
    }
  }
  // Bollinger
  if (_activeOverlays.has('bbands') && indicators?.bollingerHistory?.length) {
    const bh = indicators.bollingerHistory;
    mainDS.push({ label: 'BB Ãœst', data: pad(bh.map(b=>b.upper), dates.length), borderColor: 'rgba(255,77,106,0.5)', borderWidth: 1, borderDash: [4,4], pointRadius: 0, fill: false });
    mainDS.push({ label: 'BB Alt', data: pad(bh.map(b=>b.lower), dates.length), borderColor: 'rgba(77,166,255,0.5)', borderWidth: 1, borderDash: [4,4], pointRadius: 0, fill: '+1', backgroundColor: 'rgba(100,100,255,0.03)' });
  }
  // Ichimoku
  if (_activeOverlays.has('ichimoku') && indicators?.ichimoku?.tenkan) {
    mainDS.push({ label: 'Tenkan', data: dates.map(()=>indicators.ichimoku.tenkan), borderColor: '#26a69a', borderWidth: 1, pointRadius: 0, fill: false });
    mainDS.push({ label: 'Kijun', data: dates.map(()=>indicators.ichimoku.kijun), borderColor: '#ef5350', borderWidth: 1, pointRadius: 0, fill: false });
  }
  // VWAP
  if (_activeOverlays.has('vwap') && indicators?.vwap?.value)
    mainDS.push({ label: 'VWAP', data: dates.map(()=>indicators.vwap.value), borderColor: '#e040fb', borderWidth: 1, borderDash: [3,3], pointRadius: 0, fill: false });
  // PSAR
  if (_activeOverlays.has('psar') && indicators?.psar?.value)
    mainDS.push({ label: 'P.SAR', data: dates.map(()=>indicators.psar.value), borderColor: '#ffeb3b', borderWidth: 1.5, borderDash: [1,3], pointRadius: 0, fill: false });

  _charts.main = new Chart(document.getElementById('mainChart'), {
    type: 'line', data: { labels: dates, datasets: mainDS },
    options: { ..._cOpts, scales: { ..._cOpts.scales, x: { display: false } } }
  });

  // --- SUB CHARTS ---
  if (_activeSubCharts.has('volume') && chartData.volumes) {
    const volColors = chartData.prices.map((p,i) => i > 0 && p >= chartData.prices[i-1] ? 'rgba(0,229,160,0.5)' : 'rgba(255,77,106,0.5)');
    _charts.volume = new Chart(document.getElementById('sub_volume'), {
      type: 'bar', data: { labels: dates, datasets: [{ label: 'Hacim', data: chartData.volumes, backgroundColor: volColors, borderWidth: 0 }] },
      options: { ..._cOpts, plugins: { ..._cOpts.plugins, legend: { display: false } }, scales: { ..._cOpts.scales, x: { display: false }, y: { ...(_cOpts.scales.y), ticks: { ..._cOpts.scales.y.ticks, callback: v => v >= 1e6 ? (v/1e6).toFixed(0)+'M' : v >= 1e3 ? (v/1e3).toFixed(0)+'K' : v } } } }
    });
  }

  if (_activeSubCharts.has('macd') && indicators?.macdHistory?.length) {
    const mh = indicators.macdHistory;
    const macdData = pad(mh.map(m=>m.macd), dates.length);
    const sigData = pad(mh.map(m=>m.signal), dates.length);
    const histData = pad(mh.map(m=>m.histogram), dates.length);
    const histColors = histData.map(v => v === null ? 'transparent' : (v >= 0 ? 'rgba(0,229,160,0.6)' : 'rgba(255,77,106,0.6)'));
    _charts.macd = new Chart(document.getElementById('sub_macd'), {
      type: 'bar',
      data: { labels: dates, datasets: [
        { type: 'bar', label: 'Histogram', data: histData, backgroundColor: histColors, borderWidth: 0, order: 2 },
        { type: 'line', label: 'MACD', data: macdData, borderColor: '#ffc547', borderWidth: 1.5, pointRadius: 0, tension: 0.3, fill: false, order: 1 },
        { type: 'line', label: 'Sinyal', data: sigData, borderColor: '#ff6b6b', borderWidth: 1, pointRadius: 0, tension: 0.3, fill: false, order: 1 },
      ]},
      options: { ..._cOpts, scales: { ..._cOpts.scales, x: { display: false } } }
    });
  }

  if (_activeSubCharts.has('rsi') && indicators?.rsiHistory?.length) {
    const rh = indicators.rsiHistory;
    const rsiDates = rh.map(r => r.date);
    const rsiVals = rh.map(r => r.value);
    const rsiPad = pad(rsiVals, dates.length);
    _charts.rsi = new Chart(document.getElementById('sub_rsi'), {
      type: 'line',
      data: { labels: dates, datasets: [
        { label: 'RSI', data: rsiPad, borderColor: '#00e5a0', borderWidth: 1.5, pointRadius: 0, tension: 0.3, fill: false },
        { label: '70', data: dates.map(()=>70), borderColor: 'rgba(255,77,106,0.4)', borderWidth: 1, borderDash: [3,3], pointRadius: 0, fill: false },
        { label: '30', data: dates.map(()=>30), borderColor: 'rgba(0,229,160,0.4)', borderWidth: 1, borderDash: [3,3], pointRadius: 0, fill: false },
      ]},
      options: { ..._cOpts, scales: { ..._cOpts.scales, x: { display: false }, y: { ..._cOpts.scales.y, min: 0, max: 100 } } }
    });
  }

  if (_activeSubCharts.has('stoch') && indicators?.stochasticHistory?.length) {
    const sh = indicators.stochasticHistory;
    const kData = pad(sh.map(s=>s.k), dates.length);
    const dData = pad(sh.map(s=>s.d), dates.length);
    _charts.stoch = new Chart(document.getElementById('sub_stoch'), {
      type: 'line',
      data: { labels: dates, datasets: [
        { label: '%K', data: kData, borderColor: '#a78bfa', borderWidth: 1.5, pointRadius: 0, tension: 0.3, fill: false },
        { label: '%D', data: dData, borderColor: '#ffa06b', borderWidth: 1, pointRadius: 0, tension: 0.3, fill: false },
        { label: '80', data: dates.map(()=>80), borderColor: 'rgba(255,77,106,0.3)', borderWidth: 1, borderDash: [3,3], pointRadius: 0, fill: false },
        { label: '20', data: dates.map(()=>20), borderColor: 'rgba(0,229,160,0.3)', borderWidth: 1, borderDash: [3,3], pointRadius: 0, fill: false },
      ]},
      options: { ..._cOpts, scales: { ..._cOpts.scales, x: { display: false }, y: { ..._cOpts.scales.y, min: 0, max: 100 } } }
    });
  }

  // X-axis chart (invisible data, just shows dates)
  _charts.xAxis = new Chart(document.getElementById('xAxisChart'), {
    type: 'line', data: { labels: dates, datasets: [{ data: dates.map(()=>0), pointRadius: 0, borderWidth: 0 }] },
    options: { responsive: true, maintainAspectRatio: false, plugins: { legend: { display: false }, tooltip: { enabled: false } },
      scales: { x: { grid: { display: false }, ticks: { color: '#5a6a80', maxTicksLimit: 12, font: { size: 9 } } }, y: { display: false } } }
  });
}

// =============================================================================
// SCREENER
// =============================================================================
function addScreenerCondition() {
  const row = document.createElement('div');
  row.className = 'condition-row';
  row.innerHTML = `
    <select class="sc-indicator" onchange="updateScreenerHint(this)">
      <option value="rsi">RSI (0-100)</option>
      <option value="volume_ratio">Hacim OranÄ± (x)</option>
      <option value="atr_pct">ATR % (volatilite)</option>
      <option value="ema_cross">EMA Cross (1/-1)</option>
      <option value="breakout">Breakout (0/1)</option>
      <option value="macd_signal">MACD Sinyal (1/-1)</option>
      <option value="price_above_ema20">Fiyat > EMA20 (0/1)</option>
      <option value="price_above_ema50">Fiyat > EMA50 (0/1)</option>
      <option value="changePct">GÃ¼nlÃ¼k DeÄŸiÅŸim %</option>
      <option value="price">Fiyat (TL)</option>
      <option value="volume">Hacim (lot)</option>
      <option value="gapPct">Gap %</option>
    </select>
    <select class="sc-operator">
      <option value=">">&gt;</option>
      <option value="<">&lt;</option>
      <option value=">=">&ge;</option>
      <option value="<=">&le;</option>
      <option value="==">=</option>
    </select>
    <input class="sc-value" placeholder="DeÄŸer" style="width:100px;">
    <button class="remove-condition" onclick="this.parentElement.remove()">âœ•</button>
  `;
  document.getElementById('screenerConditions').appendChild(row);
}

function applyScreenerTemplate(tpl) {
  const container = document.getElementById('screenerConditions');
  container.innerHTML = '';
  const templates = {
    'oversold': [{indicator:'rsi',operator:'<',value:'30'}],
    'overbought': [{indicator:'rsi',operator:'>',value:'70'}],
    'highvolume': [{indicator:'volume_ratio',operator:'>',value:'2'}],
    'breakout': [{indicator:'breakout',operator:'>',value:'0'},{indicator:'volume_ratio',operator:'>',value:'1.5'}],
  };
  const conditions = templates[tpl] || [];
  conditions.forEach(c => {
    addScreenerCondition();
    const rows = container.querySelectorAll('.condition-row');
    const lastRow = rows[rows.length - 1];
    lastRow.querySelector('.sc-indicator').value = c.indicator;
    lastRow.querySelector('.sc-operator').value = c.operator;
    lastRow.querySelector('.sc-value').value = c.value;
  });
  if (conditions.length === 0) addScreenerCondition();
}

function updateScreenerHint(select) {
  // Placeholder hint based on selected indicator
  const hints = {
    'rsi': 'Ã–rn: 30', 'volume_ratio': 'Ã–rn: 2', 'atr_pct': 'Ã–rn: 3',
    'ema_cross': '1 veya -1', 'breakout': '0 veya 1', 'macd_signal': '1 veya -1',
    'price_above_ema20': '0 veya 1', 'price_above_ema50': '0 veya 1',
    'changePct': 'Ã–rn: 5', 'price': 'Ã–rn: 100', 'volume': 'Ã–rn: 1000000', 'gapPct': 'Ã–rn: 2'
  };
  const input = select.parentElement.querySelector('.sc-value');
  if (input) input.placeholder = hints[select.value] || 'DeÄŸer';
}

async function runScreener() {
  const rows = document.querySelectorAll('.condition-row');
  const conditions = [];
  rows.forEach(row => {
    const indicator = row.querySelector('.sc-indicator')?.value;
    const operator = row.querySelector('.sc-operator')?.value;
    const value = row.querySelector('.sc-value')?.value;
    if (indicator && operator && value) {
      let parsedVal = value;
      if (!isNaN(value)) parsedVal = parseFloat(value);
      else if (value === 'true') parsedVal = true;
      else if (value === 'false') parsedVal = false;
      conditions.push({ indicator, operator, value: parsedVal });
    }
  });

  const sector = document.getElementById('screenerSector').value;

  const resultsDiv = document.getElementById('screenerResults');
  resultsDiv.style.display = 'block';
  document.getElementById('screenerTable').innerHTML = '<tr><td colspan="7"><div class="loading"><div class="spinner"></div>TaranÄ±yor...</div></td></tr>';

  const data = await api('/screener', {
    method: 'POST',
    body: JSON.stringify({ conditions, sector: sector || undefined }),
  });

  if (data.error) {
    document.getElementById('screenerTable').innerHTML = `<tr><td colspan="7" style="color:var(--red);">${data.error}</td></tr>`;
    return;
  }

  document.getElementById('screenerCount').textContent = `${data.totalMatches} / ${data.scannedStocks} hisse eÅŸleÅŸti`;

  document.getElementById('screenerTable').innerHTML = (data.matches || []).map(m => `
    <tr class="stock-row" onclick="goToStock('${m.code}')">
      <td class="td-mono td-clickable">${m.code}</td>
      <td>${m.name}</td>
      <td class="td-mono">${fmtPrice(m.price)}</td>
      <td class="td-mono ${changeClass(m.changePct)}">${fmtPct(m.changePct)}</td>
      <td class="td-mono">${m.metrics?.rsi ?? '-'}</td>
      <td class="td-mono">${m.metrics?.volume_ratio ?? '-'}</td>
      <td>${m.metrics?.ema_cross === 'bullish' ? '<span class="badge badge-green">Bullish</span>' : '<span class="badge badge-red">Bearish</span>'}</td>
    </tr>
  `).join('') || '<tr><td colspan="7" class="empty-state">EÅŸleÅŸen hisse bulunamadÄ±</td></tr>';
}

// =============================================================================
// PORTFOLIO
// =============================================================================
function showAddPositionForm() {
  if (!currentUser) { showLogin(); return; }
  document.getElementById('addPositionForm').style.display = 'block';
}

async function addPosition() {
  if (!currentUser) { showLogin(); return; }
  const symbol = document.getElementById('pfSymbol').value.toUpperCase();
  const quantity = parseFloat(document.getElementById('pfQty').value);
  const avgCost = parseFloat(document.getElementById('pfCost').value);

  if (!symbol || !quantity || !avgCost) { alert('TÃ¼m alanlarÄ± doldurun'); return; }

  await api('/portfolio', {
    method: 'POST',
    body: JSON.stringify({ userId: currentUser.userId, symbol, quantity, avgCost }),
  });

  document.getElementById('addPositionForm').style.display = 'none';
  document.getElementById('pfSymbol').value = '';
  document.getElementById('pfQty').value = '';
  document.getElementById('pfCost').value = '';
  loadPortfolio();
}

async function removePosition(symbol, posId) {
  if (!confirm(`${symbol} portfÃ¶yden Ã§Ä±karÄ±lsÄ±n mÄ±?`)) return;
  await api('/portfolio', {
    method: 'DELETE',
    body: JSON.stringify({ userId: currentUser?.userId, symbol, id: posId }),
  });
  loadPortfolio();
}

async function loadPortfolio() {
  if (!currentUser) {
    document.getElementById('portfolioSummary').innerHTML = '';
    document.getElementById('portfolioTable').innerHTML = `<tr><td colspan="9"><div class="empty-state"><div class="icon">ğŸ”’</div><div>PortfÃ¶y kaydetmek iÃ§in giriÅŸ yapÄ±n</div><button class="btn btn-primary btn-sm" onclick="showLogin()" style="margin-top:12px;">GiriÅŸ Yap</button></div></td></tr>`;
    return;
  }
  const data = await api('/portfolio?userId=' + currentUser.userId);
  if (!data.success) return;

  const s = data.summary || {};

  document.getElementById('portfolioSummary').innerHTML = `
    <div class="card" style="text-align:center;">
      <div style="font-size:11px;color:var(--text-muted);">Toplam DeÄŸer</div>
      <div class="td-mono" style="font-size:20px;font-weight:700;margin-top:4px;">${fmtMoney(s.totalValue)}</div>
    </div>
    <div class="card" style="text-align:center;">
      <div style="font-size:11px;color:var(--text-muted);">Toplam Maliyet</div>
      <div class="td-mono" style="font-size:20px;font-weight:700;margin-top:4px;">${fmtMoney(s.totalCost)}</div>
    </div>
    <div class="card" style="text-align:center;">
      <div style="font-size:11px;color:var(--text-muted);">Kar/Zarar</div>
      <div class="td-mono ${changeClass(s.totalPnL)}" style="font-size:20px;font-weight:700;margin-top:4px;">${fmtMoney(s.totalPnL)} (${fmtPct(s.totalPnLPct)})</div>
    </div>
    <div class="card" style="text-align:center;">
      <div style="font-size:11px;color:var(--text-muted);">GÃ¼nlÃ¼k DeÄŸiÅŸim</div>
      <div class="td-mono ${changeClass(s.dailyPnL)}" style="font-size:20px;font-weight:700;margin-top:4px;">${fmtMoney(s.dailyPnL)}</div>
    </div>
  `;

  const positions = data.positions || [];
  if (positions.length === 0) {
    document.getElementById('portfolioTable').innerHTML = '<tr><td colspan="9" class="empty-state">PortfÃ¶y boÅŸ. Pozisyon ekleyin.</td></tr>';
    document.getElementById('riskCard').style.display = 'none';
    return;
  }

  document.getElementById('portfolioTable').innerHTML = positions.map(p => `
    <tr>
      <td class="td-mono td-clickable" onclick="goToStock('${p.symbol}')">${p.symbol}</td>
      <td class="td-mono">${p.quantity}</td>
      <td class="td-mono">${fmtPrice(p.avgCost)}</td>
      <td class="td-mono">${fmtPrice(p.currentPrice)}</td>
      <td class="td-mono">${fmtMoney(p.marketValue)}</td>
      <td class="td-mono ${p.unrealizedPnL >= 0 ? 'pnl-positive' : 'pnl-negative'}">${fmtMoney(p.unrealizedPnL)}</td>
      <td class="td-mono ${p.unrealizedPnLPct >= 0 ? 'pnl-positive' : 'pnl-negative'}">${fmtPct(p.unrealizedPnLPct)}</td>
      <td class="td-mono">${p.weight}%</td>
      <td><button class="btn btn-sm" style="background:var(--red-bg);color:var(--red);border:none;padding:4px 8px;font-size:11px;" onclick="removePosition('${p.symbol}', ${p.id})">Sil</button></td>
    </tr>
  `).join('');

  loadPortfolioRisk();
}

// =============================================================================
// WATCHLIST (FAVORÄ°LER)
// =============================================================================
async function loadWatchlist() {
  const table = document.getElementById('watchlistTable');
  const loginMsg = document.getElementById('watchlistLoginMsg');

  if (!currentUser) {
    loginMsg.style.display = 'block';
    table.innerHTML = '';
    return;
  }
  loginMsg.style.display = 'none';

  table.innerHTML = '<tr><td colspan="7"><div class="loading"><div class="spinner"></div>YÃ¼kleniyor...</div></td></tr>';

  const data = await api('/watchlist?userId=' + currentUser.userId);
  if (!data.success) return;

  const stocks = data.watchlist || [];
  if (stocks.length === 0) {
    table.innerHTML = '<tr><td colspan="7" class="empty-state">Favori listeniz boÅŸ. YukarÄ±dan hisse ekleyin.</td></tr>';
    return;
  }

  table.innerHTML = stocks.map(s => `
    <tr class="stock-row" onclick="goToStock('${s.code}')">
      <td class="td-mono td-clickable">${s.code}</td>
      <td>${s.name}</td>
      <td class="td-mono">${fmtPrice(s.price)}</td>
      <td class="td-mono ${changeClass(s.change)}">${fmtPrice(s.change)}</td>
      <td class="td-mono ${changeClass(s.changePct)}">${fmtPct(s.changePct)}</td>
      <td class="td-mono">${fmtVolume(s.volume)}</td>
      <td><button class="btn btn-sm" style="background:var(--red-bg);color:var(--red);border:none;padding:4px 8px;font-size:11px;" onclick="event.stopPropagation(); removeFromWatchlist('${s.code}')">KaldÄ±r</button></td>
    </tr>
  `).join('');
}

async function addToWatchlist(symbolOverride) {
  if (!currentUser) { showLogin(); return; }
  const sym = symbolOverride || document.getElementById('wlAddSymbol')?.value?.toUpperCase();
  if (!sym) { alert('Hisse kodu girin'); return; }

  const data = await api('/watchlist', {
    method: 'POST',
    body: JSON.stringify({ userId: currentUser.userId, symbol: sym, action: 'add' }),
  });

  if (data.success) {
    const input = document.getElementById('wlAddSymbol');
    if (input) input.value = '';
    loadWatchlist();
  }
}

async function removeFromWatchlist(symbol) {
  if (!currentUser) return;
  await api('/watchlist', {
    method: 'POST',
    body: JSON.stringify({ userId: currentUser.userId, symbol, action: 'remove' }),
  });
  loadWatchlist();
}

async function toggleWatchlist(symbol) {
  if (!currentUser) { showLogin(); return; }
  const data = await api('/watchlist', {
    method: 'POST',
    body: JSON.stringify({ userId: currentUser.userId, symbol, action: 'toggle' }),
  });
  return data;
}

async function loadPortfolioRisk() {
  const data = await api('/portfolio/risk');
  if (!data.success || !data.risk) return;
  const r = data.risk;
  if (r.message) return;

  document.getElementById('riskCard').style.display = 'block';
  document.getElementById('riskMetrics').innerHTML = `
    <div class="bt-metric"><div class="bt-val">${r.volatility}%</div><div class="bt-label">YÄ±llÄ±k Volatilite</div></div>
    <div class="bt-metric"><div class="bt-val ${changeClass(r.maxDrawdown)}">${r.maxDrawdown}%</div><div class="bt-label">Max Drawdown</div></div>
    <div class="bt-metric"><div class="bt-val">${r.sharpeRatio}</div><div class="bt-label">Sharpe OranÄ±</div></div>
    <div class="bt-metric"><div class="bt-val ${changeClass(r.annualReturn)}">${r.annualReturn}%</div><div class="bt-label">YÄ±llÄ±k Getiri</div></div>
  `;
}

// =============================================================================
// BACKTEST
// =============================================================================
function updateBtParams() {
  const strategy = document.getElementById('btStrategy').value;
  const row = document.getElementById('btParamsRow');
  if (strategy === 'ma_cross') {
    row.children[0].querySelector('label').textContent = 'HÄ±zlÄ± MA';
    row.children[0].querySelector('input').value = 20;
    row.children[1].querySelector('label').textContent = 'YavaÅŸ MA';
    row.children[1].querySelector('input').value = 50;
  } else if (strategy === 'breakout') {
    row.children[0].querySelector('label').textContent = 'Lookback GÃ¼n';
    row.children[0].querySelector('input').value = 20;
    row.children[1].querySelector('label').textContent = '(KullanÄ±lmÄ±yor)';
    row.children[1].querySelector('input').value = 0;
  } else if (strategy === 'mean_reversion') {
    row.children[0].querySelector('label').textContent = 'RSI Alt SÄ±nÄ±r';
    row.children[0].querySelector('input').value = 30;
    row.children[1].querySelector('label').textContent = 'RSI Ãœst SÄ±nÄ±r';
    row.children[1].querySelector('input').value = 70;
  }
}

async function runBacktest() {
  const symbol = document.getElementById('btSymbol').value.toUpperCase();
  const strategy = document.getElementById('btStrategy').value;
  const period = document.getElementById('btPeriod').value;
  const p1 = parseFloat(document.getElementById('btParam1').value) || 0;
  const p2 = parseFloat(document.getElementById('btParam2').value) || 0;
  const commission = (parseFloat(document.getElementById('btCommission').value) || 0) / 100;
  const capital = parseFloat(document.getElementById('btCapital').value) || 10000;

  if (!symbol) { alert('Hisse kodu girin'); return; }

  let params = {};
  if (strategy === 'ma_cross') params = { fast: p1, slow: p2 };
  else if (strategy === 'breakout') params = { lookback: p1 };
  else if (strategy === 'mean_reversion') params = { rsi_low: p1, rsi_high: p2 };

  document.getElementById('btResults').style.display = 'block';
  document.getElementById('btMetrics').innerHTML = '<div class="bt-metric" style="grid-column:1/-1;"><div class="loading"><div class="spinner"></div>Backtest Ã§alÄ±ÅŸtÄ±rÄ±lÄ±yor...</div></div>';

  const data = await api('/backtest', {
    method: 'POST',
    body: JSON.stringify({ symbol, strategy, params, period, commission, slippage: 0.001, initialCapital: capital }),
  });

  if (data.error) {
    document.getElementById('btMetrics').innerHTML = `<div style="color:var(--red);grid-column:1/-1;">${data.error}</div>`;
    return;
  }

  const r = data.results;

  document.getElementById('btMetrics').innerHTML = `
    <div class="bt-metric"><div class="bt-val ${changeClass(r.totalReturn)}">${r.totalReturn}%</div><div class="bt-label">Toplam Getiri</div></div>
    <div class="bt-metric"><div class="bt-val">${r.cagr}%</div><div class="bt-label">CAGR</div></div>
    <div class="bt-metric"><div class="bt-val">${r.sharpeRatio}</div><div class="bt-label">Sharpe</div></div>
    <div class="bt-metric"><div class="bt-val ${changeClass(r.maxDrawdown)}">${r.maxDrawdown}%</div><div class="bt-label">Max Drawdown</div></div>
    <div class="bt-metric"><div class="bt-val">${r.winRate}%</div><div class="bt-label">Kazanma OranÄ±</div></div>
    <div class="bt-metric"><div class="bt-val">${r.totalTrades}</div><div class="bt-label">Ä°ÅŸlem SayÄ±sÄ±</div></div>
    <div class="bt-metric"><div class="bt-val ${changeClass(r.buyAndHoldReturn)}">${r.buyAndHoldReturn}%</div><div class="bt-label">Al-Tut Getiri</div></div>
    <div class="bt-metric"><div class="bt-val ${changeClass(r.alpha)}">${r.alpha}%</div><div class="bt-label">Alpha</div></div>
  `;

  // Equity Chart
  if (btChartInstance) btChartInstance.destroy();
  const ctx = document.getElementById('btChart');
  const ec = data.equityCurve || [];

  btChartInstance = new Chart(ctx, {
    type: 'line',
    data: {
      labels: ec.map(e => e.date),
      datasets: [{
        label: 'PortfÃ¶y DeÄŸeri',
        data: ec.map(e => e.equity),
        borderColor: '#00d4aa', backgroundColor: 'rgba(0,212,170,0.05)',
        fill: true, tension: 0.3, pointRadius: 0, borderWidth: 2,
      }]
    },
    options: {
      responsive: true, maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#8896aa' } },
        tooltip: { backgroundColor: '#1a2234', borderColor: '#2a3548', borderWidth: 1, titleColor: '#e8ecf4', bodyColor: '#8896aa' }
      },
      scales: {
        x: { grid: { color: 'rgba(42,53,72,0.3)' }, ticks: { color: '#5a6a80', maxTicksLimit: 10, font: { size: 10 } } },
        y: { grid: { color: 'rgba(42,53,72,0.3)' }, ticks: { color: '#5a6a80', font: { family: 'JetBrains Mono', size: 11 } } },
      }
    }
  });

  // Trades table
  document.getElementById('btTrades').innerHTML = (data.trades || []).slice(-20).reverse().map(t => `
    <tr>
      <td>${t.date}</td>
      <td><span class="badge ${t.type.includes('BUY') ? 'badge-green' : 'badge-red'}">${t.type}</span></td>
      <td class="td-mono">${fmtPrice(t.price)}</td>
      <td class="td-mono">${t.shares || '-'}</td>
      <td class="td-mono ${t.pnl ? (t.pnl >= 0 ? 'pnl-positive' : 'pnl-negative') : ''}">${t.pnl ? fmtMoney(t.pnl) : '-'}</td>
    </tr>
  `).join('');
}

// =============================================================================
// ALERTS
// =============================================================================
async function createAlert() {
  if (!currentUser) { showLogin(); return; }
  const symbol = document.getElementById('alertSymbol').value.toUpperCase();
  const condition = document.getElementById('alertCondition').value;
  const threshold = parseFloat(document.getElementById('alertThreshold').value);

  if (!symbol || !condition || !threshold) { alert('Zorunlu alanlarÄ± doldurun'); return; }

  await api('/alerts', {
    method: 'POST',
    body: JSON.stringify({ userId: currentUser.userId, symbol, condition, targetValue: threshold }),
  });

  document.getElementById('alertForm').style.display = 'none';
  loadAlerts();
}

async function loadAlerts() {
  if (!currentUser) {
    document.getElementById('alertsTable').innerHTML = '<tr><td colspan="8"><div class="empty-state"><div class="icon">ğŸ”’</div><div>UyarÄ±larÄ± kullanmak iÃ§in giriÅŸ yapÄ±n</div><button class="btn btn-primary btn-sm" onclick="showLogin()" style="margin-top:12px;">GiriÅŸ Yap</button></div></td></tr>';
    return;
  }
  const data = await api('/alerts?userId=' + currentUser.userId);
  if (!data.success) return;

  const alerts = data.alerts || [];
  if (alerts.length === 0) {
    document.getElementById('alertsTable').innerHTML = '<tr><td colspan="8" class="empty-state">HenÃ¼z uyarÄ± yok</td></tr>';
    return;
  }

  const conditionNames = {
    'price_above': 'Fiyat ÃœstÃ¼nde', 'price_below': 'Fiyat AltÄ±nda',
    'change_above': 'DeÄŸiÅŸim ÃœstÃ¼nde', 'change_below': 'DeÄŸiÅŸim AltÄ±nda',
    'rsi_above': 'RSI ÃœstÃ¼nde', 'rsi_below': 'RSI AltÄ±nda',
    'volume_spike': 'Hacim Spike', 'breakout': 'KÄ±rÄ±lÄ±m',
    'macd_cross_up': 'MACD YukarÄ±', 'macd_cross_down': 'MACD AÅŸaÄŸÄ±',
  };

  document.getElementById('alertsTable').innerHTML = alerts.map(a => `
    <tr>
      <td class="td-mono td-clickable" onclick="goToStock('${a.symbol}')">${a.symbol}</td>
      <td>${conditionNames[a.condition] || a.condition}</td>
      <td class="td-mono">${a.targetValue || '-'}</td>
      <td>-</td>
      <td>-</td>
      <td class="td-mono">${a.triggered ? '1x' : '0x'}</td>
      <td>${a.active && !a.triggered ? '<span class="badge badge-green">Aktif</span>' : a.triggered ? '<span class="badge badge-yellow">Tetiklendi</span>' : '<span class="badge badge-neutral">Pasif</span>'}</td>
      <td><button class="btn btn-sm" style="background:var(--red-bg);color:var(--red);border:none;padding:4px 8px;font-size:11px;" onclick="deleteAlert(${a.id})">Sil</button></td>
    </tr>
  `).join('');
}

async function deleteAlert(id) {
  await api('/alerts/' + id, { method: 'DELETE' });
  loadAlerts();
}

// =============================================================================
// HEATMAP
// =============================================================================
async function loadHeatmap() {
  const container = document.getElementById('heatmapContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>IsÄ± haritasÄ± yÃ¼kleniyor...</div>';

  const data = await api('/heatmap');
  if (!data.success || !data.sectors || data.sectors.length === 0) {
    container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ—ºï¸</div><div>Veriler yÃ¼kleniyor...</div></div>';
    if (data.loading) setTimeout(loadHeatmap, 5000);
    return;
  }

  let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;">';
  data.sectors.forEach(sector => {
    const sColor = sector.avgChange > 1 ? 'var(--green)' : (sector.avgChange < -1 ? 'var(--red)' : 'var(--text-muted)');
    const sBg = sector.avgChange > 1 ? 'rgba(16,185,129,0.08)' : (sector.avgChange < -1 ? 'rgba(239,68,68,0.08)' : 'rgba(255,255,255,0.03)');
    html += `<div class="card" style="border-left:4px solid ${sColor};background:${sBg};">
      <div class="flex-between mb-8">
        <div style="font-weight:700;font-size:14px;">${sector.displayName}</div>
        <div style="font-weight:800;font-size:16px;color:${sColor};">${sector.avgChange >= 0 ? '+' : ''}%${sector.avgChange}</div>
      </div>
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:8px;">${sector.stockCount} hisse</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;">`;

    sector.stocks.forEach(s => {
      const c = s.changePct > 0.5 ? 'var(--green)' : (s.changePct < -0.5 ? 'var(--red)' : 'var(--text-muted)');
      const bg = s.changePct > 2 ? 'rgba(16,185,129,0.2)' : (s.changePct > 0 ? 'rgba(16,185,129,0.08)' : (s.changePct < -2 ? 'rgba(239,68,68,0.2)' : (s.changePct < 0 ? 'rgba(239,68,68,0.08)' : 'rgba(255,255,255,0.05)')));
      const size = Math.max(70, Math.min(120, 80 + Math.abs(s.changePct) * 8));
      html += `<div onclick="goToStock('${s.code}')" style="cursor:pointer;padding:8px;border-radius:8px;background:${bg};border:1px solid ${c}33;min-width:${size}px;text-align:center;transition:transform 0.2s;" onmouseover="this.style.transform='scale(1.05)'" onmouseout="this.style.transform='scale(1)'">
        <div style="font-weight:700;font-size:12px;color:${c};">${s.code}</div>
        <div style="font-family:var(--font-mono);font-size:11px;color:${c};">${s.changePct >= 0 ? '+' : ''}%${s.changePct}</div>
        <div style="font-size:10px;color:var(--text-muted);">${fmtPrice(s.price)}</div>
      </div>`;
    });

    html += '</div></div>';
  });
  html += '</div>';
  container.innerHTML = html;
}

// =============================================================================
// COMPARE
// =============================================================================
async function runCompare() {
  const symbols = [1,2,3,4].map(i => document.getElementById('cmpInput'+i).value.trim().toUpperCase()).filter(Boolean);
  if (symbols.length < 2) { alert('En az 2 hisse girin'); return; }

  const container = document.getElementById('compareResults');
  container.style.display = 'block';
  container.innerHTML = '<div class="loading"><div class="spinner"></div>KarÅŸÄ±laÅŸtÄ±rÄ±lÄ±yor...</div>';

  const data = await api('/compare', { method: 'POST', body: JSON.stringify({ symbols }) });
  if (!data.success || !data.comparison || data.comparison.length < 2) {
    container.innerHTML = '<div class="card" style="color:var(--red);">KarÅŸÄ±laÅŸtÄ±rma yapÄ±lamadÄ±. Hisse kodlarÄ±nÄ± kontrol edin.</div>';
    return;
  }

  const stocks = data.comparison;
  let html = '<div class="card mb-24"><div style="font-weight:700;margin-bottom:16px;">KarÅŸÄ±laÅŸtÄ±rma Tablosu</div>';
  html += '<div class="table-wrap"><table><thead><tr><th>Metrik</th>';
  stocks.forEach(s => { html += `<th style="text-align:center;"><span class="td-clickable" onclick="goToStock('${s.code}')">${s.code}</span><br><span style="font-size:10px;color:var(--text-muted);">${s.name}</span></th>`; });
  html += '</tr></thead><tbody>';

  const metrics = [
    {label:'Fiyat', key:'price', fmt:v=>fmtPrice(v)+' â‚º'},
    {label:'DeÄŸiÅŸim %', key:'changePct', fmt:v=>'%'+v, color:true},
    {label:'Hacim', key:'volume', fmt:v=>fmtVolume(v)},
    {label:'AÃ§Ä±lÄ±ÅŸ', key:'open', fmt:v=>fmtPrice(v)+' â‚º'},
    {label:'YÃ¼ksek', key:'high', fmt:v=>fmtPrice(v)+' â‚º'},
    {label:'DÃ¼ÅŸÃ¼k', key:'low', fmt:v=>fmtPrice(v)+' â‚º'},
    {label:'Ã–nceki KapanÄ±ÅŸ', key:'prevClose', fmt:v=>fmtPrice(v)+' â‚º'},
    {label:'Gap %', key:'gapPct', fmt:v=>'%'+v, color:true},
    {label:'RSI', key:'rsi', fmt:v=>v?v.toFixed(1):'-'},
    {label:'MACD Sinyal', key:'macdSignal', fmt:v=>v||'-'},
    {label:'EMA20', key:'ema20', fmt:v=>v?fmtPrice(v)+' â‚º':'-'},
    {label:'EMA50', key:'ema50', fmt:v=>v?fmtPrice(v)+' â‚º':'-'},
    {label:'52H YÃ¼ksek', key:'high52w', fmt:v=>v?fmtPrice(v)+' â‚º':'-'},
    {label:'52H DÃ¼ÅŸÃ¼k', key:'low52w', fmt:v=>v?fmtPrice(v)+' â‚º':'-'},
    {label:'52H Pozisyon %', key:'pos52w', fmt:v=>v?'%'+v.toFixed(0):'-'},
  ];

  metrics.forEach(m => {
    html += `<tr><td style="font-weight:600;font-size:12px;">${m.label}</td>`;
    // Find best value for highlighting
    const vals = stocks.map(s => s[m.key] || 0);
    stocks.forEach((s, i) => {
      const v = s[m.key];
      const cls = m.color ? changeClass(v) : '';
      const isBest = m.color && Math.abs(v) === Math.max(...vals.map(Math.abs)) && v > 0;
      html += `<td class="td-mono ${cls}" style="text-align:center;${isBest ? 'font-weight:700;' : ''}">${m.fmt(v)}</td>`;
    });
    html += '</tr>';
  });

  html += '</tbody></table></div></div>';
  container.innerHTML = html;
}

// =============================================================================
// DAILY REPORT
// =============================================================================
async function loadReport() {
  const container = document.getElementById('reportContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>Rapor hazÄ±rlanÄ±yor...</div>';

  const data = await api('/report');
  if (!data.success) {
    container.innerHTML = '<div class="empty-state"><div class="icon">ğŸ“‹</div><div>Veriler yÃ¼kleniyor...</div></div>';
    if (data.loading) setTimeout(loadReport, 5000);
    return;
  }

  const mb = data.marketBreadth || {};
  const upPct = mb.total ? (mb.advancing/mb.total*100).toFixed(0) : 0;
  const downPct = mb.total ? (mb.declining/mb.total*100).toFixed(0) : 0;

  let html = `
    <div class="card mb-24 fade-in">
      <div style="font-weight:700;font-size:16px;margin-bottom:8px;">ğŸ“‹ ${data.date} Piyasa Ã–zeti</div>
      <div style="font-size:13px;color:var(--text-secondary);line-height:1.8;">
        ${(data.reportLines||[]).map(l => 'â€¢ ' + l).join('<br>')}
      </div>
    </div>

    <div class="grid-4 mb-24 fade-in">
      <div class="card" style="text-align:center;border-left:3px solid var(--green);">
        <div style="font-size:11px;color:var(--text-muted);">YÃ¼kselen</div>
        <div style="font-size:24px;font-weight:800;color:var(--green);">${mb.advancing}</div>
        <div style="font-size:11px;color:var(--text-muted);">%${upPct}</div>
      </div>
      <div class="card" style="text-align:center;border-left:3px solid var(--red);">
        <div style="font-size:11px;color:var(--text-muted);">DÃ¼ÅŸen</div>
        <div style="font-size:24px;font-weight:800;color:var(--red);">${mb.declining}</div>
        <div style="font-size:11px;color:var(--text-muted);">%${downPct}</div>
      </div>
      <div class="card" style="text-align:center;border-left:3px solid var(--text-muted);">
        <div style="font-size:11px;color:var(--text-muted);">DeÄŸiÅŸmez</div>
        <div style="font-size:24px;font-weight:800;">${mb.unchanged}</div>
      </div>
      <div class="card" style="text-align:center;border-left:3px solid var(--accent);">
        <div style="font-size:11px;color:var(--text-muted);">Ort. DeÄŸiÅŸim</div>
        <div class="td-mono ${changeClass(mb.avgChange)}" style="font-size:24px;font-weight:800;">%${mb.avgChange}</div>
      </div>
    </div>

    <div class="grid-2 mb-24 fade-in">
      <div class="card">
        <div style="font-weight:700;margin-bottom:12px;color:var(--green);">ğŸŸ¢ En Ã‡ok YÃ¼kselenler</div>
        <div class="table-wrap"><table>
          <thead><tr><th>Kod</th><th>Fiyat</th><th>DeÄŸiÅŸim</th></tr></thead>
          <tbody>${(data.topGainers||[]).map(s => `<tr class="stock-row" onclick="goToStock('${s.code}')"><td class="td-clickable td-mono">${s.code}</td><td class="td-mono">${fmtPrice(s.price)}</td><td class="td-mono price-up">+%${s.changePct}</td></tr>`).join('')}</tbody>
        </table></div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:12px;color:var(--red);">ğŸ”´ En Ã‡ok DÃ¼ÅŸenler</div>
        <div class="table-wrap"><table>
          <thead><tr><th>Kod</th><th>Fiyat</th><th>DeÄŸiÅŸim</th></tr></thead>
          <tbody>${(data.topLosers||[]).map(s => `<tr class="stock-row" onclick="goToStock('${s.code}')"><td class="td-clickable td-mono">${s.code}</td><td class="td-mono">${fmtPrice(s.price)}</td><td class="td-mono price-down">%${s.changePct}</td></tr>`).join('')}</tbody>
        </table></div>
      </div>
    </div>

    <div class="grid-2 mb-24 fade-in">
      <div class="card">
        <div style="font-weight:700;margin-bottom:12px;">ğŸ“Š Hacim Liderleri</div>
        <div class="table-wrap"><table>
          <thead><tr><th>Kod</th><th>Hacim</th><th>DeÄŸiÅŸim</th></tr></thead>
          <tbody>${(data.volumeLeaders||[]).map(s => `<tr class="stock-row" onclick="goToStock('${s.code}')"><td class="td-clickable td-mono">${s.code}</td><td class="td-mono">${fmtVolume(s.volume)}</td><td class="td-mono ${changeClass(s.changePct)}">%${s.changePct}</td></tr>`).join('')}</tbody>
        </table></div>
      </div>
      <div class="card">
        <div style="font-weight:700;margin-bottom:12px;">ğŸ“ˆ SektÃ¶r PerformansÄ±</div>
        ${(data.sectorPerformance||[]).map(s => {
          const c = s.avgChange > 0 ? 'var(--green)' : (s.avgChange < 0 ? 'var(--red)' : 'var(--text-muted)');
          const w = Math.min(100, Math.abs(s.avgChange) * 15);
          return `<div style="margin-bottom:8px;">
            <div class="flex-between" style="font-size:12px;margin-bottom:2px;">
              <span>${s.name}</span>
              <span style="color:${c};font-weight:700;">${s.avgChange >= 0 ? '+' : ''}%${s.avgChange}</span>
            </div>
            <div style="height:6px;background:var(--border);border-radius:3px;overflow:hidden;">
              <div style="width:${w}%;height:100%;background:${c};border-radius:3px;"></div>
            </div>
          </div>`;
        }).join('')}
      </div>
    </div>`;

  container.innerHTML = html;
}


// =============================================================================
// SINYAL TARAMA
// =============================================================================
async function loadSignals() {
  const tf = document.getElementById('signalTimeframe')?.value || 'weekly';
  const type = document.getElementById('signalType')?.value || 'all';
  const container = document.getElementById('signalResults');
  const statsEl = document.getElementById('signalStats');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>TÃ¼m hisseler taranÄ±yor... (bu birkaÃ§ saniye sÃ¼rebilir)</div>';

  const data = await api(`/signals?timeframe=${tf}&type=${type}`);
  if (data.loading) { container.innerHTML = `<div class="loading"><div class="spinner"></div>${data.message || 'Tarihsel veriler hazÄ±rlanÄ±yor...'} Otomatik yenilenecek.</div>`; statsEl.innerHTML = ''; setTimeout(loadSignals, 10000); return; }
  if (data.error) { container.innerHTML = `<div class="card" style="text-align:center;"><div style="margin-bottom:12px;">${data.error}</div><button class="btn btn-primary btn-sm" onclick="loadSignals()">Tekrar Dene</button></div>`; return; }

  const signals = data.signals || [];
  const buys = signals.filter(s => parseFloat(s.score) > 0);
  const sells = signals.filter(s => parseFloat(s.score) < 0);
  const strong_buys = signals.filter(s => s.action === 'AL');
  const strong_sells = signals.filter(s => s.action === 'SAT');

  const tfLabels = {weekly: 'HaftalÄ±k', monthly: 'AylÄ±k', yearly: 'YÄ±llÄ±k'};

  statsEl.innerHTML = `
    <div class="card" style="text-align:center;border-left:3px solid var(--green);">
      <div style="font-size:24px;font-weight:800;color:var(--green);">${strong_buys.length}</div>
      <div style="font-size:11px;color:var(--text-muted);">GÃ¼Ã§lÃ¼ AL</div>
    </div>
    <div class="card" style="text-align:center;border-left:3px solid var(--accent);">
      <div style="font-size:24px;font-weight:800;color:var(--accent);">${buys.length}</div>
      <div style="font-size:11px;color:var(--text-muted);">Toplam AL Sinyali</div>
    </div>
    <div class="card" style="text-align:center;border-left:3px solid var(--red);">
      <div style="font-size:24px;font-weight:800;color:var(--red);">${strong_sells.length}</div>
      <div style="font-size:11px;color:var(--text-muted);">GÃ¼Ã§lÃ¼ SAT</div>
    </div>
    <div class="card" style="text-align:center;border-left:3px solid var(--text-muted);">
      <div style="font-size:24px;font-weight:800;">${data.totalScanned || 0}</div>
      <div style="font-size:11px;color:var(--text-muted);">Taranan Hisse</div>
    </div>`;

  if (!signals.length) { container.innerHTML = '<div class="card">Sinyal bulunamadÄ±.</div>'; return; }

  // Market regime banner
  let html = '';
  if (data.marketRegime) {
    html = renderMarketRegime(data.marketRegime);
    html += `<div style="margin-top:12px;font-size:12px;color:var(--text-muted);margin-bottom:12px;">Zaman Dilimi: <b>${tfLabels[tf] || tf}</b> | ${signals.length} sinyal bulundu</div>`;
  } else {
    html = `<div style="font-size:12px;color:var(--text-muted);margin-bottom:12px;">Zaman Dilimi: <b>${tfLabels[tf] || tf}</b> | ${signals.length} sinyal bulundu</div>`;
  }
  // Signal cards (daha detayli gosterim)
  for (const [idx, s] of signals.entries()) {
    const score = parseFloat(s.score);
    const actionClass = s.action === 'AL' ? 'color:var(--green);font-weight:800;' :
                        s.action === 'SAT' ? 'color:var(--red);font-weight:800;' :
                        s.action.includes('AL') ? 'color:var(--green);' :
                        s.action.includes('SAT') ? 'color:var(--red);' : 'color:var(--text-muted);';
    const barWidth = Math.min(100, Math.abs(score) / 6 * 100);
    const barColor = score > 0 ? 'var(--green)' : 'var(--red)';
    const macdIcon = s.macdSignal === 'buy' ? '<span style="color:var(--green)">â–² AL</span>' :
                     s.macdSignal === 'sell' ? '<span style="color:var(--red)">â–¼ SAT</span>' : '<span style="color:var(--text-muted)">- NÃ¶tr</span>';
    const rsiVal = parseFloat(s.rsi);
    const rsiColor = rsiVal < 30 ? 'var(--green)' : rsiVal > 70 ? 'var(--red)' : 'var(--text-primary)';
    const mlGrade = s.mlGrade || 'C';
    const mlConf = s.mlConfidence || 50;
    const mlColor = {'A':'var(--green)','B':'#4CAF50','C':'var(--yellow)','D':'var(--red)','F':'#ff0000'}[mlGrade] || 'var(--text-muted)';
    const candleInfo = (s.candlestickPatterns || []).map(p => {
      const ci = p.type === 'bullish' ? 'ğŸŸ¢' : (p.type === 'bearish' ? 'ğŸ”´' : 'âšª');
      return ci + ' ' + p.name.split('(')[0].trim();
    }).join(', ') || '';

    // Trade plan (secili timeframe icin)
    const tp = s.tradePlan || {};
    const tfPlan = tp[tf] || tp.weekly || tp.daily || {};
    const buyPlan = tfPlan.buy || {};
    const sellPlan = tfPlan.sell || {};

    html += `<div class="card mb-12 fade-in" style="padding:14px;cursor:pointer;" onclick="goToStock('${s.code}')">
      <!-- Row 1: Header -->
      <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;margin-bottom:10px;">
        <div style="display:flex;align-items:center;gap:10px;">
          <div>
            <span style="font-weight:800;font-size:15px;">${s.code}</span>
            <span style="color:var(--text-muted);font-size:11px;margin-left:4px;">${s.name}</span>
          </div>
          <span style="font-weight:700;font-size:15px;">${s.price} â‚º</span>
          <span class="${changeClass(s.changePct)}" style="font-size:12px;">%${s.changePct}</span>
        </div>
        <div style="display:flex;align-items:center;gap:12px;">
          <div style="${actionClass};font-size:18px;">${s.action}</div>
          <div style="text-align:center;"><span style="font-size:20px;font-weight:900;color:${mlColor};">${mlGrade}</span><div style="font-size:9px;color:var(--text-muted);">ML %${mlConf}</div></div>
          <div><span style="color:var(--green);font-size:11px;">${s.buySignals} AL</span> / <span style="color:var(--red);font-size:11px;">${s.sellSignals} SAT</span><div style="font-size:9px;color:var(--text-muted);">/ ${s.totalIndicators} indikatÃ¶r</div></div>
        </div>
      </div>

      <!-- Row 2: Skor bar + RSI + MACD + Formasyonlar -->
      <div style="display:flex;align-items:center;gap:16px;margin-bottom:10px;flex-wrap:wrap;font-size:12px;">
        <div style="display:flex;align-items:center;gap:6px;">
          <span style="color:var(--text-muted);">Skor:</span>
          <span class="td-mono" style="${actionClass}">${s.score}</span>
          <div style="width:60px;height:6px;background:var(--bg);border-radius:3px;overflow:hidden;"><div style="width:${barWidth}%;height:100%;background:${barColor};border-radius:3px;"></div></div>
        </div>
        <div><span style="color:var(--text-muted);">RSI:</span> <span class="td-mono" style="color:${rsiColor};font-weight:600;">${s.rsi}</span></div>
        <div><span style="color:var(--text-muted);">MACD:</span> ${macdIcon}</div>
        ${candleInfo ? `<div style="color:var(--text-secondary);">${candleInfo}</div>` : ''}
      </div>

      <!-- Row 3: TRADE PLAN -->
      ${buyPlan.entry || sellPlan.entry ? `
      <div style="display:grid;grid-template-columns:1fr 1fr;gap:10px;padding:10px;border-radius:8px;background:var(--bg);border:1px solid var(--border);">
        <!-- Alis -->
        <div>
          <div style="font-size:10px;font-weight:700;color:var(--green);margin-bottom:4px;">ğŸŸ¢ ALIÅ PLANI</div>
          <div style="font-size:12px;">
            <span style="color:var(--text-muted);">GiriÅŸ:</span> <span style="font-weight:800;color:var(--green);">${buyPlan.entry||'-'} â‚º</span>
            <span style="color:var(--text-muted);margin-left:8px;">SL:</span> <span style="color:var(--red);">${buyPlan.stopLoss||'-'} â‚º</span>
          </div>
          ${buyPlan.targets?.length ? `<div style="font-size:11px;margin-top:3px;">
            <span style="color:var(--text-muted);">Hedef:</span>
            ${buyPlan.targets.map((t,i) => `<span style="color:var(--green);font-weight:600;margin-left:4px;">${t}</span>`).join(' /')}
            <span style="color:var(--text-muted);margin-left:6px;">R/R ${buyPlan.riskReward||'-'}</span>
          </div>` : ''}
        </div>
        <!-- Satis -->
        <div>
          <div style="font-size:10px;font-weight:700;color:var(--red);margin-bottom:4px;">ğŸ”´ SATIÅ PLANI</div>
          <div style="font-size:12px;">
            <span style="color:var(--text-muted);">SatÄ±ÅŸ:</span> <span style="font-weight:800;color:var(--red);">${sellPlan.entry||'-'} â‚º</span>
            <span style="color:var(--text-muted);margin-left:8px;">SL:</span> <span style="color:var(--yellow);">${sellPlan.stopLoss||'-'} â‚º</span>
          </div>
          ${sellPlan.targets?.length ? `<div style="font-size:11px;margin-top:3px;">
            <span style="color:var(--text-muted);">Hedef:</span>
            ${sellPlan.targets.map((t,i) => `<span style="color:var(--red);font-weight:600;margin-left:4px;">${t}</span>`).join(' /')}
            <span style="color:var(--text-muted);margin-left:6px;">R/R ${sellPlan.riskReward||'-'}</span>
          </div>` : ''}
        </div>
      </div>` : ''}
    </div>`;
  }
  container.innerHTML = html;
}


// =============================================================================
// FIRSAT Ã–ZETÄ°
// =============================================================================
async function loadOpportunities() {
  const container = document.getElementById('oppContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>FÄ±rsatlar araÅŸtÄ±rÄ±lÄ±yor...</div>';

  const data = await api('/opportunities');
  if (data.loading) { container.innerHTML = `<div class="loading"><div class="spinner"></div>${data.message || 'Tarihsel veriler hazÄ±rlanÄ±yor...'} Otomatik yenilenecek.</div>`; setTimeout(loadOpportunities, 10000); return; }
  if (data.error) { container.innerHTML = `<div class="card" style="text-align:center;"><div style="margin-bottom:12px;">${data.error}</div><button class="btn btn-primary btn-sm" onclick="loadOpportunities()">Tekrar Dene</button></div>`; return; }

  const buyOpps = data.buyOpportunities || [];
  const sellOpps = data.sellOpportunities || [];

  let html = '';
  // Market regime banner
  if (data.marketRegime) {
    html += `<div class="mb-24">${renderMarketRegime(data.marketRegime)}</div>`;
  }
  html += `<div class="grid-2 mb-24">
    <div class="card" style="text-align:center;border-left:3px solid var(--green);">
      <div style="font-size:28px;font-weight:800;color:var(--green);">${buyOpps.length}</div>
      <div style="font-size:12px;color:var(--text-muted);">AlÄ±ÅŸ FÄ±rsatÄ±</div>
    </div>
    <div class="card" style="text-align:center;border-left:3px solid var(--red);">
      <div style="font-size:28px;font-weight:800;color:var(--red);">${sellOpps.length}</div>
      <div style="font-size:12px;color:var(--text-muted);">SatÄ±ÅŸ Sinyali</div>
    </div>
  </div>`;

  // Helper: opportunity card icin trade plan
  function renderOppTradePlan(opp, side) {
    const tp = opp.tradePlan || {};
    const tfPlan = tp.weekly || tp.daily || {};
    const plan = side === 'buy' ? (tfPlan.buy || {}) : (tfPlan.sell || {});
    if (!plan.entry) return '';
    const color = side === 'buy' ? 'var(--green)' : 'var(--red)';
    const label = side === 'buy' ? 'ALIÅ' : 'SATIÅ';
    return `<div style="margin-top:8px;padding:8px 10px;border-radius:6px;background:rgba(${side === 'buy' ? '16,185,129' : '239,68,68'},0.05);border:1px solid rgba(${side === 'buy' ? '16,185,129' : '239,68,68'},0.15);">
      <span style="font-size:10px;font-weight:700;color:${color};">${label} PLANI:</span>
      <span style="font-size:12px;margin-left:6px;">GiriÅŸ: <b style="color:${color};">${plan.entry} â‚º</b></span>
      <span style="font-size:12px;margin-left:8px;">SL: <b style="color:var(--red);">${plan.stopLoss} â‚º</b></span>
      ${plan.targets?.length ? `<span style="font-size:12px;margin-left:8px;">Hedef: <b style="color:${color};">${plan.targets.join(' / ')} â‚º</b></span>` : ''}
      ${plan.riskReward ? `<span style="font-size:11px;margin-left:6px;padding:1px 6px;border-radius:3px;background:rgba(99,102,241,0.1);color:var(--accent);">R/R ${plan.riskReward}</span>` : ''}
    </div>`;
  }

  // Alis firsatlari
  if (buyOpps.length) {
    html += '<div class="card mb-24"><div style="font-weight:700;font-size:15px;margin-bottom:16px;color:var(--green);">ğŸŸ¢ AlÄ±ÅŸ FÄ±rsatlarÄ±</div>';
    for (const opp of buyOpps) {
      const retHtml = Object.entries(opp.returns).map(([k,v]) => {
        const labels = {daily:'GÃ¼n',weekly:'Hafta',monthly:'Ay',yearly:'YÄ±l'};
        const val = parseFloat(v);
        return `<span style="font-size:11px;padding:2px 8px;border-radius:4px;background:${val >= 0 ? 'rgba(0,229,160,0.1)' : 'rgba(234,57,67,0.1)'};color:${val >= 0 ? 'var(--green)' : 'var(--red)'};">${labels[k]}: %${v}</span>`;
      }).join(' ');

      html += `<div style="padding:14px 0;border-bottom:1px solid var(--border);cursor:pointer;" onclick="goToStock('${opp.code}')">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
          <div>
            <span style="font-weight:700;font-size:14px;">${opp.code}</span>
            <span style="color:var(--text-muted);font-size:12px;margin-left:6px;">${opp.name}</span>
            <span style="font-weight:600;margin-left:8px;">${opp.price} â‚º</span>
            <span class="${changeClass(opp.changePct)}" style="font-size:12px;margin-left:4px;">%${opp.changePct}</span>
          </div>
          <div style="display:flex;gap:4px;flex-wrap:wrap;">${retHtml}</div>
        </div>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:4px;">
          ${opp.events.map(e => {
            const icon = e.impact === 'very_positive' ? 'ğŸ”¥' : e.impact === 'positive' ? 'ğŸŸ¢' : e.impact === 'negative' ? 'ğŸ”´' : e.impact === 'very_negative' ? 'ğŸ’€' : 'âšª';
            return `<div style="font-size:12px;color:var(--text-secondary);"><span>${icon}</span> ${e.text}</div>`;
          }).join('')}
        </div>
        ${renderOppTradePlan(opp, 'buy')}
      </div>`;
    }
    html += '</div>';
  }

  // Satis sinyalleri
  if (sellOpps.length) {
    html += '<div class="card mb-24"><div style="font-weight:700;font-size:15px;margin-bottom:16px;color:var(--red);">ğŸ”´ SatÄ±ÅŸ Sinyalleri</div>';
    for (const opp of sellOpps) {
      html += `<div style="padding:14px 0;border-bottom:1px solid var(--border);cursor:pointer;" onclick="goToStock('${opp.code}')">
        <div style="display:flex;justify-content:space-between;align-items:center;flex-wrap:wrap;gap:8px;">
          <div>
            <span style="font-weight:700;font-size:14px;">${opp.code}</span>
            <span style="color:var(--text-muted);font-size:12px;margin-left:6px;">${opp.name}</span>
            <span style="font-weight:600;margin-left:8px;">${opp.price} â‚º</span>
            <span class="${changeClass(opp.changePct)}" style="font-size:12px;margin-left:4px;">%${opp.changePct}</span>
          </div>
        </div>
        <div style="margin-top:8px;display:flex;flex-direction:column;gap:4px;">
          ${opp.events.map(e => {
            const icon = e.impact === 'very_positive' ? 'ğŸ”¥' : e.impact === 'positive' ? 'ğŸŸ¢' : e.impact === 'negative' ? 'ğŸ”´' : e.impact === 'very_negative' ? 'ğŸ’€' : 'âšª';
            return `<div style="font-size:12px;color:var(--text-secondary);"><span>${icon}</span> ${e.text}</div>`;
          }).join('')}
        </div>
        ${renderOppTradePlan(opp, 'sell')}
      </div>`;
    }
    html += '</div>';
  }

  if (!buyOpps.length && !sellOpps.length) {
    html += '<div class="card">Åu anda dikkat Ã§ekici bir fÄ±rsat bulunamadÄ±.</div>';
  }

  container.innerHTML = html;
}


// =============================================================================
// CANLI STRATEJÄ°LER
// =============================================================================
async function loadStrategies() {
  const container = document.getElementById('strategyContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>Stratejiler hesaplanÄ±yor...</div>';

  const data = await api('/strategies/live');
  if (data.loading) { container.innerHTML = '<div class="loading"><div class="spinner"></div>Veriler yÃ¼kleniyor...</div>'; setTimeout(loadStrategies, 5000); return; }
  if (data.error) { container.innerHTML = `<div class="card">${data.error}</div>`; return; }

  const strategies = data.strategies || {};
  const names = data.strategyNames || {};

  const strategyInfo = {
    ma_cross: { icon: 'ğŸ“ˆ', desc: 'EMA 20 ve EMA 50 kesiÅŸimlerini takip eder. EMA20 yukarÄ± keserse AL, aÅŸaÄŸÄ± keserse SAT sinyali verir.', color: '#4da6ff' },
    breakout: { icon: 'ğŸš€', desc: '20 gÃ¼nlÃ¼k en yÃ¼ksek/dÃ¼ÅŸÃ¼k fiyat kÄ±rÄ±lÄ±mlarÄ±nÄ± tespit eder. Yeni zirve = AL, yeni dip = SAT.', color: '#ffc547' },
    mean_reversion: { icon: 'ğŸ”„', desc: 'RSI gÃ¶stergesine gÃ¶re aÅŸÄ±rÄ± alÄ±m/satÄ±m bÃ¶lgelerini tespit eder. RSI<30 = AL, RSI>70 = SAT.', color: '#a78bfa' },
  };

  let html = '';

  for (const [key, stocks] of Object.entries(strategies)) {
    const info = strategyInfo[key] || {};
    const freshSignals = stocks.filter(s => s.freshSignal);
    const alSignals = stocks.filter(s => s.signal && (s.signal.includes('AL') || s.signal.includes('KIRILIM') && s.signal.includes('YUKARI')) && s.freshSignal);
    const satSignals = stocks.filter(s => s.signal && (s.signal.includes('SAT') || s.signal.includes('KIRILIM') && s.signal.includes('ASAGI')) && s.freshSignal);

    html += `<div class="card mb-24">
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:8px;">
        <span style="font-size:24px;">${info.icon || 'ğŸ“Š'}</span>
        <div>
          <div style="font-weight:700;font-size:15px;">${names[key] || key}</div>
          <div style="font-size:11px;color:var(--text-muted);">${info.desc || ''}</div>
        </div>
        <div style="margin-left:auto;text-align:right;">
          <span style="background:rgba(0,229,160,0.15);color:var(--green);padding:4px 10px;border-radius:6px;font-size:12px;font-weight:600;">${freshSignals.length} aktif sinyal</span>
        </div>
      </div>`;

    // Sadece fresh sinyalleri ve ilk 20 stock'u goster
    const display = stocks.filter(s => s.freshSignal).concat(stocks.filter(s => !s.freshSignal)).slice(0, 25);

    html += '<div class="table-wrap" style="max-height:400px;overflow-y:auto;"><table><thead><tr>';
    if (key === 'ma_cross') html += '<th>Hisse</th><th>Fiyat</th><th>DeÄŸiÅŸim</th><th>Sinyal</th><th>EMA 20</th><th>EMA 50</th><th>Fark %</th>';
    else if (key === 'breakout') html += '<th>Hisse</th><th>Fiyat</th><th>DeÄŸiÅŸim</th><th>Sinyal</th><th>20G YÃ¼ksek</th><th>20G DÃ¼ÅŸÃ¼k</th>';
    else html += '<th>Hisse</th><th>Fiyat</th><th>DeÄŸiÅŸim</th><th>Sinyal</th><th>RSI</th>';
    html += '</tr></thead><tbody>';

    for (const s of display) {
      const isFresh = s.freshSignal;
      const rowStyle = isFresh ? 'background:rgba(255,197,71,0.08);' : '';
      const signalColor = (s.signal||'').includes('AL') || (s.signal||'').includes('YUKARI') ? 'var(--green)' :
                          (s.signal||'').includes('SAT') || (s.signal||'').includes('ASAGI') ? 'var(--red)' : 'var(--text-muted)';

      html += `<tr class="stock-row" style="${rowStyle}" onclick="goToStock('${s.code}')">
        <td class="td-clickable td-mono" style="font-weight:${isFresh?'700':'400'};">${isFresh?'ğŸ”” ':''}${s.code}</td>
        <td class="td-mono">${s.price} â‚º</td>
        <td class="td-mono ${changeClass(s.changePct)}">%${s.changePct}</td>
        <td style="color:${signalColor};font-weight:600;font-size:12px;">${s.signal || '-'}</td>`;

      if (key === 'ma_cross') html += `<td class="td-mono">${s.ema20}</td><td class="td-mono">${s.ema50}</td><td class="td-mono">${s.distance}%</td>`;
      else if (key === 'breakout') html += `<td class="td-mono">${s.high20} â‚º</td><td class="td-mono">${s.low20} â‚º</td>`;
      else {
        const rsi = parseFloat(s.rsi);
        const rsiCol = rsi < 30 ? 'var(--green)' : rsi > 70 ? 'var(--red)' : 'var(--text-primary)';
        html += `<td class="td-mono" style="color:${rsiCol};font-weight:600;">${s.rsi}</td>`;
      }
      html += '</tr>';
    }
    html += '</tbody></table></div></div>';
  }

  container.innerHTML = html;
}


// =============================================================================
// TEMETTÃœ TAKVÄ°MÄ°
// =============================================================================
async function loadDividends() {
  const container = document.getElementById('dividendContent');
  container.innerHTML = '<div class="loading"><div class="spinner"></div>TemettÃ¼ bilgileri yÃ¼kleniyor... (bu biraz sÃ¼rebilir)</div>';

  const data = await api('/dividends');
  if (data.loading) { container.innerHTML = '<div class="loading"><div class="spinner"></div>Veriler yÃ¼kleniyor...</div>'; setTimeout(loadDividends, 5000); return; }
  if (data.error) { container.innerHTML = `<div class="card">${data.error}</div>`; return; }

  const divs = data.dividends || [];

  if (!divs.length) {
    container.innerHTML = '<div class="card">TemettÃ¼ verisi bulunamadÄ±. Veriler yÃ¼klendikten sonra tekrar deneyin.</div>';
    return;
  }

  let html = `<div class="grid-3 mb-24">
    <div class="card" style="text-align:center;border-left:3px solid var(--accent);">
      <div style="font-size:24px;font-weight:800;color:var(--accent);">${divs.length}</div>
      <div style="font-size:11px;color:var(--text-muted);">TemettÃ¼ Ã–deyen Hisse</div>
    </div>
    <div class="card" style="text-align:center;border-left:3px solid var(--green);">
      <div style="font-size:24px;font-weight:800;color:var(--green);">%${divs.length ? divs[0].dividendYield : 0}</div>
      <div style="font-size:11px;color:var(--text-muted);">En YÃ¼ksek Verim</div>
    </div>
    <div class="card" style="text-align:center;border-left:3px solid var(--text-muted);">
      <div style="font-size:24px;font-weight:800;">${divs.length ? divs[0].code : '-'}</div>
      <div style="font-size:11px;color:var(--text-muted);">En YÃ¼ksek Verimli Hisse</div>
    </div>
  </div>`;

  html += '<div class="card mb-24"><div style="font-weight:700;font-size:15px;margin-bottom:16px;">TemettÃ¼ SÄ±ralamasÄ± (Verime GÃ¶re)</div>';
  html += '<div class="table-wrap"><table><thead><tr>';
  html += '<th>#</th><th>Hisse</th><th>Fiyat</th><th>DeÄŸiÅŸim</th><th>TemettÃ¼ Verimi</th><th>Son 1 YÄ±l Toplam</th><th>Son TemettÃ¼</th><th>Son Tarih</th><th>YÄ±llÄ±k GeÃ§miÅŸ</th>';
  html += '</tr></thead><tbody>';

  divs.forEach((d, i) => {
    const yieldVal = parseFloat(d.dividendYield);
    const yieldColor = yieldVal >= 5 ? 'var(--green)' : yieldVal >= 2 ? 'var(--accent)' : 'var(--text-primary)';
    const yearlyHtml = Object.entries(d.yearlyTotals || {}).map(([y,v]) => `<span style="font-size:10px;padding:1px 5px;border-radius:3px;background:var(--bg);margin:1px;">${y}: ${v}â‚º</span>`).join('');

    html += `<tr class="stock-row" onclick="goToStock('${d.code}')">
      <td class="td-mono">${i+1}</td>
      <td class="td-clickable"><span class="td-mono" style="font-weight:700;">${d.code}</span><br><span style="font-size:10px;color:var(--text-muted);">${d.name}</span></td>
      <td class="td-mono">${d.price} â‚º</td>
      <td class="td-mono ${changeClass(d.changePct)}">%${d.changePct}</td>
      <td style="color:${yieldColor};font-weight:800;font-size:14px;">%${d.dividendYield}</td>
      <td class="td-mono">${d.totalDiv1Y} â‚º</td>
      <td class="td-mono">${d.lastDividend?.amount || '-'} â‚º</td>
      <td class="td-mono" style="font-size:11px;">${d.lastDividend?.date || '-'}</td>
      <td style="font-size:10px;">${yearlyHtml}</td>
    </tr>`;
  });

  html += '</tbody></table></div></div>';
  container.innerHTML = html;
}


// =============================================================================
// AUTH (LOGIN/REGISTER)
// =============================================================================
let currentUser = JSON.parse(localStorage.getItem('bistUser') || 'null');
let authMode = 'login';

function showLogin() {
  document.getElementById('loginModal').style.display = 'flex';
  switchAuthTab('login');
  document.getElementById('authUsername').value = '';
  document.getElementById('authPassword').value = '';
  if (document.getElementById('authEmail')) document.getElementById('authEmail').value = '';
  document.getElementById('authError').style.display = 'none';
  document.getElementById('authSuccess').style.display = 'none';
  setTimeout(() => document.getElementById('authUsername').focus(), 100);
}

function closeLogin() {
  document.getElementById('loginModal').style.display = 'none';
}

function switchAuthTab(mode) {
  authMode = mode;
  const tabLogin = document.getElementById('tabLogin');
  const tabRegister = document.getElementById('tabRegister');
  const emailRow = document.getElementById('authEmailRow');
  const submitBtn = document.getElementById('authSubmitBtn');
  const title = document.getElementById('authTitle');
  const subtitle = document.getElementById('authSubtitle');

  document.getElementById('authError').style.display = 'none';
  document.getElementById('authSuccess').style.display = 'none';

  if (mode === 'register') {
    tabRegister.style.background = 'var(--accent)';
    tabRegister.style.color = '#000';
    tabLogin.style.background = 'transparent';
    tabLogin.style.color = 'var(--text-muted)';
    emailRow.style.display = 'block';
    submitBtn.textContent = 'KayÄ±t Ol';
    title.textContent = 'Yeni Hesap OluÅŸturun';
    subtitle.textContent = 'PortfÃ¶y ve favorilerinizi kaydedin';
  } else {
    tabLogin.style.background = 'var(--accent)';
    tabLogin.style.color = '#000';
    tabRegister.style.background = 'transparent';
    tabRegister.style.color = 'var(--text-muted)';
    emailRow.style.display = 'none';
    submitBtn.textContent = 'GiriÅŸ Yap';
    title.textContent = 'HesabÄ±nÄ±za GiriÅŸ YapÄ±n';
    subtitle.textContent = 'PortfÃ¶y ve favorilerinize eriÅŸin';
  }
}

async function doAuth() {
  const username = document.getElementById('authUsername').value.trim();
  const password = document.getElementById('authPassword').value;
  const email = document.getElementById('authEmail')?.value?.trim() || '';
  const errEl = document.getElementById('authError');
  const successEl = document.getElementById('authSuccess');
  const submitBtn = document.getElementById('authSubmitBtn');

  errEl.style.display = 'none';
  successEl.style.display = 'none';

  if (!username || username.length < 3) {
    errEl.textContent = 'KullanÄ±cÄ± adÄ± en az 3 karakter olmalÄ±';
    errEl.style.display = 'block';
    return;
  }
  if (!password || password.length < 4) {
    errEl.textContent = 'Åifre en az 4 karakter olmalÄ±';
    errEl.style.display = 'block';
    return;
  }

  submitBtn.disabled = true;
  submitBtn.textContent = authMode === 'register' ? 'KayÄ±t yapÄ±lÄ±yor...' : 'GiriÅŸ yapÄ±lÄ±yor...';

  const endpoint = authMode === 'register' ? '/auth/register' : '/auth/login';
  const payload = { username, password };
  if (authMode === 'register') payload.email = email;

  const data = await api(endpoint, {
    method: 'POST',
    body: JSON.stringify(payload),
  });

  submitBtn.disabled = false;
  submitBtn.textContent = authMode === 'register' ? 'KayÄ±t Ol' : 'GiriÅŸ Yap';

  if (data.error) {
    errEl.textContent = data.error;
    errEl.style.display = 'block';
    return;
  }

  currentUser = { userId: data.userId, username: data.username, email: data.email || '' };
  localStorage.setItem('bistUser', JSON.stringify(currentUser));

  if (authMode === 'register') {
    successEl.textContent = 'Hesap oluÅŸturuldu! GiriÅŸ yapÄ±ldÄ±.';
    successEl.style.display = 'block';
    setTimeout(() => { closeLogin(); updateUserUI(); refreshActivePage(); }, 800);
  } else {
    closeLogin();
    updateUserUI();
    refreshActivePage();
  }
}

function refreshActivePage() {
  const activePage = document.querySelector('.page.active');
  if (activePage) {
    const pageId = activePage.id.replace('page-', '');
    if (pageId === 'portfolio') loadPortfolio();
    else if (pageId === 'watchlist') loadWatchlist();
    else if (pageId === 'alerts') loadAlerts();
  }
}

// Uygulama baslarken: localStorage'da kullanici varsa, DB'de hala var mi kontrol et
async function validateSession() {
  if (!currentUser) return;
  try {
    const data = await api('/auth/check?userId=' + currentUser.userId);
    if (!data.valid) {
      // DB sifirlanmis, oturum gecersiz
      currentUser = null;
      localStorage.removeItem('bistUser');
      updateUserUI();
    }
  } catch(e) { /* sessiz hata */ }
}

function logout() {
  currentUser = null;
  localStorage.removeItem('bistUser');
  updateUserUI();
  refreshActivePage();
}

function updateUserUI() {
  const el = document.getElementById('userStatus');
  if (!el) return;
  el.style.display = 'flex';
  el.style.alignItems = 'center';
  el.style.gap = '8px';
  if (currentUser) {
    el.innerHTML = `<span style="font-size:12px;color:var(--accent);font-weight:600;">
      <svg width="14" height="14" fill="none" stroke="currentColor" stroke-width="2" viewBox="0 0 24 24" style="vertical-align:-2px;margin-right:3px;"><path d="M20 21v-2a4 4 0 0 0-4-4H8a4 4 0 0 0-4 4v2"/><circle cx="12" cy="7" r="4"/></svg>
      ${currentUser.username}</span>
      <button class="btn btn-sm btn-secondary" onclick="logout()" style="font-size:10px;padding:2px 8px;">Ã‡Ä±kÄ±ÅŸ</button>`;
  } else {
    el.innerHTML = `<button class="btn btn-sm btn-primary" onclick="showLogin()" style="font-size:11px;background:var(--accent);color:#000;font-weight:700;border-radius:8px;padding:6px 14px;">GiriÅŸ / KayÄ±t</button>`;
  }
}


// =============================================================================
// BES (Bireysel Emeklilik Sistemi) FONKSIYONLARI
// =============================================================================
let besAllFunds = [];
let besSimChartInstance = null;

function besAddFundRow() {
  const container = document.getElementById('besFundInputs');
  const row = document.createElement('div');
  row.className = 'bes-fund-row';
  row.style.cssText = 'display:flex;gap:10px;margin-bottom:8px;align-items:center;';
  row.innerHTML = `
    <input type="text" placeholder="Fon Kodu (Ã¶r: IPB)" class="bes-fund-code" style="flex:2;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-primary);font-size:13px;text-transform:uppercase;">
    <input type="number" placeholder="%" class="bes-fund-pct" value="0" min="0" max="100" style="flex:1;padding:10px 12px;border-radius:8px;border:1px solid var(--border);background:var(--bg-input);color:var(--text-primary);font-size:13px;">
    <button onclick="this.parentElement.remove()" style="background:var(--red-bg);color:var(--red);border:none;border-radius:8px;padding:8px 12px;cursor:pointer;font-size:16px;">Ã—</button>
  `;
  container.appendChild(row);
}

function besGetUserFunds() {
  const rows = document.querySelectorAll('.bes-fund-row');
  const funds = [];
  rows.forEach(row => {
    const code = row.querySelector('.bes-fund-code')?.value?.trim().toUpperCase();
    const pct = parseFloat(row.querySelector('.bes-fund-pct')?.value) || 0;
    if (code && code.length >= 2) {
      funds.push({ code, pct });
    }
  });
  return funds;
}

let _besAnalyzeRetryTimer = null;

async function besAnalyze() {
  const funds = besGetUserFunds();
  const monthly = parseFloat(document.getElementById('besMonthly').value) || 2000;
  const horizon = parseInt(document.getElementById('besHorizon').value) || 36;
  const risk = document.getElementById('besRiskProfile').value;

  document.getElementById('besResults').style.display = 'none';
  document.getElementById('besFundList').style.display = 'none';
  document.getElementById('besLoading').style.display = 'block';
  document.getElementById('besLoadingText').textContent = 'TEFAS verisi analiz ediliyor, fonlar karsilastiriliyor...';

  try {
    const data = await api('/bes/analyze', {
      method: 'POST',
      body: JSON.stringify({
        funds: funds,
        monthlyContribution: monthly,
        horizonMonths: horizon,
        riskProfile: risk,
      }),
    });

    // Loading durumu - fon havuzu henuz hazir degil, otomatik tekrar dene
    if (data && data.loading) {
      document.getElementById('besLoadingText').textContent = data.message || 'Fon verileri hazÄ±rlaniyor, otomatik tekrar deneniyor...';
      if (_besAnalyzeRetryTimer) clearTimeout(_besAnalyzeRetryTimer);
      _besAnalyzeRetryTimer = setTimeout(() => besAnalyze(), 8000);
      return;
    }

    document.getElementById('besLoading').style.display = 'none';

    if (!data || !data.success) {
      alert('Analiz yapilamadi: ' + (data?.error || 'Bilinmeyen hata. Lutfen once BES sekmesinin fonlari yuklemesini bekleyin.'));
      return;
    }

    besRenderResults(data);
  } catch (e) {
    document.getElementById('besLoading').style.display = 'none';
    alert('Hata: ' + e.message);
  }
}

function besRenderResults(data) {
  document.getElementById('besResults').style.display = 'block';

  // Ozet kartlar
  const sim = data.simulation || {};
  const summaryCards = document.getElementById('besSummaryCards');
  const riskLabels = { conservative: 'Muhafazakar', moderate: 'Dengeli', aggressive: 'Agresif' };
  const riskColors = { conservative: 'var(--blue)', moderate: 'var(--yellow)', aggressive: 'var(--red)' };

  summaryCards.innerHTML = `
    <div class="card" style="text-align:center;padding:20px;">
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">Toplam Birikim</div>
      <div style="font-size:22px;font-weight:800;color:var(--green);">${besFormatMoney(sim.totalBalance)}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">${data.horizonMonths} ay sonunda</div>
    </div>
    <div class="card" style="text-align:center;padding:20px;">
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">Toplam Katki</div>
      <div style="font-size:22px;font-weight:800;color:var(--text-primary);">${besFormatMoney(sim.totalContributed)}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">Aylik ${besFormatMoney(data.monthlyContribution)}</div>
    </div>
    <div class="card" style="text-align:center;padding:20px;">
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">Devlet Katkisi</div>
      <div style="font-size:22px;font-weight:800;color:var(--blue);">${besFormatMoney(sim.devletKatkisi)}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">%30 devlet katkisi</div>
    </div>
    <div class="card" style="text-align:center;padding:20px;">
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">Fon Getirisi</div>
      <div style="font-size:22px;font-weight:800;color:${sim.totalGain >= 0 ? 'var(--green)' : 'var(--red)'};">${besFormatMoney(sim.totalGain)}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">%${sim.totalGainPct} toplam getiri</div>
    </div>
    <div class="card" style="text-align:center;padding:20px;">
      <div style="font-size:11px;color:var(--text-muted);margin-bottom:6px;">Risk Profili</div>
      <div style="font-size:18px;font-weight:800;color:${riskColors[data.riskProfile] || 'var(--accent)'};">${riskLabels[data.riskProfile] || data.riskProfile}</div>
      <div style="font-size:11px;color:var(--text-muted);margin-top:4px;">${data.horizonMonths} ay vade</div>
    </div>
  `;

  // Mevcut vs Onerilen karsilastirma
  if (data.currentPortfolio && data.currentPortfolio.funds && data.currentPortfolio.funds.length > 0) {
    const comp = data.comparison || {};
    document.getElementById('besComparison').style.display = 'block';
    document.getElementById('besComparisonContent').innerHTML = `
      <div style="display:grid;grid-template-columns:1fr auto 1fr;gap:16px;align-items:center;">
        <div style="text-align:center;padding:16px;background:var(--bg-input);border-radius:10px;">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Mevcut Portfoy Skoru</div>
          <div style="font-size:28px;font-weight:800;color:var(--yellow);">${comp.currentScore}</div>
        </div>
        <div style="font-size:24px;color:var(--accent);">â†’</div>
        <div style="text-align:center;padding:16px;background:var(--accent-dim);border-radius:10px;border:1px solid var(--accent);">
          <div style="font-size:12px;color:var(--text-muted);margin-bottom:8px;">Onerilen Portfoy Skoru</div>
          <div style="font-size:28px;font-weight:800;color:var(--green);">${comp.recommendedScore}</div>
        </div>
      </div>
      ${comp.improvement > 0 ? `<div style="text-align:center;margin-top:12px;padding:10px;background:var(--green-bg);border-radius:8px;color:var(--green);font-weight:600;font-size:13px;">+${comp.improvement} puan iyilestirme potansiyeli</div>` : ''}
    `;
  } else {
    document.getElementById('besComparison').style.display = 'none';
  }

  // Oneri tablosu
  const recs = data.recommendations || [];
  let recHtml = `<table style="width:100%;border-collapse:collapse;font-size:12px;">
    <thead><tr style="border-bottom:2px solid var(--border);">
      <th style="text-align:left;padding:10px 8px;color:var(--text-muted);">Fon</th>
      <th style="text-align:center;padding:10px 4px;color:var(--text-muted);">Kategori</th>
      <th style="text-align:center;padding:10px 4px;color:var(--text-muted);">Oran</th>
      <th style="text-align:center;padding:10px 4px;color:var(--text-muted);">6A Getiri</th>
      <th style="text-align:center;padding:10px 4px;color:var(--text-muted);">Volatilite</th>
      <th style="text-align:center;padding:10px 4px;color:var(--text-muted);">Sharpe</th>
      <th style="text-align:left;padding:10px 4px;color:var(--text-muted);">Aciklama</th>
    </tr></thead><tbody>`;

  const catColors = {
    hisse: 'var(--green)', borclanma: 'var(--blue)', katilim: 'var(--purple)',
    karma: 'var(--yellow)', doviz: '#ff9f43', altin: '#ffd700',
    endeks: 'var(--accent)', para_piyasasi: 'var(--text-muted)', standart: '#a0a0a0',
  };

  recs.forEach(r => {
    const cc = catColors[r.category] || 'var(--text-secondary)';
    recHtml += `<tr style="border-bottom:1px solid var(--border);">
      <td style="padding:10px 8px;">
        <div style="font-weight:700;color:var(--text-primary);">${r.code}</div>
        <div style="font-size:10px;color:var(--text-muted);max-width:180px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${r.name || ''}</div>
      </td>
      <td style="text-align:center;padding:10px 4px;">
        <span style="background:${cc}22;color:${cc};padding:3px 8px;border-radius:6px;font-size:10px;font-weight:600;">${r.categoryLabel || r.category}</span>
      </td>
      <td style="text-align:center;padding:10px 4px;font-weight:800;font-size:15px;color:var(--accent);">%${r.recommendedPct}</td>
      <td style="text-align:center;padding:10px 4px;color:${r.return6m >= 0 ? 'var(--green)' : 'var(--red)'};font-weight:600;">%${r.return6m}</td>
      <td style="text-align:center;padding:10px 4px;">%${r.volatility}</td>
      <td style="text-align:center;padding:10px 4px;font-weight:600;color:${r.sharpe >= 0 ? 'var(--green)' : 'var(--red)'};">${r.sharpe}</td>
      <td style="padding:10px 4px;font-size:11px;color:var(--text-secondary);max-width:250px;">${r.reasoning || ''}</td>
    </tr>`;
  });
  recHtml += '</tbody></table>';
  document.getElementById('besRecommendations').innerHTML = recHtml;

  // Simulasyon timeline
  const timeline = sim.timeline || [];
  if (timeline.length > 0) {
    let simHtml = `<table style="width:100%;border-collapse:collapse;font-size:12px;">
      <thead><tr style="border-bottom:2px solid var(--border);">
        <th style="text-align:center;padding:8px;color:var(--text-muted);">Ay</th>
        <th style="text-align:right;padding:8px;color:var(--text-muted);">Toplam Birikim</th>
        <th style="text-align:right;padding:8px;color:var(--text-muted);">Kendi Katkiniz</th>
        <th style="text-align:right;padding:8px;color:var(--text-muted);">Devlet Katkisi</th>
        <th style="text-align:right;padding:8px;color:var(--text-muted);">Fon Getirisi</th>
        <th style="text-align:right;padding:8px;color:var(--text-muted);">Getiri %</th>
      </tr></thead><tbody>`;
    timeline.forEach(t => {
      simHtml += `<tr style="border-bottom:1px solid var(--border);">
        <td style="text-align:center;padding:8px;font-weight:600;">${t.month}. ay</td>
        <td style="text-align:right;padding:8px;font-weight:700;color:var(--green);">${besFormatMoney(t.totalBalance)}</td>
        <td style="text-align:right;padding:8px;">${besFormatMoney(t.totalContributed)}</td>
        <td style="text-align:right;padding:8px;color:var(--blue);">${besFormatMoney(t.devletKatkisi)}</td>
        <td style="text-align:right;padding:8px;color:${t.totalGain >= 0 ? 'var(--green)' : 'var(--red)'};">${besFormatMoney(t.totalGain)}</td>
        <td style="text-align:right;padding:8px;font-weight:600;color:${t.gainPct >= 0 ? 'var(--green)' : 'var(--red)'};">%${t.gainPct}</td>
      </tr>`;
    });
    simHtml += '</tbody></table>';
    document.getElementById('besSimulation').innerHTML = simHtml;

    // Chart
    besRenderSimChart(timeline);
  }

  // Fon bazli detay
  const fundDetails = sim.fundDetails || [];
  if (fundDetails.length > 0) {
    document.getElementById('besFundDetails').style.display = 'block';
    let fdHtml = `<div style="display:grid;grid-template-columns:repeat(auto-fit,minmax(240px,1fr));gap:12px;">`;
    fundDetails.forEach(fd => {
      fdHtml += `
        <div style="background:var(--bg-input);border-radius:10px;padding:16px;border:1px solid var(--border);">
          <div style="font-weight:700;font-size:13px;margin-bottom:4px;color:var(--accent);">${fd.code}</div>
          <div style="font-size:11px;color:var(--text-muted);margin-bottom:12px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${fd.name}</div>
          <div style="display:grid;grid-template-columns:1fr 1fr;gap:8px;">
            <div><span style="font-size:10px;color:var(--text-muted);">Oran</span><div style="font-weight:700;">%${fd.pct}</div></div>
            <div><span style="font-size:10px;color:var(--text-muted);">Birikim</span><div style="font-weight:700;color:var(--green);">${besFormatMoney(fd.balance)}</div></div>
            <div><span style="font-size:10px;color:var(--text-muted);">Katki</span><div>${besFormatMoney(fd.totalContribution)}</div></div>
            <div><span style="font-size:10px;color:var(--text-muted);">Getiri</span><div style="color:${fd.gain >= 0 ? 'var(--green)' : 'var(--red)'};font-weight:600;">${besFormatMoney(fd.gain)} (%${fd.gainPct})</div></div>
          </div>
        </div>`;
    });
    fdHtml += '</div>';
    document.getElementById('besFundDetailsContent').innerHTML = fdHtml;
  }
}

function besRenderSimChart(timeline) {
  const canvas = document.getElementById('besSimChart');
  if (!canvas) return;
  if (besSimChartInstance) { besSimChartInstance.destroy(); }

  const labels = timeline.map(t => t.month + '. ay');
  const balanceData = timeline.map(t => t.totalBalance);
  const contribData = timeline.map(t => t.totalContributed);
  const devletData = timeline.map(t => t.devletKatkisi);

  besSimChartInstance = new Chart(canvas, {
    type: 'line',
    data: {
      labels,
      datasets: [
        {
          label: 'Toplam Birikim',
          data: balanceData,
          borderColor: '#00e5a0',
          backgroundColor: 'rgba(0,229,160,0.1)',
          fill: true,
          tension: 0.3,
          borderWidth: 2.5,
          pointRadius: 2,
        },
        {
          label: 'Kendi Katkiniz',
          data: contribData,
          borderColor: '#8896aa',
          borderDash: [5, 5],
          fill: false,
          tension: 0.3,
          borderWidth: 1.5,
          pointRadius: 1,
        },
        {
          label: 'Devlet Katkisi',
          data: devletData,
          borderColor: '#4da6ff',
          borderDash: [3, 3],
          fill: false,
          tension: 0.3,
          borderWidth: 1.5,
          pointRadius: 1,
        },
      ],
    },
    options: {
      responsive: true,
      maintainAspectRatio: false,
      plugins: {
        legend: { labels: { color: '#8896aa', font: { size: 11 } } },
        tooltip: {
          callbacks: {
            label: ctx => ctx.dataset.label + ': ' + besFormatMoney(ctx.raw),
          }
        }
      },
      scales: {
        x: { ticks: { color: '#5a6a80', font: { size: 10 } }, grid: { color: 'rgba(42,53,72,0.5)' } },
        y: {
          ticks: {
            color: '#5a6a80', font: { size: 10 },
            callback: v => besFormatMoney(v),
          },
          grid: { color: 'rgba(42,53,72,0.5)' },
        },
      },
    },
  });
}

async function besLoadFunds() {
  document.getElementById('besResults').style.display = 'none';
  document.getElementById('besFundList').style.display = 'none';
  document.getElementById('besLoading').style.display = 'block';
  document.getElementById('besLoadingText').textContent = 'BES fonlari yukleniyor...';

  try {
    const data = await api('/bes/funds');
    document.getElementById('besLoading').style.display = 'none';

    if (!data || !data.success) {
      alert('Fon listesi alinamadi: ' + (data?.error || 'Bilinmeyen hata'));
      return;
    }

    besAllFunds = data.funds || [];
    document.getElementById('besFundList').style.display = 'block';
    besRenderFundList(besAllFunds);
  } catch (e) {
    document.getElementById('besLoading').style.display = 'none';
    alert('Hata: ' + e.message);
  }
}

function besFilterFunds() {
  const cat = document.getElementById('besCategoryFilter').value;
  const search = (document.getElementById('besFundSearch').value || '').toUpperCase();
  let filtered = besAllFunds;
  if (cat) filtered = filtered.filter(f => f.category === cat);
  if (search) filtered = filtered.filter(f =>
    (f.code || '').toUpperCase().includes(search) ||
    (f.name || '').toUpperCase().includes(search)
  );
  besRenderFundList(filtered);
}

function besRenderFundList(funds) {
  let html = `<table style="width:100%;border-collapse:collapse;font-size:12px;">
    <thead><tr style="border-bottom:2px solid var(--border);">
      <th style="text-align:left;padding:8px;color:var(--text-muted);">Fon Kodu</th>
      <th style="text-align:left;padding:8px;color:var(--text-muted);">Fon Adi</th>
      <th style="text-align:center;padding:8px;color:var(--text-muted);">Kategori</th>
      <th style="text-align:right;padding:8px;color:var(--text-muted);">Birim Pay</th>
      <th style="text-align:right;padding:8px;color:var(--text-muted);">Toplam Deger</th>
      <th style="text-align:right;padding:8px;color:var(--text-muted);">Yatirimci</th>
      <th style="text-align:center;padding:8px;color:var(--text-muted);">Islem</th>
    </tr></thead><tbody>`;

  funds.forEach(f => {
    const catColors = {
      hisse: '#00e5a0', borclanma: '#4da6ff', katilim: '#a78bfa',
      karma: '#ffc547', doviz: '#ff9f43', altin: '#ffd700',
      endeks: '#00d4aa', para_piyasasi: '#8896aa',
    };
    const cc = catColors[f.category] || '#8896aa';
    html += `<tr style="border-bottom:1px solid var(--border);cursor:pointer;" onmouseover="this.style.background='var(--bg-card-hover)'" onmouseout="this.style.background='transparent'">
      <td style="padding:8px;font-weight:700;color:var(--accent);">${f.code}</td>
      <td style="padding:8px;max-width:250px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${f.name || ''}</td>
      <td style="text-align:center;padding:8px;">
        <span style="background:${cc}22;color:${cc};padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600;">${f.categoryLabel || f.category}</span>
      </td>
      <td style="text-align:right;padding:8px;font-weight:600;">${sf2(f.price)}</td>
      <td style="text-align:right;padding:8px;">${besFormatMoney(f.total_value)}</td>
      <td style="text-align:right;padding:8px;">${f.investors ? f.investors.toLocaleString('tr-TR') : '-'}</td>
      <td style="text-align:center;padding:8px;">
        <button onclick="besAddFundFromList('${f.code}')" class="btn btn-sm" style="font-size:10px;padding:4px 10px;background:var(--accent-dim);color:var(--accent);border:1px solid var(--accent);border-radius:6px;cursor:pointer;">Ekle</button>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  if (funds.length === 0) {
    html = '<div style="text-align:center;padding:24px;color:var(--text-muted);">Fon bulunamadi</div>';
  }
  document.getElementById('besFundListContent').innerHTML = html;
}

function besAddFundFromList(code) {
  const container = document.getElementById('besFundInputs');
  // Zaten eklenmis mi kontrol et
  const existing = container.querySelectorAll('.bes-fund-code');
  for (const inp of existing) {
    if (inp.value.toUpperCase() === code.toUpperCase()) {
      inp.style.borderColor = 'var(--accent)';
      setTimeout(() => inp.style.borderColor = 'var(--border)', 1000);
      return;
    }
  }
  // Bos input varsa ona yaz
  for (const inp of existing) {
    if (!inp.value.trim()) {
      inp.value = code;
      return;
    }
  }
  // Yeni satir ekle
  besAddFundRow();
  const newInputs = container.querySelectorAll('.bes-fund-code');
  newInputs[newInputs.length - 1].value = code;
}

function besFormatMoney(val) {
  if (val === null || val === undefined) return '-';
  const num = parseFloat(val);
  if (isNaN(num)) return '-';
  if (Math.abs(num) >= 1e9) return (num / 1e9).toFixed(1) + ' Milyar TL';
  if (Math.abs(num) >= 1e6) return (num / 1e6).toFixed(1) + ' Milyon TL';
  return num.toLocaleString('tr-TR', { minimumFractionDigits: 0, maximumFractionDigits: 0 }) + ' TL';
}

function sf2(v) {
  const n = parseFloat(v);
  if (isNaN(n)) return '-';
  return n.toLocaleString('tr-TR', { minimumFractionDigits: 6, maximumFractionDigits: 6 });
}

// =============================================================================
// BES TOP FONLAR & KATEGORÄ° ANALÄ°ZÄ°
// =============================================================================
let _besCurrentPeriod = '3a';
let _besTopPollTimer = null;
let _besTopPollCount = 0;

async function besLoadTopFunds(forceRefresh, period) {
  if (period) _besCurrentPeriod = period;
  const p = _besCurrentPeriod;

  // Period butonlarini guncelle
  document.querySelectorAll('.bes-period-btn').forEach(btn => {
    btn.style.background = 'transparent';
    btn.style.color = 'var(--text-muted)';
  });
  const activeBtn = document.getElementById('besPeriod' + p);
  if (activeBtn) { activeBtn.style.background = 'var(--accent)'; activeBtn.style.color = '#fff'; }

  const cacheKey = 'bes_top_' + p;
  const cached = forceRefresh ? null : _getCached(cacheKey);
  if (cached) {
    besRenderTopFunds(cached);
    return;
  }

  const el = document.getElementById('besTopFundsContent');
  el.innerHTML = '<div class="loading"><div class="spinner"></div>BES fonlari hazÄ±rlaniyor...</div>';

  try {
    const data = await api('/bes/top?period=' + p);
    if (!data) {
      el.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:12px;">Sunucuya ulasilamadi. <button class="btn btn-sm btn-secondary" onclick="besLoadTopFunds(true)" style="margin-left:8px;">Tekrar Dene</button></div>';
      return;
    }
    // Loading durumu - backend arka planda analiz ediyor, polling yap
    if (data.loading) {
      _besTopPollCount++;
      const msg = data.message || 'Fonlar analiz ediliyor...';
      el.innerHTML = `<div class="loading"><div class="spinner"></div>${msg} (${_besTopPollCount * 5}s)</div>`;
      if (_besTopPollCount < 24) { // Max 2 dakika (24 x 5s)
        if (_besTopPollTimer) clearTimeout(_besTopPollTimer);
        _besTopPollTimer = setTimeout(() => besLoadTopFunds(true), 5000);
      } else {
        _besTopPollCount = 0;
        el.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:12px;">Fon analizi uzun suruyor. <button class="btn btn-sm btn-secondary" onclick="_besTopPollCount=0;besLoadTopFunds(true)" style="margin-left:8px;">Tekrar Dene</button></div>';
      }
      return;
    }
    _besTopPollCount = 0;
    if (!data.success) {
      el.innerHTML = `<div style="color:var(--text-muted);font-size:12px;padding:12px;">${data.error || 'Fon verileri yuklenemedi.'} <button class="btn btn-sm btn-secondary" onclick="besLoadTopFunds(true)" style="margin-left:8px;">Tekrar Dene</button></div>`;
      return;
    }
    _setCache(cacheKey, data);
    besRenderTopFunds(data);
  } catch(e) {
    el.innerHTML = '<div style="color:var(--text-muted);font-size:12px;padding:12px;">Hata: ' + e.message + ' <button class="btn btn-sm btn-secondary" onclick="besLoadTopFunds(true)" style="margin-left:8px;">Tekrar Dene</button></div>';
  }
}

function besRenderTopFunds(data) {
  const el = document.getElementById('besTopFundsContent');
  const topFunds = data.topFunds || data.funds || [];

  if (topFunds.length === 0) {
    el.innerHTML = '<div style="color:var(--text-muted);font-size:12px;">HenÃ¼z fon verisi yok.</div>';
    return;
  }

  const catColors = {
    hisse: '#00e5a0', borclanma: '#4da6ff', katilim: '#a78bfa',
    karma: '#ffc547', doviz: '#ff9f43', altin: '#ffd700',
    endeks: '#00d4aa', para_piyasasi: '#8896aa', standart: '#a0a0a0', diger: '#666'
  };

  // Top 10 fonlar tablosu
  let html = `<table style="width:100%;border-collapse:collapse;font-size:12px;">
    <thead><tr style="border-bottom:2px solid var(--border);">
      <th style="text-align:left;padding:8px;color:var(--text-muted);">Fon</th>
      <th style="text-align:center;padding:8px;color:var(--text-muted);">Kategori</th>
      <th style="text-align:right;padding:8px;color:var(--text-muted);">1A Getiri</th>
      <th style="text-align:right;padding:8px;color:var(--text-muted);">3A Getiri</th>
      <th style="text-align:right;padding:8px;color:var(--text-muted);">6A Getiri</th>
      <th style="text-align:right;padding:8px;color:var(--text-muted);">Volatilite</th>
      <th style="text-align:right;padding:8px;color:var(--text-muted);">Sharpe</th>
      <th style="text-align:right;padding:8px;color:var(--text-muted);">Maks. DÃ¼ÅŸÃ¼ÅŸ</th>
      <th style="text-align:center;padding:8px;color:var(--text-muted);">Islem</th>
    </tr></thead><tbody>`;

  topFunds.slice(0, 15).forEach((f, i) => {
    const cc = catColors[f.category] || '#8896aa';
    const ret1m = f.returns?.['1a'] ?? f.return1m ?? null;
    const ret3m = f.returns?.['3a'] ?? f.return3m ?? null;
    const ret6m = f.returns?.['6a'] ?? f.return6m ?? null;
    const vol = f.volatility != null ? Number(f.volatility).toFixed(1) : null;
    const sharpe = f.sharpe != null ? Number(f.sharpe).toFixed(2) : null;
    const maxDD = f.maxDrawdown != null ? Number(f.maxDrawdown).toFixed(1) : null;
    const sharpeColor = sharpe > 1 ? 'var(--green)' : (sharpe > 0 ? 'var(--yellow)' : 'var(--red)');

    html += `<tr style="border-bottom:1px solid var(--border);" onmouseover="this.style.background='var(--bg-card-hover)'" onmouseout="this.style.background='transparent'">
      <td style="padding:8px;">
        <div style="display:flex;align-items:center;gap:8px;">
          <span style="font-size:14px;font-weight:800;color:var(--accent);min-width:22px;">${i+1}</span>
          <div>
            <div style="font-weight:700;color:var(--text-primary);">${f.code}</div>
            <div style="font-size:10px;color:var(--text-muted);max-width:200px;overflow:hidden;text-overflow:ellipsis;white-space:nowrap;">${f.name || ''}</div>
          </div>
        </div>
      </td>
      <td style="text-align:center;padding:8px;">
        <span style="background:${cc}22;color:${cc};padding:2px 8px;border-radius:6px;font-size:10px;font-weight:600;">${f.categoryLabel || f.category || '-'}</span>
      </td>
      <td style="text-align:right;padding:8px;font-weight:600;color:${(ret1m||0) >= 0 ? 'var(--green)' : 'var(--red)'};">${ret1m != null ? '%'+Number(ret1m).toFixed(2) : '-'}</td>
      <td style="text-align:right;padding:8px;font-weight:600;color:${(ret3m||0) >= 0 ? 'var(--green)' : 'var(--red)'};">${ret3m != null ? '%'+Number(ret3m).toFixed(2) : '-'}</td>
      <td style="text-align:right;padding:8px;font-weight:600;color:${(ret6m||0) >= 0 ? 'var(--green)' : 'var(--red)'};">${ret6m != null ? '%'+Number(ret6m).toFixed(2) : '-'}</td>
      <td style="text-align:right;padding:8px;font-size:11px;color:var(--text-secondary);">${vol != null ? '%'+vol : '-'}</td>
      <td style="text-align:right;padding:8px;font-weight:600;color:${sharpeColor};">${sharpe ?? '-'}</td>
      <td style="text-align:right;padding:8px;font-size:11px;color:var(--red);">${maxDD != null ? '-%'+maxDD : '-'}</td>
      <td style="text-align:center;padding:8px;">
        <button onclick="besAddFundFromList('${f.code}')" class="btn btn-sm" style="font-size:10px;padding:4px 10px;background:var(--accent-dim);color:var(--accent);border:1px solid var(--accent);border-radius:6px;cursor:pointer;">Ekle</button>
      </td>
    </tr>`;
  });
  html += '</tbody></table>';
  el.innerHTML = html;

  // Kategori bazli performans
  besRenderCategoryOverview(data);
}

function besRenderCategoryOverview(data) {
  const categories = data.categories || data.categoryStats || null;
  if (!categories || Object.keys(categories).length === 0) {
    // Fon listesinden kategori istatistiklerini hesapla
    const funds = data.topFunds || data.funds || [];
    if (funds.length === 0) return;

    const catStats = {};
    funds.forEach(f => {
      const cat = f.category || 'diger';
      if (!catStats[cat]) catStats[cat] = { count: 0, totalReturn: 0, funds: [] };
      const ret = f.returns?.['6a'] ?? f.return6m ?? f.totalReturn ?? 0;
      catStats[cat].count++;
      catStats[cat].totalReturn += Number(ret) || 0;
      catStats[cat].funds.push(f);
    });

    if (Object.keys(catStats).length === 0) return;

    const catLabels = {
      hisse: 'Hisse Senedi', borclanma: 'BorÃ§lanma', katilim: 'KatÄ±lÄ±m',
      karma: 'Karma/Dengeli', doviz: 'DÃ¶viz', altin: 'AltÄ±n/K.Maden',
      endeks: 'Endeks', para_piyasasi: 'Para PiyasasÄ±', standart: 'Standart', diger: 'DiÄŸer'
    };
    const catColors = {
      hisse: '#00e5a0', borclanma: '#4da6ff', katilim: '#a78bfa',
      karma: '#ffc547', doviz: '#ff9f43', altin: '#ffd700',
      endeks: '#00d4aa', para_piyasasi: '#8896aa', standart: '#a0a0a0', diger: '#666'
    };

    let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;">';
    const sorted = Object.entries(catStats).sort((a,b) => (b[1].totalReturn / b[1].count) - (a[1].totalReturn / a[1].count));

    sorted.forEach(([cat, stats]) => {
      const avgRet = stats.count > 0 ? (stats.totalReturn / stats.count) : 0;
      const cc = catColors[cat] || '#8896aa';
      const bestFund = stats.funds.sort((a,b) => {
        const ra = Number(a.returns?.['6a'] ?? a.return6m ?? a.totalReturn ?? 0);
        const rb = Number(b.returns?.['6a'] ?? b.return6m ?? b.totalReturn ?? 0);
        return rb - ra;
      })[0];

      html += `<div style="background:var(--bg-input);border-radius:10px;padding:14px;border:1px solid var(--border);border-top:3px solid ${cc};">
        <div style="font-weight:700;font-size:12px;color:${cc};margin-bottom:8px;">${catLabels[cat] || cat}</div>
        <div style="font-size:20px;font-weight:800;color:${avgRet >= 0 ? 'var(--green)' : 'var(--red)'};">%${avgRet.toFixed(1)}</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">Ort. 6 AylÄ±k Getiri</div>
        <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">${stats.count} fon</div>
        ${bestFund ? `<div style="font-size:10px;color:var(--accent);margin-top:4px;">En iyi: ${bestFund.code}</div>` : ''}
      </div>`;
    });
    html += '</div>';

    const section = document.getElementById('besCategoryOverview');
    document.getElementById('besCategoryContent').innerHTML = html;
    section.style.display = 'block';
    return;
  }

  // API'den gelen kategori verileri
  const catColors = {
    hisse: '#00e5a0', borclanma: '#4da6ff', katilim: '#a78bfa',
    karma: '#ffc547', doviz: '#ff9f43', altin: '#ffd700',
    endeks: '#00d4aa', para_piyasasi: '#8896aa', standart: '#a0a0a0', diger: '#666'
  };
  const catLabels = {
    hisse: 'Hisse Senedi', borclanma: 'BorÃ§lanma', katilim: 'KatÄ±lÄ±m',
    karma: 'Karma/Dengeli', doviz: 'DÃ¶viz', altin: 'AltÄ±n/K.Maden',
    endeks: 'Endeks', para_piyasasi: 'Para PiyasasÄ±', standart: 'Standart', diger: 'DiÄŸer'
  };

  let html = '<div style="display:grid;grid-template-columns:repeat(auto-fill,minmax(180px,1fr));gap:12px;">';
  Object.entries(categories).forEach(([cat, stats]) => {
    const cc = catColors[cat] || '#8896aa';
    html += `<div style="background:var(--bg-input);border-radius:10px;padding:14px;border:1px solid var(--border);border-top:3px solid ${cc};">
      <div style="font-weight:700;font-size:12px;color:${cc};margin-bottom:8px;">${catLabels[cat] || cat}</div>
      <div style="font-size:20px;font-weight:800;color:${(stats.avgReturn||0) >= 0 ? 'var(--green)' : 'var(--red)'};">%${Number(stats.avgReturn || 0).toFixed(1)}</div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:2px;">Ort. Getiri</div>
      <div style="font-size:10px;color:var(--text-muted);margin-top:6px;">${stats.count || 0} fon</div>
      ${stats.bestFund ? `<div style="font-size:10px;color:var(--accent);margin-top:4px;">En iyi: ${stats.bestFund}</div>` : ''}
    </div>`;
  });
  html += '</div>';

  const section = document.getElementById('besCategoryOverview');
  document.getElementById('besCategoryContent').innerHTML = html;
  section.style.display = 'block';
}

// =============================================================================
// INIT
// =============================================================================
document.addEventListener('DOMContentLoaded', () => {
  loadDashboard().catch(() => dismissLoadingPopup());
  updateUserUI();
  validateSession(); // DB sifirlanmissa oturumu yeniden olustur
});
</script>
</body>
</html>
